<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- SDKs -->
  <script src="https://js.stripe.com/v3"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827;
      --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --header-h:56px; --nav-h:64px;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; max-width:100%; overflow-x:hidden; -webkit-text-size-adjust:100% }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }

    header {
      position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:100;
      background:var(--card); border-bottom:1px solid var(--border); display:flex; align-items:center;
      padding-top: env(safe-area-inset-top, 0px);
    }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; width:100% }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }
    .small { color:var(--muted); font-size:13px }

    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; max-width:100% }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow) }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#eef2ff; display:flex; align-items:center; justify-content:center; font-size:18px }
    .field { display:flex; flex-direction:column; gap:6px }
    .field input, .field textarea, .field select { padding:10px; border:1px solid var(--border); border-radius:10px }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:100% }
    .price { font-weight:700; color:#111 }
    .hint { font-size:12px; color:#6b7280 }

    .nav {
      position:fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      display:flex; align-items:center; justify-content:space-around; background:#fff; border-top:1px solid var(--border); z-index:90;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }

    .page {
      position:fixed; top:calc(var(--header-h) + env(safe-area-inset-top, 0px)); bottom:var(--nav-h); left:0; right:0;
      overflow-y:auto; overflow-x:hidden; display:none; -webkit-overflow-scrolling:touch; background:var(--bg);
    }
    .page.active { display:block }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:200; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow); max-width:100% }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px; max-height:calc(100vh - 120px); overflow:auto }

    /* Full-screen height forms */
    #checkoutModal .sheet, #sellModal .sheet { height: calc(100vh - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px)); display:flex; flex-direction:column }
    #checkoutModal .sheet .body, #sellModal .sheet .body { flex:1; overflow:auto }

    /* Header alignment: greeting removed; push actions into header fully */
    header .row > .left { flex:1; min-width:0; }
    #notifBtn { margin-right:6px; }

    /* Floating panic */
    .floating-panic { position:fixed; right:16px; bottom:80px; width:56px; height:56px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:96; display:flex; align-items:center; justify-content:center }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="row">
      <div class="left"></div>
      <div class="row">
        <button class="btn ghost" id="notifBtn" type="button" title="Notifications">üîî</button>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn" type="button">üë§ Account</button>
          <div id="profileMenu" style="position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:220px; z-index:300; padding:6px">
            <button class="btn ghost" id="menuProfile" type="button">üë§ Profile</button>
            <button class="btn ghost" id="menuOrders" type="button">üì¶ Manage Orders</button>
            <button class="btn ghost" id="menuWallet" type="button">üí∞ Wallet</button>
            <button class="btn ghost" id="menuTopup" type="button">‚ö° Digital Services</button>
            <button class="btn ghost" id="menuSupport" type="button">üÜò Contact Support</button>
            <button class="btn ghost" id="menuLogout" type="button">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Home -->
  <main id="page-home" class="page active">
    <!-- Location under header -->
    <section class="section">
      <div class="small">üìç <span id="userLocUnder">Detecting location‚Ä¶</span></div>
    </section>

    <!-- Live map with simulated vehicles -->
    <section class="section">
      <div id="homeMap" style="height:180px;border-radius:12px;border:1px solid var(--border)"></div>
    </section>

    <!-- Global Search -->
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency‚Ä¶"/>
        <button class="btn ghost" id="voiceBtn" type="button">üé§</button>
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </section>

    <!-- All Services -->
    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>

    <!-- Emergency -->
    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>
  </main>

  <!-- Marketplace -->
  <main id="page-marketplace" class="page">
    <section class="section">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="title" style="margin:0">Marketplace</div>
        <button class="btn ghost" id="sellProductsBtn" type="button">Sell Products</button>
      </div>
      <div class="search">
        <div class="box">
          <input id="mpSearch" placeholder="Search products‚Ä¶"/>
          <button class="btn ghost" id="mpVoice" type="button">üé§</button>
          <button class="btn primary" id="mpSearchBtn" type="button">Search</button>
        </div>
      </div>
      <div class="row" id="mpChips" style="gap:6px;margin:8px 0"></div>
      <div class="grid" id="mpGrid"></div>
    </section>
  </main>

  <!-- Profile -->
  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row">
            <div id="user-avatar" style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">üë§</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Guest</strong> <span class="small muted">(Public name)</span></div>
              <div class="small" id="profEmail">guest@example.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><strong>Availability</strong><div class="small muted">Go Offline / Available</div></div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="availToggle" type="checkbox" style="display:none"/>
            <span id="availTrack" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px"></span>
            <span id="availKnob" style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s"></span>
          </label>
        </div>
      </div>

      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn" type="button">Manage Product (Food Vendors Only)</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
      </div>
    </section>
  </main>

  <!-- Orders -->
  <main id="page-orders" class="page">
    <section class="section">
      <div class="title">My Bookings</div>
      <div id="bookingsList" class="list"></div>
      <div class="title" style="margin-top:12px">Orders</div>
      <div class="card">
        <div class="list">
          <div class="small muted">Buyer view</div>
          <div id="buyerOrders" class="list"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="list">
          <div class="small muted">Seller view</div>
          <div id="sellerOrders" class="list"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Wallet -->
  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong id="walletBalance">$0.00</strong></div>
      <div class="row" style="gap:8px;margin-top:8px">
        <button class="btn ghost" id="walletAdd" type="button">Add Funds (Coming soon)</button>
        <button class="btn ghost" id="walletCashOut" type="button">Cash Out (Coming soon)</button>
        <button class="btn ghost" id="walletSend" type="button">Send to user</button>
        <button class="btn ghost" id="walletCards" type="button">Saved cards</button>
      </div>
      <div class="title" style="margin-top:12px">Transactions</div>
      <div id="walletTx" class="grid"></div>
    </section>
  </main>

  <!-- Digital Services -->
  <main id="page-digital" class="page">
    <section class="section">
      <div class="title">Digital Services</div>
      <div class="grid" style="margin-top:8px">
        <div class="card service">üì± Buy Airtime</div>
        <div class="card service">üì∂ Buy Data</div>
        <div class="card service">üßæ Pay Bills</div>
        <div class="card service">üõí Digital Products</div>
      </div>
      <div class="small muted" style="margin-top:8px">Coming soon</div>
    </section>
  </main>

  <!-- Manage Services -->
  <main id="page-manage-services" class="page">
    <section class="section">
      <div class="title">Manage Services</div>
      <div class="card">
        <div class="list">
          <div class="grid-2">
            <div class="field">
              <label class="small">Category</label>
              <select id="msCategory">
                <option value="transport">Transport</option>
                <option value="food">Food</option>
                <option value="tech">Tech Services</option>
                <option value="home">Home Services</option>
                <option value="construction">Construction</option>
                <option value="auto">Automobile Repair</option>
                <option value="others">Others</option>
              </select>
            </div>
            <div class="field" id="msTransportTypeWrap" style="display:none">
              <label class="small">Transport type</label>
              <select id="msTransportType">
                <option value="ride">Ride / Taxi</option>
                <option value="moving">Truck / Backie</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label class="small">Service type</label>
            <input id="msType" placeholder="e.g., Driver, Plumber"/>
          </div>
          <div class="field">
            <label class="small">Details</label>
            <textarea id="msDetails" rows="3" placeholder="Describe your service‚Ä¶"></textarea>
          </div>
          <div class="grid-2">
            <div class="field">
              <label class="small">Price (per 1‚Äì2hr)</label>
              <input id="msPrice" type="number" min="0" step="0.01" placeholder="e.g., 50"/>
            </div>
            <div class="field">
              <label class="small">Catalog images (up to 4)</label>
              <input id="msImages" type="file" accept="image/*" multiple/>
              <div class="hint">Optional</div>
            </div>
          </div>
          <button class="btn primary" id="msAdd" type="button">+ Add Service</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="msList"></div>
    </section>
  </main>

  <!-- Manage Products (Food vendors) -->
  <main id="page-manage-products" class="page">
    <section class="section">
      <div class="title">Manage Product (Food Vendors Only)</div>
      <div class="card">
        <div class="small muted" style="margin-bottom:8px">Upload multiple items per batch; up to 5 images per item; set payment options.</div>
        <div id="foodItemsForm"></div>
        <button class="btn ghost" id="addFoodRow" type="button">+ Add another item</button>
        <button class="btn primary" id="saveFoodItems" type="button" style="margin-top:10px">Save items</button>
      </div>
      <div class="list" id="foodItemsList" style="margin-top:12px"></div>
    </section>
  </main>

  <!-- Emergency Contacts -->
  <main id="page-emergency-contacts" class="page">
    <section class="section">
      <div class="title">Emergency Contacts</div>
      <div class="card">
        <div class="small muted">Add up to 5 contacts (name and phone).</div>
        <div id="ecForm" class="list" style="margin-top:10px"></div>
        <button class="btn primary" id="ecSave" type="button">Save Contacts</button>
      </div>
    </section>
  </main>

  <!-- Verify Provider -->
  <main id="page-verify-provider" class="page">
    <section class="section">
      <div class="title">Become Verified Provider</div>
      <div class="card">
        <div class="list">
          <div class="field"><label class="small">Full name</label><input id="vpName" placeholder="Your name"/></div>
          <div class="field"><label class="small">Address</label><input id="vpAddress" placeholder="Street, City"/></div>
          <div class="field"><label class="small">Service category</label><input id="vpCategory" placeholder="e.g., Driver, Plumber"/></div>
          <div class="field"><label class="small">ID number</label><input id="vpId" placeholder="Your ID"/></div>
          <div class="field"><label class="small">ID/Passport docs</label><input id="vpIdDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <div class="field"><label class="small">Business/License docs</label><input id="vpBizDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="vpBack" type="button">Back</button>
            <button class="btn primary" id="vpSubmit" type="button">Submit</button>
          </div>
          <div id="vpStatus" class="small" style="color:#2563EB"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button data-page="home" class="active" type="button">üè† Home</button>
    <button data-page="orders" type="button">üìã My Bookings</button>
    <button data-page="marketplace" type="button">üõçÔ∏è Marketplace</button>
    <button data-page="profile" type="button">üë§ Profile</button>
  </nav>

  <!-- Providers Modal (with search/mic toggle) -->
  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" id="provSearchRow" style="gap:8px;margin-bottom:10px;display:none">
          <input id="provSearch" placeholder="Search providers or specialties‚Ä¶" style="flex:1"/>
          <button class="btn ghost" id="provVoice" type="button">üé§</button>
          <button class="btn primary" id="provSearchBtn" type="button">Search</button>
        </div>
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <!-- Transport Options -->
  <div class="modal" id="transportOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong>Transport Options</strong>
        <button class="btn ghost" id="transportOptionsClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="grid">
          <div class="card service" data-transport="ride">üöó Ride / Taxi</div>
          <div class="card service" data-transport="moving">üöö Truck / Backie</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking" type="button">‚úñ</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="grid-2">
            <div class="field"><label class="small">Date</label><input id="bkDate" type="date" required/></div>
            <div class="field"><label class="small">Time</label><input id="bkTime" type="time" required/></div>
          </div>
          <div class="field">
            <label class="small">Address</label>
            <div class="row" style="gap:8px">
              <input id="bkAddress" required placeholder="Enter address" style="flex:1"/>
              <button class="btn ghost" id="bkUseCurrent" type="button">üìç Use current</button>
            </div>
          </div>
          <div class="field"><label class="small">Details</label><textarea id="bkDesc" rows="3" placeholder="Describe the job‚Ä¶"></textarea></div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Instant Request / Tracking -->
  <div class="modal" id="instantModal">
    <div class="sheet">
      <div class="head">
        <strong id="instantTitle">Contacting provider‚Ä¶</strong>
        <button class="btn ghost" id="cancelInstant" type="button">Cancel</button>
      </div>
      <div class="body">
        <div class="card">
          <div>Time left: <strong id="countdown">90</strong>s</div>
          <div class="small muted" id="instantHint">Waiting for provider to accept‚Ä¶</div>
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="findOthers" type="button">Find other providers</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong>Live Tracking</strong>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="trackCancelBtn" type="button">Cancel</button>
          <button class="btn ghost" id="closeTrack" type="button">‚úñ</button>
        </div>
      </div>
      <div class="body">
        <div id="trackStatus" class="small muted">Provider accepted. En route‚Ä¶</div>
        <div id="trackMapWrap" style="margin-top:10px"><div id="track-map" style="width:100%;height:360px;border-radius:12px;border:1px solid var(--border)"></div></div>
      </div>
    </div>
  </div>

  <!-- Others category search -->
  <div class="modal" id="othersModal">
    <div class="sheet">
      <div class="head"><strong>Others</strong><button class="btn ghost" id="othersClose" type="button">‚úñ</button></div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="othersSearch" placeholder="Search providers or tasks‚Ä¶" style="flex:1"/>
          <button class="btn ghost" id="othersVoice" type="button">üé§</button>
          <button class="btn primary" id="othersGo" type="button">Search</button>
        </div>
        <div id="othersList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Food Options -->
  <div class="modal" id="foodOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong>Food</strong>
        <button class="btn ghost" id="closeFoodOptions" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="search">
          <div class="box">
            <input id="foodSearch" placeholder="Search vendors or food‚Ä¶"/>
            <button class="btn primary" id="foodSearchBtn" type="button">Search</button>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn primary" id="foodFastBtn" type="button">üçî Fast food</button>
          <button class="btn ghost" id="foodGroceryBtn" type="button">üõí Groceries</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Food Vendors -->
  <div class="modal" id="foodVendorsModal">
    <div class="sheet">
      <div class="head">
        <strong id="foodVendorsTitle">Food Vendors</strong>
        <button class="btn ghost" id="closeFoodVendors" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="fvSearch" placeholder="Search vendors or menu items‚Ä¶" style="flex:1"/>
          <button class="btn ghost" id="fvVoice" type="button">üé§</button>
          <button class="btn primary" id="fvSearchBtn" type="button">Search</button>
        </div>
        <div id="foodVendorsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Food Menu -->
  <div class="modal" id="foodMenuModal">
    <div class="sheet">
      <div class="head">
        <strong id="foodMenuTitle">Menu</strong>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="foodMenuBack" type="button">‚Üê Back</button>
          <button class="btn ghost" id="closeFoodMenu" type="button">‚úñ</button>
        </div>
      </div>
      <div class="body">
        <div id="foodMenuList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="foodCartTotal">0.00</span></div>
          <div class="row" style="gap:6px">
            <button class="btn ghost" id="clearCartBtn" type="button">Clear Cart</button>
            <button class="btn primary" id="foodCheckoutBtn" type="button">Checkout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart -->
  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head">
        <strong>My Cart</strong>
        <button class="btn ghost" id="closeCart" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="cartList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <button class="btn ghost" id="cartClear" type="button">Clear Cart</button>
          <div class="row" style="gap:8px;align-items:center">
            <div class="price">Total: $<span id="cartTotal">0.00</span></div>
            <button class="btn primary" id="checkoutBtn" type="button">Checkout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout -->
  <div class="modal" id="checkoutModal">
    <div class="sheet">
      <div class="head">
        <strong>Checkout</strong>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="chkBack" type="button">‚Üê Back</button>
          <button class="btn ghost" id="closeCheckout" type="button">‚úñ</button>
        </div>
      </div>
      <div class="body">
        <div class="list" id="chkFormList">
          <div class="grid-2">
            <div class="field"><label class="small">Full Name</label><input id="chkName"/></div>
            <div class="field"><label class="small">Phone</label><input id="chkPhone"/></div>
          </div>
          <div class="grid-2">
            <div class="field"><label class="small">Street / Address</label><input id="chkAddress"/></div>
            <div class="field"><label class="small">Flat / House No.</label><input id="chkUnit"/></div>
          </div>
          <div class="field"><label class="small">Delivery Notes</label><textarea id="chkNotes" rows="3"></textarea></div>
          <div class="field">
            <label class="small">Payment Method</label>
            <div class="controls">
              <label><input type="radio" name="payMethod" value="card" checked/> Card</label>
              <label><input type="radio" name="payMethod" value="cash"/> Cash</label>
            </div>
            <div class="small muted" id="vendorPayHint"></div>
          </div>
          <label class="row" style="align-items:flex-start;gap:8px"><input type="checkbox" id="chkTerms"/> <span>I accept the Terms.</span></label>
          <div id="chkItemsList" class="list"></div>
          <button class="btn primary" id="placeOrderBtn" type="button">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Status -->
  <div class="modal" id="orderModal">
    <div class="sheet">
      <div class="head">
        <strong>Order Status</strong>
        <button class="btn ghost" id="closeOrder" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="orderInfo" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Roadside -->
  <div class="modal" id="roadsideModal">
    <div class="sheet">
      <div class="head">
        <strong>Roadside Assistance</strong>
        <button class="btn ghost" id="roadClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="roadSearch" placeholder="Search roadside help (tyres, battery, tow)..." style="flex:1"/>
          <button class="btn ghost" id="roadVoice" type="button">üé§</button>
          <button class="btn primary" id="roadGo" type="button">Search</button>
        </div>
        <div id="roadList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notifModal" class="modal">
    <div class="sheet">
      <div class="head">
        <strong>Notifications</strong>
        <button class="btn ghost" id="closeNotif" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="notifList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Sell Product (Marketplace) -->
  <div class="modal" id="sellModal">
    <div class="sheet">
      <div class="head"><strong>Sell a product</strong><div class="row" style="gap:6px"><button class="btn ghost" id="sellBack" type="button">‚Üê Back</button><button class="btn ghost" id="sellClose" type="button">‚úñ</button></div></div>
      <div class="body">
        <div class="grid-2">
          <div class="field"><label class="small">Category</label>
            <select id="sellCat">
              <option value="electronics">Electronics</option>
              <option value="fashion">Fashion</option>
              <option value="home">Home & Garden</option>
              <option value="sports">Sports</option>
              <option value="automobile">Automobile</option>
              <option value="spares">Spare Parts</option>
              <option value="others">Others</option>
            </select>
          </div>
          <div class="field"><label class="small">Type</label><input id="sellType" placeholder="e.g., Phone"/></div>
        </div>
        <div class="grid-2">
          <div class="field"><label class="small">Title</label><input id="sellTitle"/></div>
          <div class="field"><label class="small">Price</label><input id="sellPrice" type="number" min="0" step="0.01"/></div>
        </div>
        <div class="grid-2">
          <div class="field"><label class="small">Stock</label><input id="sellStock" type="number" min="0"/></div>
          <div class="field"><label class="small">Images (up to 10)</label><input id="sellImages" type="file" accept="image/*" multiple/></div>
        </div>
        <div class="field"><label class="small">Description</label><textarea id="sellDesc" rows="3"></textarea></div>
        <button class="btn primary" id="sellSubmit" type="button">Submit</button>
      </div>
    </div>
  </div>

  <!-- Panic Modal -->
  <div class="modal" id="panicModal">
    <div class="sheet">
      <div class="head">
        <strong>Emergency Alert</strong>
        <button class="btn ghost" id="panicClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="small muted">We'll notify your contacts and nearby security with your location.</div>
          <div class="field">
            <label class="small">Message (optional)</label>
            <textarea id="panicMsg" rows="3" placeholder="Describe the emergency‚Ä¶"></textarea>
          </div>
          <div class="small muted">Location: <span id="panicLocHint">Fetching‚Ä¶</span></div>
          <div class="row" style="gap:8px; justify-content:flex-end; margin-top:8px">
            <button class="btn ghost" id="panicCancel" type="button">Back</button>
            <button class="btn primary" id="panicSend" type="button">Send Alert</button>
          </div>
          <div id="panicStatus" class="small muted" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Panic -->
  <button class="floating-panic" id="panicBtn" type="button">üö®</button>

  <!-- Splash -->
  <div id="splash" style="position:fixed;inset:0;background:linear-gradient(135deg,#2563EB 0%,#1D4ED8 100%);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff">
    <div style="font-size:28px;font-weight:800;margin-top:12px">ZippUp</div>
    <div style="opacity:.9;margin-top:4px">On‚Äëdemand services, fast.</div>
  </div>

  <script>
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyApgmcfu5qGFn9tw872dQ2KkdDz_GPmL70",
      authDomain: "zippup-535ca.firebaseapp.com",
      projectId: "zippup-535ca",
      appId: "1:382212325227:web:c04d91386817c7cff7d62e",
      messagingSenderId: "382212325227",
      measurementId: "G-YKJEVL8M6V"
    };
    if (!window.firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // State
    let user = { name:'Guest', email:'guest@example.com', wallet: 0 };
    let coords = null, homeMap=null, vehicleMarkers=[];
    let requestId=null, instantTimer=null, instantLeft=90, trackPoll=null, providerMarker=null, userMarker=null, trackMap=null;

    let cart = loadCart();
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('food_cart')||'{"vendorId":null,"vendorName":null,"vendorPayment":[],"items":[]}'); }catch{ return { vendorId:null, vendorName:null, vendorPayment:[], items:[] } } }
    function saveCart(){ localStorage.setItem('food_cart', JSON.stringify(cart)); }
    function resetCart(){ cart={ vendorId:null, vendorName:null, vendorPayment:[], items:[] }; saveCart(); }

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function money(n){ return `$${(+n||0).toFixed(2)}`; }

    // Nav
    $$('.nav button').forEach(b=>{
      b.onclick = ()=>{
        $$('.nav button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const page=b.getAttribute('data-page');
        $$('.page').forEach(p=>p.classList.remove('active'));
        $('#page-'+page).classList.add('active');
        if (page==='marketplace') { renderMarketplace(); }
        if (page==='orders') { renderBookings(); renderOrders(); }
        if (page==='wallet') { openWallet(); }
      };
    });

    // Header menu
    $('#profileBtn').onclick = (e)=>{ e.stopPropagation(); const m=$('#profileMenu'); m.style.display = (m.style.display==='block'?'none':'block'); };
    document.addEventListener('click', ()=>{ const m=$('#profileMenu'); if (m) m.style.display='none'; });
    $('#menuProfile').onclick = ()=>{ $('#profileMenu').style.display='none'; $('.nav [data-page="profile"]').click(); };
    $('#menuOrders').onclick  = ()=>{ $('#profileMenu').style.display='none'; $('.nav [data-page="orders"]').click(); };
    $('#menuWallet').onclick  = ()=>{ $('#profileMenu').style.display='none'; $('.nav [data-page="wallet"]')?.click(); };
    $('#menuTopup').onclick   = ()=>{ $('#profileMenu').style.display='none'; $('.nav [data-page="digital"]')?.click(); };
    $('#menuSupport').onclick = ()=>{ $('#profileMenu').style.display='none'; alert('Support: email support@zippup.app'); };
    $('#menuLogout').onclick  = async ()=>{ $('#profileMenu').style.display='none'; try{ await auth.signOut(); alert('Signed out'); }catch{} };

    // Services & Emergency
    const SERVICES = [
      { id:'transport', name:'Transport', icon:'üöó', desc:'Ride & moving' },
      { id:'food',      name:'Food',      icon:'üçî', desc:'Restaurants & groceries' },
      { id:'tech',      name:'Tech',      icon:'üîß', desc:'Phone/computer repair' },
      { id:'home',      name:'Home',      icon:'üè†', desc:'Cleaning & maintenance' },
      { id:'construction', name:'Construction', icon:'üèóÔ∏è', desc:'Builders & electricians' },
      { id:'auto',      name:'Automobile', icon:'üõ†Ô∏è', desc:'Mechanics, tires, roadside' },
      { id:'digital',   name:'Digital Services', icon:'üí≥', desc:'Airtime, data, bills, digital products' },
      { id:'marketplace', name:'Marketplace', icon:'üõçÔ∏è', desc:'Buy & Sell (contact only)' },
      { id:'others',    name:'Others',    icon:'üéØ', desc:'Events, tutors, more' },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance', icon:'üöë' },
      { id:'fire',      name:'Fire Service', icon:'üöí' },
      { id:'towing',    name:'Towing', icon:'üöõ' },
      { id:'security',  name:'Security', icon:'üõ°Ô∏è' },
      { id:'roadside',  name:'Roadside', icon:'üîß' },
    ];

    function renderServices(){
      const grid = $('#servicesGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderEmergency(){
      const grid = $('#emergencyGrid'); grid.innerHTML='';
      EMERGENCY.forEach(e=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div>`;
        el.onclick = ()=> openEmergency(e.id, e.name);
        grid.appendChild(el);
      });
    }

    // Open Category
    function openCategory(catId, label){
      if (catId==='digital'){ $('.nav [data-page="digital"]').click(); return; }
      if (catId==='marketplace'){ $('.nav [data-page="marketplace"]').click(); return; }
      if (catId==='food'){ $('#foodOptionsModal').classList.add('open'); return; }
      if (catId==='others'){ openOthers(); return; }
      if (catId==='transport'){ $('#transportOptionsModal').classList.add('open'); return; }

      // For home/tech/construction/auto: show providers with search row
      $('#provSearchRow').style.display = ['home','tech','construction','auto'].includes(catId) ? '' : 'none';
      $('#providersTitle').textContent = label + ' ‚Äî Providers';
      renderProviders(dummyProviders(catId));
      $('#providersModal').classList.add('open');
    }

    // Transport Options handlers
    $('#transportOptionsClose').onclick = ()=> $('#transportOptionsModal').classList.remove('open');
    $('#transportOptionsModal').addEventListener('click',(e)=>{
      const card = e.target.closest('[data-transport]'); if (!card) return;
      const sub = card.getAttribute('data-transport'); $('#transportOptionsModal').classList.remove('open');
      $('#providersTitle').textContent = (sub==='ride'?'Ride / Taxi':'Truck / Backie') + ' ‚Äî Drivers nearby';
      renderProviders(nearbyDrivers(sub));
      $('#provSearchRow').style.display=''; // enable search in providers
      $('#providersModal').classList.add('open');
    });
    function nearbyDrivers(sub){
      return [
        { id:'d1', publicName:'Sam K.', jobTitle:(sub==='ride'?'Taxi':'Truck'), verified:true, rating:4.9, distance:'0.6km', eta:'5-7m', fee:'$6-9', available:true, icon:'üöó' },
        { id:'d2', publicName:'Lara B.', jobTitle:(sub==='ride'?'Taxi':'Truck'), verified:true, rating:4.7, distance:'1.1km', eta:'7-10m', fee:'$7-10', available:true, icon:'üöó' }
      ];
    }

    // Providers render with Instant/Schedule
    function renderProviders(list){
      const box=$('#providersList'); box.innerHTML='';
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row" style="align-items:center">
              <div class="avatar">${p.icon||'üë§'}</div>
              <div>
                <div><strong>${p.publicName||'Provider'}</strong> ${p.verified? '‚úîÔ∏è':''}</div>
                <div class="small muted">${p.distance||'‚Äî'} ‚Ä¢ ETA ${p.eta||'‚Äî'} ‚Ä¢ ${p.jobTitle||''}</div>
                <div class="small"><strong>Est.:</strong> ${p.fee||'‚Äî'}</div>
              </div>
            </div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="row" style="gap:8px; margin-top:6px">
            <button class="btn primary" data-k="instant" type="button">Instant</button>
            <button class="btn ghost" data-k="schedule" type="button">Schedule</button>
          </div>`;
        el.querySelector('[data-k="instant"]').onclick = ()=> startInstant(p);
        el.querySelector('[data-k="schedule"]').onclick = ()=> { $('#providersModal').classList.remove('open'); $('#bookingModal').classList.add('open'); };
        box.appendChild(el);
      });
    }
    $('#closeProviders').onclick = ()=> $('#providersModal').classList.remove('open');

    // Emergency lists (functional)
    async function openEmergency(id,label){
      $('#providersTitle').textContent = label + ' ‚Äî Nearby';
      renderProviders([
        { publicName:`${label} Team A`, jobTitle:label, verified:true, rating:4.8, distance:'0.8km', eta:'6m', fee:'‚Äî', available:true, icon:'üöë' },
        { publicName:`${label} Team B`, jobTitle:label, verified:true, rating:4.6, distance:'1.3km', eta:'9m', fee:'‚Äî', available:true, icon:'üöë' }
      ]);
      $('#provSearchRow').style.display=''; $('#providersModal').classList.add('open');
    }

    // Instant flow (Bolt-like)
    function startInstant(provider){
      requestId = 'rq-'+Date.now();
      instantLeft = 90; $('#countdown').textContent=String(instantLeft);
      $('#instantHint').textContent='Waiting for provider to accept‚Ä¶';
      $('#providersModal').classList.remove('open');
      $('#instantModal').classList.add('open');
      playTone(660, 150); // notify provider sound (demo)

      if (instantTimer) clearInterval(instantTimer);
      instantTimer = setInterval(async ()=>{
        instantLeft--; $('#countdown').textContent=String(instantLeft);
        if (instantLeft===86){ // accept
          $('#instantModal').classList.remove('open');
          $('#trackModal').classList.add('open'); setTimeout(initTrackMap,50);
          $('#trackStatus').textContent='Provider accepted. En route‚Ä¶';
          playTone(880, 200); // user accept sound
        }
        if (instantLeft<=0){ clearInterval(instantTimer); $('#instantModal').classList.remove('open'); alert('No response. Try others.'); }
      }, 1000);
    }
    $('#cancelInstant').onclick = ()=> { clearInterval(instantTimer); $('#instantModal').classList.remove('open'); };
    $('#findOthers').onclick = ()=> { $('#instantModal').classList.remove('open'); $('#providersModal').classList.add('open'); };

    function initTrackMap(){
      try{
        trackMap = L.map('track-map',{ zoomControl:true }).setView([coords?.lat||0, coords?.lng||0], coords?15:2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM' }).addTo(trackMap);
        if (coords) userMarker = L.marker([coords.lat, coords.lng],{title:'You'}).addTo(trackMap);
        let prov = coords ? [coords.lat+(Math.random()-0.5)/500, coords.lng+(Math.random()-0.5)/500] : [0.001,0.001];
        providerMarker = L.marker(prov,{title:'Driver'}).addTo(trackMap);
        let t=0;
        trackPoll = setInterval(()=>{
          t+=1;
          const p = providerMarker.getLatLng();
          const nx = L.latLng(p.lat + (coords? (coords.lat-p.lat)/40 : 0), p.lng + (coords? (coords.lng-p.lng)/40 : 0));
          providerMarker.setLatLng(nx);
          $('#trackStatus').textContent = `Provider en route ‚Ä¢ ETA ${Math.max(1,Math.ceil((40-t)/3))} min`;
          if (coords && nx.distanceTo(userMarker.getLatLng())<20){
            clearInterval(trackPoll);
            $('#trackStatus').textContent='Driver arrived';
            playTone(520, 250); // arrival sound
          }
        }, 1000);
      }catch{}
    }
    $('#trackCancelBtn').onclick = ()=> { if (trackPoll) clearInterval(trackPoll); $('#trackModal').classList.remove('open'); };
    $('#closeTrack').onclick = ()=> { if (trackPoll) clearInterval(trackPoll); $('#trackModal').classList.remove('open'); };

    // Booking Form
    $('#closeBooking').onclick = ()=> $('#bookingModal').classList.remove('open');
    $('#bkUseCurrent').onclick = async ()=>{
      try {
        if (!coords) await initLocation();
        if (coords) { const nm = await reverseGeocode(coords.lat, coords.lng); $('#bkAddress').value = nm || ''; }
      } catch {}
    };
    $('#bookingForm').onsubmit = (e)=>{ e.preventDefault(); $('#bookingModal').classList.remove('open'); alert('Booking requested'); };

    // Others category search
    function openOthers(){ renderOthers(''); $('#othersModal').classList.add('open'); }
    function renderOthers(q){
      const all = [
        { name:'Event Planner' }, { name:'Tutor (Math)' }, { name:'Photographer' },
        { name:'Laundry Pickup' }, { name:'Errands Runner' }
      ];
      const f=(q||'').toLowerCase();
      $('#othersList').innerHTML = all.filter(x=>x.name.toLowerCase().includes(f)).map(x=>`
        <div class="card"><div class="row" style="justify-content:space-between">
          <div><strong>${x.name}</strong></div>
          <button class="btn primary" type="button" onclick="alert('Request sent')">Request</button>
        </div></div>`).join('') || '<div class="small muted">No matches</div>';
    }
    $('#othersClose').onclick = ()=> $('#othersModal').classList.remove('open');
    $('#othersGo').onclick = ()=> renderOthers($('#othersSearch').value.trim());
    $('#othersVoice').onclick = ()=> voiceToInput($('#othersSearch'), ()=> $('#othersGo').click());

    // Food
    const VENDORS = [
      { id:'v1', name:'Burger Place', kind:'fastfood', payment:['card','cash'] },
      { id:'v2', name:'Pizza Town',   kind:'fastfood', payment:['card'] },
      { id:'v3', name:'Green Grocer', kind:'grocery',  payment:['cash'] }
    ];
    const MENUS = {
      v1: [ { id:'m1', title:'Cheeseburger', price:8.5, img:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=800&auto=format&fit=crop' },
            { id:'m2', title:'Fries', price:3.0, img:'https://images.unsplash.com/photo-1541592106381-b31e9677c0e5?q=80&w=800&auto=format&fit=crop' } ],
      v2: [ { id:'m4', title:'Pepperoni Pizza', price:12.0, img:'https://images.unsplash.com/photo-1548365328-9f547fb09530?q=80&w=800&auto=format&fit=crop' } ],
      v3: [ { id:'m6', title:'Bananas (1kg)', price:2.5, img:'https://images.unsplash.com/photo-1571772805064-2073979f0d4a?q=80&w=800&auto=format&fit=crop' } ]
    };
    $('#closeFoodOptions').onclick = ()=> $('#foodOptionsModal').classList.remove('open');
    $('#foodFastBtn').onclick = ()=> { $('#foodOptionsModal').classList.remove('open'); openFoodVendors('fastfood'); };
    $('#foodGroceryBtn').onclick = ()=> { $('#foodOptionsModal').classList.remove('open'); openFoodVendors('grocery'); };
    $('#foodSearchBtn').onclick = ()=> { const q=($('#foodSearch').value||'').toLowerCase(); $('#foodOptionsModal').classList.remove('open'); openFoodVendorsSearch(q); };

    function openFoodVendors(kind){ renderVendorsList(VENDORS.filter(v=>v.kind===kind)); }
    function openFoodVendorsSearch(q){
      const vendorIds = Object.keys(MENUS).filter(vid => (MENUS[vid]||[]).some(m=>m.title.toLowerCase().includes(q)));
      const list = VENDORS.filter(v=> v.name.toLowerCase().includes(q) || vendorIds.includes(v.id));
      renderVendorsList(list);
    }
    function renderVendorsList(list){
      const box=$('#foodVendorsList'); box.innerHTML='';
      list.forEach(v=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>${v.name}</strong></div><div class="small muted">${v.kind==='fastfood'?'Fast food':'Grocery'} ‚Ä¢ Payments: ${v.payment.join(', ')}</div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="menu">View Menu</button></div>
        </div>`;
        el.querySelector('[data-k="menu"]').onclick = ()=> openFoodMenu(v);
        box.appendChild(el);
      });
      $('#foodVendorsTitle').textContent='Food Vendors';
      $('#foodVendorsModal').classList.add('open');
    }
    $('#closeFoodVendors').onclick = ()=> $('#foodVendorsModal').classList.remove('open');

    function openFoodMenu(vendor){
      if (cart.vendorId && cart.vendorId !== vendor.id) {
        if (!confirm(`Your cart has items from ${cart.vendorName}. Clear cart to order from ${vendor.name}?`)) return;
        resetCart();
      }
      if (!cart.vendorId){ cart.vendorId=vendor.id; cart.vendorName=vendor.name; cart.vendorPayment=vendor.payment.slice(); saveCart(); }
      $('#foodVendorsModal').classList.remove('open');
      $('#foodMenuTitle').textContent = `${vendor.name} ‚Äî Menu`;
      const list=$('#foodMenuList'); list.innerHTML='';
      (MENUS[vendor.id]||[]).forEach(m=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${m.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${m.title}</strong><div class="small muted">${money(m.price)}</div></div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="add">Ôºã Add</button></div>
        </div>`;
        row.querySelector('[data-k="add"]').onclick = ()=>{
          const i=cart.items.findIndex(x=>x.id===m.id);
          if (i>=0) cart.items[i].qty+=1; else cart.items.push({ id:m.id, title:m.title, price:m.price, img:m.img, qty:1 });
          saveCart(); syncFoodTotals(); updateBellBadge();
        };
        list.appendChild(row);
      });
      syncFoodTotals();
      $('#foodMenuModal').classList.add('open');
    }
    $('#foodMenuBack').onclick = ()=> { $('#foodMenuModal').classList.remove('open'); $('#foodVendorsModal').classList.add('open'); };
    $('#closeFoodMenu').onclick = ()=> $('#foodMenuModal').classList.remove('open');
    function syncFoodTotals(){
      const total=cart.items.reduce((a,b)=>a+b.price*b.qty,0);
      $('#foodCartTotal').textContent=total.toFixed(2);
    }
    $('#foodCheckoutBtn').onclick = ()=>{ renderCart(); $('#cartModal').classList.add('open'); };
    $('#clearCartBtn').onclick = ()=>{ resetCart(); syncFoodTotals(); };

    // Cart
    $('#closeCart').onclick = ()=> $('#cartModal').classList.remove('open');
    $('#cartClear').onclick = ()=>{ resetCart(); renderCart(); updateBellBadge(); };
    $('#checkoutBtn').onclick = ()=> openCheckout();
    function renderCart(){
      const list=$('#cartList'); const totalEl=$('#cartTotal'); list.innerHTML='';
      if(!cart.items.length){ list.innerHTML='<div class="small muted">Your cart is empty.</div>'; totalEl.textContent='0.00'; return; }
      let total=0;
      cart.items.forEach(item=>{
        total+=item.price*item.qty;
        const row=document.createElement('div'); row.className='card'; row.dataset.id=item.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between; align-items:flex-start">
          <div class="row"><img src="${item.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${item.title}</strong><div class="small muted">${money(item.price)}</div><div class="small muted">Vendor: ${cart.vendorName||'-'}</div></div></div>
          <div class="row" style="gap:6px; align-items:center">
            <button class="btn ghost" data-k="dec" type="button">‚àí</button>
            <div>${item.qty}</div>
            <button class="btn ghost" data-k="inc" type="button">Ôºã</button>
            <button class="btn ghost" data-k="rm"  type="button">‚úñ</button>
          </div>
        </div>`;
        list.appendChild(row);
      });
      totalEl.textContent=total.toFixed(2);

      list.onclick = (e)=>{
        const btn=e.target.closest('[data-k]'); if(!btn) return;
        const id=btn.closest('.card')?.dataset?.id; const k=btn.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if (i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); } else saveCart();
        renderCart(); updateBellBadge();
      };
    }

    // Checkout
    function openCheckout(){
      if (!cart.items.length) { alert('Your cart is empty.'); return; }
      const wrap=$('#chkItemsList'); wrap.innerHTML='';
      cart.items.forEach(it=>{
        const row=document.createElement('div'); row.className='card'; row.dataset.id=it.id;
        row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${it.img||''}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${it.title}</strong><div class="small muted">${money(it.price)}</div></div></div>
          <div class="row"><button class="btn ghost" data-k="dec">‚àí</button><div>${it.qty}</div><button class="btn ghost" data-k="inc">Ôºã</button><button class="btn ghost" data-k="rm">‚úñ</button></div>
        </div>`;
        wrap.appendChild(row);
      });
      wrap.onclick=(e)=>{
        const b=e.target.closest('[data-k]'); if(!b) return;
        const id=b.closest('.card')?.dataset?.id; const k=b.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if(i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); $('#checkoutModal').classList.remove('open'); return; }
        saveCart(); openCheckout();
      };
      $('#vendorPayHint').textContent = `Vendor accepts: ${cart.vendorPayment.join(', ') || '‚Äî'}`;
      $('#checkoutModal').classList.add('open');
    }
    $('#chkBack').onclick = ()=> { $('#checkoutModal').classList.remove('open'); $('#cartModal').classList.add('open'); };
    $('#closeCheckout').onclick = ()=> $('#checkoutModal').classList.remove('open');

    $('#placeOrderBtn').onclick = ()=>{
      if (!$('#chkTerms').checked) return alert('Please accept the Terms');
      if (!cart.items.length) return alert('Cart is empty');
      const orderId='ord-'+Date.now(), code=String(Math.floor(100000+Math.random()*900000));
      $('#checkoutModal').classList.remove('open');
      $('#orderInfo').innerHTML = `<div class="card">
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div style="margin-top:6px"><strong>Status:</strong> <span>pending</span></div>
        <div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div>
        <div class="small muted" style="margin-top:6px">Please don't share this code with the seller until your goods are delivered and confirmed.</div>
      </div>`;
      $('#orderModal').classList.add('open');
      resetCart(); updateBellBadge();
    };
    $('#closeOrder').onclick = ()=> $('#orderModal').classList.remove('open');

    // Marketplace
    const MP_CATEGORIES = [
      { id:'electronics', name:'Electronics' },
      { id:'fashion',     name:'Fashion' },
      { id:'home',        name:'Home & Garden' },
      { id:'sports',      name:'Sports' },
      { id:'automobile',  name:'Automobile' },
      { id:'spares',      name:'Spare Parts' },
      { id:'others',      name:'Others' },
    ];
    let MP_PRODUCTS = [
      { id:'p100', title:'Smartphone X', cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop', seller:'Tony' },
      { id:'p200', title:'Running Shoes', cat:'sports', price:79,  stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop', seller:'Kelvin' },
    ];
    function getUserProducts(){ try { return JSON.parse(localStorage.getItem('zup_user_products')||'[]'); } catch { return []; } }
    function setUserProducts(arr){ localStorage.setItem('zup_user_products', JSON.stringify(arr||[])); }
    function renderMarketplace(category=null, query=''){
      const chips=$('#mpChips'); if (!chips.innerHTML) MP_CATEGORIES.forEach(c=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=c.name; b.onclick=()=> renderMarketplace(c.id, $('#mpSearch').value.trim().toLowerCase()); chips.appendChild(b); });
      const grid=$('#mpGrid'); grid.innerHTML='';
      const list = (MP_PRODUCTS.concat(getUserProducts())).filter(p=>{
        if (category && p.cat!==category) return false;
        if (query && !(p.title.toLowerCase().includes(query)||p.cat.includes(query))) return false;
        return true;
      });
      if (!list.length){ grid.innerHTML='<div class="small muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card product';
        el.innerHTML=`<img src="${p.img}" alt="${p.title}"/><div><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between"><div class="price">${money(p.price)}</div><div class="small muted">Seller: ${p.seller||'You'}</div></div>
          <div class="row" style="gap:8px;margin-top:6px"><button class="btn primary" type="button">üí¨ Chat</button></div>`;
        el.querySelector('button').onclick = ()=> alert('In‚Äëapp chat coming soon.');
        grid.appendChild(el);
      });
    }
    $('#sellProductsBtn').onclick = ()=> $('#sellModal').classList.add('open');
    $('#sellBack').onclick = ()=> $('#sellModal').classList.remove('open');
    $('#sellClose').onclick = ()=> $('#sellModal').classList.remove('open');
    $('#sellSubmit').onclick = async ()=>{
      const cat=$('#sellCat').value, type=$('#sellType').value.trim(), title=$('#sellTitle').value.trim();
      const price=parseFloat($('#sellPrice').value||'0'), stock=parseInt($('#sellStock').value||'0',10), desc=$('#sellDesc').value.trim();
      if (!title || !price || !stock) return alert('Fill title, price, stock');
      const files=Array.from($('#sellImages').files||[]).slice(0,10);
      const images = files.length? await Promise.all(files.map(f=>new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }))):[];
      const list=getUserProducts(); list.unshift({ id:'u'+Date.now(), cat, type, title, price, stock, desc, images, img:images[0]||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=800&auto=format&fit=crop', seller:(user.name||'You') }); setUserProducts(list);
      $('#sellModal').classList.remove('open'); renderMarketplace(); alert('Listing submitted');
    };

    // Manage Services
    function getUserServices(){ try { return JSON.parse(localStorage.getItem('zup_user_services')||'[]'); } catch { return []; } }
    function setUserServices(arr){ localStorage.setItem('zup_user_services', JSON.stringify(arr||[])); }
    $('#msCategory').onchange = (e)=>{ $('#msTransportTypeWrap').style.display = e.target.value==='transport' ? '' : 'none'; };
    $('#msAdd').onclick = ()=>{
      const cat=$('#msCategory').value, type=$('#msType').value.trim(), details=$('#msDetails').value.trim(), price=Number($('#msPrice').value||0);
      if (!type || !details || !price) return alert('Fill category, type, details, price');
      const transportType = cat==='transport' ? $('#msTransportType').value : null;
      const id='svc-'+Date.now();
      const files=Array.from($('#msImages').files||[]).slice(0,4), images=[];
      if (!files.length) save(); else {
        let pending=files.length;
        files.forEach(f=>{ const fr=new FileReader(); fr.onload=()=>{ images.push(fr.result); if(--pending===0) save(); }; fr.readAsDataURL(f); });
      }
      function save(){
        const services=getUserServices();
        services.push({ id, cat, transportType, type, details, price, images, publicName:user.name, status:'available' });
        setUserServices(services);
        loadServicesManage(); alert('Service added');
      }
    };
    function loadServicesManage(){
      const list=$('#msList'); list.innerHTML='';
      const services=getUserServices();
      if (!services.length){ list.innerHTML='<div class="small muted">No services yet.</div>'; return; }
      services.forEach(s=>{
        const el=document.createElement('div'); el.className='card';
        const imgs = (s.images||[]).map(src=>`<img src="${src}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/>`).join('');
        el.innerHTML=`<div class="list">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div><strong>${s.type}</strong> <span class="small muted">[${s.cat}${s.transportType?('/'+s.transportType):''}]</span></div>
              <div class="small muted">${s.details}</div>
              <div class="small"><strong>Price:</strong> ${money(s.price)} ‚Ä¢ <strong>By:</strong> ${s.publicName}</div>
            </div>
          </div>
          <div class="row" style="gap:6px;flex-wrap:wrap">${imgs||'<span class="small muted">No catalog images</span>'}</div>
        </div>`;
        list.appendChild(el);
      });
    }

    // Manage Products (Food vendors)
    (function manageFoodProducts(){
      const wrap = document.getElementById('foodItemsForm');
      const list = document.getElementById('foodItemsList');
      function ensureRow(){
        const row = document.createElement('div');
        row.className='card'; row.style.margin='8px 0';
        row.innerHTML = `
          <div class="grid-2">
            <div class="field"><label class="small">Sub‚Äëcategory</label>
              <select class="f-cat">
                <option value="fastfood">Fast food</option>
                <option value="grocery">Groceries</option>
              </select>
            </div>
            <div class="field"><label class="small">Title</label><input class="f-title" placeholder="Item title"></div>
          </div>
          <div class="grid-2">
            <div class="field"><label class="small">Price</label><input class="f-price" type="number" min="0" step="0.01"></div>
            <div class="field"><label class="small">Images (up to 5)</label><input class="f-imgs" type="file" accept="image/*" multiple></div>
          </div>
          <div class="field"><label class="small">Description</label><textarea class="f-desc" rows="2"></textarea></div>
          <div class="row"><label class="small"><input type="checkbox" class="f-cash" checked> Cash</label><label class="small"><input type="checkbox" class="f-card" checked> Card</label></div>
        `;
        wrap.appendChild(row);
      }
      function getSaved(){ try { return JSON.parse(localStorage.getItem('zup_food_menu')||'[]'); } catch { return []; } }
      function setSaved(arr){ localStorage.setItem('zup_food_menu', JSON.stringify(arr||[])); }
      function loadList(){
        const data = getSaved(); list.innerHTML='';
        if (!data.length) { list.innerHTML='<div class="small muted">No items yet.</div>'; return; }
        data.forEach((it, idx)=>{
          const card=document.createElement('div'); card.className='card';
          const imgs=(it.images||[]).map(src=>`<img src="${src}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/>`).join('');
          card.innerHTML = `
            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div>
                <div><strong>${it.title}</strong> <span class="small muted">[${it.cat}]</span></div>
                <div class="small muted">${it.desc||''}</div>
                <div class="small"><strong>Price:</strong> ${money(it.price)} ‚Ä¢ <strong>Pay:</strong> ${(it.pay||[]).join(', ')||'‚Äî'}</div>
              </div>
              <div class="row" style="gap:6px">
                <button class="btn ghost" data-k="edit" data-i="${idx}">Edit</button>
                <button class="btn ghost" data-k="del" data-i="${idx}">Delete</button>
              </div>
            </div>
            <div class="row" style="gap:6px;flex-wrap:wrap;margin-top:6px">${imgs||'<span class="small muted">No images</span>'}</div>
          `;
          list.appendChild(card);
        });
        list.onclick = (e)=>{
          const b=e.target.closest('[data-k]'); if(!b) return;
          const i=Number(b.getAttribute('data-i')); const data=getSaved();
          if (b.getAttribute('data-k')==='del'){ data.splice(i,1); setSaved(data); loadList(); }
          if (b.getAttribute('data-k')==='edit'){
            const it=data[i]; wrap.innerHTML=''; ensureRow();
            const r=wrap.querySelector('.card');
            r.querySelector('.f-cat').value=it.cat;
            r.querySelector('.f-title').value=it.title;
            r.querySelector('.f-price').value=it.price;
            r.querySelector('.f-desc').value=it.desc||'';
            r.querySelector('.f-cash').checked=(it.pay||[]).includes('cash');
            r.querySelector('.f-card').checked=(it.pay||[]).includes('card');
            document.getElementById('saveFoodItems').onclick = ()=> saveItems(i);
          }
        };
      }
      function readImages(input, limit){
        const files=Array.from((input.files||[])).slice(0,limit);
        if (!files.length) return Promise.resolve([]);
        return new Promise(res=>{
          const imgs=[]; let left=files.length;
          files.forEach(f=>{ const fr=new FileReader(); fr.onload=()=>{ imgs.push(fr.result); if(--left===0) res(imgs); }; fr.readAsDataURL(f); });
        });
      }
      async function saveItems(replaceIdx){
        const cards = Array.from(wrap.querySelectorAll('.card'));
        const items=[];
        for (const c of cards){
          const cat=c.querySelector('.f-cat').value;
          const title=c.querySelector('.f-title').value.trim();
          const price=parseFloat(c.querySelector('.f-price').value||'0');
          const desc=c.querySelector('.f-desc').value.trim();
          const imgs=await readImages(c.querySelector('.f-imgs'), 5);
          const pay=[]; if (c.querySelector('.f-cash').checked) pay.push('cash'); if (c.querySelector('.f-card').checked) pay.push('card');
          if (title && price>0) items.push({ cat, title, price, desc, images:imgs, pay });
        }
        if (!items.length) return alert('Add at least one valid item');
        const saved=getSaved();
        if (typeof replaceIdx==='number'){ saved[replaceIdx]=items[0]; } else { saved.unshift(...items); }
        setSaved(saved); wrap.innerHTML=''; ensureRow(); loadList(); alert('Saved');
        document.getElementById('saveFoodItems').onclick = ()=> saveItems(undefined);
      }
      document.getElementById('addFoodRow').addEventListener('click', ensureRow);
      document.getElementById('saveFoodItems').addEventListener('click', ()=> saveItems(undefined));
      ensureRow(); loadList();
    })();

    // Profile buttons (navigation)
    $('#manageServicesBtn').onclick   = ()=>{ $('.nav [data-page="orders"]').click(); $('#page-manage-services').classList.add('active'); };
    $('#manageProductsBtn').onclick   = ()=>{ $('.nav [data-page="orders"]').click(); $('#page-manage-products').classList.add('active'); };
    $('#emergencyContactsBtn').onclick= ()=>{ $('.nav [data-page="orders"]').click(); $('#page-emergency-contacts').classList.add('active'); loadContactsForm(); };
    $('#providerVerifyBtn').onclick   = ()=>{ $('.nav [data-page="orders"]').click(); $('#page-verify-provider').classList.add('active'); };
    $('#vpSubmit').onclick = ()=>{ $('#vpStatus').textContent='Submitted. Awaiting admin review.'; };
    $('#vpBack').onclick = ()=> { $('.nav [data-page="profile"]').click(); };

    // Emergency contacts
    function loadContactsForm(){
      const wrap=$('#ecForm'); wrap.innerHTML='';
      const saved=loadContacts();
      for (let i=0;i<5;i++){
        const row=document.createElement('div'); row.className='grid-2';
        row.innerHTML=`<div class="field"><label class="small">Name ${i+1}</label><input id="ecName${i}" value="${saved[i]?.name||''}"/></div>
                       <div class="field"><label class="small">Phone ${i+1}</label><input id="ecPhone${i}" value="${saved[i]?.phone||''}"/></div>`;
        wrap.appendChild(row);
      }
    }
    function loadContacts(){ try { return JSON.parse(localStorage.getItem('zup_contacts')||'[]'); } catch { return []; } }
    function saveContacts(){
      const arr=[]; for(let i=0;i<5;i++){ const name=$('#ecName'+i).value.trim(), phone=$('#ecPhone'+i).value.trim(); if (name||phone) arr.push({name,phone}); }
      localStorage.setItem('zup_contacts', JSON.stringify(arr)); alert('Contacts saved');
    }
    $('#ecSave').onclick = saveContacts;

    // Notifications (cart badge)
    function updateBellBadge(){
      const n=cart.items.reduce((a,b)=>a+(b.qty||0),0);
      let badge = document.getElementById('notifBellBadge');
      if (!badge){ const bell=document.getElementById('notifBtn'); badge=document.createElement('span'); badge.id='notifBellBadge'; badge.style.cssText='position:absolute; top:-4px; right:-4px; background:#DC2626; color:#fff; border-radius:999px; font-size:11px; padding:0 5px; line-height:16px; min-width:16px; text-align:center; display:none'; bell.style.position='relative'; bell.appendChild(badge); }
      badge.style.display = n>0 ? 'inline-block' : 'none';
      badge.textContent = n || '';
    }
    document.getElementById('closeNotif').onclick = ()=> document.getElementById('notifModal').classList.remove('open');
    document.getElementById('notifBtn').onclick = ()=>{
      const list = document.getElementById('notifList'); list.innerHTML='';
      const n=cart.items.reduce((a,b)=>a+(b.qty||0),0);
      if (n>0){
        const row=document.createElement('div'); row.className='card'; row.style.cursor='pointer';
        row.innerHTML = `<div class="row" style="justify-content:space-between"><div>üõí You have ${n} item(s) in Food cart</div><div>‚Ä∫</div></div>`;
        row.onclick = ()=>{ document.getElementById('notifModal').classList.remove('open'); renderCart(); document.getElementById('cartModal').classList.add('open'); };
        list.appendChild(row);
      } else {
        list.innerHTML='<div class="small muted">No notifications.</div>';
      }
      document.getElementById('notifModal').classList.add('open');
    };

    // Availability toggle
    const availKey='zippup_availability';
    const toggle=document.getElementById('availToggle'); const knob=document.getElementById('availKnob'); const track=document.getElementById('availTrack');
    toggle.checked = localStorage.getItem(availKey) === 'on';
    knob.style.transform = toggle.checked ? 'translateX(20px)' : 'translateX(0)';
    track.style.background = toggle.checked ? '#10B981' : '#d1d5db';
    toggle.onchange = (e)=>{ localStorage.setItem(availKey, e.target.checked?'on':'off'); knob.style.transform = e.target.checked?'translateX(20px)':'translateX(0)'; track.style.background = e.target.checked ? '#10B981' : '#d1d5db'; };

    // Panic
    function updatePanicLoc(){ document.getElementById('panicLocHint').textContent = coords ? `${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}` : 'Unknown'; }
    document.getElementById('panicBtn').onclick = ()=> { updatePanicLoc(); document.getElementById('panicStatus').textContent=''; document.getElementById('panicMsg').value=''; document.getElementById('panicModal').classList.add('open'); };
    document.getElementById('panicClose').onclick = ()=> document.getElementById('panicModal').classList.remove('open');
    document.getElementById('panicCancel').onclick = ()=> document.getElementById('panicModal').classList.remove('open');
    document.getElementById('panicSend').onclick = ()=>{ document.getElementById('panicStatus').textContent='Alert sent.'; setTimeout(()=> document.getElementById('panicModal').classList.remove('open'), 700); };

    // Voice helpers
    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{ const text=e.results[0][0].transcript||''; inputEl.value=text; onResult&&onResult(text); };
      rec.start();
    }
    document.getElementById('voiceBtn').onclick = ()=> voiceToInput(document.getElementById('search'), ()=>{});
    document.getElementById('mpVoice').onclick  = ()=> voiceToInput(document.getElementById('mpSearch'), ()=> document.getElementById('mpSearchBtn').click());

    // Search route
    document.getElementById('searchBtn').onclick = ()=>{
      const q=(document.getElementById('search').value||'').toLowerCase();
      if (!q) return;
      if (/(transport|ride|taxi|truck|backie)/.test(q)) return openCategory('transport','Transport');
      if (/(food|pizza|burger|fries|grocery|groceries)/.test(q)) return openCategory('food','Food');
      if (/(ambulance|medical)/.test(q)) return openEmergency('ambulance','Ambulance');
      if (/(fire)/.test(q)) return openEmergency('fire','Fire Service');
      if (/(towing|tow)/.test(q)) return openEmergency('towing','Towing');
      if (/(security|police)/.test(q)) return openEmergency('security','Security');
      if (/(market)/.test(q)) return $('.nav [data-page="marketplace"]').click();
      if (/(other|tutor|event|photographer)/.test(q)) return openOthers();
      openCategory('home','Home');
    };

    // Location + map
    async function reverseGeocode(lat,lng){
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json(); return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || '');
      } catch { return null; }
    }
    async function initLocation(){
      try {
        const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:9000 }));
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const name = await reverseGeocode(coords.lat, coords.lng);
        document.getElementById('userLocUnder').textContent = name || `Lat ${coords.lat.toFixed(4)}, Lng ${coords.lng.toFixed(4)}`;
      } catch {
        document.getElementById('userLocUnder').textContent = 'Location unavailable';
      }
    }
    function initHomeMap(){
      try {
        homeMap = L.map('homeMap',{ zoomControl:false }).setView([coords?.lat||0, coords?.lng||0], coords?15:2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(homeMap);
        if (coords) {
          for (let i=0;i<6;i++){
            const lat = coords.lat + (Math.random()-0.5)/100;
            const lng = coords.lng + (Math.random()-0.5)/100;
            const m = L.circleMarker([lat,lng],{radius:6,color:'#2563EB',fillColor:'#2563EB',fillOpacity:.9});
            m.addTo(homeMap); vehicleMarkers.push(m);
          }
          setInterval(()=>{
            vehicleMarkers.forEach(m=>{
              const p = m.getLatLng();
              m.setLatLng([p.lat + (Math.random()-0.5)/1000, p.lng + (Math.random()-0.5)/1000]);
            });
          }, 1500);
        }
      } catch {}
    }

    // Simple tones
    function playTone(freq, ms){
      try{
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const o=ac.createOscillator(), g=ac.createGain();
        o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(ac.destination);
        g.gain.setValueAtTime(0.0001, ac.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.02);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.02); o.stop(ac.currentTime+0.03); }, ms||150);
      }catch{}
    }

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      renderServices(); renderEmergency();
      renderMarketplace();
      await initLocation(); initHomeMap();
      updateProfileUI();
      // close hooks
      document.getElementById('closeNotif').onclick = ()=> document.getElementById('notifModal').classList.remove('open');
      // splash off
      setTimeout(()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(),250); } }, 250);
    });
  </script>
</body>
</html>
