<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://js.stripe.com/v3"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <style>
    :root { --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.08); --header-h:56px; --nav-h:64px }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; max-width:100%; overflow-x:hidden; -webkit-text-size-adjust:100% }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }

    header { position:fixed; top:0; left:0; right:0; height:var(--header-h); background:var(--card); border-bottom:1px solid var(--border); z-index:100; display:flex; align-items:center }
    header .row { width:100%; display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 16px }
    header .greet { flex:1; min-width:0 }
    header .greet strong, header .greet .small { display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    header .btn { white-space:nowrap }
    #profileMenu { position:absolute; right:0; top:calc(100% + 8px); display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:200px; z-index:1000; padding:8px }
    #profileMenu .dropdown-item, #profileMenu .btn { width:100%; padding:10px 12px; border-radius:8px; border:0; text-align:left; background:#F3F4F6; margin-bottom:6px; display:flex; align-items:center; gap:8px; cursor:pointer }
    #profileMenu .dropdown-item:last-child { margin-bottom:0 }

    .nav { position:fixed; left:0; right:0; bottom:0; height:var(--nav-h); display:flex; align-items:center; justify-content:space-around; background:#fff; border-top:1px solid var(--border); z-index:90 }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }

    .page { position:fixed; top:var(--header-h); bottom:var(--nav-h); left:0; right:0; overflow-y:auto; overflow-x:hidden; display:none; padding:12px 16px }
    .page.active { display:block }

    .section { margin:8px 0 }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:12px }
    @media (min-width:720px) { .grid { grid-template-columns:repeat(3, minmax(0, 1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success { background:#ECFDF5; color:#065F46 }
    .small { color:var(--muted); font-size:13px }

    /* Ensure Account fits */
    #profileBtn { padding:8px 12px; font-size:15px; max-width:170px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    /* Hide header cart; bell badge */
    #cartBtn, #headerCartBadge { display:none !important }
    #notifBtn { position:relative }
    #notifBellBadge { position:absolute; top:-4px; right:-4px; background:#DC2626; color:#fff; border-radius:999px; font-size:11px; padding:0 5px; line-height:16px; min-width:16px; text-align:center; display:none }

    /* Modal base */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:200; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow); display:flex; flex-direction:column; max-height:80vh }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px; overflow:auto }
    .list { display:flex; flex-direction:column; gap:12px }
    .qty { display:flex; gap:8px; align-items:center }
    .qty button { width:30px; height:30px; border-radius:8px }

    /* Terms modal (topmost, readable) */
    #termsModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:10000; align-items:center; justify-content:center; }
    #termsModal .modal-card { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); overflow:hidden }
    #termsModal .modal-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border) }
    #termsModal .modal-body { padding:16px; max-height:65vh; overflow:auto }

    /* Full-screen checkout content scrolls inside */
    #checkoutModal .sheet { height:100vh; }
    #checkoutModal .sheet .body { flex:1; overflow:auto }
  </style>
</head>

<body>
  <header>
    <div class="row">
      <div class="greet">
        <strong>Hello, <span id="userName">Guest</span></strong>
        <span class="small">üìç <span id="userLoc">Detecting location‚Ä¶</span></span>
      </div>
      <div class="row" style="position:relative">
        <button class="btn ghost" id="notifBtn" type="button">üîî</button>
        <span id="notifBellBadge"></span>
        <button class="btn ghost" id="profileBtn" type="button">üë§ Account</button>
        <div id="profileMenu">
          <div class="dropdown-item" id="menuProfile"><span>üë§</span><span>Profile</span></div>
          <div class="dropdown-item" id="menuWallet"><span>üí∞</span><span>Wallet</span></div>
          <div class="dropdown-item" id="menuTopup"><span>‚ö°</span><span>Top‚Äëup</span></div>
          <!-- will be replaced with Confirm Delivery -->
          <div class="dropdown-item" id="menuSupport"><span>üÜò</span><span>Contact Support</span></div>
          <div class="dropdown-item" id="menuLogout"><span>üö™</span><span>Logout</span></div>
        </div>
      </div>
    </div>
  </header>

  <nav class="nav">
    <button data-page="home" class="active" type="button">üè† Home</button>
    <button data-page="services" type="button">üîß Services</button>
    <button data-page="bookings" type="button">üìã Bookings</button>
    <button data-page="marketplace" type="button">üõçÔ∏è Marketplace</button>
  </nav>

  <!-- Pages -->
  <main id="page-home" class="page active">
    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>
    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>
    <section class="section">
      <div class="title">Recent</div>
      <div id="recentList"></div>
    </section>
  </main>

  <main id="page-services" class="page">
    <section class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesAllGrid"></div>
    </section>
  </main>

  <main id="page-bookings" class="page">
    <section class="section">
      <div class="title">My Bookings</div>
      <div id="bookingsList"></div>
    </section>
  </main>

  <main id="page-marketplace" class="page">
    <section class="section">
      <div class="row">
        <input id="mpSearch" placeholder="Search products‚Ä¶" style="flex:1; padding:10px; border:1px solid var(--border); border-radius:10px"/>
        <button class="btn ghost" id="mpSearchBtn" type="button">Search</button>
      </div>
    </section>
    <section class="section">
      <div class="controls" id="mpChips"></div>
    </section>
    <section class="section">
      <div class="title">Products</div>
      <div class="grid" id="mpGrid"></div>
    </section>
    <div style="position:fixed;right:16px;bottom:calc(var(--nav-h) + 16px);z-index:120">
      <button class="btn primary" id="openCartBtn" type="button">üõí Cart (<span id="cartCount">0</span>)</button>
    </div>
  </main>

  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row">
            <div id="user-avatar" style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">üë§</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Demo User</strong> <span class="small muted">(Public name)</span></div>
              <div class="small" id="profEmail">demo@zippup.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><strong>Availability</strong><div class="small muted">Go Offline / Available</div></div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="availToggle" type="checkbox" style="display:none"/>
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px"></span>
            <span style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s" id="availKnob"></span>
          </label>
        </div>
      </div>

      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn" type="button">Manage Products</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
        <button class="btn ghost" id="supportBtn" type="button">Contact Support</button>
      </div>
    </section>
  </main>

  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong>$245.80</strong></div>
    </section>
  </main>

  <main id="page-topup" class="page">
    <section class="section">
      <div class="title">Top‚Äëup (Digital)</div>
      <div class="grid">
        <div class="card service" data-topup="airtime"><div class="row"><div style="font-size:24px">üìû</div><h4>Buy Airtime</h4></div></div>
        <div class="card service" data-topup="data"><div class="row"><div style="font-size:24px">üì∂</div><h4>Data Bundles</h4></div></div>
        <div class="card service" data-topup="bills"><div class="row"><div style="font-size:24px">üí°</div><h4>Pay Bills</h4></div></div>
      </div>
    </section>
  </main>

  <main id="page-manage-services" class="page">
    <section class="section">
      <div class="title">Manage Services</div>
      <div class="card">
        <div class="list">
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label class="small">Category</label>
              <select id="msCategory">
                <option value="transport">Transport</option><option value="food">Food</option>
                <option value="tech">Tech Services</option><option value="home">Home Services</option>
                <option value="construction">Construction</option><option value="auto">Automobile</option><option value="others">Others</option>
              </select>
            </div>
            <div class="field"><label class="small">Service type</label><input id="msType" placeholder="e.g., Driver, Plumber"/></div>
          </div>
          <div class="field"><label class="small">Details</label><textarea id="msDetails" rows="3" placeholder="Describe your service‚Ä¶"></textarea></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label class="small">Price (per 1‚Äì2hr)</label><input id="msPrice" type="number" min="0" step="0.01" placeholder="e.g., 50"/></div>
            <div class="field"><label class="small">Catalog images (up to 4)</label><input id="msImages" type="file" accept="image/*" multiple/></div>
          </div>
          <button class="btn primary" id="msAdd" type="button">+ Add Service</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="msList"></div>
    </section>
  </main>

  <main id="page-manage-products" class="page">
    <section class="section">
      <div class="title">Manage Products</div>
      <div class="card">
        <div class="list">
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label class="small">Category</label>
              <select id="mpCatSelect">
                <option value="electronics">Electronics</option><option value="fashion">Fashion</option>
                <option value="home">Home & Garden</option><option value="sports">Sports</option>
                <option value="automobile">Automobile</option><option value="spares">Spare Parts</option><option value="others">Others</option>
              </select>
            </div>
            <div class="field"><label class="small">Product name</label><input id="mpName" placeholder="e.g., iPhone 13"/></div>
          </div>
          <div class="field"><label class="small">Description</label><textarea id="mpDesc" rows="3" placeholder="Describe the product‚Ä¶"></textarea></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label class="small">Price</label><input id="mpPrice" type="number" min="0" step="0.01"/></div>
            <div class="field"><label class="small">Stock</label><input id="mpStock" type="number" min="0" step="1"/></div>
          </div>
          <div class="field"><label class="small">Images (up to 10)</label><input id="mpImages" type="file" accept="image/*" multiple/></div>
          <button class="btn primary" id="mpAdd" type="button">+ Add Product</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="mpManageList"></div>
    </section>
  </main>

  <main id="page-emergency-contacts" class="page">
    <section class="section">
      <div class="title">Emergency Contacts</div>
      <div class="card">
        <div class="small muted">Add up to 5 contacts (name and phone).</div>
        <div id="ecForm" class="list" style="margin-top:10px"></div>
        <button class="btn primary" id="ecSave" type="button">Save Contacts</button>
      </div>
    </section>
  </main>

  <main id="page-verify-provider" class="page">
    <section class="section">
      <div class="title">Become Verified Provider</div>
      <div class="card">
        <div class="list">
          <div class="field"><label class="small">Full name</label><input id="vpName" placeholder="Your name"/></div>
          <div class="field"><label class="small">Service category</label><input id="vpCategory" placeholder="e.g., Driver, Plumber"/></div>
          <div class="field"><label class="small">ID number</label><input id="vpId" placeholder="Your ID"/></div>
          <button class="btn primary" id="vpSubmit" type="button">Submit for Verification</button>
          <div id="vpStatus" class="small" style="color:#2563EB"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="page-support" class="page">
    <section class="section">
      <div class="title">Contact Support</div>
      <div class="card">
        <div class="list" id="aiFaq"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="list">
          <div class="small"><strong>Reach Support</strong></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label class="small">Name</label><input id="supName"/></div>
            <div class="field"><label class="small">Phone</label><input id="supPhone"/></div>
          </div>
          <div class="field"><label class="small">Email</label><input id="supEmail"/></div>
          <div class="field"><label class="small">Reason</label><textarea id="supReason" rows="3" placeholder="Describe your issue‚Ä¶"></textarea></div>
          <button class="btn primary" id="supSend" type="button">Send Message</button>
          <div class="small">Emergency? <a href="tel:0784079686">Call 0784079686</a></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal" id="providersModal"><div class="sheet"><div class="head"><strong id="providersTitle">Providers</strong><button class="btn ghost" id="closeProviders" type="button">‚úñ</button></div><div class="body"><div class="list" id="providersList"></div></div></div></div>
  <div class="modal" id="bookingModal"><div class="sheet"><div class="head"><strong>Book Service</strong><button class="btn ghost" id="closeBooking" type="button">‚úñ</button></div><div class="body"><form id="bookingForm" class="list"><div class="grid" style="grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label class="small">Date</label><input id="bkDate" type="date" required/></div><div class="field"><label class="small">Time</label><input id="bkTime" type="time" required/></div></div><div class="field"><label class="small">Address</label><input id="bkAddress" required placeholder="Enter address"/></div><div class="field"><label class="small">Details</label><textarea id="bkDesc" rows="3" placeholder="Describe the job‚Ä¶"></textarea></div><button class="btn primary" type="submit">Send Booking Request</button></form></div></div></div>
  <div class="modal" id="tiModal"><div class="sheet"><div class="head"><strong>Ride Details</strong><button class="btn ghost" id="tiClose" type="button">‚úñ</button></div><div class="body"><div class="list"><div class="field"><label class="small">Pickup address</label><div class="row" style="gap:8px; width:100%"><input id="tiPickup" placeholder="Your current or preferred pickup‚Ä¶" style="flex:1"/><button class="btn ghost" id="tiUseCurrent" type="button">üìç Use current</button></div></div><div class="field"><label class="small">Destination address</label><input id="tiDestination" placeholder="Where are you going?"/></div><div class="field"><label class="small">Stops (optional, max 5)</label><div id="tiStops" class="list"></div><div class="row" style="gap:8px;margin-top:6px"><button class="btn ghost" id="tiAddStop" type="button">Ôºã Add stop</button><button class="btn ghost" id="tiRemoveStop" type="button">‚àí Remove stop</button></div></div><button class="btn primary" id="tiStart" type="button">Start Instant Request</button></div></div></div></div>
  <div class="modal" id="instantModal"><div class="sheet"><div class="head"><strong id="instantTitle">Contacting provider‚Ä¶</strong><button class="btn ghost" id="cancelInstant" type="button">Cancel</button></div><div class="body"><div class="card"><div>Time left: <strong id="countdown">90</strong>s</div><div class="small muted" id="instantHint">Waiting for provider to accept‚Ä¶</div></div><div class="controls" style="margin-top:10px"><button class="btn ghost" id="findOthers" type="button">Find other providers</button></div></div></div></div>
  <div class="modal" id="cancelReasonsModal"><div class="sheet"><div class="head"><strong>Cancel request</strong><button class="btn ghost" id="crClose" type="button">‚úñ</button></div><div class="body"><div id="crList" class="list"></div><div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px"><button class="btn ghost" id="crBack" type="button">Back</button><button class="btn primary" id="crConfirm" type="button">Confirm cancel</button></div></div></div></div>
  <div class="modal" id="trackModal"><div class="sheet"><div class="head"><strong>Live Tracking</strong><div class="row" style="gap:6px"><button class="btn ghost" id="trackCancelBtn" type="button">Cancel</button><button class="btn ghost" id="closeTrack" type="button">‚úñ</button></div></div><div class="body"><div id="trackStatus" class="small muted">Provider accepted. En route‚Ä¶</div><div id="trackMapWrap" style="margin-top:10px"><div id="track-map" style="width:100%;height:360px;border:1px solid var(--border);border-radius:12px"></div></div></div></div></div>
  <div class="modal" id="categoryOptionsModal"><div class="sheet"><div class="head"><strong id="categoryOptionsTitle">Options</strong><button class="btn ghost" id="closeCategoryOptions" type="button">‚úñ</button></div><div class="body"><div id="categoryOptionsList" class="list"></div></div></div></div>
  <div class="modal" id="itemsModal"><div class="sheet"><div class="head"><strong id="itemsTitle">Find Items</strong><button class="btn ghost" id="closeItems" type="button">‚úñ</button></div><div class="body"><div class="row" style="gap:8px;margin-bottom:10px"><input id="itemSearch" placeholder="Say or type what you need‚Ä¶" style="flex:1"/><button class="btn ghost" id="itemVoice" type="button">üé§</button><button class="btn primary" id="itemGo" type="button">Search</button></div><div id="itemChips" class="controls"></div></div></div></div>
  <div class="modal" id="cartModal"><div class="sheet"><div class="head"><strong>My Cart</strong><button class="btn ghost" id="closeCart" type="button">‚úñ</button></div><div class="body"><div id="cartList" class="list"></div><div class="row" style="justify-content:space-between;margin-top:10px; position:sticky; bottom:0; background:#fff; padding-top:10px; border-top:1px solid var(--border)"><div class="price">Total: $<span id="cartTotal">0.00</span></div><button class="btn primary" id="checkoutBtn" type="button">Checkout</button></div></div></div></div>
  <div class="modal" id="checkoutModal"><div class="sheet"><div class="head"><strong>Checkout</strong><button class="btn ghost" id="closeCheckout" type="button">‚úñ</button></div><div class="body"><div class="list" id="checkoutList"><div class="grid" style="grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label class="small">Full Name</label><input id="chkName"/></div><div class="field"><label class="small">Phone</label><input id="chkPhone"/></div></div><div class="grid" style="grid-template-columns:1fr 1fr;gap:12px"><div class="field"><label class="small">Street / Address</label><input id="chkAddress"/></div><div class="field"><label class="small">Flat / House No.</label><input id="chkUnit"/></div></div><div class="field"><label class="small">Delivery Notes</label><textarea id="chkNotes" rows="3"></textarea></div><div class="field"><label class="small">Payment Method</label><div class="controls"><label><input type="radio" name="payMethod" value="card" checked/> Card</label><label><input type="radio" name="payMethod" value="cash"/> Cash</label></div></div><label class="small"><input type="checkbox" id="chkTerms"/> I accept the Terms. <a href="#" id="termsLink">Read Terms</a></label><button class="btn primary" id="placeOrderBtn" type="button">Place Order</button></div></div></div></div>
  <div class="modal" id="orderModal"><div class="sheet"><div class="head"><strong>Order Status</strong><button class="btn ghost" id="closeOrder" type="button">‚úñ</button></div><div class="body"><div id="orderInfo" class="list"></div></div></div></div>

  <!-- Panic Modal -->
  <div class="modal" id="panicModal"><div class="sheet"><div class="head"><strong>Emergency Alert</strong><button class="btn ghost" id="panicClose" type="button">‚úñ</button></div><div class="body"><div class="list"><div class="small muted">We‚Äôll notify your contacts and nearby providers with your location.</div><div class="field"><label class="small">Message (optional)</label><textarea id="panicMsg" rows="3" placeholder="Describe the emergency‚Ä¶"></textarea></div><div class="small muted">Location: <span id="panicLocHint">Fetching‚Ä¶</span></div><div class="row" style="gap:8px; justify-content:flex-end; margin-top:8px"><button class="btn ghost" id="panicCancel" type="button">Cancel</button><button class="btn primary" id="panicSend" type="button">Send Alert</button></div><div id="panicStatus" class="small muted"></div></div></div></div></div>

  <!-- Confirm Delivery + Last Order -->
  <div class="modal" id="confirmDeliveryModal"><div class="sheet"><div class="head"><strong>Confirm Delivery</strong><button class="btn ghost" id="confirmClose" type="button">‚úñ</button></div><div class="body"><div class="list"><div class="small muted">Seller: ask buyer for the one‚Äëtime delivery code and enter it below to mark delivery complete and release payment.</div><input id="confirmCode" placeholder="Enter 6‚Äëdigit code" inputmode="numeric" maxlength="6"/><button id="confirmSubmit" class="btn primary" type="button">Submit Code</button><div id="confirmStatus" class="small muted"></div></div></div></div></div>
  <div class="modal" id="lastOrderModal"><div class="sheet"><div class="head"><strong>Your Last Order</strong><button class="btn ghost" id="lastOrderClose" type="button">‚úñ</button></div><div class="body"><div id="lastOrderInfo" class="small"></div><div class="row" style="gap:8px;justify-content:flex-end"><button id="sendCodeSMS" class="btn ghost" type="button">Send Code by SMS</button></div></div></div></div>

  <!-- Notifications Modal -->
  <div class="modal" id="notifModal"><div class="sheet"><div class="head"><strong>Notifications</strong><button class="btn ghost" id="closeNotif" type="button">‚úñ</button></div><div class="body"><div id="notifList" class="list"></div></div></div></div>

  <button class="btn primary" id="panicBtn" type="button" style="position:fixed; right:16px; bottom:calc(var(--nav-h) + 12px); width:60px; height:60px; border-radius:50%">üö®</button>

  <script>
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';
    let user = { name:'Guest', email:'demo@zippup.com' };
    let coords = null, requestId = null, trackPoll = null, instantTimer = null, instantLeft = 90, lastCategory = null;

    const $ = (id)=>document.getElementById(id);
    function showPage(page){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); (document.getElementById('page-'+page) || document.getElementById('page-home')).classList.add('active'); }
    document.querySelectorAll('.nav button').forEach(b=>{ b.onclick = ()=>{ document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showPage(b.dataset.page); }; });

    // Header menu
    $('profileBtn').onclick = (e)=>{ e.stopPropagation(); const m=$('profileMenu'); m.style.display = (m.style.display==='block'?'none':'block'); };
    document.addEventListener('click', ()=>{ const m=$('profileMenu'); if (m) m.style.display='none'; });
    $('menuProfile').onclick = ()=>{ $('profileMenu').style.display='none'; showPage('profile'); };
    $('menuWallet').onclick  = ()=>{ $('profileMenu').style.display='none'; showPage('wallet'); };
    $('menuTopup').onclick   = ()=>{ $('profileMenu').style.display='none'; showPage('topup'); };
    $('menuSupport').onclick = ()=>{ $('profileMenu').style.display='none'; showPage('support'); };
    $('menuLogout').onclick  = ()=>{ $('profileMenu').style.display='none'; alert('Logged out'); };

    // location
    async function initLocation() {
      try { const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 }));
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        $('userLoc').textContent = (await reverseGeocode(coords.lat, coords.lng)) || 'Unknown';
      } catch { $('userLoc').textContent = 'Location unavailable'; }
    }
    async function reverseGeocode(lat,lng){
      try { const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json(); return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || ''); } catch { return null; }
    }

    // Services
    const SERVICES = [
      { id:'transport', name:'Transport', icon:'üöó', desc:'Ride & moving', instant:true,  scheduled:true },
      { id:'food',      name:'Food',      icon:'üçî', desc:'Restaurant & grocery', instant:true,  scheduled:true },
      { id:'tech',      name:'Tech',      icon:'üîß', desc:'Phone/computer repair', instant:true,  scheduled:true },
      { id:'home',      name:'Home',      icon:'üè†', desc:'Cleaning & maintenance', instant:true,  scheduled:true },
      { id:'construction', name:'Construction', icon:'üèóÔ∏è', desc:'Builders & electricians', instant:false, scheduled:true },
      { id:'auto',      name:'Automobile', icon:'üõ†Ô∏è', desc:'Mechanics, tires, roadside', instant:true,  scheduled:true },
      { id:'others',    name:'Others',    icon:'üéØ', desc:'Events, tutors, more', instant:false, scheduled:true },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance', icon:'üöë' },
      { id:'fire',      name:'Fire Service', icon:'üöí' },
      { id:'towing',    name:'Towing', icon:'üöõ' },
      { id:'security',  name:'Security', icon:'üõ°Ô∏è' },
      { id:'roadside',  name:'Roadside', icon:'üîß' },
    ];

    function renderServices(){
      const grid = $('servicesGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small" style="margin-top:6px;color:#6B7280">${s.desc}</div><div class="row" style="margin-top:8px">${s.instant?'<span class="pill">Instant</span>':''}${s.scheduled?'<span class="pill">Scheduled</span>':''}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderServicesAll(){
      const grid = $('servicesAllGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small" style="margin-top:6px;color:#6B7280">${s.desc}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderEmergency(){
      const grid = $('emergencyGrid'); grid.innerHTML='';
      EMERGENCY.forEach(e=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div><div class="small muted" style="margin-top:6px">${e.id==='roadside'?'Describe the issue':'Find nearest/available'}</div><div class="row" style="margin-top:8px"><span class="pill">Instant</span></div>`;
        el.onclick = ()=> (e.id==='roadside' ? openItemsModal('roadside') : openEmergency(e.id, e.name));
        grid.appendChild(el);
      });
    }
    function renderRecent(){
      $('recentList').innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>`;
    }
    async function openEmergency(emId, label){
      $('providersTitle').textContent = label + ' ‚Äî Nearest';
      const list = await fetchProviders('emergency', emId);
      renderProviders(list);
      $('providersModal').classList.add('open');
    }

    // Providers
    async function fetchProviders(category, sub=null){
      try{
        const q = new URLSearchParams({ category, sub: sub||'', lat: coords?.lat||'', lng: coords?.lng||'' });
        const r = await fetch(`${BASE_API}/api/providers/nearby?${q.toString()}`);
        if (!r.ok) throw 0; const d = await r.json(); return d.providers||[];
      }catch{
        return [
          { id:'p1', publicName:'Alex M.', jobTitle:'Driver', verified:true, rating:4.8, icon:'üë§', distance:'0.8km', eta:'6-9m', fareMin:12, fareMax:18, currency:'$' },
          { id:'p2', publicName:'Quick Help', jobTitle:'Mechanic', verified:false, rating:4.5, icon:'‚ö°', distance:'1.2km', eta:'8-12m', fareMin:10, fareMax:15, currency:'$' },
          { id:'p3', publicName:'Nearby Tech', jobTitle:'Plumber', verified:true, rating:4.2, icon:'üîß', distance:'2.1km', eta:'12-18m', fareMin:12, fareMax:18, currency:'$' },
        ];
      }
    }
    function renderProviders(list){
      const box=$('providersList'); box.innerHTML='';
      if (!list?.length){ box.innerHTML='<div class="small muted">No providers found nearby.</div>'; return; }
      list.forEach(p=>{
        const name = p.publicName || p.name || 'Provider';
        const title= p.jobTitle ? ` ‚Ä¢ ${p.jobTitle}` : '';
        const verified = p.verified ? `<span style="color:#2563EB">‚úîÔ∏è</span>` : `<span class="small muted">unverified</span>`;
        const rating = p.rating ? ` <span style="color:#F59E0B;font-size:12px">‚òÖ ${(Number(p.rating)).toFixed(1)}</span>` : '';
        const avatar = `<div style="width:40px;height:40px;border-radius:50%;border:1px solid var(--border);display:flex;align-items:center;justify-content:center">${p.icon||'üë§'}</div>`;
        const fare = (p.fareMin && p.fareMax) ? `${p.currency||'$'}${p.fareMin}‚Äë${p.fareMax}` : (p.fee||'‚Äî');
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div class="row" style="align-items:center">${avatar}<div style="margin-left:8px"><div><strong>${name}</strong> ${verified} ${rating}</div><div class="small muted">${p.distance || '‚Äî'} ‚Ä¢ ETA ${p.eta || '‚Äî'}${title}</div><div class="small"><strong>Est. fare:</strong> ${fare}</div></div></div>
            <div class="row" style="gap:8px"><button class="btn primary" data-k="instant" type="button">Instant</button><button class="btn ghost" data-k="schedule" type="button">Schedule</button></div>
          </div>`;
        el.querySelector('[data-k="instant"]').onclick = ()=> startInstant(name);
        el.querySelector('[data-k="schedule"]').onclick = ()=> { $('providersModal').classList.remove('open'); $('bookingModal').classList.add('open'); };
        box.appendChild(el);
      });
    }

    // Instant request stub
    function startInstant(serviceName){
      lastCategory = lastCategory || 'general';
      $('providersModal').classList.remove('open');
      instantLeft=90; $('countdown').textContent=String(instantLeft); $('instantHint').textContent='Waiting for provider to accept‚Ä¶'; $('instantModal').classList.add('open');
      requestId = 'req-'+Date.now();
      if (instantTimer) clearInterval(instantTimer);
      instantTimer=setInterval(async ()=>{
        instantLeft -= 1; $('countdown').textContent=String(instantLeft);
        if (instantLeft % 3 === 0) {
          // Simulate acceptance after a while
          if (instantLeft < 78) { stopInstant(); openTracking(); return; }
        }
        if (instantLeft <= 0) { stopInstant(); alert('No response. Try others.'); $('instantModal').classList.remove('open'); }
      }, 1000);
    }
    function stopInstant(){ if (instantTimer) clearInterval(instantTimer); instantTimer=null; }
    function openTracking(){
      $('instantModal').classList.remove('open'); $('trackModal').classList.add('open'); setTimeout(initMap, 50); startTracking();
    }
    function initMap(){
      const mapEl = document.getElementById('track-map'); if (!mapEl) return;
      if (!window.__map){ window.__map=L.map('track-map',{zoomControl:true}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM' }).addTo(window.__map); }
      const center = coords ? [coords.lat, coords.lng] : [0,0];
      window.__map.setView(center, 14);
    }
    function startTracking(){
      if (trackPoll) clearInterval(trackPoll);
      trackPoll=setInterval(()=>{ $('trackStatus').textContent='Provider en route ‚Ä¢ ETA 8 min'; }, 3000);
    }
    $('closeTrack').onclick = ()=>{ if (trackPoll) clearInterval(trackPoll); $('trackModal').classList.remove('open'); };
    $('trackCancelBtn').onclick = ()=> { buildCancelList(); $('cancelReasonsModal').classList.add('open'); };
    function buildCancelList(){
      const crList = $('crList'); crList.innerHTML='';
      ['Changed my mind','Wait is too long','Found another provider','Wrong service','Other'].forEach((r,i)=>{
        const row=document.createElement('label'); row.className='row';
        row.innerHTML = `<input type="radio" name="cr" value="${r}" ${i===0?'checked':''}/> <span>${r}</span>`;
        crList.appendChild(row);
      });
      const other=document.createElement('input'); other.id='crOther'; other.placeholder='If Other, describe‚Ä¶'; other.style.cssText='width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin-top:6px'; crList.appendChild(other);
      $('crClose').onclick=()=> $('cancelReasonsModal').classList.remove('open');
      $('crBack').onclick =()=> $('cancelReasonsModal').classList.remove('open');
      $('crConfirm').onclick=async ()=>{
        try { if (requestId) await fetch(`${BASE_API}/api/requests/${encodeURIComponent(requestId)}?reason=${encodeURIComponent('User cancelled')}`, { method:'DELETE' }); } catch {}
        if (trackPoll) clearInterval(trackPoll); requestId=null;
        $('cancelReasonsModal').classList.remove('open'); $('trackModal').classList.remove('open'); showPage('home'); alert('Request cancelled');
      };
    }

    // Marketplace demo products
    const MP_CATEGORIES=[{id:'electronics',name:'Electronics'},{id:'fashion',name:'Fashion'},{id:'home',name:'Home & Garden'},{id:'sports',name:'Sports'},{id:'automobile',name:'Automobile'},{id:'spares',name:'Spare Parts'},{id:'others',name:'Others'}];
    let MP_PRODUCTS=[
      { id:'p100', title:'Smartphone X', cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop' },
      { id:'p101', title:'Wireless Earbuds', cat:'electronics', price:59, stock:34, img:'https://images.unsplash.com/photo-1585386959984-a41552231658?q=80&w=800&auto=format&fit=crop' },
      { id:'p200', title:'Running Shoes', cat:'fashion', price:79, stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop' },
      { id:'p201', title:'Denim Jacket', cat:'fashion', price:69, stock:9, img:'https://images.unsplash.com/photo-1542060748-10c28b62716b?q=80&w=800&auto=format&fit=crop' },
      { id:'p300', title:'Blender Pro', cat:'home', price:49, stock:22, img:'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=800&auto=format&fit=crop' },
      { id:'p301', title:'Desk Lamp', cat:'home', price:25, stock:41, img:'https://images.unsplash.com/photo-1505685296765-3a2736de412f?q=80&w=800&auto=format&fit=crop' }
    ];
    function getUserProducts(){ try { return JSON.parse(localStorage.getItem('zup_user_products')||'[]'); } catch { return []; } }
    function setUserProducts(arr){ localStorage.setItem('zup_user_products', JSON.stringify(arr||[])); }
    function mergeProducts(){ const ups=getUserProducts(); MP_PRODUCTS = MP_PRODUCTS.filter(p=>!p.user).concat(ups); }
    function renderMarketplace(category=null, query=''){
      $('mpGrid').innerHTML='';
      let list = MP_PRODUCTS.slice();
      if (category) list = list.filter(p=>p.cat===category);
      if (query) list = list.filter(p=>p.title.toLowerCase().includes(query)||p.cat.includes(query));
      if (!list.length){ $('mpGrid').innerHTML='<div class="small muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card'; el.dataset.id=p.id;
        el.innerHTML=`<img src="${p.img}" alt="${p.title}" style="width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--border)"/><div style="margin-top:6px"><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between"><div class="price">$${Number(p.price).toFixed(2)}</div><div class="small muted">Stock: ${p.stock}</div></div>
          <button class="btn primary" type="button">${p.stock>0?'Add to Cart':'Out of Stock'}</button>`;
        const btn=el.querySelector('button'); btn.disabled=p.stock<=0; btn.onclick=()=>addToCart(p.id);
        $('mpGrid').appendChild(el);
      });
    }
    $('mpSearchBtn').onclick = ()=> renderMarketplace(null, $('mpSearch').value.trim().toLowerCase());
    (function initMarketplace(){
      $('mpChips').innerHTML=''; MP_CATEGORIES.forEach(c=>{ const b=document.createElement('button'); b.className='btn ghost'; b.type='button'; b.textContent=c.name; b.onclick=()=> renderMarketplace(c.id, $('mpSearch').value.trim().toLowerCase()); $('mpChips').appendChild(b); }); mergeProducts(); renderMarketplace(); updateCartCount();
    })();

    // Cart (storage-driven)
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('mp_cart')||'{"items":[]}'); }catch{ return { items:[] }; } }
    function saveCart(){ localStorage.setItem('mp_cart', JSON.stringify(cart)); }
    let cart = loadCart();
    function updateCartCount(){ const n=cart.items.reduce((a,b)=>a+b.qty,0); const badge=document.getElementById('cartCount'); if (badge) badge.textContent=String(n); const hb=document.getElementById('notifBellBadge'); if(hb) hb.textContent = n>0? String(n) : ''; hb.style.display = n>0? 'inline-block':'none'; }
    function addToCart(productId){ const prod=MP_PRODUCTS.find(p=>p.id===productId); if(!prod||prod.stock<=0) return; const i=cart.items.findIndex(x=>x.id===productId); if (i>=0) cart.items[i].qty+=1; else cart.items.push({id:prod.id,title:prod.title,price:Number(prod.price),img:prod.img,qty:1}); saveCart(); updateCartCount(); }
    function renderCart(){
      const list=$('cartList'), totalEl=$('cartTotal'); list.innerHTML='';
      if(!cart.items.length){ list.innerHTML='<div class="small muted">Your cart is empty.</div>'; totalEl.textContent='0.00'; return; }
      let total=0;
      cart.items.forEach(item=>{
        total+=item.price*item.qty;
        const row=document.createElement('div'); row.className='card'; row.dataset.id=item.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between; align-items:flex-start">
          <div class="row"><img src="${item.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${item.title}</strong><div class="small muted">$${Number(item.price).toFixed(2)}</div></div></div>
          <div class="qty"><button class="btn ghost" data-k="dec" type="button">‚àí</button><div>${item.qty}</div><button class="btn ghost" data-k="inc" type="button">Ôºã</button><button class="btn ghost" data-k="rm" type="button">‚úñ</button></div></div>`;
        list.appendChild(row);
      });
      totalEl.textContent=total.toFixed(2);
    }
    // Cart edit delegation
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('#cartList [data-k]'); if (!btn) return;
      const id = btn.closest('.card')?.dataset?.id; if (!id) return;
      const k = btn.getAttribute('data-k'); const i=cart.items.findIndex(x=>x.id===id); if (i<0) return;
      if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
      if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
      if (k==='rm')  cart.items.splice(i,1);
      saveCart(); renderCart(); updateCartCount();
    });

    // Open modals
    $('openCartBtn').onclick = ()=>{ cart = loadCart(); renderCart(); $('cartModal').classList.add('open'); };
    $('closeCart').onclick = ()=> $('cartModal').classList.remove('open');
    $('checkoutBtn').onclick = ()=>{ $('cartModal').classList.remove('open'); $('checkoutModal').classList.add('open'); };
    $('closeCheckout').onclick = ()=> $('checkoutModal').classList.remove('open');
    $('closeOrder').onclick = ()=> $('orderModal').classList.remove('open');

    // Checkout
    $('placeOrderBtn').onclick = async ()=>{
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      const name=$('chkName').value.trim(), phone=$('chkPhone').value.trim(), address=$('chkAddress').value.trim(), unit=($('chkUnit').value||'').trim(), notes=($('chkNotes').value||'').trim();
      if (!$('chkTerms').checked) return alert('Please accept the Terms.');
      if (!address) return alert('Enter delivery address');
      if (!name||!phone) return alert('Enter name and phone');
      cart = loadCart();
      if (!cart.items.length) return alert('Cart is empty');
      const payload = { items: cart.items.map(i=>({id:i.id,title:i.title,qty:i.qty,price:i.price})), name, phone, address, unit, notes };
      if (method==='card'){
        try{
          const r=await fetch(`${BASE_API}/api/payments/checkout-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,successUrl:location.origin+'/?checkout=success',cancelUrl:location.origin+'/?checkout=cancel'})});
          const d=await r.json().catch(()=>({}));
          if (d?.url){ location.href=d.url; return; }
          if ((d?.id||d?.sessionId) && window.Stripe){ const stripe=window.Stripe(STRIPE_PK); await stripe.redirectToCheckout({sessionId: d.id||d.sessionId}); return; }
          alert('Payment session error. Try Cash.');
        }catch{ alert('Payment session error. Try Cash.'); }
      } else {
        let orderId='demo-'+Date.now(), code=String(Math.floor(100000+Math.random()*900000));
        try{ const r2=await fetch(`${BASE_API}/api/marketplace/orders`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,paymentMethod:'cash'})}); const d2=await r2.json().catch(()=>({})); orderId=d2.orderId||orderId; code=d2.deliveryCode||code; }catch{}
        $('checkoutModal').classList.remove('open'); showOrderStatus(orderId, code, 'cash'); cart.items=[]; saveCart(); updateCartCount();
      }
    };
    function showOrderStatus(orderId, code, method){
      $('orderInfo').innerHTML = `<div class="card"><div><strong>Order ID:</strong> ${orderId}</div><div style="margin-top:6px"><strong>Status:</strong> <span id="ordStatus">pending</span></div><div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div><div class="small muted" style="margin-top:6px">${method==='card'?'Funds are held until code entry.':'Cash selected: code marks delivered.'}</div><div class="small muted" style="margin-top:6px">Please don't share this code with the seller until your goods are delivered and confirmed.</div></div>`;
      $('orderModal').classList.add('open');
      const ord=$('ordStatus'); let t=0; const poll=setInterval(async()=>{ t+=3; let s; try{ const r=await fetch(`${BASE_API}/api/marketplace/orders/${encodeURIComponent(orderId)}`); const d=await r.json().catch(()=>({})); s=d.status; }catch{ if (t>=6&&t<12) s='accepted'; else if (t>=12&&t<18) s='out_for_delivery'; else if (t>=18) s='delivered'; else s='pending'; } ord.textContent=s||'pending'; if (s==='delivered'||t>=24) clearInterval(poll); },3000);
      localStorage.setItem('zup_last_order', JSON.stringify({ orderId, code, status:'pending' }));
    }

    // Panic modal
    (function wirePanic(){
      const panicBtn=$('panicBtn'); const modal=$('panicModal');
      function open(){ $('panicStatus').textContent=''; $('panicMsg').value=''; $('panicLocHint').textContent = coords ? `${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}` : 'Unknown'; modal.classList.add('open'); }
      function close(){ modal.classList.remove('open'); }
      panicBtn.onclick = (e)=>{ e.preventDefault(); open(); };
      $('panicClose').onclick = close; $('panicCancel').onclick = close;
      modal.addEventListener('click', (e)=>{ if (e.target===modal) close(); });
      $('panicSend').onclick = async ()=>{
        const status=$('panicStatus'); status.textContent='Sending‚Ä¶';
        try { if (!coords) await initLocation(); const body={ type:'panic', userPublicName:user.name, message:$('panicMsg').value.trim()||undefined, location: coords?{latitude:coords.lat, longitude:coords.lng}:null }; const r=await fetch(`${BASE_API}/api/emergency/alert`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); const d=await r.json().catch(()=>({})); if (r.ok){ status.textContent='Alert sent.'; if (d.trackingUrl){ close(); location.href=d.trackingUrl; } } else status.textContent='Alert queued (fallback).'; } catch { status.textContent='Could not reach server.'; }
      };
    })();

    // Notifications (bell)
    (function bell(){
      function getCartCount(){ try{ return (JSON.parse(localStorage.getItem('mp_cart')||'{"items":[]}').items||[]).reduce((a,b)=>a+(+b.qty||0),0); }catch{return 0} }
      function updateBadge(){ const n=getCartCount(); const b=$('notifBellBadge'); if (n>0){ b.style.display='inline-block'; b.textContent=String(n); } else { b.style.display='none'; b.textContent=''; } }
      function openCart(){ cart = loadCart(); renderCart(); $('cartModal').classList.add('open'); showPage('marketplace'); document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); document.querySelector('.nav [data-page="marketplace"]').classList.add('active'); }
      function renderNotifs(){ const list=$('notifList'); list.innerHTML=''; const items=[]; const c=getCartCount(); if (c>0) items.push({ icon:'üõí', title:'Items in your cart', text:`You have ${c} item${c>1?'s':''} in cart.`, action:openCart }); if (!items.length){ list.innerHTML='<div class="small muted">No new notifications.</div>'; return; } items.forEach(n=>{ const row=document.createElement('div'); row.className='card'; row.style.cursor='pointer'; row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start"><div class="row" style="gap:8px;align-items:center"><div style="font-size:20px">${n.icon}</div><div><div><strong>${n.title}</strong></div><div class="small muted">${n.text}</div></div></div><div>‚Ä∫</div></div>`; row.onclick=()=>{ n.action&&n.action(); $('notifModal').classList.remove('open'); }; list.appendChild(row); }); }
      $('notifBtn').onclick = ()=>{ renderNotifs(); $('notifModal').classList.add('open'); };
      $('closeNotif').onclick = ()=> $('notifModal').classList.remove('open');
      updateBadge(); setInterval(updateBadge, 1000);
    })();

    // Profile UI
    (function wireProfile(){
      const availKey='zippup_availability'; const knob=$('availKnob'); const toggle=$('availToggle'); toggle.checked = localStorage.getItem(availKey) === 'on'; knob.style.transform = toggle.checked ? 'translateX(20px)' : 'translateX(0)'; toggle.onchange = (e)=>{ localStorage.setItem(availKey, e.target.checked?'on':'off'); knob.style.transform = e.target.checked?'translateX(20px)':'translateX(0)'; };
      $('editProfileBtn').onclick = ()=>{
        const m=document.createElement('div'); m.className='modal open'; m.innerHTML=`<div class="sheet"><div class="head"><strong>Edit Profile</strong><button class="btn ghost" id="peClose" type="button">‚úñ</button></div><div class="body"><div class="list"><div class="field"><label class="small">Public name</label><input id="peName" value="${user.name||''}"/></div><div class="field"><label class="small">Photo</label><input id="pePhoto" type="file" accept="image/*"/></div><button class="btn primary" id="peSave" type="button">Save</button></div></div></div>`; document.body.appendChild(m);
        const close=()=> m.remove(); m.addEventListener('click',(e)=>{ if (e.target===m) close(); }); m.querySelector('#peClose').onclick=close; m.querySelector('#peSave').onclick=()=>{ const name=m.querySelector('#peName').value.trim(); if (name) user.name=name; $('userName').textContent=user.name; $('profName').textContent=user.name; const f=m.querySelector('#pePhoto').files?.[0]; if (f){ const fr=new FileReader(); fr.onload=()=>{ localStorage.setItem('zup_profile_photo', fr.result); const av=$('user-avatar'); if(av){ av.style.background=`url("${fr.result}") center/cover`; av.textContent=''; } const profAv=document.querySelector('#page-profile .card .row > div[style*="width:48px"]'); if (profAv){ profAv.style.background=`url("${fr.result}") center/cover`; profAv.textContent=''; } close(); }; fr.readAsDataURL(f); } else close(); };
      };
      // Nav buttons inside Profile
      const go = (pageId)=>{ showPage(pageId.replace('page-','')); document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); document.querySelector(`.nav [data-page="${pageId.replace('page-','')}"]`)?.classList.add('active'); };
      $('manageServicesBtn').onclick   = ()=> go('page-manage-services');
      $('manageProductsBtn').onclick   = ()=> go('page-manage-products');
      $('emergencyContactsBtn').onclick= ()=> go('page-emergency-contacts');
      $('providerVerifyBtn').onclick   = ()=> go('page-verify-provider');
      $('supportBtn').onclick          = ()=> go('page-support');
    })();

    // Confirm Delivery + Last Order shortcuts in dropdown
    (function dropdownExtras(){
      const menu=$('profileMenu'); if (!menu) return;
      // remove contact support from dropdown, add Confirm Delivery and Last Order
      const sup = document.getElementById('menuSupport'); if (sup) sup.remove();
      if (!document.getElementById('confirmDeliveryNav')) {
        const cd=document.createElement('div'); cd.id='confirmDeliveryNav'; cd.className='dropdown-item'; cd.innerHTML='<span>‚úÖ</span><span>Confirm Delivery</span>'; cd.onclick=()=> $('confirmDeliveryModal').style.display='flex'; menu.appendChild(cd);
        const lo=document.createElement('div'); lo.id='lastOrderNav'; lo.className='dropdown-item'; lo.innerHTML='<span>üßæ</span><span>View Last Order Code</span>';
        lo.onclick=()=>{ const last=getLastOrder(); const box=$('lastOrderInfo'); box.innerHTML = last?.orderId ? `<div><strong>Order ID:</strong> ${last.orderId}</div><div><strong>Delivery code:</strong> <span style="font-family:monospace">${last.code||'‚Äî'}</span></div><div class="small muted" style="margin-top:6px">Do NOT share this code until delivery is confirmed.</div>` : '<div class="small muted">No recent order found.</div>'; $('lastOrderModal').style.display='flex'; }; menu.appendChild(lo);
      }
      $('confirmClose').onclick=()=> $('confirmDeliveryModal').style.display='none';
      $('lastOrderClose').onclick=()=> $('lastOrderModal').style.display='none';
      $('confirmDeliveryModal').addEventListener('click',(e)=>{ if (e.target===e.currentTarget) e.currentTarget.style.display='none'; });
      $('lastOrderModal').addEventListener('click',(e)=>{ if (e.target===e.currentTarget) e.currentTarget.style.display='none'; });
      $('confirmSubmit').onclick=async ()=>{ const code=($('confirmCode').value||'').trim(); if (!code) return alert('Enter 6‚Äëdigit code'); $('confirmStatus').textContent='Delivery confirmed. Payment will be released.'; setTimeout(()=>{ $('confirmDeliveryModal').style.display='none'; }, 800); };
      function getLastOrder(){ try{ return JSON.parse(localStorage.getItem('zup_last_order')||'{}'); }catch{return{}} }
      $('sendCodeSMS').onclick=()=>{ const last=getLastOrder(); if(!last?.code) return alert('No code found.'); const phone=prompt('Enter phone number to send the code:'); if (!phone) return; const msg=`ZippUp delivery code for Order ${last.orderId||''}: ${last.code}. Do NOT share until delivery.`; location.href=`sms:${encodeURIComponent(phone)}?body=${encodeURIComponent(msg)}`; };
    })();

    (async function boot(){
      $('userName').textContent = user.name;
      await initLocation();
      renderServices(); renderServicesAll(); renderEmergency(); renderRecent();
      document.getElementById('closeProviders').onclick = ()=>$('providersModal').classList.remove('open');
      document.getElementById('closeCategoryOptions').onclick=()=>$('categoryOptionsModal').classList.remove('open');
      // Stripe return messages (no auto success on cancel)
      const q=new URLSearchParams(location.search); const c=q.get('checkout'); if (c==='success') alert("Don't share your delivery code until goods are delivered and confirmed."); if (c==='cancel') alert('Card payment cancelled.');
    })();
  </script>
</body>
</html>
