<script>
// App State
let currentUser = null;
let isAuthenticated = false;
let currentPage = 'home';
let currentLocation = null;
let bookings = [];
let cart = [];
let myServices = [];
let marketplaceProducts = [];
let emergencyContacts = [];
let deferredPrompt = null;
let userCurrency = '$';
let userCountry = 'US';
let isProvider = false;
let providerAvailable = true;
let commissionDebt = 0;
let stripe = null;
let currentBookingProvider = null;
let panicAlertActive = false;

// Mock user database with password reset
const mockUsers = [
  {
    email: 'demo@zippup.com',
    password: 'password123',
    name: 'Demo User',
    phone: '+1234567890',
    isProvider: false,
    profileImage: null,
    emergencyContacts: [],
    walletBalance: 245.80,
    commissionDebt: 0,
    verified: true
  },
  {
    email: 'provider@zippup.com',
    password: 'provider123',
    name: 'Provider Demo',
    phone: '+1234567891',
    isProvider: true,
    profileImage: null,
    emergencyContacts: [],
    walletBalance: 890.50,
    commissionDebt: 0,
    verified: true
  }
];

// Services Data
const services = [
  { id: 1, name: 'Ride', icon: 'ðŸš—', description: 'Taxi and ride services', examples: ['Taxi', 'Airport transfer', 'Long distance'], priceMin: 15, priceMax: 80, type: 'transport', hasInstant: true, hasScheduled: true },
  { id: 2, name: 'Personal Care', icon: 'ðŸ’…', description: 'Beauty and wellness', examples: ['Hair', 'Nails', 'Massage', 'Makeup', 'Yoga'], priceMin: 40, priceMax: 200, type: 'care', hasInstant: true, hasScheduled: true },
  { id: 3, name: 'Tech Repair', icon: 'ðŸ“±', description: 'Phone and computer repair', examples: ['Phone repair', 'Laptop fix', 'Software help'], priceMin: 30, priceMax: 150, type: 'tech', hasInstant: true, hasScheduled: true },
  { id: 4, name: 'Home Services', icon: 'ðŸ§¹', description: 'Cleaning and maintenance', examples: ['Cleaning', 'Plumbing', 'Electrician', 'Pest control'], priceMin: 50, priceMax: 300, type: 'home', hasInstant: true, hasScheduled: true },
  { id: 5, name: 'Construction', icon: 'ðŸ—ï¸', description: 'Building and renovation', examples: ['Building', 'Carpentry', 'Painting', 'Architecture'], priceMin: 100, priceMax: 500, type: 'construction', hasInstant: true, hasScheduled: true },
  { id: 6, name: 'Emergency', icon: 'ðŸš¨', description: 'Urgent help services', examples: ['Ambulance', 'Fire services', 'Roadside help', 'Towing'], price: 0, type: 'emergency', hasInstant: true, hasScheduled: false },
  { id: 7, name: 'Food Delivery', icon: 'ðŸ”', description: 'Restaurant & grocery', examples: ['Restaurant delivery', 'Grocery shopping', 'Fast food'], priceMin: 10, priceMax: 60, type: 'food', hasInstant: true, hasScheduled: true },
  { id: 8, name: 'Digital Services', icon: 'ðŸ“±', description: 'Airtime, data & bills', examples: ['Buy airtime', 'Buy data', 'Pay bills', 'Buy digital products'], priceMin: 1, priceMax: 500, type: 'digital', hasInstant: true, hasScheduled: false }
];

// Providers Data
const providers = {
  transport: [
    { id: 101, name: 'Fast Cab', avatar: 'ðŸš•', rating: 4.8, jobs: 1200, experience: '5 years', price: '20-100', description: 'Reliable taxi services', distance: '1.2km' },
    { id: 102, name: 'Luxury Rides', avatar: 'ðŸš˜', rating: 4.9, jobs: 890, experience: '4 years', price: '50-200', description: 'Premium car services', distance: '2.5km' }
  ],
  care: [
    { id: 103, name: 'Beauty Pro', avatar: 'ðŸ’‡', rating: 4.7, jobs: 450, experience: '3 years', price: '60-150', description: 'Professional hair and makeup', distance: '1.8km' }
  ],
  tech: [
    { id: 104, name: 'Tech Fix', avatar: 'ðŸ”§', rating: 4.6, jobs: 670, experience: '4 years', price: '40-120', description: 'Phone and laptop repair', distance: '0.9km' }
  ],
  home: [
    { id: 105, name: 'Clean Master', avatar: 'ðŸ§½', rating: 4.5, jobs: 340, experience: '2 years', price: '50-120', description: 'Professional cleaning services', distance: '1.5km' }
  ],
  construction: [
    { id: 106, name: 'Build Right', avatar: 'ðŸ‘·', rating: 4.8, jobs: 230, experience: '6 years', price: '100-400', description: 'Construction and renovation', distance: '3.0km' }
  ],
  food: [
    { id: 107, name: 'Quick Bites', avatar: 'ðŸŸ', rating: 4.4, jobs: 560, experience: '2 years', price: '10-50', description: 'Fast food delivery', distance: '1.0km' }
  ],
  digital: [
    { id: 108, name: 'Airtime Pro', avatar: 'ðŸ“¶', rating: 4.9, jobs: 2000, experience: '3 years', price: '1-500', description: 'Instant airtime and data', distance: '0.5km' }
  ],
  automobile: [
    { id: 201, name: 'Tow Master', avatar: 'ðŸš›', rating: 4.8, jobs: 410, experience: '5 years', price: '80-200', description: 'Professional towing services', distance: '3.2km' },
    { id: 202, name: 'Van Express', avatar: 'ðŸš', rating: 4.6, jobs: 320, experience: '4 years', price: '30-80', description: 'Van rental and delivery services', distance: '2.1km' },
    { id: 203, name: 'Pickup Pro', avatar: 'ðŸ›»', rating: 4.7, jobs: 280, experience: '3 years', price: '25-60', description: 'Pickup truck services for medium loads', distance: '1.8km' }
  ]
};

// Initialize Stripe
if (window.Stripe) {
  stripe = Stripe('pk_test_your_stripe_publishable_key'); // Replace with your actual Stripe key
}

// ======================
// DOM EVENT LISTENERS
// ======================
function setupEventListeners() {
  // Auth
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    loginForm.addEventListener('submit', handleLogin);
  }

  const registerForm = document.getElementById('register-form');
  if (registerForm) {
    registerForm.addEventListener('submit', handleRegister);
  }

  document.getElementById('forgot-password')?.addEventListener('click', handleForgotPassword);
  document.getElementById('toggle-auth')?.addEventListener('click', toggleAuthMode);

  // Navigation
  document.querySelectorAll('.nav-item').forEach(element => {
    element.addEventListener('click', () => {
      const page = element.getAttribute('data-page');
      navigateToPage(page);
      document.getElementById('dropdown-menu').classList.remove('active');
    });
  });

  // Profile
  document.getElementById('edit-profile')?.addEventListener('click', editProfile);
  document.getElementById('change-profile-image')?.addEventListener('click', () => {
    document.getElementById('profile-image-input').click();
  });
  document.getElementById('profile-image-input')?.addEventListener('change', (e) => {
    if (e.target.files[0]) {
      changeProfileImage(e.target.files[0]);
    }
  });
  document.getElementById('edit-profile-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    saveProfile(formData);
  });

  // Emergency
  document.getElementById('manage-emergency-contacts')?.addEventListener('click', manageEmergencyContacts);
  document.getElementById('add-emergency-contact')?.addEventListener('click', addEmergencyContact);

  // Modal Close
  document.getElementById('close-edit-profile')?.addEventListener('click', () => {
    document.getElementById('edit-profile-modal').style.display = 'none';
  });
  document.getElementById('close-emergency-contacts')?.addEventListener('click', () => {
    document.getElementById('emergency-contacts-modal').style.display = 'none';
  });

  // Provider Toggle
  document.getElementById('availability-toggle')?.addEventListener('click', () => {
    providerAvailable = !providerAvailable;
    updateProviderStatus();
    showNotification(`You are now ${providerAvailable ? 'available' : 'unavailable'} for bookings`, 'info');
  });

  // Marketplace
  document.getElementById('upload-product-btn')?.addEventListener('click', () => {
    navigateToPage('upload-product');
  });
  document.getElementById('product-upload-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    handleProductUpload(formData);
  });

  // Search
  document.getElementById('search-input')?.addEventListener('input', (e) => {
    handleSearchInput(e.target.value);
  });
  document.getElementById('search-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleSearchEnter(e.target.value);
    }
  });
  document.getElementById('voice-btn')?.addEventListener('click', startVoiceSearch);

  // Panic Button
  document.getElementById('panic-btn')?.addEventListener('click', triggerPanicAlert);

  // Booking
  document.getElementById('book-instant')?.addEventListener('click', () => bookService('instant'));
  document.getElementById('book-scheduled')?.addEventListener('click', () => bookService('scheduled'));
  document.getElementById('confirm-booking')?.addEventListener('click', () => bookService('instant'));

  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.profile-section')) {
      document.getElementById('dropdown-menu')?.classList.remove('active');
    }
  });
}

// ======================
// APP INITIALIZATION
// ======================
function initApp() {
  console.log('ðŸš€ Initializing Enterprise ZippUp...');

  // Check saved login
  const savedUser = localStorage.getItem('zippup_user');
  if (savedUser) {
    try {
      currentUser = JSON.parse(savedUser);
      isAuthenticated = true;
      isProvider = currentUser.isProvider || false;
      commissionDebt = currentUser.commissionDebt || 0;
    } catch (error) {
      console.error('Failed to parse saved user', error);
      localStorage.removeItem('zippup_user');
    }
  }

  // Detect region and set currency
  detectRegionAndCurrency();

  // Hide splash screen after 2 seconds
  setTimeout(() => {
    const splash = document.getElementById('splash-screen');
    if (splash) {
      splash.style.opacity = '0';
      setTimeout(() => {
        splash.style.display = 'none';
        if (isAuthenticated) {
          showMainApp();
        } else {
          showAuthScreen();
        }
      }, 500);
    }
  }, 2000);

  // Initialize features
  setupEventListeners();
  loadServices();
  loadBookings();
  loadMyServices();
  loadMarketplaceProducts();
  loadCart();
  loadEmergencyContacts();
  initializeLocation();
  initializePWA();
  updateProviderStatus();
  loadWalletTransactions();
}

// Attach after DOM loads
document.addEventListener('DOMContentLoaded', initApp);

// ======================
// PAGE NAVIGATION
// ======================
function navigateToPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`${page}-page`)?.classList.add('active');
  currentPage = page;
  updatePageContent(page);
}

function updatePageContent(page) {
  switch (page) {
    case 'home':
      loadServices();
      break;
    case 'wallet':
      updateWalletDisplay();
      loadWalletTransactions();
      break;
    case 'my-services':
      loadMyServices();
      break;
    case 'marketplace':
      loadMarketplaceProducts();
      break;
    case 'automobile':
      showAutomobileProviders();
      break;
  }
}

// ======================
// AUTH FUNCTIONS
// ======================
function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const loginBtn = document.getElementById('login-btn');

  if (!validateLogin(email, password)) return;

  loginBtn.classList.add('loading');
  loginBtn.disabled = true;

  setTimeout(() => {
    const user = mockUsers.find(u => u.email === email && u.password === password);
    if (user) {
      currentUser = { ...user };
      isAuthenticated = true;
      isProvider = user.isProvider;
      commissionDebt = user.commissionDebt;

      localStorage.setItem('zippup_user', JSON.stringify(currentUser));
      showMainApp();
      showNotification('ðŸ‘‹ Welcome back!', 'success');
    } else {
      showError('login-email', 'Invalid email or password');
    }
    loginBtn.classList.remove('loading');
    loginBtn.disabled = false;
  }, 1000);
}

function handleRegister(e) {
  e.preventDefault();
  const name = document.getElementById('register-name').value;
  const email = document.getElementById('register-email').value;
  const phone = document.getElementById('register-phone').value;
  const password = document.getElementById('register-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const registerBtn = document.getElementById('register-btn');

  if (!validateRegister(name, email, phone, password, confirmPassword)) return;

  registerBtn.classList.add('loading');
  registerBtn.disabled = true;

  setTimeout(() => {
    if (mockUsers.some(u => u.email === email)) {
      showError('register-email', 'Email already registered');
      registerBtn.classList.remove('loading');
      registerBtn.disabled = false;
      return;
    }

    const newUser = {
      email,
      password,
      name,
      phone,
      isProvider: false,
      profileImage: null,
      emergencyContacts: [],
      walletBalance: 50.00,
      commissionDebt: 0,
      verified: false
    };

    mockUsers.push(newUser);
    currentUser = newUser;
    isAuthenticated = true;
    isProvider = false;

    localStorage.setItem('zippup_user', JSON.stringify(newUser));
    showMainApp();
    showNotification('ðŸŽ‰ Account created! Welcome bonus: $50.00 added to wallet!', 'success');

    registerBtn.classList.remove('loading');
    registerBtn.disabled = false;
  }, 1500);
}

function validateLogin(email, password) {
  let isValid = true;
  if (!email) {
    showError('login-email', 'Email or phone is required');
    isValid = false;
  }
  if (!password) {
    showError('login-password', 'Password is required');
    isValid = false;
  }
  return isValid;
}

function validateRegister(name, email, phone, password, confirmPassword) {
  let isValid = true;
  if (!name) {
    showError('register-name', 'Name is required');
    isValid = false;
  }
  if (!email) {
    showError('register-email', 'Email is required');
    isValid = false;
  } else if (!/\S+@\S+\.\S+/.test(email)) {
    showError('register-email', 'Email is invalid');
    isValid = false;
  }
  if (!phone) {
    showError('register-phone', 'Phone number is required');
    isValid = false;
  }
  if (!password || password.length < 6) {
    showError('register-password', 'Password must be at least 6 characters');
    isValid = false;
  }
  if (password !== confirmPassword) {
    showError('confirm-password', 'Passwords do not match');
    isValid = false;
  }
  return isValid;
}

function handleForgotPassword() {
  const email = prompt('Enter your email address:');
  if (!email) return;

  const user = mockUsers.find(u => u.email === email);
  if (user) {
    const code = Math.random().toString(36).substr(2, 6).toUpperCase();
    console.log('Reset code:', code); // In real app: send via email
    const enteredCode = prompt('Enter the reset code sent to your email:');
    if (enteredCode && enteredCode.toUpperCase() === code) {
      const newPassword = prompt('Enter your new password (min 6 characters):');
      if (newPassword && newPassword.length >= 6) {
        user.password = newPassword;
        showNotification('âœ… Password reset successful! You can now login.', 'success');
      } else {
        showNotification('âŒ Password must be at least 6 characters', 'error');
      }
    } else {
      showNotification('âŒ Invalid reset code', 'error');
    }
  } else {
    showNotification('âŒ Email not found in our system', 'error');
  }
}

function toggleAuthMode() {
  const authContainer = document.getElementById('auth-container');
  authContainer.classList.toggle('show-register');
}

function showError(fieldId, message) {
  const field = document.getElementById(fieldId);
  const error = document.getElementById(`${fieldId}-error`);
  if (field && error) {
    field.classList.add('error');
    error.textContent = message;
  }
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 300);
  }, 3000);
}

function showAuthScreen() {
  document.getElementById('auth-screen').style.display = 'flex';
}

function showMainApp() {
  document.getElementById('app').style.display = 'block';
  if (currentUser) {
    document.getElementById('user-name').textContent = currentUser.name;
    document.getElementById('profile-name-display').textContent = currentUser.name;
    document.getElementById('profile-email-display').textContent = currentUser.email;
    document.getElementById('profile-phone-display').textContent = currentUser.phone || 'Not provided';
    document.getElementById('user-initials').textContent = currentUser.name.charAt(0).toUpperCase();

    if (currentUser.profileImage) {
      document.getElementById('user-profile-image').src = currentUser.profileImage;
      document.getElementById('user-profile-image').style.display = 'block';
      document.getElementById('profile-image-display').src = currentUser.profileImage;
      document.getElementById('profile-image-display').style.display = 'block';
      document.getElementById('user-initials').style.display = 'none';
      document.getElementById('profile-initials-display').style.display = 'none';
    }

    if (currentUser.verified) {
      document.getElementById('verification-badge').style.display = 'flex';
    }

    document.getElementById('wallet-main-balance').textContent = userCurrency + (currentUser.walletBalance || 0).toFixed(2);

    if (currentUser.commissionDebt > 0) {
      document.getElementById('commission-debt').classList.remove('hidden');
      document.getElementById('debt-amount').textContent = userCurrency + currentUser.commissionDebt.toFixed(2);
    }

    if (isProvider) {
      document.getElementById('provider-features').style.display = 'block';
      document.getElementById('provider-status').classList.remove('hidden');
      updateProviderStatus();
    }
  }
}

// Add any missing UI functions below...
function updateProviderStatus() {
  const status = document.getElementById('provider-status');
  if (status) {
    status.innerHTML = `
      <div class="provider-status ${providerAvailable ? 'available' : 'unavailable'}">
        <span class="status-indicator"></span>
        ${providerAvailable ? 'Available for bookings' : 'Unavailable'}
      </div>
    `;
  }
}

function detectRegionAndCurrency() {
  const regionMap = { 'New_York': 'US', 'London': 'UK', 'Lagos': 'NG', 'Nairobi': 'KE', 'Sydney': 'AU' };
  const currencyMap = { 'US': '$', 'UK': 'Â£', 'NG': 'â‚¦', 'KE': 'KSh', 'AU': '$' };
  const region = 'Lagos'; // Simulated geolocation
  userCountry = regionMap[region] || 'US';
  userCurrency = currencyMap[userCountry] || '$';
  updateCurrencyDisplay();
}

function updateCurrencyDisplay() {
  document.querySelectorAll('.currency').forEach(element => {
    const text = element.textContent;
    const match = text.match(/[\d.]+/);
    if (match) {
      const number = match[0];
      element.textContent = text.replace(/[\d.]+/, userCurrency + number);
    }
  });
}

function initializePWA() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(registration => {
      console.log('âœ… Service Worker registered');
    }).catch(error => console.log('âŒ SW registration failed:', error));
  }
}

function loadServices() {
  const container = document.getElementById('services');
  if (!container) return;
  container.innerHTML = '';
  services.forEach(service => {
    const card = document.createElement('div');
    card.className = 'service-card';
    card.innerHTML = `
      <div class="service-icon">${service.icon}</div>
      <div class="service-name">${service.name}</div>
      <p class="service-description">${service.description}</p>
      <p style="font-weight: 600; color: var(--primary);">${userCurrency}${service.priceMin} - ${userCurrency}${service.priceMax}</p>
    `;
    card.addEventListener('click', () => navigateToPage('booking'));
    container.appendChild(card);
  });
}

// Add other missing functions like:
// - loadBookings()
// - loadMyServices()
// - loadMarketplaceProducts()
// - loadCart()
// - loadEmergencyContacts()
// - initializeLocation()
// - handleProductUpload()
// - bookService()
// - triggerPanicAlert()
// - etc.

// You can add them gradually as needed

</script>
