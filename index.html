<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp — On‑Demand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- SDKs -->
  <script src="https://js.stripe.com/v3"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827;
      --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --header-h:56px; --nav-h:64px;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; max-width:100%; overflow-x:hidden; -webkit-text-size-adjust:100% }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }

    header {
      position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:100;
      background:var(--card); border-bottom:1px solid var(--border); display:flex; align-items:center;
      padding-top: env(safe-area-inset-top, 0px);
    }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; width:100% }
    .small { color:var(--muted); font-size:13px }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }

    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; max-width:100% }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#eef2ff; display:flex; align-items:center; justify-content:center; font-size:18px }
    .field { display:flex; flex-direction:column; gap:6px }
    .field input, .field textarea, .field select { padding:10px; border:1px solid var(--border); border-radius:10px }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:100% }
    .price { font-weight:700; color:#111 }
    .hint { font-size:12px; color:#6b7280 }

    .nav {
      position:fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      display:flex; align-items:center; justify-content:space-around; background:#fff; border-top:1px solid var(--border); z-index:90;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }

    .page {
      position:fixed; top:calc(var(--header-h) + env(safe-area-inset-top, 0px)); bottom:var(--nav-h); left:0; right:0;
      overflow-y:auto; overflow-x:hidden; display:none; -webkit-overflow-scrolling:touch; background:var(--bg);
    }
    .page.active { display:block }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:200; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow); max-width:100% }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px }

    .floating-panic { position:fixed; right:16px; bottom:80px; width:60px; height:60px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:96; display:flex; align-items:center; justify-content:center }

    #cartBtn, #headerCartBadge { display:none !important; }

    .product img { width:100%; height:140px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }

    header .row { align-items:center; }
    header .row > .left { flex:1; min-width:0; }
    #notifBtn { margin-right:6px; }

    #checkoutModal .sheet, #sellModal .sheet, #trackModal .sheet { height: calc(100vh - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px)); display:flex; flex-direction:column; }
    #checkoutModal .sheet .body, #sellModal .sheet .body, #trackModal .sheet .body { flex:1; overflow:auto; }

    /* scrolling comfort for manage-products and marketplace */
    #page-manage-products, #page-marketplace { overflow-x:auto; overflow-y:auto; }

    .backbar { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); z-index:5; display:flex; align-items:center; gap:8px; padding:8px 4px 8px 0; }

    /* Support FAQ styles */
    #faqList .q { font-weight:700; cursor:pointer }
    #faqList .a { display:none; color:#374151 }
    #faqList .item { padding:10px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; background:#fff }
    /* Make these pages scroll both ways */
#page-manage-services,
#page-emergency-contacts,
#page-support { overflow-x: auto; overflow-y: auto; }

/* Profile list: align buttons with chevron to indicate navigation */
#page-profile .list > button {
  width: 100%;
  justify-content: space-between;
}
#page-profile .list > button::after {
  content: '›';
  opacity: .6;
}

/* Dark mode variables */
body[data-theme="dark"] {
  --bg:#0B1020; --card:#0F172A; --text:#E5E7EB; --muted:#9CA3AF;
  --border:#1F2A44; --primary:#3B82F6; --primary-600:#2563EB; --shadow:0 8px 24px rgba(0,0,0,.35);
}
body[data-theme="dark"] .card,
body[data-theme="dark"] .sheet { background: var(--card); border-color: var(--border); }
body[data-theme="dark"] .search .box { background: var(--card); border-color: var(--border); }

/* Marketplace advisory note */
#marketAdvisory {
  background:#FFF7ED; border:1px solid #FED7AA; color:#7C2D12;
  border-radius:12px; padding:10px; margin:10px 16px; font-size:13px;
}

/* Promotions strip */
#promoStrip {
  margin: 8px 16px 0; overflow: hidden; border:1px solid var(--border); border-radius:12px; background:#fff;
}
#promoStrip .inner {
  display:flex; gap:16px; padding:10px; white-space:nowrap; animation: slidePromo 24s linear infinite;
}
@keyframes slidePromo {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
  /* Allow extra scrolling on these pages */
#page-manage-services,
#page-emergency-contacts,
#page-support { overflow-x: auto; overflow-y: auto; }

/* Profile nav buttons: full width with chevron */
#page-profile .list > button { width:100%; justify-content:space-between; }
#page-profile .list > button::after { content:'›'; opacity:.6; }

/* Dark mode palette */
body[data-theme="dark"] {
  --bg:#0B1020; --card:#0F172A; --text:#E5E7EB; --muted:#9CA3AF; --border:#1F2A44;
  --primary:#3B82F6; --primary-600:#2563EB; --shadow:0 8px 24px rgba(0,0,0,.35);
}
body[data-theme="dark"] .card,
body[data-theme="dark"] .sheet { background:var(--card); border-color:var(--border); }
body[data-theme="dark"] .search .box { background:var(--card); border-color:var(--border); }

/* Marketplace advisory note */
#marketAdvisory {
  background:#FFF7ED; border:1px solid #FED7AA; color:#7C2D12;
  border-radius:12px; padding:10px; margin:10px 16px; font-size:13px;
}

/* Promotions board under Emergency */
#promoBoard { margin:12px 16px; }
#promoGrid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
@media(min-width:720px){ #promoGrid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
.promoCard { background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
    /* Promo carousels */
#promoBoard { margin:12px 16px; }
#promoBoard .sectionTitle { font-weight:700; margin:12px 0 8px; }
.promoRow { display:flex; gap:12px; overflow-x:auto; padding:4px 2px; scroll-snap-type:x mandatory; }
.promoMini { min-width:68%; max-width:68%; scroll-snap-align:start; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); }
@media(min-width:720px){ .promoMini{ min-width:32%; max-width:32%; } }
.promoMini .thumb { width:100%; height:110px; object-fit:cover; border-top-left-radius:12px; border-top-right-radius:12px; border-bottom:1px solid var(--border); }
.promoMini .content { padding:10px; display:flex; flex-direction:column; gap:4px }
.promoMini .title { font-weight:700 }
.promoMini .sub { font-size:12px; color:var(--muted) }
.promoCTA { display:flex; align-items:center; justify-content:center; height:110px; font-weight:700; font-size:14px; }
    /* Promo carousels with provider/product mini-cards */
#promoBoard { margin:12px 16px; }
.promoSec { margin:14px 0; }
.promoSec .sectionTitle { font-weight:700; margin:0 0 8px; }
.promoRow { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
@media(min-width:720px){ .promoRow{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
.promoMini { background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); overflow:hidden; cursor:pointer; }
.promoMini .thumb { width:100%; height:110px; object-fit:cover; border-bottom:1px solid var(--border); background:#f3f4f6; display:flex; align-items:center; justify-content:center; font-size:20px; }
.promoMini .content { padding:10px; display:flex; flex-direction:column; gap:4px }
.promoMini .title { font-weight:700; }
.promoMini .sub { font-size:12px; color:var(--muted) }
    /* Green action button */
.btn.success { background: var(--success); color:#fff; }
.btn.success:hover { filter: brightness(0.95); }
    /* Admin page */
#page-admin { overflow-x:auto; overflow-y:auto; }
.admin-tabs { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; }
.admin-tabs .btn.active { background:var(--primary); color:#fff; }
.admin-grid { display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:720px){ .admin-grid { grid-template-columns:1fr 1fr; } }
.admin-note { font-size:12px; color:var(--muted) }
}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="left"></div>
      <div class="row">
        <button class="btn ghost" id="notifBtn" type="button" title="Notifications">🔔</button>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn" type="button">👤 Account</button>
          <div id="profileMenu" style="position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:220px; z-index:300; padding:6px">
            <button class="btn ghost" id="menuProfile" type="button">👤 Profile</button>
            <button class="btn ghost" id="menuOrders" type="button">📦 Manage Orders</button>
            <button class="btn ghost" id="menuWallet" type="button">💰 Wallet</button>
            <button class="btn ghost" id="menuTopup" type="button">⚡ Top‑up (Digital)</button>
            <button class="btn ghost" id="menuSupport" type="button">🆘 Contact Support</button>
            <button class="btn ghost" id="menuLogout" type="button">🚪 Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="page-home" class="page active">
    <section class="section">
      <div class="small">📍 <span id="userLocUnder">Detecting location…</span></div>
    </section>
    <section class="section">
      <div id="homeMap" style="height:180px;border-radius:12px;border:1px solid var(--border)"></div>
    </section>
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency…"/>
        <button class="btn ghost" id="voiceBtn" type="button">🎤</button>
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </section>
    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>
    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>
  </main>

  <main id="page-marketplace" class="page">
    <section class="section">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="title" style="margin:0">Marketplace</div>
        <button class="btn ghost" id="sellProductsBtn" type="button">Sell Products</button>
      </div>
      <div class="search">
        <div class="box">
          <input id="mpSearch" placeholder="Search products…"/>
          <button class="btn ghost" id="mpVoice" type="button">🎤</button>
          <button class="btn primary" id="mpSearchBtn" type="button">Search</button>
        </div>
      </div>
      <div class="row" id="mpChips" style="gap:6px;margin:8px 0"></div>
      <div class="grid" id="mpGrid"></div>
    </section>
  </main>

  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row">
            <div id="user-avatar" style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">👤</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Guest</strong> <span class="small muted">(Public name)</span></div>
              <div class="small" id="profEmail">guest@example.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><strong>Availability</strong><div class="small muted">Go Offline / Available</div></div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="availToggle" type="checkbox" style="display:none"/>
            <span id="availTrack" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px;transition:.2s"></span>
            <span id="availKnob" style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s"></span>
          </label>
        </div>
      </div>

      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn" type="button">Manage Product (Food Vendors Only)</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
        <button class="btn ghost" id="openSupportBtn" type="button">Contact Support</button>
      </div>
    </section>
  </main>

  <main id="page-orders" class="page">
    <section class="section">
      <div class="title">Manage Orders</div>
      <div class="card">
        <div class="list">
          <div class="small muted">Active</div>
          <div id="buyerOrders" class="list"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="list">
          <div class="small muted">History</div>
          <div id="sellerOrders" class="list"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong id="walletBalance">$0.00</strong></div>
      <div class="row" style="gap:8px;margin-top:8px">
        <button class="btn ghost" id="walletAdd" type="button">Add Funds (Coming soon)</button>
        <button class="btn ghost" id="walletCashOut" type="button">Cash Out (Coming soon)</button>
        <button class="btn ghost" id="walletSend" type="button">Send to user</button>
        <button class="btn ghost" id="walletCards" type="button">Saved cards</button>
      </div>
      <div class="title" style="margin-top:12px">Transactions</div>
      <div id="walletTx" class="grid"></div>
    </section>
  </main>

  <main id="page-digital" class="page">
    <section class="section">
      <div class="title">Digital Services</div>
      <div class="grid" style="margin-top:8px">
        <div class="card service">📱 Buy Airtime</div>
        <div class="card service">📶 Buy Data</div>
        <div class="card service">🧾 Pay Bills</div>
        <div class="card service">🛒 Digital Products</div>
      </div>
      <div class="small muted" style="margin-top:8px">Coming soon</div>
    </section>
  </main>

  <main id="page-manage-services" class="page">
    <section class="section">
      <div class="backbar"><button class="btn ghost" id="msBack" type="button">← Back</button><strong>Manage Services</strong></div>
      <div class="card">
        <div class="list">
          <div class="grid-2">
            <div class="field">
              <label class="small">Category</label>
              <select id="msCategory">
                <option value="transport">Transport</option>
                <option value="food">Food</option>
                <option value="tech">Tech Services</option>
                <option value="home">Home Services</option>
                <option value="construction">Construction</option>
                <option value="auto">Automobile Repair</option>
                <option value="others">Others</option>
              </select>
            </div>
            <div class="field" id="msTransportSubWrap" style="display:none">
              <label class="small">Transport type</label>
              <select id="msTransportSub">
                <option value="taxi">Ride / Taxi</option>
                <option value="truck">Truck / Backie</option>
              </select>
            </div>
            <div class="field" id="msTypeWrap">
              <label class="small">Service type</label>
              <input id="msType" placeholder="e.g., Driver, Plumber"/>
            </div>
          </div>
          <div class="field">
            <label class="small">Details</label>
            <textarea id="msDetails" rows="3" placeholder="Describe your service…"></textarea>
          </div>
          <div class="grid-2">
            <div class="field">
              <label class="small">Price (per 1–2hr)</label>
              <input id="msPrice" type="number" min="0" step="0.01" placeholder="e.g., 50"/>
            </div>
            <div class="field">
              <label class="small">Catalog images (up to 4)</label>
              <input id="msImages" type="file" accept="image/*" multiple/>
              <div class="hint">Optional</div>
            </div>
          </div>
          <button class="btn primary" id="msAdd" type="button">+ Add Service</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="msList"></div>
    </section>
  </main>

  <main id="page-manage-products" class="page">
    <section class="section">
      <div class="backbar"><button class="btn ghost" id="mpBack" type="button">← Back</button><strong>Manage Product (Food Vendors Only)</strong></div>
      <div class="card">
        <div class="small muted" style="margin-bottom:8px">Upload multiple items per batch; up to 5 images per item; set payment options.</div>
        <div id="foodItemsForm"></div>
        <button class="btn ghost" id="addFoodRow" type="button">+ Add another item</button>
        <button class="btn primary" id="saveFoodItems" type="button" style="margin-top:10px">Save items</button>
      </div>
      <div class="list" id="foodItemsList" style="margin-top:12px"></div>
    </section>
  </main>

  <main id="page-emergency-contacts" class="page">
    <section class="section">
      <div class="backbar"><button class="btn ghost" id="ecBack" type="button">← Back</button><strong>Emergency Contacts</strong></div>
      <div class="card">
        <div class="small muted">Add up to 5 contacts (name and phone).</div>
        <div id="ecForm" class="list" style="margin-top:10px"></div>
        <button class="btn primary" id="ecSave" type="button">Save Contacts</button>
      </div>
    </section>
  </main>

  <main id="page-verify-provider" class="page">
    <section class="section">
      <div class="backbar"><button class="btn ghost" id="vpBack" type="button">← Back</button><strong>Become Verified Provider</strong></div>
      <div class="card">
        <div class="list">
          <div class="field"><label class="small">Full name</label><input id="vpName" placeholder="Your name"/></div>
          <div class="field"><label class="small">Address</label><input id="vpAddress" placeholder="Your address"/></div>
          <div class="field"><label class="small">Service category</label><input id="vpCategory" placeholder="e.g., Driver, Plumber"/></div>
          <div class="field"><label class="small">ID number</label><input id="vpId" placeholder="Your ID"/></div>
          <div class="field"><label class="small">ID/Passport docs</label><input id="vpIdDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <div class="field"><label class="small">Business/License docs</label><input id="vpBizDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <button class="btn primary" id="vpSubmit" type="button">Submit for Verification</button>
          <div id="vpStatus" class="small" style="color:#2563EB"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="page-support" class="page">
    <section class="section">
      <div class="backbar"><button class="btn ghost" id="supportBack" type="button">← Back</button><strong>Contact Support</strong></div>
      <div class="card">
        <div class="list">
          <div class="title" style="margin-top:0">Help center</div>
          <div id="faqList"></div>
          <div class="small muted" style="margin:8px 0 6px">Not satisfied with the answers? Fill the form below to contact support.</div>
          <div class="grid-2">
            <div class="field"><label class="small">Full name</label><input id="supName" placeholder="Your name"/></div>
            <div class="field"><label class="small">Email</label><input id="supEmail" placeholder="you@example.com"/></div>
          </div>
          <div class="field"><label class="small">Contact number</label><input id="supPhone" placeholder="+27XXXXXXXXX"/></div>
          <div class="field"><label class="small">Message</label><textarea id="supMsg" rows="4" placeholder="Describe your issue…"></textarea></div>
          <button class="btn primary" id="supSend" type="button">Send</button>
          <div class="small" style="margin-top:8px">Prefer to call? <a href="tel:0784079686">078 407 9686</a></div>
        </div>
      </div>
    </section>
  </main>

<main id="page-admin" class="page">
  <section class="section">
    <div class="title">Admin</div>
    <div class="admin-note" id="adminRoleNote">Checking admin access…</div>

    <div class="admin-tabs" id="adminTabs">
      <button class="btn ghost" data-admin-tab="orders" type="button">Orders</button>
      <button class="btn ghost" data-admin-tab="vendors" type="button">Vendors (Food)</button>
      <button class="btn ghost" data-admin-tab="market" type="button">Marketplace</button>
      <button class="btn ghost" data-admin-tab="users" type="button">Users/KYC</button>
      <button class="btn ghost" data-admin-tab="wallet" type="button">Wallet</button>
      <button class="btn ghost" data-admin-tab="emergency" type="button">Emergency</button>
      <button class="btn ghost" data-admin-tab="promos" type="button">Promotions</button>
    </div>

    <div id="adminView">
      <div id="admin-orders" class="admin-grid" style="display:none"></div>
      <div id="admin-vendors" class="admin-grid" style="display:none"></div>
      <div id="admin-market" class="admin-grid" style="display:none"></div>
      <div id="admin-users" class="admin-grid" style="display:none"></div>
      <div id="admin-wallet" class="admin-grid" style="display:none"></div>
      <div id="admin-emergency" class="admin-grid" style="display:none">
        <div class="card">
          <div class="list">
            <div class="field"><label class="small">Region (e.g., ZA-GP)</label><input id="admEmerRegion" placeholder="Country/Area code"/></div>
            <div class="field"><label class="small">Default emergency number</label><input id="admEmerNumber" placeholder="+27…"/></div>
            <button class="btn primary" id="admEmerSave" type="button">Save default</button>
            <div class="small muted" id="admEmerStatus"></div>
          </div>
        </div>
      </div>
      <div id="admin-promos" class="admin-grid" style="display:none">
        <div class="card">
          <div class="list">
            <div class="field"><label class="small">Title</label><input id="admPromoTitle" placeholder="e.g., High‑rated taxi drivers around you"/></div>
            <div class="field"><label class="small">Type</label>
              <select id="admPromoType">
                <option value="transport">transport</option>
                <option value="providers">providers</option>
                <option value="marketplace">marketplace</option>
                <option value="food">food</option>
              </select>
            </div>
            <div class="field"><label class="small">Payload (JSON)</label><textarea id="admPromoPayload" rows="3" placeholder='{"kind":"taxi"}'></textarea></div>
            <button class="btn primary" id="admPromoSave" type="button">Publish</button>
            <div class="small muted" id="admPromoStatus"></div>
          </div>
        </div>
        <div class="card">
          <div class="title" style="margin:0 0 6px">Existing promotions</div>
          <div id="admPromoList" class="list"></div>
        </div>
      </div>
    </div>
  </section>
</main>
  
  <nav class="nav">
    <button data-page="home" class="active" type="button">🏠 Home</button>
    <button data-page="orders" type="button">📋 My Bookings</button>
    <button data-page="marketplace" type="button">🛍️ Marketplace</button>
    <button data-page="profile" type="button">👤 Profile</button>
  </nav>

  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders" type="button">✖</button>
      </div>
      <div class="body">
        <div class="row" id="provSearchRow" style="gap:8px;margin-bottom:10px;display:none">
          <input id="provSearch" placeholder="Search providers or specialties…" style="flex:1"/>
          <button class="btn ghost" id="provVoice" type="button">🎤</button>
          <button class="btn primary" id="provSearchBtn" type="button">Search</button>
        </div>
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking" type="button">✖</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="grid-2">
            <div class="field"><label class="small">Date</label><input id="bkDate" type="date" required/></div>
            <div class="field"><label class="small">Time</label><input id="bkTime" type="time" required/></div>
          </div>
          <div class="field">
            <label class="small">Address</label>
            <div class="row" style="gap:8px">
              <input id="bkAddress" required placeholder="Enter address" style="flex:1"/>
              <button class="btn ghost" id="bkUseCurrent" type="button">📍 Use current</button>
            </div>
            <div id="bkSuggest" class="list" style="margin-top:6px"></div>
          </div>
          <div class="field"><label class="small">Details</label><textarea id="bkDesc" rows="3" placeholder="Describe the job…"></textarea></div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="transportOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong>Transport</strong>
        <button class="btn ghost" id="closeTransportOptions" type="button">✖</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px">
          <button class="btn primary" id="optTaxi" type="button">🚖 Ride / Taxi</button>
          <button class="btn ghost" id="optTruck" type="button">🚚 Truck / Backie</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="ridePlanModal">
    <div class="sheet">
      <div class="head">
        <strong>Plan Ride</strong>
        <button class="btn ghost" id="ridePlanClose" type="button">✖</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="field"><label class="small">Pickup</label>
            <div class="row" style="gap:8px">
              <input id="rpPickup" placeholder="Enter pickup"/>
              <button class="btn ghost" id="rpUseCurrent" type="button">📍 Use current</button>
            </div>
          </div>
          <div class="field"><label class="small">Destination</label><input id="rpDest" placeholder="Enter destination"/></div>
          <div id="rpStopsWrap"></div>
          <div class="row" style="gap:8px">
            <button class="btn ghost" id="rpAddStop" type="button">+ Add stop</button>
            <button class="btn primary" id="rpStart" type="button">Start</button>
          </div>
          <div class="small muted">Up to 5 stops</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="transportProvidersModal">
    <div class="sheet">
      <div class="head">
        <strong id="transportTitle">Nearby Drivers</strong>
        <button class="btn ghost" id="closeTransportProviders" type="button">✖</button>
      </div>
      <div class="body">
        <div id="transportList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong id="trackTitle">Driver on the way</strong>
        <button class="btn ghost" id="trackCancel" type="button">Cancel</button>
      </div>
      <div class="body">
        <div id="trackMap" style="height:100%; border:1px solid var(--border); border-radius:12px"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="foodOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong>Food</strong>
        <button class="btn ghost" id="closeFoodOptions" type="button">✖</button>
      </div>
      <div class="body">
        <div class="search">
          <div class="box">
            <input id="foodSearch" placeholder="Search vendors or food…"/>
            <button class="btn primary" id="foodSearchBtn" type="button">Search</button>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn primary" id="foodFastBtn" type="button">🍔 Fast food</button>
          <button class="btn ghost" id="foodGroceryBtn" type="button">🛒 Groceries</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="foodVendorsModal">
    <div class="sheet">
      <div class="head">
        <button class="btn ghost" id="backToFoodOptions" type="button">← Back</button>
        <strong id="foodVendorsTitle">Food Vendors</strong>
        <button class="btn ghost" id="closeFoodVendors" type="button">✖</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="fvSearch" placeholder="Search vendors or menu items…" style="flex:1"/>
          <button class="btn ghost" id="fvVoice" type="button">🎤</button>
          <button class="btn primary" id="fvSearchBtn" type="button">Search</button>
        </div>
        <div id="foodVendorsList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="foodMenuModal">
    <div class="sheet">
      <div class="head">
        <button class="btn ghost" id="backToVendors" type="button">← Back</button>
        <strong id="foodMenuTitle">Menu</strong>
        <button class="btn ghost" id="closeFoodMenu" type="button">✖</button>
      </div>
      <div class="body">
        <div id="foodMenuList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="foodCartTotal">0.00</span></div>
          <div class="row" style="gap:6px">
            <button class="btn ghost" id="clearFoodCart" type="button">Clear</button>
            <button class="btn primary" id="foodCheckoutBtn" type="button">Checkout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head">
        <strong>My Cart</strong>
        <button class="btn ghost" id="closeCart" type="button">✖</button>
      </div>
      <div class="body">
        <div id="cartList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="cartTotal">0.00</span></div>
          <button class="btn primary" id="checkoutBtn" type="button">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="checkoutModal">
    <div class="sheet">
      <div class="head">
        <button class="btn ghost" id="backToCart" type="button">← Back</button>
        <strong>Checkout</strong>
        <button class="btn ghost" id="closeCheckout" type="button">✖</button>
      </div>
      <div class="body">
        <div class="list" id="chkFormList">
          <div class="grid-2">
            <div class="field"><label class="small">Full Name</label><input id="chkName"/></div>
            <div class="field"><label class="small">Phone</label><input id="chkPhone"/></div>
          </div>
          <div class="grid-2">
            <div class="field"><label class="small">Street / Address</label><input id="chkAddress"/></div>
            <div class="field"><label class="small">Flat / House No.</label><input id="chkUnit"/></div>
          </div>
          <div class="field"><label class="small">Delivery Notes</label><textarea id="chkNotes" rows="3"></textarea></div>
          <div class="field">
            <label class="small">Payment Method</label>
            <div class="controls">
              <label><input type="radio" name="payMethod" value="card" checked/> Card</label>
              <label><input type="radio" name="payMethod" value="cash"/> Cash</label>
            </div>
            <div class="small muted" id="vendorPayHint"></div>
          </div>
          <label class="row" style="align-items:flex-start;gap:8px"><input type="checkbox" id="chkTerms"/> <span>I accept the Terms.</span></label>
          <div id="chkItemsList" class="list"></div>
          <button class="btn primary" id="placeOrderBtn" type="button">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="orderModal">
    <div class="sheet">
      <div class="head">
        <strong>Order Status</strong>
        <button class="btn ghost" id="closeOrder" type="button">✖</button>
      </div>
      <div class="body">
        <div id="orderInfo" class="list"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="roadsideModal">
    <div class="sheet">
      <div class="head">
        <strong>Roadside Assistance</strong>
        <button class="btn ghost" id="roadClose" type="button">✖</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="roadSearch" placeholder="Search roadside help (tyres, battery, tow)..." style="flex:1"/>
          <button class="btn ghost" id="roadVoice" type="button">🎤</button>
          <button class="btn primary" id="roadGo" type="button">Search</button>
        </div>
        <div id="roadList" class="list"></div>
      </div>
    </div>
  </div>

  <div id="notifModal" class="modal">
    <div class="sheet">
      <div class="head">
        <strong>Notifications</strong>
        <button class="btn ghost" id="closeNotif" type="button">✖</button>
      </div>
      <div class="body">
        <div id="notifList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="sellModal">
    <div class="sheet">
      <div class="head"><button class="btn ghost" id="sellBack" type="button">← Back</button><strong>Sell a product</strong><button class="btn ghost" type="button" onclick="document.getElementById('sellModal').classList.remove('open')">✖</button></div>
      <div class="body">
        <div class="grid-2">
          <div class="field"><label class="small">Category</label>
            <select id="sellCat">
              <option value="electronics">Electronics</option>
              <option value="fashion">Fashion</option>
              <option value="home">Home & Garden</option>
              <option value="sports">Sports</option>
              <option value="automobile">Automobile</option>
              <option value="spares">Spare Parts</option>
              <option value="others">Others</option>
            </select>
          </div>
          <div class="field"><label class="small">Type</label><input id="sellType" placeholder="e.g., Phone"/></div>
        </div>
        <div class="grid-2">
          <div class="field"><label class="small">Title</label><input id="sellTitle"/></div>
          <div class="field"><label class="small">Price</label><input id="sellPrice" type="number" min="0" step="0.01"/></div>
        </div>
        <div class="grid-2">
          <div class="field"><label class="small">Stock</label><input id="sellStock" type="number" min="0"/></div>
          <div class="field"><label class="small">Images (up to 10)</label><input id="sellImages" type="file" accept="image/*" multiple/></div>
        </div>
        <div class="field"><label class="small">Description</label><textarea id="sellDesc" rows="3"></textarea></div>
        <div class="row" style="gap:6px">
          <button class="btn primary" id="sellSubmit" type="button">Submit</button>
          <button class="btn ghost" id="sellCall" type="button">📞 Call</button>
          <button class="btn ghost" id="sellWhatsApp" type="button">🟢 WhatsApp</button>
        </div>
      </div>
    </div>
  </div>

  <button class="floating-panic" id="panicBtn" title="Emergency">🚨</button>
  <div class="modal" id="panicModal">
    <div class="sheet">
      <div class="head">
        <strong>Emergency Alert</strong>
        <button class="btn ghost" id="panicClose" type="button">✖</button>
      </div>
      <div class="body">
        <div class="small muted" style="margin-bottom:8px">We’ll notify your contacts and nearby security with your location.</div>
        <div class="field"><label class="small">Message (optional)</label><textarea id="panicMsg" rows="3" placeholder="Describe the emergency…"></textarea></div>
        <div class="row" style="justify-content:flex-end; gap:8px">
          <button class="btn ghost" id="panicCancel" type="button">Close</button>
          <button class="btn primary" id="panicSend" type="button">Send Alert</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="chatModal">
    <div class="sheet">
      <div class="head">
        <strong id="chatTitle">Chat</strong>
        <button class="btn ghost" id="chatClose" type="button">✖</button>
      </div>
      <div class="body">
        <div id="chatList" class="list" style="max-height:50vh;overflow:auto"></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <input id="chatInput" placeholder="Type a message…" style="flex:1"/>
          <button class="btn primary" id="chatSend" type="button">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth modal (overlay only) -->
  <div class="modal" id="authModal" style="display:none">
    <div class="sheet" style="height:100vh;width:100vw;max-width:none;border-radius:0;border:0;background:var(--bg);display:flex;flex-direction:column">
      <div class="head" style="border:0;justify-content:center">
        <div style="text-align:center;margin:6px 0 0">
          <div style="font-size:42px">🚀</div>
          <div style="margin-top:4px;color:var(--muted);font-weight:600">ZippUp: Hustle faster!</div>
        </div>
      </div>
      <div class="body" style="display:flex;align-items:center;justify-content:center">
        <div id="authCard" style="width:100%;max-width:420px;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px">
          <div id="authTabs" style="display:grid;grid-auto-flow:column;gap:8px;margin:10px 0 12px">
            <button id="tabSignIn" class="btn ghost" type="button">Sign in</button>
            <button id="tabSignUp" class="btn ghost" type="button">Sign up</button>
            <button id="tabPhone" class="btn ghost" type="button">Phone</button>
            <button id="tabReset" class="btn ghost" type="button">Recover</button>
          </div>

          <div id="paneSignIn" class="auth-pane">
            <div class="field"><label class="small">Email</label><input id="inEmail" placeholder="you@example.com"/></div>
            <div class="field"><label class="small">Password</label><input id="inPass" type="password" placeholder="••••••••"/></div>
            <button class="btn primary block" id="btnSignIn" type="button">Continue</button>
            <div class="small muted" style="margin:10px 0; text-align:center">or</div>
            <button class="btn block" id="googleBtn" type="button" style="background:#fff;border:1px solid var(--border)">🔵 Continue with Google</button>
          </div>

          <div id="paneSignUp" class="auth-pane" style="display:none">
            <div class="field"><label class="small">Name</label><input id="upName" placeholder="Your name"/></div>
            <div class="field"><label class="small">Email</label><input id="upEmail" placeholder="you@example.com"/></div>
            <div class="field"><label class="small">Password</label><input id="upPass" type="password" placeholder="At least 6 characters"/></div>
            <button class="btn primary block" id="btnSignUp" type="button">Create account</button>
            <div class="small muted" style="margin:10px 0; text-align:center">or</div>
            <button class="btn block" id="googleBtn2" type="button" style="background:#fff;border:1px solid var(--border)">🔵 Continue with Google</button>
          </div>

          <div id="panePhone" class="auth-pane" style="display:none">
            <div class="field"><label class="small">Phone (with country code)</label><input id="phNumber" placeholder="+27XXXXXXXXX"/></div>
            <div id="recaptcha-container" style="margin:6px 0"></div>
            <button class="btn primary block" id="btnPhoneSend" type="button">Send code</button>
            <div class="field" style="margin-top:10px"><label class="small">Verification code</label><input id="phCode" placeholder="123456"/></div>
            <button class="btn primary block" id="btnPhoneVerify" type="button">Verify & Sign in</button>
          </div>

          <div id="paneReset" class="auth-pane" style="display:none">
            <div class="field"><label class="small">Email</label><input id="rsEmail" placeholder="you@example.com"/></div>
            <button class="btn primary block" id="btnReset" type="button">Send reset link</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="splash" style="position:fixed;inset:0;background:linear-gradient(135deg,#2563EB 0%,#1D4ED8 100%);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff">
    <div style="font-size:28px;font-weight:800;margin-top:12px">ZippUp</div>
    <div style="opacity:.9;margin-top:4px">On‑demand services, fast.</div>
  </div>

  <script>
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';
    const stripe = (()=>{ try { return Stripe(STRIPE_PK); } catch { return null; } })();

    const firebaseConfig = {
      apiKey: "AIzaSyApgmcfu5qGFn9tw872dQ2KkdDz_GPmL70",
      authDomain: "zippup-535ca.firebaseapp.com",
      projectId: "zippup-535ca",
      appId: "1:382212325227:web:c04d91386817c7cff7d62e",
      messagingSenderId: "382212325227",
      measurementId: "G-YKJEVL8M6V"
    };
    if (!window.firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    let user = { name:'Guest', email:'guest@example.com', wallet: 0 };
    let coords = null, homeMap=null, vehicleMarkers=[];
    let trackMap=null, trackInterval=null;
    let cart = loadCart();
    let orders = getOrders();
    let notifications = getNotifications();
    let currentChat = null;

    function loadCart(){ try{ return JSON.parse(localStorage.getItem('food_cart')||'{"vendorId":null,"vendorName":null,"vendorPayment":[],"items":[]}'); }catch{ return { vendorId:null, vendorName:null, vendorPayment:[], items:[] } } }
    function saveCart(){ localStorage.setItem('food_cart', JSON.stringify(cart)); }
    function resetCart(){ cart={ vendorId:null, vendorName:null, vendorPayment:[], items:[] }; saveCart(); }

    function getOrders(){ try{ return JSON.parse(localStorage.getItem('zup_orders')||'[]'); } catch{ return []; } }
    function setOrders(o){ orders=o||[]; localStorage.setItem('zup_orders', JSON.stringify(orders)); }
    function getNotifications(){ try{ return JSON.parse(localStorage.getItem('zup_notifications')||'[]'); } catch{ return []; } }
    function setNotifications(n){ notifications=n||[]; localStorage.setItem('zup_notifications', JSON.stringify(notifications)); }
    function addNotification(entry){ notifications.unshift({ id:'n'+Date.now(), at:Date.now(), ...entry }); setNotifications(notifications); }

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function money(n){ return `$${(+n||0).toFixed(2)}`; }
    function showPage(id){
      $$('.page').forEach(p=>p.classList.remove('active'));
      const el=$('#page-'+id); if (el) el.classList.add('active');
      $$('.nav button').forEach(b=>b.classList.toggle('active', b.getAttribute('data-page')===id));
    }

    const sndRequest = new Audio('data:audio/mp3;base64,//uQZAAAAAAAA');
    const sndAccept  = new Audio('data:audio/mp3;base64,//uQZAAAAAAAA');
    const sndArrive  = new Audio('data:audio/mp3;base64,//uQZAAAAAAAA');
    function playSound(what){ try{ ({request:sndRequest,accept:sndAccept,arrive:sndArrive}[what])?.play(); }catch{} }

    $$('.nav button').forEach(b=>{
      b.onclick = ()=>{
        const page=b.getAttribute('data-page');
        showPage(page);
        if (page==='marketplace') { renderMarketplace(); }
        if (page==='wallet') { openWallet(); }
        if (page==='orders') { renderOrders(); }
      };
    });

    $('#profileBtn').onclick = (e)=>{ e.stopPropagation(); const m=$('#profileMenu'); m.style.display = (m.style.display==='block'?'none':'block'); };
    document.addEventListener('click', ()=>{ const m=$('#profileMenu'); if (m) m.style.display='none'; });
    $('#menuProfile').onclick = ()=>{ $('#profileMenu').style.display='none'; showPage('profile'); };
    $('#menuOrders').onclick  = ()=>{ $('#profileMenu').style.display='none'; showPage('orders'); renderOrders(); };
    $('#menuWallet').onclick  = ()=>{ $('#profileMenu').style.display='none'; showPage('wallet'); };
    $('#menuTopup').onclick   = ()=>{ $('#profileMenu').style.display='none'; showPage('digital'); };
    $('#menuSupport').onclick = ()=>{ $('#profileMenu').style.display='none'; showPage('support'); };
    $('#menuLogout').onclick  = async ()=>{
      $('#profileMenu').style.display='none';
      try{ await auth.signOut(); }catch{}
      user = { name:'Guest', email:'' };
      $('#authModal').style.display='flex'; $('#authModal').classList.add('open');
    };

    $('#openSupportBtn').onclick = ()=> showPage('support');
    $('#supportBack').onclick = ()=> showPage('profile');
    $('#supSend').onclick = ()=>{ alert('Support request sent'); showPage('profile'); };

    // Global search (text and voice)
    function runGlobalSearch(qRaw){
      const q=(qRaw||'').trim().toLowerCase();
      if(!q) return;
      // Marketplace products
      const mpMatch = (MP_PRODUCTS.concat(getUserProducts())).filter(p=> (p.title||'').toLowerCase().includes(q) || (p.type||'').toLowerCase().includes(q) || (p.cat||'').toLowerCase().includes(q));
      if (mpMatch.length){
        showPage('marketplace');
        $('#mpSearch').value=q;
        renderMarketplace(null, q);
        return;
      }
      // Food vendors or menu items
      const vendorIds = Object.keys(MENUS).filter(vid => (MENUS[vid]||[]).some(m=> (m.title||'').toLowerCase().includes(q)));
      if (vendorIds.length || VENDORS.some(v=> (v.name||'').toLowerCase().includes(q))){
        $('#foodOptionsModal').classList.remove('open');
        openFoodVendorsSearch(q);
        return;
      }
      // Service categories
      const svcMap = {
        transport:['transport','taxi','ride','truck','backie'],
        food:['food','restaurant','grocery','groceries','menu'],
        tech:['tech','phone','computer','laptop','repair'],
        home:['home','clean','cleaning','maintenance'],
        construction:['build','builder','construction','electrician','plumber'],
        auto:['auto','mechanic','tyre','tire','battery','roadside'],
        others:['others','event','tutor','more'],
        digital:['digital','airtime','data','bills','voucher']
      };
      for (const [cat,keys] of Object.entries(svcMap)){
        if (keys.some(k=> q.includes(k))){ openCategory(cat, cat[0].toUpperCase()+cat.slice(1)); return; }
      }
      // Fallback: providers modal filtered
      $('#provSearchRow').style.display='';
      $('#providersTitle').textContent = 'Providers — Search';
      renderProviders(dummyProviders('general'), 'general');
      $('#providersModal').classList.add('open');
      $('#provSearch').value=q;
      document.getElementById('provSearchBtn').click();
    }
    $('#searchBtn').onclick = ()=> runGlobalSearch($('#search').value);
    $('#voiceBtn').onclick  = ()=> voiceToInput($('#search'), runGlobalSearch);

    const SERVICES = [
      { id:'transport',   name:'Transport',         icon:'🚗', desc:'Ride & moving' },
      { id:'food',        name:'Food',              icon:'🍔', desc:'Restaurants & groceries' },
      { id:'tech',        name:'Tech',              icon:'🔧', desc:'Phone/computer/appliances repair' },
      { id:'home',        name:'Home',              icon:'🏠', desc:'Cleaning, maintenance, fixes & more' },
      { id:'construction',name:'Construction',      icon:'🏗️', desc:'Builders, Plumbers, electricians & more' },
      { id:'auto',        name:'Automobile',        icon:'🛠️', desc:'Mechanics, tires, roadside' },
      { id:'digital',     name:'Digital Services',  icon:'💳', desc:'Airtime, data, bills, digital products' },
      { id:'marketplace', name:'Marketplace',       icon:'🛍️', desc:'Buy & Sell (contact sellers)' },
      { id:'others',      name:'Others',            icon:'🎯', desc:'Events, tutors, more' },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance', icon:'🚑' },
      { id:'fire',      name:'Fire Service', icon:'🚒' },
      { id:'towing',    name:'Towing', icon:'🚛' },
      { id:'security',  name:'Security', icon:'🛡️' },
      { id:'roadside',  name:'Roadside', icon:'🔧' },
    ];

    function renderServices(){
      const grid = $('#servicesGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderEmergency(){
      const grid = $('#emergencyGrid'); grid.innerHTML='';
      EMERGENCY.forEach(e=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div>`;
        el.onclick = ()=> {
          if (e.id==='roadside') openRoadside();
          else openEmergencyProviders(e.id, e.name);
        };
        grid.appendChild(el);
      });
    }

    function openCategory(catId, label){
      if (catId==='digital'){ showPage('digital'); return; }
      if (catId==='marketplace'){ showPage('marketplace'); return; }
      if (catId==='food'){ $('#foodOptionsModal').classList.add('open'); return; }
      if (catId==='transport'){ $('#transportOptionsModal').classList.add('open'); return; }

      const showProvSearch = ['home','tech','construction','auto','automobile','others'].includes(catId);
      $('#provSearchRow').style.display = showProvSearch ? '' : 'none';
      $('#providersTitle').textContent = label + ' — Providers';
      renderProviders(dummyProviders(catId), catId);
      $('#providersModal').classList.add('open');
    }

    function dummyProviders(cat){
      return [
        { id:'pr1', publicName:'Handy Pro', jobTitle:cat, verified:true, rating:4.8, distance:'0.8km', eta:'6-9m', fee:'$20-30', available:true, icon:'👤' },
        { id:'pr2', publicName:'Quick Help', jobTitle:cat, verified:false, rating:4.5, distance:'1.2km', eta:'8-12m', fee:'$15-25', available:true, icon:'⚡' }
      ];
    }
    function renderProviders(list, catId){
      const box=$('#providersList'); box.innerHTML='';
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row" style="align-items:center">
              <div class="avatar">${p.icon||'👤'}</div>
              <div>
                <div><strong>${p.publicName||'Provider'}</strong> ${p.verified? '✔️':''}</div>
                <div class="small muted">${p.distance||'—'} • ETA ${p.eta||'—'} • ${p.jobTitle||''}</div>
                <div class="small"><strong>Est.:</strong> ${p.fee||'—'}</div>
              </div>
            </div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="row" style="gap:8px; margin-top:6px">
            <button class="btn primary" data-k="instant" type="button">Instant</button>
            <button class="btn ghost" data-k="schedule" type="button">Schedule</button>
          </div>`;
        el.querySelector('[data-k="instant"]').onclick = ()=>{
          if (catId==='transport'){ $('#providersModal').classList.remove('open'); $('#transportOptionsModal').classList.add('open'); }
          else createServiceInstant(p);
        };
        el.querySelector('[data-k="schedule"]').onclick = ()=> { $('#providersModal').classList.remove('open'); $('#bookingModal').classList.add('open'); };
        box.appendChild(el);
      });
    }
    $('#closeProviders').onclick = ()=> $('#providersModal').classList.remove('open');

    function openEmergencyProviders(id, label){
      $('#provSearchRow').style.display='';
      $('#providersTitle').textContent = label + ' — Nearby';
      const list = [
        { id:'e1', publicName:`${label} Team A`, jobTitle:label, verified:true, rating:4.9, distance:'0.6km', eta:'4-7m', fee:'—', available:true, icon:'🛟' },
        { id:'e2', publicName:`${label} Team B`, jobTitle:label, verified:true, rating:4.6, distance:'1.1km', eta:'8-12m', fee:'—', available:true, icon:'🛟' }
      ];
      renderProviders(list, id);
      $('#providersModal').classList.add('open');
    }

    $('#closeTransportOptions').onclick = ()=> $('#transportOptionsModal').classList.remove('open');
    $('#optTaxi').onclick  = ()=> openTransportProviders('taxi', 'Ride / Taxi');
    $('#optTruck').onclick = ()=> openTransportProviders('truck', 'Truck / Backie');
    $('#closeTransportProviders').onclick = ()=> $('#transportProvidersModal').classList.remove('open');

    function openTransportProviders(kind, label){
      $('#transportOptionsModal').classList.remove('open');
      $('#transportTitle').textContent = `${label} — Nearby`;
      const list = [
        { id:'d1', name:`${label} • Alex`, eta:'3-5m', distance:'0.5km', fare:'$6-9' },
        { id:'d2', name:`${label} • Sam`,  eta:'5-7m', distance:'0.9km', fare:'$7-10' },
      ];
      const box=$('#transportList'); box.innerHTML='';
      list.forEach(d=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
          <div><strong>${d.name}</strong><div class="small muted">${d.distance} • ETA ${d.eta}</div></div>
          <div class="row" style="gap:6px">
            <button class="btn primary" data-k="instant">Instant</button>
            <button class="btn ghost" data-k="schedule">Schedule</button>
          </div>
        </div>`;
        el.querySelector('[data-k="instant"]').onclick = ()=> openRidePlan(d);
        el.querySelector('[data-k="schedule"]').onclick = ()=> $('#bookingModal').classList.add('open');
        box.appendChild(el);
      });
      $('#transportProvidersModal').classList.add('open');
    }

    function openRidePlan(driver){
      $('#transportProvidersModal').classList.remove('open');
      $('#ridePlanModal').classList.add('open');
      const wrapStops = $('#rpStopsWrap'); wrapStops.innerHTML='';
      $('#rpPickup').value=''; $('#rpDest').value='';
      $('#rpUseCurrent').onclick = ()=>{ if(coords) $('#rpPickup').value = $('#userLocUnder').textContent || `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}`; };
      $('#rpAddStop').onclick = ()=>{
        const count = wrapStops.children.length;
        if (count>=5) return;
        const row=document.createElement('div'); row.className='row'; row.style.gap='8px'; row.style.margin='6px 0';
        row.innerHTML=`<input placeholder="Stop ${count+1}" style="flex:1"/><button class="btn ghost" type="button">✖</button>`;
        row.querySelector('button').onclick = ()=> row.remove();
        wrapStops.appendChild(row);
      };
      $('#ridePlanClose').onclick = ()=> $('#ridePlanModal').classList.remove('open');
      $('#rpStart').onclick = ()=>{
        const stops = Array.from(wrapStops.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
        $('#ridePlanModal').classList.remove('open');
        createTransportInstant(driver, $('#rpPickup').value.trim(), $('#rpDest').value.trim(), stops);
      };
    }

    function initTrackMap(){
      try {
        if (!coords) return;
        trackMap = L.map('trackMap',{ zoomControl:true }).setView([coords.lat, coords.lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(trackMap);
        L.circleMarker([coords.lat, coords.lng],{radius:7,color:'#10B981',fillColor:'#10B981',fillOpacity:.9}).addTo(trackMap).bindPopup('You');
        let drvLat = coords.lat + 0.01, drvLng = coords.lng + 0.01;
        const drv = L.circleMarker([drvLat, drvLng],{radius:7,color:'#2563EB',fillColor:'#2563EB',fillOpacity:.9}).addTo(trackMap).bindPopup('Driver');
        trackInterval = setInterval(()=>{
          drvLat = drvLat + (coords.lat - drvLat)/20;
          drvLng = drvLng + (coords.lng - drvLng)/20;
          drv.setLatLng([drvLat, drvLng]);
          const dLat = drvLat - coords.lat, dLng = drvLng - coords.lng;
          const dist = Math.sqrt(dLat*dLat + dLng*dLng) * 111_000;
          if (dist < 30) { playSound('arrive'); clearInterval(trackInterval); alert('Driver has arrived'); }
        }, 1500);
      } catch {}
    }
    function startTracking(title){
      $('#trackTitle').textContent = title || 'On the way';
      $('#trackModal').classList.add('open');
      setTimeout(()=> initTrackMap(), 10);
      playSound('accept');
    }
    function stopTracking(){
      try{ if (trackInterval) clearInterval(trackInterval); }catch{}
      $('#trackModal').classList.remove('open');
    }
    $('#trackCancel').onclick = ()=>{
      stopTracking();
      showPage('home');
    };

    // Food demo data
    const VENDORS = [
      { id:'v1', name:'Burger Place', kind:'fastfood', payment:['card','cash'] },
      { id:'v2', name:'Pizza Town',   kind:'fastfood', payment:['card'] },
      { id:'v3', name:'Green Grocer', kind:'grocery',  payment:['cash'] }
    ];
    const MENUS = {
      v1: [
        { id:'m1', title:'Cheeseburger', price:8.5, img:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=800&auto=format&fit=crop' },
        { id:'m2', title:'Fries',        price:3.0, img:'https://images.unsplash.com/photo-1541592106381-b31e9677c0e5?q=80&w=800&auto=format&fit=crop' },
      ],
      v2: [
        { id:'m4', title:'Pepperoni Pizza', price:12.0, img:'https://images.unsplash.com/photo-1548365328-9f547fb09530?q=80&w=800&auto=format&fit=crop' },
      ],
      v3: [
        { id:'m6', title:'Bananas (1kg)', price:2.5, img:'https://images.unsplash.com/photo-1571772805064-2073979f0d4a?q=80&w=800&auto=format&fit=crop' },
      ]
    };

    // Food flows
    $('#closeFoodOptions').onclick = ()=> $('#foodOptionsModal').classList.remove('open');
    $('#foodFastBtn').onclick = ()=> { $('#foodOptionsModal').classList.remove('open'); openFoodVendors('fastfood'); };
    $('#foodGroceryBtn').onclick = ()=> { $('#foodOptionsModal').classList.remove('open'); openFoodVendors('grocery'); };
    $('#foodSearchBtn').onclick = ()=> { const q=($('#foodSearch').value||'').toLowerCase(); $('#foodOptionsModal').classList.remove('open'); openFoodVendorsSearch(q); };
    $('#backToFoodOptions').onclick = ()=> { $('#foodVendorsModal').classList.remove('open'); $('#foodOptionsModal').classList.add('open'); };
    $('#backToVendors').onclick = ()=> { $('#foodMenuModal').classList.remove('open'); $('#foodVendorsModal').classList.add('open'); };

    function openFoodVendors(kind){
      renderVendorsList(VENDORS.filter(v=>v.kind===kind), kind);
    }
    function openFoodVendorsSearch(q){
      const vendorIds = Object.keys(MENUS).filter(vid => (MENUS[vid]||[]).some(m=>m.title.toLowerCase().includes(q)));
      const list = VENDORS.filter(v=> v.name.toLowerCase().includes(q) || vendorIds.includes(v.id));
      renderVendorsList(list, 'search');
    }
    function renderVendorsList(list, mode){
      const box=$('#foodVendorsList'); box.innerHTML='';
      list.forEach(v=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>${v.name}</strong></div><div class="small muted">${v.kind==='fastfood'?'Fast food':'Grocery'} • Payments: ${v.payment.join(', ')}</div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="menu">View Menu</button></div>
        </div>`;
        el.querySelector('[data-k="menu"]').onclick = ()=> openFoodMenu(v);
        box.appendChild(el);
      });
      $('#foodVendorsTitle').textContent='Food Vendors';
      $('#foodVendorsModal').classList.add('open');
    }
    $('#closeFoodVendors').onclick = ()=> $('#foodVendorsModal').classList.remove('open');

    function openFoodMenu(vendor){
      if (cart.vendorId && cart.vendorId !== vendor.id) {
        if (!confirm(`Your cart has items from ${cart.vendorName}. Clear cart to order from ${vendor.name}?`)) return;
        resetCart();
      }
      if (!cart.vendorId){ cart.vendorId=vendor.id; cart.vendorName=vendor.name; cart.vendorPayment=vendor.payment.slice(); saveCart(); }
      $('#foodVendorsModal').classList.remove('open');
      $('#foodMenuTitle').textContent = `${vendor.name} — Menu`;
      const list=$('#foodMenuList'); list.innerHTML='';
      (MENUS[vendor.id]||[]).forEach(m=>{
        const row=document.createElement('div'); row.className='card'; row.dataset.id=m.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${m.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${m.title}</strong><div class="small muted">${money(m.price)}</div></div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="add">＋ Add</button></div>
        </div>`;
        row.querySelector('[data-k="add"]').onclick = ()=>{
          const i=cart.items.findIndex(x=>x.id===m.id);
          if (i>=0) cart.items[i].qty+=1; else cart.items.push({ id:m.id, title:m.title, price:m.price, img:m.img, qty:1 });
          saveCart(); syncFoodTotals(); updateBellBadge();
        };
        list.appendChild(row);
      });
      syncFoodTotals();
      $('#foodMenuModal').classList.add('open');
    }
    $('#closeFoodMenu').onclick = ()=> $('#foodMenuModal').classList.remove('open');
    $('#clearFoodCart').onclick = ()=> { resetCart(); syncFoodTotals(); };
    function syncFoodTotals(){ const total=cart.items.reduce((a,b)=>a+b.price*b.qty,0); $('#foodCartTotal').textContent=total.toFixed(2); }
    $('#foodCheckoutBtn').onclick = ()=>{ renderCart(); $('#cartModal').classList.add('open'); };
    $('#closeCart').onclick = ()=> $('#cartModal').classList.remove('open');
    $('#checkoutBtn').onclick = ()=> openCheckout();

    function renderCart(){
      const list=$('#cartList'); const totalEl=$('#cartTotal'); list.innerHTML='';
      if(!cart.items.length){ list.innerHTML='<div class="small muted">Your cart is empty.</div>'; totalEl.textContent='0.00'; return; }
      let total=0;
      cart.items.forEach(item=>{
        total+=item.price*item.qty;
        const row=document.createElement('div'); row.className='card'; row.dataset.id=item.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between; align-items:flex-start">
          <div class="row"><img src="${item.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${item.title}</strong><div class="small muted">${money(item.price)}</div><div class="small muted">Vendor: ${cart.vendorName||'-'}</div></div></div>
          <div class="row" style="gap:6px; align-items:center">
            <button class="btn ghost" data-k="dec" type="button">−</button>
            <div>${item.qty}</div>
            <button class="btn ghost" data-k="inc" type="button">＋</button>
            <button class="btn ghost" data-k="rm"  type="button">✖</button>
          </div>
        </div>`;
        list.appendChild(row);
      });
      totalEl.textContent=total.toFixed(2);
      list.onclick = (e)=>{
        const btn=e.target.closest('[data-k]'); if(!btn) return;
        const id=btn.closest('.card')?.dataset?.id; const k=btn.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if (i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); } else saveCart();
        renderCart(); updateBellBadge();
      };
    }

    function openCheckout(){
      if (!cart.items.length) { alert('Your cart is empty.'); return; }
      const wrap=$('#chkItemsList'); wrap.innerHTML='';
      cart.items.forEach(it=>{
        const row=document.createElement('div'); row.className='card'; row.dataset.id=it.id;
        row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${it.img||''}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${it.title}</strong><div class="small muted">${money(it.price)}</div></div></div>
          <div class="row"><button class="btn ghost" data-k="dec">−</button><div>${it.qty}</div><button class="btn ghost" data-k="inc">＋</button><button class="btn ghost" data-k="rm">✖</button></div>
        </div>`;
        wrap.appendChild(row);
      });
      wrap.onclick=(e)=>{
        const b=e.target.closest('[data-k]'); if(!b) return;
        const id=b.closest('.card')?.dataset?.id; const k=b.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if(i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); $('#checkoutModal').classList.remove('open'); return; }
        saveCart(); openCheckout();
      };
      $('#vendorPayHint').textContent = `Vendor accepts: ${cart.vendorPayment.join(', ') || '—'}`;
      $('#checkoutModal').classList.add('open');
    }
    $('#backToCart').onclick = ()=>{ $('#checkoutModal').classList.remove('open'); $('#cartModal').classList.add('open'); };
    $('#closeCheckout').onclick = ()=> $('#checkoutModal').classList.remove('open');

    async function stripeCheckout(orderId){
      if (!stripe) { alert('Payment library not loaded'); return; }
      try {const origin = location.origin;
      const payload = { items: cart.items.map(i => ({ name: i.title, amount: Math.round(i.price * 100), quantity: i.qty })),
      currency: window.USER_CURRENCY, metadata: { orderId },success_url: `${origin}/?success=1&order=${encodeURIComponent(orderId)}`,
      cancel_url: `${origin}/?canceled=1&order=${encodeURIComponent(orderId)}`
   };
  const r = await fetch(`${BASE_API}/api/payments/checkout-session3`, {
   method: 'POST',
   headers: { 'Content-Type': 'application/json' },
   body: JSON.stringify(payload)
   });
        };
        const r = await fetch(`${BASE_API}/api/payments/checkout-session`, {
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload)
        });
        const j = await r.json();
        const sid = j.id || j.sessionId || j.session_id;
        if (!sid) throw new Error('No session');
        await stripe.redirectToCheckout({ sessionId: sid });
      } catch(e){
        alert('Unable to start payment. Please try again.');
      }
    }

    $('#placeOrderBtn').onclick = async ()=>{
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      if (!$('#chkTerms').checked) return alert('Please accept the Terms');
      if (!cart.items.length) return alert('Cart is empty');
      if (cart.vendorPayment.length && !cart.vendorPayment.includes(method)) {
        return alert(`This vendor does not accept ${method.toUpperCase()} payment. Allowed: ${cart.vendorPayment.join(', ')}`);
      }
      const orderId='ord-'+Date.now(), code=String(Math.floor(100000+Math.random()*900000));
      addFoodOrder(orderId, code, method);
      if (method==='card') {
        await stripeCheckout(orderId);
      }
      $('#checkoutModal').classList.remove('open');
      $('#orderInfo').innerHTML = `<div class="card">
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div style="margin-top:6px"><strong>Status:</strong> <span>preparing (15 min)</span></div>
        <div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div>
        <div class="small muted" style="margin-top:6px">Please don’t share this code with the seller until your goods are delivered and confirmed. You can always view it under Manage Orders.</div>
      </div>`;
      $('#orderModal').classList.add('open');
      resetCart(); updateBellBadge();
    };
    $('#closeOrder').onclick = ()=> $('#orderModal').classList.remove('open');

    function addFoodOrder(orderId, code, method){
      const o = {
        id: orderId, type:'food', status:'preparing', vendorName: cart.vendorName, createdAt: Date.now(),
        code, payMethod: method, items: cart.items.slice()
      };
      orders.unshift(o); setOrders(orders); renderOrders();
      setTimeout(()=> assignDelivery(orderId), 15*60*1000);
    }
    function assignDelivery(orderId){
      const o = orders.find(x=>x.id===orderId); if (!o || o.status!=='preparing') return;
      o.status='assigned'; o.driver='Courier • Lee'; setOrders(orders);
      addNotification({ kind:'booking', text:`Food order assigned: ${o.vendorName}`, data:{ orderId } });
      startTracking('Courier on the way');
    }

    function createServiceInstant(provider){
      const id='svc-'+Date.now();
      const o={ id, type:'service', category:provider.jobTitle, status:'preparing', createdAt:Date.now(), title:`${provider.publicName} • ${provider.jobTitle}` };
      orders.unshift(o); setOrders(orders); renderOrders();
      setTimeout(()=> beginServiceTracking(id), 10*60*1000);
      addNotification({ kind:'booking', text:`${provider.jobTitle} booking created`, data:{ orderId:id } });
    }
    function beginServiceTracking(id){
      const o=orders.find(x=>x.id===id); if (!o || o.status!=='preparing') return;
      o.status='enroute'; setOrders(orders);
      startTracking(`${o.title||'Provider'} — en route`);
    }

    function createTransportInstant(driver, pickup, dest, stops){
      const id='ride-'+Date.now();
      const o={ id, type:'transport', status:'enroute', driver:driver.name, createdAt:Date.now(), pickup, dest, stops:stops||[] };
      orders.unshift(o); setOrders(orders); renderOrders();
      startTracking(`${driver.name} — arriving ${driver.eta}`);
    }

    $('#closeNotif').onclick = ()=> $('#notifModal').classList.remove('open');
    $('#notifBtn').onclick = ()=>{
      const list = $('#notifList'); list.innerHTML='';
      const nCart=cart.items.reduce((a,b)=>a+(b.qty||0),0);
      if (nCart>0){
        const row=document.createElement('div'); row.className='card'; row.style.cursor='pointer';
        row.innerHTML = `<div class="row" style="justify-content:space-between"><div>🛒 You have ${nCart} item(s) in Food cart</div><div>›</div></div>`;
        row.onclick = ()=>{ $('#notifModal').classList.remove('open'); renderCart(); $('#cartModal').classList.add('open'); };
        list.appendChild(row);
      }
      notifications.forEach(n=>{
        const row=document.createElement('div'); row.className='card'; row.style.cursor='pointer';
        row.innerHTML = `<div class="row" style="justify-content:space-between"><div>${n.kind==='message'?'💬':'📣'} ${n.text}</div><div>›</div></div>`;
        row.onclick = ()=>{
          $('#notifModal').classList.remove('open');
          if (n.kind==='message'){ openChat(n.data?.peer||'Support'); }
          if (n.kind==='booking'){ showPage('orders'); renderOrders(); }
        };
        list.appendChild(row);
      });
      $('#notifModal').classList.add('open');
    };

    function updateBellBadge(){
      const n=cart.items.reduce((a,b)=>a+(b.qty||0),0) + notifications.length;
      let badge = $('#notifBellBadge');
      if (!badge){ const bell=$('#notifBtn'); badge=document.createElement('span'); badge.id='notifBellBadge'; badge.style.cssText='position:absolute; top:-4px; right:-4px; background:#DC2626; color:#fff; border-radius:999px; font-size:11px; padding:0 5px; line-height:16px; min-width:16px; text-align:center; display:none'; bell.style.position='relative'; bell.appendChild(badge); }
      badge.style.display = n>0 ? 'inline-block' : 'none';
      badge.textContent = n || '';
    }

    const MP_CATEGORIES = [
      { id:'electronics', name:'Electronics' },
      { id:'fashion',     name:'Fashion' },
      { id:'home',        name:'Home & Garden' },
      { id:'sports',      name:'Sports' },
      { id:'automobile',  name:'Automobile' },
      { id:'spares',      name:'Spare Parts' },
      { id:'others',      name:'Others' },
    ];
    let MP_PRODUCTS = [
      { id:'p100', title:'Smartphone X', cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop', seller:'Tony', phone:'+12025550123' },
      { id:'p200', title:'Running Shoes', cat:'sports', price:79,  stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop', seller:'Kelvin', phone:'+12025550124' },
    ];
    function getUserProducts(){ try { return JSON.parse(localStorage.getItem('zup_user_products')||'[]'); } catch { return []; } }
    function setUserProducts(arr){ localStorage.setItem('zup_user_products', JSON.stringify(arr||[])); }

    async function fetchProductsFromApi(){
      try {
        const r = await fetch(`${BASE_API}/api/marketplace/products`);
        const j = await r.json();
        if (Array.isArray(j)) MP_PRODUCTS = j.map(p=>({
          id: p.id||('p'+Math.random()), title:p.title, cat:p.category, price:p.price, stock:p.stock, img:p.images?.[0]||'', seller:p.sellerName||'Seller', phone:p.phone||''
        }));
      } catch {}
    }

    function initMarketplace(){
      const chips=$('#mpChips'); chips.innerHTML='';
      MP_CATEGORIES.forEach(c=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=c.name; b.onclick=()=> renderMarketplace(c.id, $('#mpSearch').value.trim().toLowerCase()); chips.appendChild(b); });
      fetchProductsFromApi().finally(()=>renderMarketplace());
      $('#sellProductsBtn').onclick = ()=> $('#sellModal').classList.add('open');
      $('#mpSearchBtn').onclick = ()=> renderMarketplace(null, $('#mpSearch').value.trim().toLowerCase());
      $('#mpVoice').onclick = ()=> voiceToInput($('#mpSearch'), ()=> renderMarketplace(null, $('#mpSearch').value.trim().toLowerCase()));
      $('#sellSubmit').onclick = submitMarketplace;
      $('#sellBack').onclick = ()=> $('#sellModal').classList.remove('open');
      $('#sellCall').onclick = ()=> { const ph=prompt('Enter phone to call', '+12025550123'); if (ph) location.href='tel:'+ph; };
      $('#sellWhatsApp').onclick = ()=> { const ph=prompt('Enter WhatsApp number', '+12025550123'); if (ph) location.href='https://wa.me/'+ph.replace(/\D/g,''); };
    }
    function renderMarketplace(category=null, query=''){
      const grid=$('#mpGrid'); grid.innerHTML='';
      const list = (MP_PRODUCTS.concat(getUserProducts())).filter(p=>{
        if (category && p.cat!==category) return false;
        if (query && !(p.title.toLowerCase().includes(query)||String(p.cat).toLowerCase().includes(query))) return false;
        return true;
      });
      if (!list.length){ grid.innerHTML='<div class="small muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card product';
        el.innerHTML=`<img src="${p.img}" alt="${p.title}"/><div><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between"><div class="price">${money(p.price)}</div><div class="small muted">Seller: ${p.seller||'You'}</div></div>
          <div class="row" style="gap:8px;margin-top:6px">
            <button class="btn primary" data-k="chat" type="button">💬 Chat</button>
            <button class="btn ghost" data-k="call" type="button">📞 Call</button>
            <button class="btn ghost" data-k="wa" type="button">🟢 WhatsApp</button>
          </div>`;
        el.querySelector('[data-k="chat"]').onclick = ()=> openChat(p.seller||'Seller');
        el.querySelector('[data-k="call"]').onclick = ()=> location.href = 'tel:'+(p.phone||'+12025550123');
        el.querySelector('[data-k="wa"]').onclick = ()=> location.href = 'https://wa.me/'+(p.phone||'+12025550123').replace(/\D/g,'');
        grid.appendChild(el);
      });
    }
    async function submitMarketplace(){
      const cat=$('#sellCat').value;
      const type=$('#sellType').value.trim();
      const title=$('#sellTitle').value.trim();
      const price=parseFloat($('#sellPrice').value||'0');
      const stock=parseInt($('#sellStock').value||'0',10);
      const files=Array.from($('#sellImages').files||[]).slice(0,10);
      const desc=$('#sellDesc').value.trim();
      if (!title || !price || !stock) return alert('Fill title, price, stock');
      const images = await (files.length? Promise.all(files.map(f=>new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(f); }))): Promise.resolve([]));
      const item = { id:'u'+Date.now(), cat, type, title, price, stock, desc, images, img:images[0]||'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=800&auto=format&fit=crop', seller:(user.name||'You'), phone:'+12025550123' };
      // Try API save, fallback to local
      let ok=false;
      try{
        const r = await fetch(`${BASE_API}/api/marketplace/listings`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(item) });
        ok = r.ok;
      }catch{}
      if(!ok){
        const list=getUserProducts(); list.unshift(item); setUserProducts(list);
      }
      $('#sellModal').classList.remove('open');
      renderMarketplace();
      alert('Listing submitted');
    }

    $('#manageServicesBtn').onclick   = ()=>{ showPage('profile'); $('#page-manage-services').classList.add('active'); };
    $('#manageProductsBtn').onclick   = ()=>{ showPage('profile'); $('#page-manage-products').classList.add('active'); ensureFoodRow(); renderFoodItemsList(); };
    $('#emergencyContactsBtn').onclick= ()=>{ showPage('profile'); $('#page-emergency-contacts').classList.add('active'); renderEmergencyContacts(); };
    $('#providerVerifyBtn').onclick   = ()=>{ showPage('profile'); $('#page-verify-provider').classList.add('active'); };

    $('#msBack').onclick = ()=> showPage('profile');
    $('#mpBack').onclick = ()=> showPage('profile');
    $('#ecBack').onclick = ()=> showPage('profile');
    $('#vpBack').onclick = ()=> showPage('profile');

    const avail = $('#availToggle'), knob=$('#availKnob'), track=$('#availTrack');
    function syncAvail(){ if (avail.checked){ track.style.background='#34D399'; knob.style.transform='translateX(20px)'; } else { track.style.background='#d1d5db'; knob.style.transform='translateX(0)'; } }
    avail.onchange = syncAvail; syncAvail();

    function getContacts(){ try { return JSON.parse(localStorage.getItem('zup_contacts')||'[]'); } catch { return []; } }
    function setContacts(c){ localStorage.setItem('zup_contacts', JSON.stringify(c||[])); }
    function renderEmergencyContacts(){
      const wrap=$('#ecForm'); wrap.innerHTML='';
      const data=getContacts();
      for (let i=0;i<Math.max(3,data.length||0);i++){
        const row=document.createElement('div'); row.className='grid-2';
        row.innerHTML=`<div class="field"><label class="small">Name</label><input data-k="name" value="${data[i]?.name||''}"/></div>
                       <div class="field"><label class="small">Phone</label><input data-k="phone" value="${data[i]?.phone||''}"/></div>`;
        wrap.appendChild(row);
      }
    }
    $('#ecSave').onclick = ()=>{
      const rows=$$('#ecForm .grid-2'); const out=[];
      rows.forEach(r=>{ const name=r.querySelector('[data-k="name"]').value.trim(); const phone=r.querySelector('[data-k="phone"]').value.trim(); if (name||phone) out.push({name,phone}); });
      setContacts(out.slice(0,5));
      alert('Contacts saved');
    };

    function getFoodItems(){ try { return JSON.parse(localStorage.getItem('zup_food_items')||'[]'); } catch { return []; } }
    function setFoodItems(x){ localStorage.setItem('zup_food_items', JSON.stringify(x||[])); }
    function foodRowTemplate(){
      const div=document.createElement('div'); div.className='card';
      div.innerHTML=`
        <div class="grid-2">
          <div class="field"><label class="small">Subcategory</label>
            <select data-k="kind"><option value="fastfood">Fast food</option><option value="grocery">Grocery</option></select>
          </div>
          <div class="field"><label class="small">Title</label><input data-k="title" placeholder="Item title"/></div>
        </div>
        <div class="grid-2">
          <div class="field"><label class="small">Price</label><input data-k="price" type="number" min="0" step="0.01"/></div>
          <div class="field"><label class="small">Images (up to 5)</label><input data-k="images" type="file" accept="image/*" multiple/></div>
        </div>
        <div class="field"><label class="small">Description</label><textarea data-k="desc" rows="2"></textarea></div>
        <div class="row" style="gap:8px">
          <label><input type="checkbox" data-k="pm-card" checked/> Card</label>
          <label><input type="checkbox" data-k="pm-cash" /> Cash</label>
          <button class="btn ghost" data-k="rm" type="button" style="margin-left:auto">Remove</button>
        </div>`;
      div.querySelector('[data-k="rm"]').onclick = ()=> div.remove();
      return div;
    }
    function ensureFoodRow(){ if (!$('#foodItemsForm').children.length) $('#foodItemsForm').appendChild(foodRowTemplate()); }
    $('#addFoodRow').onclick = ()=> $('#foodItemsForm').appendChild(foodRowTemplate());
    $('#saveFoodItems').onclick = async ()=>{
      const rows = Array.from($('#foodItemsForm').children||[]);
      if (!rows.length) return alert('Add at least one item');
      const out=[];
      for (const r of rows){
        const kind=r.querySelector('[data-k="kind"]').value;
        const title=r.querySelector('[data-k="title"]').value.trim();
        const price=parseFloat(r.querySelector('[data-k="price"]').value||'0');
        const desc=r.querySelector('[data-k="desc"]').value.trim();
        const files=Array.from(r.querySelector('[data-k="images"]').files||[]).slice(0,5);
        const images = await (files.length? Promise.all(files.map(f=>new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(f); }))): Promise.resolve([]));
        const pm=[]; if (r.querySelector('[data-k="pm-card"]').checked) pm.push('card'); if (r.querySelector('[data-k="pm-cash"]').checked) pm.push('cash');
        if (!title || !price) continue;
        out.push({ id:'fi'+Date.now()+Math.random(), kind, title, price, desc, images, payment:pm });
      }
      // Try API save, fallback local
      let ok=false;
      try { const r=await fetch(`${BASE_API}/api/food/items`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(out)}); ok=r.ok; } catch {}
      if(!ok){ const cur=getFoodItems(); setFoodItems(out.concat(cur)); }
      renderFoodItemsList();
      alert('Items saved');
    };
    function renderFoodItemsList(){
      const box=$('#foodItemsList'); const items=getFoodItems();
      box.innerHTML = items.map(it=>`<div class="card"><div class="row" style="justify-content:space-between"><div><strong>${it.title}</strong> <span class="small muted">${it.kind}</span><div class="small muted">${money(it.price)}</div></div><div class="small muted">${(it.payment||[]).join(', ')}</div></div></div>`).join('') || '<div class="small muted">No items yet</div>';
    }

    function openWallet(){
      $('#walletBalance').textContent = money(user.wallet||0);
      const tx = JSON.parse(localStorage.getItem('zup_wallet_tx')||'[]');
      $('#walletTx').innerHTML = tx.map(t=>`<div class="card"><div class="row" style="justify-content:space-between"><div>${t.note||t.type}</div><div style="font-weight:700">${t.type==='debit'?'-':''}${money(t.amount)}</div></div></div>`).join('') || '<div class="small muted">No transactions</div>';
    }
    $('#walletAdd').onclick = ()=> alert('Top‑up coming soon');
    $('#walletCashOut').onclick = ()=> alert('Cash out coming soon');
    $('#walletSend').onclick = ()=>{
      const to = prompt('Send to (username/email)'); if (!to) return;
      const amt = parseFloat(prompt('Amount')||'0'); if (!amt || amt<=0) return;
      const tx = JSON.parse(localStorage.getItem('zup_wallet_tx')||'[]');
      tx.unshift({ id:'tx'+Date.now(), type:'debit', amount:amt, note:`Send to ${to}` });
      localStorage.setItem('zup_wallet_tx', JSON.stringify(tx));
      alert('Transfer recorded (demo).'); openWallet();
    };
    $('#walletCards').onclick = ()=> alert('VISA •••• 4242');

    $('#closeBooking').onclick = ()=> $('#bookingModal').classList.remove('open');
    $('#bookingForm').onsubmit = (e)=>{
      e.preventDefault();
      const dt = ($('#bkDate').value||'')+' '+($('#bkTime').value||'');
      const when = new Date(dt).getTime();
      if (!when || when < Date.now()) { alert('Pick a future date/time'); return; }
      const id='sch-'+Date.now();
      orders.unshift({ id, type:'scheduled', status:'scheduled', createdAt:Date.now(), scheduledAt:when, title:($('#bkDesc').value||'Scheduled Service'), addr:$('#bkAddress').value||'' });
      setOrders(orders); scheduleAlerts(id, when); renderOrders();
      alert('Booking scheduled');
      $('#bookingModal').classList.remove('open');
    };

    function scheduleAlerts(id, when){
      const diff = when - Date.now();
      if (diff <= 0) return startScheduled(id);
      const set = (ms,msg)=>{ if (ms>0) setTimeout(()=> { addNotification({ kind:'booking', text:msg, data:{ orderId:id } }); updateBellBadge(); }, ms); };
      set(diff - 60*60*1000, 'Your booking starts in 1 hour');
      set(diff - 30*60*1000, 'Your booking starts in 30 minutes');
      set(diff - 5*60*1000,  'Your booking starts in 5 minutes');
      set(diff,               'Your booking has started');
      setTimeout(()=> startScheduled(id), Math.max(0, diff));
    }
    function startScheduled(id){
      const o=orders.find(x=>x.id===id); if (!o || o.status!=='scheduled') return;
      o.status='enroute'; setOrders(orders);
      startTracking(o.title||'Booking in progress');
    }

    function openRoadside(){
      renderRoadsideList('');
      $('#roadsideModal').classList.add('open');
    }
    function renderRoadsideList(q){
      const all = [
        { name:'Tyre change • Team A', eta:'5 min' },
        { name:'Battery jumpstart • Team B', eta:'7 min' },
        { name:'Fuel delivery • Team C', eta:'10 min' },
        { name:'Tow truck • Wingate', eta:'12 min' }
      ];
      const f=(q||'').toLowerCase();
      $('#roadList').innerHTML = all.filter(x=>x.name.toLowerCase().includes(f)).map(x=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div><strong>${x.name}</strong><div class="small muted">ETA ${x.eta}</div></div>
            <button class="btn primary" type="button" onclick="alert('Request sent')">Request</button>
          </div>
        </div>`).join('') || '<div class="small muted">No matches</div>';
    }
    document.getElementById('roadClose').onclick = ()=> document.getElementById('roadsideModal').classList.remove('open');
    document.getElementById('roadGo').onclick = ()=> renderRoadsideList(document.getElementById('roadSearch').value.trim());
    document.getElementById('roadVoice').onclick = ()=> voiceToInput(document.getElementById('roadSearch'), txt=>renderRoadsideList(txt));

    (function providersFilter(){
      const row = $('#provSearchRow'), list = $('#providersList');
      function filter(){ const q=($('#provSearch').value||'').toLowerCase(); list?.querySelectorAll('.card').forEach(c=>{ c.style.display = c.textContent.toLowerCase().includes(q)?'':'none'; }); }
      $('#provSearch')?.addEventListener('input', filter);
      $('#provSearchBtn')?.addEventListener('click', filter);
      $('#provVoice')?.addEventListener('click', ()=>voiceToInput($('#provSearch'), filter));
    })();

    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{ const text=e.results[0][0].transcript||''; inputEl.value=text; onResult&&onResult(text); };
      rec.start();
    }
    $('#mpVoice').onclick  = ()=> voiceToInput($('#mpSearch'), ()=>$('#mpSearchBtn').click());

    // Address suggestions for booking
    let suggestTimer=null;
    $('#bkAddress').addEventListener('input', ()=>{
      clearTimeout(suggestTimer);
      const q = $('#bkAddress').value.trim();
      if (!q) { $('#bkSuggest').innerHTML=''; return; }
      suggestTimer=setTimeout(async ()=>{
        try{
          const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=jsonv2&addressdetails=1&limit=5`);
          const j=await r.json();
          $('#bkSuggest').innerHTML = (j||[]).map(x=>`<div class="card" data-addr="${x.display_name.replace(/"/g,'&quot;')}">${x.display_name}</div>`).join('');
        }catch{ $('#bkSuggest').innerHTML=''; }
      }, 300);
    });
    $('#bkSuggest').addEventListener('click',(e)=>{
      const d=e.target.closest('[data-addr]'); if(!d) return;
      $('#bkAddress').value = d.getAttribute('data-addr')||'';
      $('#bkSuggest').innerHTML='';
    });

    function updateProfileUI(){
      $('#profName').textContent=(user?.name||'Guest');
      $('#profEmail').textContent=(user?.email||'guest@example.com');
      const saved=localStorage.getItem('zup_profile_photo');
      if (saved) { const av=$('#user-avatar'); av.style.backgroundImage=`url("${saved}")`; av.style.backgroundSize='cover'; av.style.backgroundPosition='center'; av.textContent=''; }
    }
    $('#editProfileBtn').onclick = ()=>{
      let m=document.getElementById('profileEditModal');
      if (!m) {
        m=document.createElement('div'); m.id='profileEditModal'; m.className='modal open';
        m.innerHTML=`
          <div class="sheet">
            <div class="head"><strong>Edit Profile</strong><button class="btn ghost" id="peClose" type="button">✖</button></div>
            <div class="body">
              <div class="list">
                <div class="field"><label class="small">Public name</label><input id="peName" value="${(user?.name||'')}"/></div>
                <div class="field"><label class="small">Photo</label><input id="pePhoto" type="file" accept="image/*"/></div>
                <button class="btn primary" id="peSave" type="button">Save</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(m);
        m.addEventListener('click',(e)=>{ if(e.target===m) m.classList.remove('open'); });
        document.getElementById('peClose').onclick=()=> m.classList.remove('open');
        document.getElementById('peSave').onclick=()=>{
          const name=document.getElementById('peName').value.trim(); if (name) user.name=name;
          const f=document.getElementById('pePhoto').files?.[0];
          if (f) { const fr=new FileReader(); fr.onload=()=>{ localStorage.setItem('zup_profile_photo', fr.result); updateProfileUI(); m.classList.remove('open'); }; fr.readAsDataURL(f); }
          else { updateProfileUI(); m.classList.remove('open'); }
        };
      } else m.classList.add('open');
    };

    $('#panicBtn').onclick = ()=> $('#panicModal').classList.add('open');
    $('#panicClose').onclick = ()=> $('#panicModal').classList.remove('open');
    $('#panicCancel').onclick = ()=> $('#panicModal').classList.remove('open');
    $('#panicSend').onclick = async ()=>{
      alert('Emergency alert sent');
      $('#panicModal').classList.remove('open');
    };

    async function initLocation(){
      try {
        const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:8000 }));
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        try {
          const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${coords.lat}&lon=${coords.lng}`);
          const j = await r.json();
          const addr = j?.display_name || `Lat ${coords.lat.toFixed(4)}, Lng ${coords.lng.toFixed(4)}`;
          $('#userLocUnder').textContent = addr;
        } catch {
          $('#userLocUnder').textContent = `Lat ${coords.lat.toFixed(4)}, Lng ${coords.lng.toFixed(4)}`;
        }
      } catch {
        $('#userLocUnder').textContent = 'Location unavailable';
      }
    }
    function initHomeMap(){
      try {
        homeMap = L.map('homeMap',{ zoomControl:false }).setView([coords?.lat||0, coords?.lng||0], coords?15:2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(homeMap);
        if (coords) {
          for (let i=0;i<6;i++){
            const lat = coords.lat + (Math.random()-0.5)/100;
            const lng = coords.lng + (Math.random()-0.5)/100;
            const m = L.circleMarker([lat,lng],{radius:6,color:'#2563EB',fillColor:'#2563EB',fillOpacity:.9});
            m.addTo(homeMap); vehicleMarkers.push(m);
          }
          setInterval(()=>{
            vehicleMarkers.forEach(m=>{
              const p = m.getLatLng();
              m.setLatLng([p.lat + (Math.random()-0.5)/1000, p.lng + (Math.random()-0.5)/1000]);
            });
          }, 1500);
        }
      } catch {}
    }

    (function providersFilter(){
      const row = $('#provSearchRow'), list = $('#providersList');
      function filter(){ const q=($('#provSearch').value||'').toLowerCase(); list?.querySelectorAll('.card').forEach(c=>{ c.style.display = c.textContent.toLowerCase().includes(q)?'':'none'; }); }
      $('#provSearch')?.addEventListener('input', filter);
      $('#provSearchBtn')?.addEventListener('click', filter);
      $('#provVoice')?.addEventListener('click', ()=>voiceToInput($('#provSearch'), filter));
    })();

    $('#backToCart').onclick = ()=>{ $('#checkoutModal').classList.remove('open'); $('#cartModal').classList.add('open'); };
    $('#closeProviders').onclick = ()=> $('#providersModal').classList.remove('open');

    function renderOrders(){
      const active=$('#buyerOrders'), hist=$('#sellerOrders');
      const act=orders.filter(o=>['preparing','assigned','enroute','scheduled'].includes(o.status));
      const past=orders.filter(o=>['completed','canceled'].includes(o.status));
      active.innerHTML = act.map(o=>{
        const title = o.type==='food'? (o.vendorName||'Food order') : (o.title||o.type);
        const extra = o.type==='food' && o.code ? `<div class="small muted">Code: <span style="font-family:monospace">${o.code}</span></div>` : '';
        return `<div class="card">
          <div><strong>${title}</strong> <span class="small muted">• ${o.status}</span>${extra}</div>
          <div class="row" style="gap:6px;margin-top:6px">
            <button class="btn primary" data-k="track" data-id="${o.id}">Track</button>
            <button class="btn ghost" data-k="cancel" data-id="${o.id}">Cancel</button>
          </div>
        </div>`;
      }).join('') || '<div class="small muted">No active bookings</div>';
      hist.innerHTML = past.map(o=>`<div class="card"><div><strong>${o.title||o.type}</strong> <span class="small muted">• ${o.status}</span></div></div>`).join('') || '<div class="small muted">No history yet</div>';
      active.onclick = (e)=>{
        const b=e.target.closest('button[data-k]'); if(!b) return;
        const id=b.getAttribute('data-id'); const k=b.getAttribute('data-k');
        const o=orders.find(x=>x.id===id); if(!o) return;
        if (k==='track'){ startTracking((o.type==='food'?'Courier on the way':(o.title||'Tracking'))); }
        if (k==='cancel'){ if(confirm('Cancel this booking?')){ o.status='canceled'; setOrders(orders); stopTracking(); renderOrders(); } }
      };
    }

    function openChat(peer){
      currentChat = peer||'Chat';
      $('#chatTitle').textContent = 'Chat — ' + currentChat;
      $('#chatList').innerHTML = '<div class="small muted">Say hi…</div>';
      $('#chatModal').classList.add('open');
    }
    $('#chatClose').onclick = ()=> $('#chatModal').classList.remove('open');
    $('#chatSend').onclick = ()=>{
      const v=$('#chatInput').value.trim(); if(!v) return;
      const list=$('#chatList'); const row=document.createElement('div'); row.className='card'; row.textContent='You: '+v; list.appendChild(row);
      $('#chatInput').value='';
      addNotification({ kind:'message', text:`New message with ${currentChat}`, data:{ peer: currentChat } });
      updateBellBadge();
    };

    // Auth controller (overlay only)
    (function authController(){
      const $=s=>document.querySelector(s);
      const tabs = { SignIn:'#paneSignIn', SignUp:'#paneSignUp', Phone:'#panePhone', Reset:'#paneReset' };
      function setTab(which){
        Object.keys(tabs).forEach(k=>{
          $('#tab'+k)?.classList.toggle('primary', k===which);
          $('#tab'+k)?.classList.toggle('ghost', k!==which);
          const p = document.querySelector(tabs[k]);
          if (p) p.style.display = (k===which?'block':'none');
        });
      }
      $('#tabSignIn')?.addEventListener('click', ()=>setTab('SignIn'));
      $('#tabSignUp')?.addEventListener('click', ()=>setTab('SignUp'));
      $('#tabPhone') ?.addEventListener('click', ()=>setTab('Phone'));
      $('#tabReset') ?.addEventListener('click', ()=>setTab('Reset'));
      setTab('SignIn');

      function openAuth(){ const m=$('#authModal'); if (m) { m.style.display='flex'; m.classList.add('open'); } }
      function closeAuth(){ const m=$('#authModal'); if (m) { m.classList.remove('open'); m.style.display='none'; } }
      $('#authClose')?.addEventListener('click', closeAuth);

      function provider(){ try { return new firebase.auth.GoogleAuthProvider(); } catch { return null; } }

      $('#btnSignIn')?.addEventListener('click', async ()=>{
        const email=$('#inEmail')?.value.trim(), pass=$('#inPass')?.value.trim();
        if(!email||!pass) return alert('Enter email and password');
        try { await auth.signInWithEmailAndPassword(email, pass); } catch(e){ alert(e?.message||'Sign in failed'); }
      });

      $('#btnSignUp')?.addEventListener('click', async ()=>{
        const name=$('#upName')?.value.trim(), email=$('#upEmail')?.value.trim(), pass=$('#upPass')?.value.trim();
        if(!name||!email||!pass) return alert('Fill name, email, password');
        try {
          const { user:u } = await auth.createUserWithEmailAndPassword(email, pass);
          try { await u.updateProfile({ displayName:name }); } catch {}
        } catch(e){ alert(e?.message||'Sign up failed'); }
      });

      $('#btnReset')?.addEventListener('click', async ()=>{
        const email=$('#rsEmail')?.value.trim(); if(!email) return alert('Enter your email');
        try { await auth.sendPasswordResetEmail(email); alert('Reset link sent'); setTab('SignIn'); } catch(e){ alert(e?.message||'Failed to send reset link'); }
      });

      const g = provider();
      const googleSign = async ()=>{ if(!g) return alert('Google not available'); try{ await auth.signInWithPopup(g); }catch(e){ alert(e?.message||'Google sign-in failed'); } };
      $('#googleBtn') ?.addEventListener('click', googleSign);
      $('#googleBtn2')?.addEventListener('click', googleSign);

      // Phone auth
      let recaptcha;
      function ensureRecaptcha(){
        if (recaptcha) return recaptcha;
        try {
          recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size:'invisible' });
        } catch {
          try { recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha-container'); } catch {}
        }
        return recaptcha;
      }
      let confirmationResult = null;
      $('#btnPhoneSend')?.addEventListener('click', async ()=>{
        const num = $('#phNumber')?.value.trim();
        if (!num) return alert('Enter phone');
        try {
          ensureRecaptcha();
          confirmationResult = await auth.signInWithPhoneNumber(num, recaptcha);
          alert('Code sent');
        } catch(e){ alert(e?.message||'Failed to send code'); }
      });
      $('#btnPhoneVerify')?.addEventListener('click', async ()=>{
        const code = $('#phCode')?.value.trim();
        if (!code || !confirmationResult) return alert('Enter the code');
        try { await confirmationResult.confirm(code); } catch(e){ alert(e?.message||'Invalid code'); }
      });

      auth.onAuthStateChanged(u=>{
        if (u) {
          user.email=u.email||''; user.name=u.displayName || (user.email?user.email.split('@')[0]:'Guest');
          updateProfileUI && updateProfileUI();
          closeAuth();
        } else {
          openAuth();
        }
      });

      $('#openSupportBtn')?.addEventListener('click', ()=> showPage && showPage('support'));
    })();

    // Support FAQ content
    (function supportFAQ(){
      const faq = [
        { q:'How do I track my driver?', a:'Open My Bookings → Track on the active booking.' },
        { q:'How do payments work?', a:'Food uses upfront card/cash per vendor rules. Transport charges at trip end. Other services start billing after arrival + 7 minutes grace.' },
        { q:'Where is my delivery code?', a:'Open Manage Orders and select your active Food order to view the code.' },
        { q:'How do I become a provider?', a:'Go to Profile → Become Verified Provider and submit your documents.' }
      ];
      const box = document.getElementById('faqList');
      if (!box) return;
      box.innerHTML = faq.map((f,i)=>`
        <div class="item"><div class="q" data-i="${i}">${f.q}</div><div class="a" id="a${i}">${f.a}</div></div>
      `).join('');
      box.addEventListener('click', (e)=>{
        const i = e.target.closest('.q')?.dataset?.i; if (i==null) return;
        const a = document.getElementById('a'+i);
        if (a) a.style.display = a.style.display==='block' ? 'none' : 'block';
      });
    })();

    function renderOrdersOnce(){ renderOrders && renderOrders(); }
    document.addEventListener('DOMContentLoaded', async ()=>{
      showPage('home');
      renderServices(); renderEmergency();
      initMarketplace();
      await initLocation(); initHomeMap();
      updateProfileUI(); updateBellBadge();
      ensureFoodRow(); renderFoodItemsList();
      setTimeout(()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(),250); } }, 250);
      renderOrdersOnce();
    });
    window.addEventListener('load', ()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(),250); } });
    setTimeout(()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(),250); } }, 2000);

    $('#bkUseCurrent').onclick = ()=>{ if (coords) $('#bkAddress').value = $('#userLocUnder').textContent || `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}`; };
  </script>
  <!-- Settings Modal -->
<div class="modal" id="settingsModal" style="display:none">
  <div class="sheet">
    <div class="head">
      <strong>Settings</strong>
      <button class="btn ghost" type="button" onclick="document.getElementById('settingsModal').classList.remove('open')">✖</button>
    </div>
    <div class="body">
      <div class="list">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <strong>Dark mode</strong>
            <div class="small muted">Switch between light and dark theme</div>
          </div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="darkToggle" type="checkbox" style="display:none"/>
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px;transition:.2s"></span>
            <span id="darkKnob" style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s"></span>
          </label>
        </div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <strong>Face verification (beta)</strong>
            <div class="small muted">Prompt to capture a face photo on first order/upload</div>
          </div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="faceToggle" type="checkbox" style="display:none"/>
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px;transition:.2s"></span>
            <span id="faceKnob" style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Terms Modal -->
<div class="modal" id="termsModal" style="display:none">
  <div class="sheet">
    <div class="head">
      <strong>Terms and Conditions</strong>
      <button class="btn ghost" type="button" onclick="document.getElementById('termsModal').classList.remove('open')">✖</button>
    </div>
    <div class="body" style="max-height:60vh;overflow:auto">
      <div class="list small" style="color:var(--text)">
        <p><strong>Payments & escrow:</strong> For card orders paid via Stripe, funds are held until delivery is confirmed (food: via delivery code; services: upon completion).</p>
        <p><strong>Transport:</strong> Final fare is calculated by distance/time at trip end.</p>
        <p><strong>Services:</strong> Billing starts after provider arrival + 7 minutes grace and stops at completion.</p>
        <p><strong>Marketplace:</strong> ZippUp is not a party to transactions. Never pay before receiving goods. Meet in public places.</p>
        <p><strong>Emergency:</strong> Alerts are sent to your saved contacts and may include local emergency numbers where available.</p>
        <p><strong>Privacy:</strong> Optional face verification (beta) stores a face snapshot locally unless you opt-in to cloud verification later.</p>
      </div>
    </div>
  </div>
</div>

<!-- Referral Modal -->
<div class="modal" id="refModal" style="display:none">
  <div class="sheet">
    <div class="head">
      <strong>Invite & earn</strong>
      <button class="btn ghost" type="button" onclick="document.getElementById('refModal').classList.remove('open')">✖</button>
    </div>
    <div class="body">
      <div class="small muted" style="margin-bottom:8px">Share your link. When your friend completes their first order, you both get a discount coupon.</div>
      <div class="row" style="gap:8px">
        <input id="refLink" readonly style="flex:1" />
        <button class="btn primary" type="button" onclick="navigator.clipboard.writeText(document.getElementById('refLink').value).then(()=>alert('Copied'))">Copy</button>
      </div>
    </div>
  </div>
</div>
  <script>
(function finalTouchUps(){
  const $=s=>document.querySelector(s);

  // A) Dark mode toggle in Settings
  // Add Settings entry under Profile buttons (with chevron styling it looks like others)
  (function injectSettingsButton(){
    const list = document.querySelector('#page-profile .list');
    if (!list || document.getElementById('openSettingsBtn')) return;
    const btn = document.createElement('button');
    btn.className='btn ghost';
    btn.id='openSettingsBtn';
    btn.type='button';
    btn.textContent='Settings';
    btn.onclick=()=>{ document.getElementById('settingsModal').style.display='flex'; document.getElementById('settingsModal').classList.add('open'); syncToggles(); };
    list.appendChild(btn);
    // Also add "Invite & earn"
    const ref = document.createElement('button');
    ref.className='btn ghost';
    ref.type='button';
    ref.textContent='Invite & earn';
    ref.onclick=()=>{ const l = genReferralLink(); const inp=$('#refLink'); if(inp){ inp.value=l; } const m=$('#refModal'); if(m){ m.style.display='flex'; m.classList.add('open'); } };
    list.appendChild(ref);
  })();

  function applyTheme(t){
    if (t==='dark'){ document.body.setAttribute('data-theme','dark'); }
    else { document.body.removeAttribute('data-theme'); }
  }
  function syncToggles(){
    const t = localStorage.getItem('zup_theme')||'light';
    applyTheme(t);
    const dT=$('#darkToggle'), k=$('#darkKnob');
    if(dT){ dT.checked = (t==='dark'); if(k) k.style.transform=dT.checked?'translateX(20px)':'translateX(0)'; }
    const face = localStorage.getItem('zup_face_beta')==='1';
    const fT=$('#faceToggle'), fk=$('#faceKnob');
    if(fT){ fT.checked = face; if(fk) fk.style.transform=fT.checked?'translateX(20px)':'translateX(0)'; }
  }
  document.addEventListener('click',(e)=>{
    if (e.target && e.target.id==='darkToggle'){
      const on = e.target.checked; localStorage.setItem('zup_theme', on?'dark':'light'); applyTheme(on?'dark':'light');
      const k=$('#darkKnob'); if(k) k.style.transform=on?'translateX(20px)':'translateX(0)';
    }
    if (e.target && e.target.id==='faceToggle'){
      const on = e.target.checked; localStorage.setItem('zup_face_beta', on?'1':'0');
      const k=$('#faceKnob'); if(k) k.style.transform=on?'translateX(20px)':'translateX(0)';
    }
  });
  // Apply theme on load
  (function initTheme(){ applyTheme(localStorage.getItem('zup_theme')||'light'); })();

  // B) Terms link next to checkbox in Checkout
  (function injectTermsLink(){
    const label = document.querySelector('#chkTerms')?.parentElement;
    if (!label || document.getElementById('termsLink')) return;
    const a = document.createElement('a');
    a.id='termsLink';
    a.href='javascript:void(0)';
    a.textContent=' Read Terms';
    a.style.marginLeft='4px';
    a.onclick=()=>{ const m=document.getElementById('termsModal'); if(m){ m.style.display='flex'; m.classList.add('open'); } };
    label.appendChild(a);
  })();

  // C) Marketplace advisory note (one-liner above listings)
  (function injectMarketAdvisory(){
    if (document.getElementById('marketAdvisory')) return;
    const page = document.getElementById('page-marketplace');
    if (!page) return;
    const note = document.createElement('div');
    note.id='marketAdvisory';
    note.innerHTML='Safety tip: Never send payment before receiving your goods. Meet sellers in public places.';
    page.insertBefore(note, page.querySelector('.search')?.nextElementSibling || page.firstChild);
  })();

  // D) Promotions strip on Home
  (function injectPromos(){
    if (document.getElementById('promoStrip')) return;
    const home = document.getElementById('page-home');
    if (!home) return;
    const wrap = document.createElement('div');
    wrap.id='promoStrip';
    wrap.innerHTML = '<div class="inner"><span>🔥 10% off first food order • </span><span>🚗 Book taxi or truck instantly • </span><span>🛠️ Hire verified providers • </span><span>💳 Pay securely with Stripe • </span><span>🎁 Refer friends, earn coupons • </span></div>';
    const anchor = home.querySelector('.search');
    home.insertBefore(wrap, anchor?.nextElementSibling || home.firstChild);
  })();

  // E) Panic: if no contacts saved, guide user; also include default regional emergency if available
  async function fetchDefaultEmergency(lat,lng){
    try {
      const r = await fetch(`${(window.BASE_API||'')}/api/emergency/default?lat=${encodeURIComponent(lat||'')}&lng=${encodeURIComponent(lng||'')}`);
      const j = await r.json();
      return j?.number || null;
    } catch { return null; }
  }
  (function wirePanic(){
    const btn = document.getElementById('panicSend');
    if (!btn) return;
    btn.addEventListener('click', async ()=>{
      try {
        const contacts = JSON.parse(localStorage.getItem('zup_contacts')||'[]');
        if (!contacts.length){
          alert('Please add emergency contacts in Profile → Emergency Contacts to use this service.');
          // Open the page for convenience
          window.showPage && showPage('profile');
          document.getElementById('page-emergency-contacts')?.classList.add('active');
          return;
        }
        let defaultNum = null;
        if (window.coords) defaultNum = await fetchDefaultEmergency(window.coords.lat, window.coords.lng);
        // Here you would call your backend to send alerts to contacts + defaultNum
        alert('Emergency alert sent to your contacts' + (defaultNum ? ` and ${defaultNum}` : '') + '.');
      } catch { alert('Emergency alert sent'); }
      document.getElementById('panicModal')?.classList.remove('open');
    }, { once:false });
  })();

  // F) Referral link
  function genReferralLink(){
    const uid = (window.firebase?.auth?.().currentUser?.uid) || 'guest';
    return `${location.origin}/?ref=${encodeURIComponent(uid)}`;
  }

  // G) Face verification (beta) – optional prompt (does not block existing flow)
  // Example hook: when opening Checkout or saving items, if enabled and not done, gently prompt user (no blocking)
  (function faceBetaHooks(){
    const enabled = localStorage.getItem('zup_face_beta')==='1';
    const done = localStorage.getItem('zup_face_done')==='1';
    if (!enabled || done) return;
    // Show small non-blocking prompt after 3s on Profile
    if (document.getElementById('page-profile')){
      setTimeout(()=>{
        if (confirm('Enable face verification to help secure your account? You can add it in Settings.')){
          // In a real app, open a capture flow/camera here and store result.
          localStorage.setItem('zup_face_done','1');
          alert('Face verification placeholder saved locally.');
        }
      }, 3000);
    }
  })();

  // H) Make support and emergency contacts pages horizontally scrollable content-friendly (already handled by CSS)

  // I) Auto-generate referral link if modal opened directly
  (function initRef(){
    const m=document.getElementById('refModal');
    if (!m) return;
    m.addEventListener('click',(e)=>{ if(e.target===m) m.classList.remove('open'); });
  })();

  // J) Help center: ensure FAQ exists (already injected by your code)
})();
</script>
  <script>
(function touchUps(){
  const $=s=>document.querySelector(s);

  // Header greeting (between bell and account)
  (function headerGreet(){
    const bell=$('#notifBtn');
    if (bell && !$('#headerGreet')) {
      const span=document.createElement('span');
      span.id='headerGreet'; span.className='small'; span.style.whiteSpace='nowrap';
      span.textContent='Hi, Guest';
      bell.insertAdjacentElement('afterend', span);
    }
  })();

  // Modal close helper (works for overlay click and ✖)
  function wireModalClose(id){
    const m=document.getElementById(id); if(!m) return;
    const hide=()=>{ m.classList.remove('open'); m.style.display='none'; };
    m.addEventListener('click',e=>{ if(e.target===m) hide(); });
    const x=m.querySelector('.head .btn.ghost'); if(x) x.onclick=hide;
  }
  ['settingsModal','refModal','termsModal'].forEach(wireModalClose);

  // Settings button + dark mode + face toggle
  (function settings(){
    // Add Settings + Invite buttons under Profile list (if not present)
    const list = document.querySelector('#page-profile .list');
    if (list && !document.getElementById('openSettingsBtn')) {
      const sBtn=document.createElement('button'); sBtn.className='btn ghost'; sBtn.id='openSettingsBtn'; sBtn.type='button'; sBtn.textContent='Settings';
      sBtn.onclick=()=>{ const m=$('#settingsModal'); if(m){ m.style.display='flex'; m.classList.add('open'); syncToggles(); } };
      list.appendChild(sBtn);
      const rBtn=document.createElement('button'); rBtn.className='btn ghost'; rBtn.type='button'; rBtn.textContent='Invite & earn';
      rBtn.onclick=()=>{ const m=$('#refModal'); if(m){ const inp=$('#refLink'); if(inp) inp.value=genReferralLink(); m.style.display='flex'; m.classList.add('open'); } };
      list.appendChild(rBtn);
    }
    // Toggles
    function applyTheme(t){ if(t==='dark') document.body.setAttribute('data-theme','dark'); else document.body.removeAttribute('data-theme'); }
    function syncToggles(){
      const t=localStorage.getItem('zup_theme')||'light'; applyTheme(t);
      const d=$('#darkToggle'), dk=$('#darkKnob'); if(d){ d.checked=(t==='dark'); if(dk) dk.style.transform=d.checked?'translateX(20px)':'translateX(0)'; }
      const fe=localStorage.getItem('zup_face_beta')==='1'; const f=$('#faceToggle'), fk=$('#faceKnob'); if(f){ f.checked=fe; if(fk) fk.style.transform=f.checked?'translateX(20px)':'translateX(0)'; }
    }
    document.addEventListener('click',(e)=>{
      if (e.target?.id==='darkToggle'){ const on=e.target.checked; localStorage.setItem('zup_theme', on?'dark':'light'); applyTheme(on?'dark':'light'); const k=$('#darkKnob'); if(k) k.style.transform=on?'translateX(20px)':'translateX(0)'; }
      if (e.target?.id==='faceToggle'){ const on=e.target.checked; localStorage.setItem('zup_face_beta', on?'1':'0'); const k=$('#faceKnob'); if(k) k.style.transform=on?'translateX(20px)':'translateX(0)'; }
    });
    applyTheme(localStorage.getItem('zup_theme')||'light');
  })();

  // Terms: add "Read Terms" link next to checkbox; ensure close works (wired above)
  (function termsLink(){
    const label = document.querySelector('#chkTerms')?.parentElement;
    if (!label || document.getElementById('termsLink')) return;
    const a=document.createElement('a'); a.id='termsLink'; a.href='javascript:void(0)'; a.textContent=' Read Terms';
    a.style.marginLeft='4px'; a.onclick=()=>{ const m=$('#termsModal'); if(m){ m.style.display='flex'; m.classList.add('open'); } };
    label.appendChild(a);
  })();

  // Marketplace safety advisory (ensure visible)
  (function marketAdvice(){
    if ($('#marketAdvisory')) return;
    const page=$('#page-marketplace'); if(!page) return;
    const section=page.querySelector('.section');
    const note = document.createElement('div');
    note.id='marketAdvisory';
    note.textContent='Safety tip: Never send payment before receiving your goods. Meet sellers in public places.';
    if (section) section.insertBefore(note, section.querySelector('.search')?.nextElementSibling || section.firstChild);
  })();

  // Promotions board under Emergency section (as grids)
  (function promos(){
    if ($('#promoBoard')) return;
    const home=$('#page-home'); if(!home) return;
    const sections=[...home.querySelectorAll('.section')];
    const emergency = sections.find(sec=> sec.querySelector('.title')?.textContent.trim().toLowerCase()==='emergency');
    const container=document.createElement('section');
    container.className='section'; container.id='promoBoard';
    container.innerHTML = '<div class="title">Promotions & suggestions</div><div id="promoGrid"></div>';
    (emergency? emergency.insertAdjacentElement('afterend', container) : home.appendChild(container));
    const grid=container.querySelector('#promoGrid');
    [
      {i:'🍔', t:'10% off first food order'},
      {i:'🚗', t:'Taxi & truck booking'},
      {i:'🛠️', t:'Hire verified providers'},
      {i:'💳', t:'Pay securely with Stripe'},
      {i:'🎁', t:'Refer & earn coupons'},
      {i:'🛍️', t:'Marketplace deals near you'}
    ].forEach(c=>{
      const d=document.createElement('div'); d.className='promoCard';
      d.innerHTML=`<div class="row"><div style="font-size:22px">${c.i}</div><strong>${c.t}</strong></div>`;
      grid.appendChild(d);
    });
  })();

  // Panic: if no saved contacts, guide user before opening modal
  (function panicGuard(){
    const btn=$('#panicBtn'); if(!btn) return;
    btn.addEventListener('click', ()=>{
      let contacts=[]; try{ contacts=JSON.parse(localStorage.getItem('zup_contacts')||'[]'); }catch{}
      if (!contacts.length){
        alert('Please add emergency contacts in Profile → Emergency Contacts.');
        if (window.showPage){ showPage('profile'); document.getElementById('page-emergency-contacts')?.classList.add('active'); }
        return;
      }
      const m=$('#panicModal'); if(m){ m.style.display='flex'; m.classList.add('open'); }
    });
  })();

  // Referral modal: close on overlay tap (wired), ensure link is ready
  (function refInit(){
    const m=$('#refModal'); if(!m) return;
    const inp=$('#refLink'); if (inp && !inp.value) inp.value = genReferralLink();
  })();
  function genReferralLink(){
    const uid=(window.firebase?.auth?.().currentUser?.uid)||'guest';
    return `${location.origin}/?ref=${encodeURIComponent(uid)}`;
  }

  // Search field: avoid email autofill after sign-in
  (function searchFix(){
    const si=$('#search'); if(!si) return;
    si.setAttribute('autocomplete','off'); si.setAttribute('inputmode','search');
    const _update=window.updateProfileUI;
    window.updateProfileUI=function(){ if(_update) _update.apply(this, arguments);
      const name=(window.user&&window.user.name)||'Guest';
      const greet=$('#headerGreet'); if(greet) greet.textContent='Hi, '+name;
      if (si.value && si.value.includes('@')) si.value='';
    };
  })();
})();
</script>
  <script>
(function promosRich(){
  const $=s=>document.querySelector(s);
  // remove old promo (if any)
  const old = document.getElementById('promoBoard'); if (old) old.remove();

  const home=$('#page-home'); if(!home) return;
  // insert under Emergency section
  const sections=[...home.querySelectorAll('.section')];
  const emergency = sections.find(sec=> sec.querySelector('.title')?.textContent.trim().toLowerCase()==='emergency');
  const wrap=document.createElement('section'); wrap.className='section'; wrap.id='promoBoard';
  (emergency? emergency.insertAdjacentElement('afterend', wrap) : home.appendChild(wrap));

  // Helpers
  function row(title){ const s=document.createElement('div'); s.innerHTML=`<div class="sectionTitle">${title}</div><div class="promoRow"></div>`; wrap.appendChild(s); return s.querySelector('.promoRow'); }
  function card({img, title, sub, onClick}){
    const d=document.createElement('div'); d.className='promoMini'; d.tabIndex=0; d.style.cursor='pointer';
    d.innerHTML = (img? `<img class="thumb" src="${img}"/>` : `<div class="thumb promoCTA">${title||''}</div>`)
                + `<div class="content">${img? `<div class="title">${title||''}</div>`:''}${sub? `<div class="sub">${sub}</div>`:''}</div>`;
    d.onclick=onClick; return d;
  }
  function money(n){ return `$${(+n||0).toFixed(2)}`; }

  // Data (use what you already have; fallback safely)
  const mp = (window.MP_PRODUCTS||[]).slice(0,6);
  // pick 6 menu items across vendors
  const menus = (function(){
    const MENUS = window.MENUS || {}; const out=[];
    Object.keys(MENUS).forEach(v=> (MENUS[v]||[]).forEach(m=> out.push({...m, vendorId:v})));
    return out.slice(0,6);
  })();
  const providers = (function(){
    const cats=['home','tech','construction','auto']; const pool=[];
    cats.forEach(c=> (window.dummyProviders? window.dummyProviders(c):[]).forEach(p=> pool.push({...p, cat:c})));
    return pool.slice(0,6);
  })();

  // 1) Food promos
  const rFood = row('10% off first food order');
  menus.forEach(m=>{
    rFood.appendChild(card({
      img: m.img, title: m.title, sub: money(m.price),
      onClick: ()=> { const VENDORS=window.VENDORS||[]; const v = VENDORS.find(x=>x.id===m.vendorId)||VENDORS[0]; if (v) window.openFoodMenu? openFoodMenu(v): (document.getElementById('foodOptionsModal')?.classList.add('open'));}
    }));
  });

  // 2) Taxi & Truck
  const rTx = row('Taxi & truck booking');
  [
    {emoji:'🚖', t:'Nearby taxis', sub:'Book instantly', kind:'taxi'},
    {emoji:'🚚', t:'Nearby trucks', sub:'Move goods fast', kind:'truck'}
  ].forEach(x=>{
    rTx.appendChild(card({
      img:'', title:x.emoji+' '+x.t, sub:x.sub,
      onClick: ()=> { const m=document.getElementById('transportOptionsModal'); if(m){ m.classList.add('open'); m.style.display='flex'; } }
    }));
  });

  // 3) Hire providers
  const rProv = row('Hire verified providers');
  providers.forEach(p=>{
    rProv.appendChild(card({
      img:'', title:p.publicName||'Provider', sub:`${p.jobTitle||p.cat} • ETA ${p.eta||'—'}`,
      onClick: ()=> window.openCategory? openCategory(p.cat||'home', (p.cat||'Home')) : null
    }));
  });

  // 4) Stripe safety
  const rStripe = row('Pay securely with Stripe');
  rStripe.appendChild(card({
    img:'', title:'💳 Card checkout', sub:'Protected payments',
    onClick: ()=> alert('Use Card in Checkout to pay securely with Stripe.')
  }));

  // 5) Referral
  const rRef = row('Refer & earn coupons');
  rRef.appendChild(card({
    img:'', title:'🎁 Invite friends', sub:'Earn discount coupons',
    onClick: ()=> { const m=document.getElementById('refModal'); if(m){ const inp=document.getElementById('refLink'); if(inp){ inp.value = (function(){ const uid=(window.firebase?.auth?.().currentUser?.uid)||'guest'; return `${location.origin}/?ref=${encodeURIComponent(uid)}`; })(); } m.style.display='flex'; m.classList.add('open'); } }
  }));

  // 6) Marketplace deals
  const rMp = row('Marketplace deals near you');
  mp.forEach(p=>{
    rMp.appendChild(card({
      img:p.img, title:p.title, sub:`${money(p.price)} • ${p.cat}`,
      onClick: ()=> { window.showPage && showPage('marketplace'); const s=document.getElementById('mpSearch'); if(s){ s.value=p.title; } const b=document.getElementById('mpSearchBtn'); b&&b.click(); }
    }));
  });
})();
</script>
  <script>
(function fixModalClosing(){
  const hide=m=>{ m.classList.remove('open'); m.style.display='none'; };
  document.querySelectorAll('.modal').forEach(m=>{
    m.addEventListener('click', e=>{ if(e.target===m) hide(m); });
    const x=m.querySelector('.head .btn.ghost'); if(x) x.onclick=()=>hide(m);
  });
})();

(function promosDynamic(){
  const $=s=>document.querySelector(s);
  const money=n=>`$${(+n||0).toFixed(2)}`;

  // remove old promo (if any)
  const old = document.getElementById('promoBoard'); if (old) old.remove();

  // create board under Emergency section
  const home=$('#page-home'); if(!home) return;
  const sections=[...home.querySelectorAll('.section')];
  const emergency = sections.find(sec=> sec.querySelector('.title')?.textContent.trim().toLowerCase()==='emergency');
  const wrap=document.createElement('section'); wrap.className='section'; wrap.id='promoBoard';
  (emergency? emergency.insertAdjacentElement('afterend', wrap) : home.appendChild(wrap));

  function sec(title){ const c=document.createElement('div'); c.className='promoSec'; c.innerHTML=`<div class="sectionTitle">${title}</div><div class="promoRow"></div>`; wrap.appendChild(c); return c.querySelector('.promoRow'); }
  function card({img, title, sub, click, emoji}){
    const d=document.createElement('div'); d.className='promoMini'; d.onclick=click;
    d.innerHTML = `<div class="thumb">${img? `<img src="${img}" class="thumb" style="height:110px;width:100%;object-fit:cover;border:0">` : (emoji||'')}</div>
                   <div class="content"><div class="title">${title||''}</div>${sub? `<div class="sub">${sub}</div>`:''}</div>`;
    return d;
  }

  // sources
  const MP = (window.MP_PRODUCTS||[]).concat((function(){ try{return JSON.parse(localStorage.getItem('zup_user_products')||'[]')}catch{return[]} })());
  const VEND = window.VENDORS || [];
  const MENUS = window.MENUS || {};
  function menuFlatten(){
    const out=[]; Object.keys(MENUS).forEach(v=> (MENUS[v]||[]).forEach(m=> out.push({...m, vendorId:v}))); return out;
  }
  function pick(arr, n=4){
    const a = arr.slice(); const out=[];
    while (a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); }
    return out;
  }
  function dp(cat){ return (window.dummyProviders? window.dummyProviders(cat):[]); }

  // 1) High‑rated taxi drivers around you
  const rowTaxi = sec('High‑rated taxi drivers around you');
  function renderTaxi(){
    rowTaxi.innerHTML='';
    const drivers = [
      { name:'Taxi • Alex', eta:'3‑5m' }, { name:'Taxi • Sam', eta:'4‑6m' },
      { name:'Taxi • Zoe', eta:'5‑7m' },  { name:'Taxi • Ray', eta:'6‑9m' },
      { name:'Taxi • Neo', eta:'7‑10m' }
    ];
    pick(drivers,4).forEach(d=>{
      rowTaxi.appendChild(card({
        emoji:'🚖',
        title:d.name,
        sub:`ETA ${d.eta}`,
        click:()=>{ if (window.openTransportProviders) openTransportProviders('taxi','Ride / Taxi'); else document.getElementById('transportOptionsModal')?.classList.add('open'); }
      }));
    });
  }
  renderTaxi();

  // 2) Reliable electricians around you
  const rowElec = sec('Reliable electricians around you');
  function renderElec(){
    rowElec.innerHTML='';
    const prov = dp('construction').map(p=>({...p, jobTitle:'Electrician'}));
    pick(prov.length?prov:[{publicName:'Pro Spark', eta:'6‑9m'},{publicName:'Wired Fix', eta:'8‑12m'},{publicName:'Volt Crew', eta:'5‑8m'},{publicName:'Quick Electrix', eta:'7‑10m'}],4)
      .forEach(p=>{
        rowElec.appendChild(card({
          emoji:'🔌',
          title:p.publicName||'Electrician',
          sub:`ETA ${p.eta||'—'}`,
          click:()=> window.openCategory ? openCategory('construction','Construction') : null
        }));
      });
  }
  renderElec();

  // 3) Best sellers at Marketplace
  const rowMP = sec('Best sellers at Marketplace');
  function renderMP(){
    rowMP.innerHTML='';
    pick(MP.length?MP:[
      {title:'Smartphone', price:499, img:''},
      {title:'Sneakers', price:79, img:''},
      {title:'Tool set', price:39, img:''},
      {title:'Headphones', price:59, img:''},
    ],4).forEach(p=>{
      rowMP.appendChild(card({
        img:p.img, emoji:p.img?'':'🛍️',
        title:p.title, sub: (p.price!=null? money(p.price):''),
        click:()=>{ window.showPage && showPage('marketplace'); const s=document.getElementById('mpSearch'); if(s){ s.value=p.title; } document.getElementById('mpSearchBtn')?.click(); }
      }));
    });
  }
  renderMP();

  // 4) Finger‑licking bites from nearby vendors
  const rowFood = sec('Finger‑licking bites from nearby vendors');
  function renderFood(){
    rowFood.innerHTML='';
    const menus = menuFlatten();
    pick(menus.length?menus:[
      {title:'Burger', price:8.5, vendorId:(VEND[0]?.id), img:''},
      {title:'Pizza', price:12, vendorId:(VEND[1]?.id), img:''},
      {title:'Fries', price:3, vendorId:(VEND[0]?.id), img:''},
      {title:'Salad', price:6, vendorId:(VEND[2]?.id), img:''},
    ],4).forEach(m=>{
      rowFood.appendChild(card({
        img:m.img, emoji:m.img?'':'🍔',
        title:m.title, sub: money(m.price),
        click:()=>{ 
          const V=window.VENDORS||[];
          const v = V.find(x=>x.id===m.vendorId) || V[0];
          if (v && window.openFoodMenu){ openFoodMenu(v); }
          else { document.getElementById('foodOptionsModal')?.classList.add('open'); }
        }
      }));
    });
  }
  renderFood();

  // 5) What you can do with ZippUp
  const rowZU = sec('What you can do with ZippUp');
  [
    {emoji:'🚗', t:'Book rides & trucks', click:()=>document.getElementById('transportOptionsModal')?.classList.add('open')},
    {emoji:'🛠️', t:'Hire providers', click:()=> window.openCategory && openCategory('home','Home') },
    {emoji:'🛍️', t:'Buy & sell safely', click:()=> window.showPage && showPage('marketplace') },
    {emoji:'🍔', t:'Order food', click:()=> document.getElementById('foodOptionsModal')?.classList.add('open') },
  ].forEach(x=> rowZU.appendChild(card({emoji:x.emoji, title:x.t, click:x.click})));

  // auto-reshuffle every 10s
  setInterval(()=>{ renderTaxi(); renderElec(); renderMP(); renderFood(); }, 10000);
})();
</script>
  <script>
/* Replace the previous promos builder with this one (better routing) */
(function promosDynamicRouted(){
  const $=s=>document.querySelector(s);
  const money=n=>`$${(+n||0).toFixed(2)}`;

  // Remove old board
  document.getElementById('promoBoard')?.remove();

  // Insert under Emergency section
  const home=$('#page-home'); if(!home) return;
  const sections=[...home.querySelectorAll('.section')];
  const emergency = sections.find(sec=> sec.querySelector('.title')?.textContent.trim().toLowerCase()==='emergency');
  const wrap=document.createElement('section'); wrap.className='section'; wrap.id='promoBoard';
  (emergency? emergency.insertAdjacentElement('afterend', wrap) : home.appendChild(wrap));

  // Helpers
  function sec(title){ const c=document.createElement('div'); c.className='promoSec'; c.innerHTML=`<div class="sectionTitle">${title}</div><div class="promoRow"></div>`; wrap.appendChild(c); return c.querySelector('.promoRow'); }
  function card({img, title, sub, click, emoji}){
    const d=document.createElement('div'); d.className='promoMini'; d.onclick=click;
    d.innerHTML = `<div class="thumb">${img? `<img src="${img}" style="height:110px;width:100%;object-fit:cover;border:0">` : (emoji||'')}</div>
                   <div class="content"><div class="title">${title||''}</div>${sub? `<div class="sub">${sub}</div>`:''}</div>`;
    return d;
  }
  function pick(arr, n=4){ const a=arr.slice(); const out=[]; while(a.length && out.length<n){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

  // Data sources (use what you already have on page)
  const VENDORS = (window.VENDORS || []);
  const MENUS   = (window.MENUS   || {});
  const MP      = (window.MP_PRODUCTS||[]).concat((()=>{ try{return JSON.parse(localStorage.getItem('zup_user_products')||'[]')}catch{return[]} })());

  // Flatten menu with vendor reference (for reliable routing)
  const MENUS_FLAT = (function(){
    const out=[];
    Object.keys(MENUS).forEach(vid=>{
      const vendor = VENDORS.find(v=>v.id===vid);
      (MENUS[vid]||[]).forEach(m=> out.push({ ...m, vendorId: vid, vendor }));
    });
    return out;
  })();

  // Routing helpers (go straight to the right UI)
  function goTransport(kind){
    if (window.openTransportProviders) openTransportProviders(kind, kind==='taxi'?'Ride / Taxi':'Truck / Backie');
    else document.getElementById('transportOptionsModal')?.classList.add('open');
  }
  function goFoodMenuByVendor(vendor){
    if (vendor && window.openFoodMenu) { openFoodMenu(vendor); return; }
    // fallback: open options, then vendors, then first vendor
    const m=document.getElementById('foodOptionsModal'); if(m){ m.classList.add('open'); }
    setTimeout(()=>{ if (window.openFoodVendors) openFoodVendors('fastfood'); }, 150);
    setTimeout(()=>{ const v = VENDORS[0]; if (v && window.openFoodMenu) openFoodMenu(v); }, 350);
  }
  function goProvidersFiltered(cat, list){
    if (window.renderProviders) {
      document.getElementById('provSearchRow').style.display='';
      document.getElementById('providersTitle').textContent = 'Providers — Suggested';
      renderProviders(list, cat);
      document.getElementById('providersModal')?.classList.add('open');
    } else if (window.openCategory) {
      openCategory(cat, cat);
    }
  }
  function goMarketplaceTo(title){
    if (window.showPage) showPage('marketplace');
    const s=document.getElementById('mpSearch'); if (s) s.value=title||'';
    document.getElementById('mpSearchBtn')?.click();
  }

  // Sections

  // 1) High‑rated taxi drivers around you (dynamic-ish demo)
  const rowTaxi = sec('High‑rated taxi drivers around you');
  (function renderTaxi(){
    rowTaxi.innerHTML='';
    const drivers = [
      { name:'Taxi • Alex', eta:'3‑5m' }, { name:'Taxi • Sam', eta:'4‑6m' },
      { name:'Taxi • Zoe', eta:'5‑7m' },  { name:'Taxi • Ray', eta:'6‑9m' },
      { name:'Taxi • Neo', eta:'7‑10m' }
    ];
    pick(drivers,4).forEach(d=>{
      rowTaxi.appendChild(card({
        emoji:'🚖', title:d.name, sub:`ETA ${d.eta}`,
        click:()=> goTransport('taxi')
      }));
    });
  })();

  // 2) Reliable electricians around you (provider cards)
  const rowElec = sec('Reliable electricians around you');
  (function renderElec(){
    rowElec.innerHTML='';
    // Use your providers list if available; else demo
    const base = (window.dummyProviders? window.dummyProviders('construction'):[]).map(p=>({...p, jobTitle:'Electrician'}));
    const fallback = [
      { publicName:'Pro Spark', jobTitle:'Electrician', eta:'6‑9m' },
      { publicName:'Wired Fix', jobTitle:'Electrician', eta:'8‑12m' },
      { publicName:'Volt Crew', jobTitle:'Electrician', eta:'5‑8m' },
      { publicName:'Quick Electrix', jobTitle:'Electrician', eta:'7‑10m' }
    ];
    pick(base.length?base:fallback,4).forEach(p=>{
      rowElec.appendChild(card({
        emoji:'🔌',
        title:p.publicName||'Electrician',
        sub:`${p.jobTitle||'Electrician'} • ETA ${p.eta||'—'}`,
        click:()=> goProvidersFiltered('construction', base.length?base:fallback)
      }));
    });
  })();

  // 3) Best sellers at Marketplace (product cards)
  const rowMP = sec('Best sellers at Marketplace');
  (function renderMP(){
    rowMP.innerHTML='';
    const pool = MP.length? MP : [
      {title:'Smartphone', price:499, img:''},
      {title:'Sneakers', price:79, img:''},
      {title:'Tool set', price:39, img:''},
      {title:'Headphones', price:59, img:''},
    ];
    pick(pool,4).forEach(p=>{
      rowMP.appendChild(card({
        img:p.img, emoji:p.img?'':'🛍️',
        title:p.title, sub:(p.price!=null? money(p.price):''),
        click:()=> goMarketplaceTo(p.title)
      }));
    });
  })();

  // 4) Finger‑licking bites from nearby vendors (menu items -> vendor menu)
  const rowFood = sec('Finger‑licking bites from nearby vendors');
  (function renderFood(){
    rowFood.innerHTML='';
    const pool = MENUS_FLAT.length? MENUS_FLAT : [
      {title:'Burger', price:8.5, vendor: (VENDORS[0]||null), img:''},
      {title:'Pizza',  price:12,  vendor: (VENDORS[1]||null), img:''},
      {title:'Fries',  price:3,   vendor: (VENDORS[0]||null), img:''},
      {title:'Salad',  price:6,   vendor: (VENDORS[2]||null), img:''},
    ];
    pick(pool,4).forEach(m=>{
      rowFood.appendChild(card({
        img:m.img, emoji:m.img?'':'🍔',
        title:m.title, sub: money(m.price),
        click:()=> goFoodMenuByVendor(m.vendor || (VENDORS.find(v=>v.id===m.vendorId) || VENDORS[0] || null))
      }));
    });
  })();

  // 5) What you can do with ZippUp (navigational promos)
  const rowZU = sec('What you can do with ZippUp');
  [
    {emoji:'🚗', t:'Book rides & trucks', click:()=> goTransport('taxi')},
    {emoji:'🛠️', t:'Hire providers',     click:()=> goProvidersFiltered('home', (window.dummyProviders? window.dummyProviders('home'):[]))},
    {emoji:'🛍️', t:'Buy & sell safely',  click:()=> goMarketplaceTo('')},
    {emoji:'🍔', t:'Order food',          click:()=> document.getElementById('foodOptionsModal')?.classList.add('open') },
  ].forEach(x=> rowZU.appendChild(card({emoji:x.emoji, title:x.t, click:x.click})));

  // Auto-reshuffle provider/product pools every 12s (feels alive)
  setInterval(()=>{ 
    // rerender only data sections
    while(rowTaxi.firstChild) rowTaxi.removeChild(rowTaxi.firstChild);
    while(rowElec.firstChild) rowElec.removeChild(rowElec.firstChild);
    while(rowMP.firstChild)   rowMP.removeChild(rowMP.firstChild);
    while(rowFood.firstChild) rowFood.removeChild(rowFood.firstChild);
    // re-run
    const rePick = (r, pool, cb)=> pick(pool,4).forEach(x=> r.appendChild(cb(x)));
    // taxi
    (function(){ const drivers=[{name:'Taxi • Alex',eta:'3‑5m'},{name:'Taxi • Sam',eta:'4‑6m'},{name:'Taxi • Zoe',eta:'5‑7m'},{name:'Taxi • Ray',eta:'6‑9m'},{name:'Taxi • Neo',eta:'7‑10m'}];
      rePick(rowTaxi, drivers, d=> card({emoji:'🚖', title:d.name, sub:`ETA ${d.eta}`, click:()=>goTransport('taxi')})); })();
    // electricians
    (function(){ const base=(window.dummyProviders? window.dummyProviders('construction'):[]).map(p=>({...p, jobTitle:'Electrician'}));
      const fb=[{publicName:'Pro Spark', jobTitle:'Electrician', eta:'6‑9m'},{publicName:'Wired Fix', jobTitle:'Electrician', eta:'8‑12m'},{publicName:'Volt Crew', jobTitle:'Electrician', eta:'5‑8m'},{publicName:'Quick Electrix', jobTitle:'Electrician', eta:'7‑10m'}];
      const pool=base.length?base:fb;
      rePick(rowElec, pool, p=> card({emoji:'🔌', title:p.publicName||'Electrician', sub:`${p.jobTitle||'Electrician'} • ETA ${p.eta||'—'}`, click:()=>goProvidersFiltered('construction', pool)})); })();
    // marketplace
    const MP2 = (window.MP_PRODUCTS||[]).concat((()=>{ try{return JSON.parse(localStorage.getItem('zup_user_products')||'[]')}catch{return[]} })());
    const mpPool = MP2.length? MP2 : [{title:'Smartphone',price:499,img:''},{title:'Sneakers',price:79,img:''},{title:'Tool set',price:39,img:''},{title:'Headphones',price:59,img:''}];
    rePick(rowMP, mpPool, p=> card({img:p.img, emoji:p.img?'':'🛍️', title:p.title, sub:(p.price!=null? money(p.price):''), click:()=>goMarketplaceTo(p.title)}));
    // food
    const FLAT=(function(){ const out=[]; const V=(window.VENDORS||[]); const M=(window.MENUS||{}); Object.keys(M).forEach(vid=>{ const v=V.find(x=>x.id===vid); (M[vid]||[]).forEach(m=> out.push({...m, vendor:v})); }); return out; })();
    const foodPool = FLAT.length? FLAT : [{title:'Burger', price:8.5, vendor:(VENDORS[0]||null), img:''},{title:'Pizza', price:12, vendor:(VENDORS[1]||null), img:''},{title:'Fries', price:3, vendor:(VENDORS[0]||null), img:''},{title:'Salad', price:6, vendor:(VENDORS[2]||null), img:''}];
    rePick(rowFood, foodPool, m=> card({img:m.img, emoji:m.img?'':'🍔', title:m.title, sub:money(m.price), click:()=>goFoodMenuByVendor(m.vendor || null)}));
  }, 12000);
})();
</script>
  <script>
(function stopEmailAutofillInSearch(){
  const s = document.getElementById('search');
  if (s) {
    s.setAttribute('name','q');
    s.setAttribute('autocomplete','off');
    s.setAttribute('autocapitalize','off');
    s.setAttribute('spellcheck','false');
    // If browser already dropped an email, clear it
    if (/@/.test(s.value)) s.value = '';
  }
  // Honeypot to catch autofill away from search
  const hp = document.createElement('input');
  hp.type = 'text';
  hp.autocomplete = 'username';
  hp.style.cssText = 'position:fixed;left:-9999px;width:0;height:0;opacity:0';
  document.body.prepend(hp);

  // Also clear after Firebase login changes state
  try {
    firebase.auth().onAuthStateChanged(function(u){
      const box = document.getElementById('search');
      if (box && /@/.test(box.value)) box.value = '';
    });
  } catch(e){}
})();
</script>
  <!-- Confirm Delivery -->
<div class="modal" id="confirmCodeModal" style="display:none">
  <div class="sheet">
    <div class="head">
      <strong>Confirm Delivery</strong>
      <button class="btn ghost" id="dlvCodeClose" type="button">✖</button>
    </div>
    <div class="body">
      <div class="small muted" style="margin-bottom:6px">Enter the buyer’s 6‑digit delivery code to complete the order.</div>
      <div class="row" style="gap:8px">
        <input id="dlvCodeInput" placeholder="e.g., 123456" inputmode="numeric" style="flex:1"/>
        <button class="btn primary" id="dlvCodeSubmit" type="button">Confirm</button>
      </div>
    </div>
  </div>
</div>
  <script>
(function confirmDeliveryWiring(){
  const $=s=>document.querySelector(s);
  // Add a "Confirm Delivery" button on Manage Orders page header
  (function injectButton(){
    const page=document.getElementById('page-orders'); if(!page) return;
    const sec=page.querySelector('.section'); if(!sec) return;
    if (document.getElementById('openConfirmCode')) return;
    const btn=document.createElement('button');
    btn.className='btn ghost'; btn.id='openConfirmCode'; btn.type='button'; btn.textContent='Confirm Delivery';
    btn.style.margin='6px 0';
    // place right under the title
    const title=sec.querySelector('.title');
    if (title) title.insertAdjacentElement('afterend', btn); else sec.prepend(btn);
    btn.onclick=()=>{ const m=$('#confirmCodeModal'); if(m){ m.style.display='flex'; m.classList.add('open'); $('#dlvCodeInput')?.focus(); } };
  })();

  // Close handlers
  (function wireClose(id){
    const m=document.getElementById(id); if(!m) return;
    const hide=()=>{ m.classList.remove('open'); m.style.display='none'; };
    m.addEventListener('click', e=>{ if(e.target===m) hide(); });
    m.querySelector('#dlvCodeClose')?.addEventListener('click', hide);
  })('confirmCodeModal');

  // Confirm handler: match code to an active food order, mark completed
  const submit=async ()=>{
    const input=document.getElementById('dlvCodeInput'); if(!input) return;
    const code=(input.value||'').trim();
    if (!code) return alert('Enter the 6‑digit code');
    try{
      const list = (window.orders||[]);
      const o = list.find(x=> x && x.type==='food' && ['assigned','enroute','preparing'].includes(x.status) && String(x.code||'')===code);
      if (!o) { alert('Invalid code or no matching active food order'); return; }
      o.status='completed';
      if (typeof window.setOrders==='function') window.setOrders(list);
      if (typeof window.renderOrders==='function') window.renderOrders();
      alert('Delivery confirmed. Thank you!');
      const m=document.getElementById('confirmCodeModal'); if(m){ m.classList.remove('open'); m.style.display='none'; }
      input.value='';
    }catch{ alert('Could not confirm delivery, please try again.'); }
  };
  document.getElementById('dlvCodeSubmit')?.addEventListener('click', submit);
  document.getElementById('dlvCodeInput')?.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });
})();
</script>
  <script>
document.addEventListener('DOMContentLoaded', ()=>{
  const b=document.getElementById('openConfirmCode');
  if (b){ b.classList.remove('ghost'); b.classList.add('success'); }
});
</script>
  <script>
(function personalizedGreeting(){
  const $=s=>document.querySelector(s);

  function getName(){
    try{
      if (window.user?.name) return window.user.name;
      const u = window.firebase?.auth?.().currentUser;
      const n = (u?.displayName) || (u?.email? u.email.split('@')[0] : '');
      return n || 'Guest';
    }catch{return 'Guest'}
  }
  function titleCase(n){
    return (n||'').split(/[\s._-]+/).filter(Boolean)
      .map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' ');
  }
  function greetPrefix(){
    const h=new Date().getHours();
    if (h<12) return 'Good morning';
    if (h<18) return 'Good afternoon';
    return 'Good evening';
  }
  function ensureSpan(){
    const bell=$('#notifBtn');
    let span=$('#headerGreet');
    if (!span && bell){
      span=document.createElement('span');
      span.id='headerGreet';
      span.className='small';
      span.style.whiteSpace='nowrap';
      bell.insertAdjacentElement('afterend', span);
    }
    return span;
  }
  function update(){
    const span=ensureSpan(); if (!span) return;
    const name=titleCase(getName());
    span.textContent = `${greetPrefix()} ${name}`;
  }

  document.addEventListener('DOMContentLoaded', update);
  try { firebase.auth().onAuthStateChanged(()=> setTimeout(update, 50)); } catch {}
  const prev = window.updateProfileUI;
  window.updateProfileUI = function(){ if (prev) prev.apply(this, arguments); update(); };
})();
</script>
  <script>
(function adminDash(){
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  let isAdmin=false, idToken=null;

  // Add "Admin" button in profile menu (visible only if admin)
  function ensureAdminMenu(){
    if (!isAdmin) { const b=$('#menuAdmin'); if (b) b.remove(); return; }
    if ($('#menuAdmin')) return;
    const anchor=$('#menuSupport') || $('#menuWallet') || $('#menuProfile');
    const btn=document.createElement('button');
    btn.className='btn ghost'; btn.id='menuAdmin'; btn.type='button'; btn.textContent='🛡️ Admin';
    btn.onclick=()=>{ $('#profileMenu').style.display='none'; openAdmin(); };
    const menu=$('#profileMenu'); if (!menu) return;
    if (anchor) anchor.insertAdjacentElement('beforebegin', btn); else menu.prepend(btn);
  }

  async function refreshToken(){
    try{
      const u = window.firebase?.auth?.().currentUser;
      if (!u) { idToken=null; return; }
      const t = await u.getIdToken(/*forceRefresh*/true);
      idToken = t;
      const tr = await u.getIdTokenResult();
      isAdmin = !!(tr?.claims?.role==='admin' || tr?.claims?.admin===true || tr?.claims?.role==='staff');
    }catch{ isAdmin=false; idToken=null; }
    ensureAdminMenu();
    const note=$('#adminRoleNote'); if (note) note.textContent = isAdmin ? 'Admin access granted' : 'You are not an admin';
  }

  // Auth change => check claims
  try { window.firebase.auth().onAuthStateChanged(()=>refreshToken()); } catch {}

  // API helpers
  async function api(path, opts={}){
    const url = (window.BASE_API||'') + path;
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers||{});
    if (idToken) headers['Authorization']='Bearer '+idToken;
    const res = await fetch(url, Object.assign({}, opts, { headers }));
    if (!res.ok) throw new Error(await res.text());
    if ((res.headers.get('content-type')||'').includes('application/json')) return res.json();
    return res.text();
  }

  // Open admin page (guard)
  window.openAdmin = function(){
    if (!isAdmin){ alert('Admin access required'); return; }
    if (window.showPage) window.showPage('admin');
    activateTab('orders');
    loadOrders();
  };

  // Tabs
  function activateTab(name){
    $$('#adminTabs .btn').forEach(b=> b.classList.toggle('active', b.getAttribute('data-admin-tab')===name));
    ['orders','vendors','market','users','wallet','emergency','promos'].forEach(id=>{
      const v=$('#admin-'+id); if (v) v.style.display = (id===name? 'grid':'none');
    });
  }
  $('#adminTabs')?.addEventListener('click',(e)=>{
    const b=e.target.closest('[data-admin-tab]'); if(!b) return;
    const tab=b.getAttribute('data-admin-tab'); activateTab(tab);
    if (tab==='orders') loadOrders();
    if (tab==='vendors') loadVendors();
    if (tab==='market') loadMarket();
    if (tab==='users') loadUsers();
    if (tab==='wallet') loadWallet();
    if (tab==='emergency') {} // form only
    if (tab==='promos') loadPromos();
  });

  // Loaders
  async function loadOrders(){
    const box=$('#admin-orders'); if (!box) return;
    box.innerHTML='<div class="small muted">Loading…</div>';
    try{
      const data = await api('/api/orders?role=all', { method:'GET' });
      if (!Array.isArray(data) || !data.length){ box.innerHTML='<div class="small muted">No orders</div>'; return; }
      box.innerHTML = data.slice(0,20).map(o=>`
        <div class="card">
          <div><strong>${o.title||o.vendorName||o.type||'Order'}</strong> <span class="small muted">• ${o.status}</span></div>
          <div class="small muted">ID: ${o.id}</div>
          ${o.code? `<div class="small">Code: <span style="font-family:monospace">${o.code}</span></div>`:''}
          <div class="row" style="gap:6px;margin-top:8px">
            <button class="btn ghost" data-act="mark" data-id="${o.id}" data-s="completed">Mark completed</button>
            <button class="btn ghost" data-act="mark" data-id="${o.id}" data-s="canceled">Cancel</button>
          </div>
        </div>`).join('');
      box.onclick=async (e)=>{
        const b=e.target.closest('[data-act="mark"]'); if(!b) return;
        const id=b.getAttribute('data-id'), st=b.getAttribute('data-s');
        try{ await api(`/api/orders/${encodeURIComponent(id)}`, { method:'PATCH', body: JSON.stringify({ status: st }) }); loadOrders(); }catch(err){ alert('Failed: '+err.message); }
      };
    }catch(err){ box.innerHTML='<div class="small muted">Failed to load orders</div>'; }
  }

  async function loadVendors(){
    const box=$('#admin-vendors'); if (!box) return;
    box.innerHTML='<div class="small muted">Loading…</div>';
    try{
      const v = await api('/api/food/vendors', { method:'GET' });
      if (!Array.isArray(v) || !v.length){ box.innerHTML='<div class="small muted">No vendors</div>'; return; }
      box.innerHTML = v.slice(0,20).map(x=>`
        <div class="card">
          <div><strong>${x.name||'Vendor'}</strong> <span class="small muted">${x.kind||''}</span></div>
          <div class="small muted">ID: ${x.id||''}</div>
        </div>`).join('');
    }catch{ box.innerHTML='<div class="small muted">Failed to load vendors</div>'; }
  }

  async function loadMarket(){
    const box=$('#admin-market'); if (!box) return;
    box.innerHTML='<div class="small muted">Loading…</div>';
    try{
      const items = await api('/api/marketplace/products', { method:'GET' });
      if (!Array.isArray(items) || !items.length){ box.innerHTML='<div class="small muted">No listings</div>'; return; }
      box.innerHTML = items.slice(0,20).map(p=>`
        <div class="card">
          <div><strong>${p.title||'Item'}</strong> <span class="small muted">• ${p.cat||p.category||''}</span></div>
          <div class="small muted">${p.price!=null? ('$'+p.price):''}</div>
          <div class="row" style="gap:6px;margin-top:8px">
            <button class="btn ghost" data-act="disable" data-id="${p.id}">Disable</button>
          </div>
        </div>`).join('');
      box.onclick=async (e)=>{
        const b=e.target.closest('[data-act="disable"]'); if(!b) return;
        const id=b.getAttribute('data-id');
        try{ await api(`/api/marketplace/listings/${encodeURIComponent(id)}`, { method:'PATCH', body: JSON.stringify({ status:'disabled' }) }); loadMarket(); }catch(err){ alert('Failed: '+err.message); }
      };
    }catch{ box.innerHTML='<div class="small muted">Failed to load marketplace</div>'; }
  }

  async function loadUsers(){
    const box=$('#admin-users'); if (!box) return;
    box.innerHTML='<div class="small muted">Loading…</div>';
    try{
      // Optional endpoint: /api/admin/users
      const users = await api('/api/admin/users', { method:'GET' }).catch(()=>[]);
      if (!Array.isArray(users) || !users.length){ box.innerHTML='<div class="small muted">No user list API. You can still set roles via server script.</div>'; return; }
      box.innerHTML = users.slice(0,20).map(u=>`
        <div class="card">
          <div><strong>${u.name||u.email||u.uid}</strong> <span class="small muted">${u.email||''}</span></div>
          <div class="row" style="gap:6px;margin-top:8px">
            <button class="btn ghost" data-role="admin" data-uid="${u.uid}">Make Admin</button>
            <button class="btn ghost" data-role="staff" data-uid="${u.uid}">Make Staff</button>
          </div>
        </div>`).join('');
      box.onclick=async (e)=>{
        const b=e.target.closest('[data-role]'); if(!b) return;
        const uid=b.getAttribute('data-uid'), role=b.getAttribute('data-role');
        try{ await api(`/api/admin/users/${encodeURIComponent(uid)}/role`, { method:'POST', body: JSON.stringify({ role }) }); alert('Role updated'); }catch(err){ alert('Failed: '+err.message); }
      };
    }catch{ box.innerHTML='<div class="small muted">Failed to load users</div>'; }
  }

  async function loadWallet(){
    const box=$('#admin-wallet'); if (!box) return;
    box.innerHTML='<div class="small muted">Wallet admin is coming soon (adjustments, payouts).</div>';
  }

  // Emergency defaults
  $('#admEmerSave')?.addEventListener('click', async ()=>{
    const region=$('#admEmerRegion')?.value.trim(), number=$('#admEmerNumber')?.value.trim();
    if (!region || !number) return alert('Fill region and number');
    try{ await api('/api/admin/emergency/default',{ method:'POST', body: JSON.stringify({ region, number }) }); $('#admEmerStatus').textContent='Saved'; }catch(err){ alert('Failed: '+err.message); }
  });

  // Promotions
  async function loadPromos(){
    const list=$('#admPromoList'); if(!list) return;
    list.innerHTML='<div class="small muted">Loading…</div>';
    try{
      const items = await api('/api/promotions', { method:'GET' });
      if (!Array.isArray(items) || !items.length){ list.innerHTML='<div class="small muted">No promotions</div>'; return; }
      list.innerHTML = items.map(p=>`<div class="card"><div><strong>${p.title}</strong> <span class="small muted">• ${p.type}</span></div></div>`).join('');
    }catch{ list.innerHTML='<div class="small muted">Failed to load</div>'; }
  }
  $('#admPromoSave')?.addEventListener('click', async ()=>{
    const title=$('#admPromoTitle')?.value.trim(), type=$('#admPromoType')?.value, payload=$('#admPromoPayload')?.value.trim();
    if (!title || !type) return alert('Fill title and type');
    let json={}; try{ if(payload) json=JSON.parse(payload); }catch{ return alert('Payload must be valid JSON'); }
    try{ await api('/api/admin/promotions', { method:'POST', body: JSON.stringify({ title, type, payload: json }) }); $('#admPromoStatus').textContent='Published'; loadPromos(); }catch(err){ alert('Failed: '+err.message); }
  });

  // Deep-link: /admin or #/admin
  (function deepLink(){
    const path = location.pathname.toLowerCase(), hash=location.hash.toLowerCase();
    if (path.endsWith('/admin') || hash==='#/admin') {
      const wait = setInterval(()=>{ if (typeof window.showPage==='function'){ clearInterval(wait); refreshToken().then(()=> openAdmin()); } }, 50);
    }
  })();
})();
</script>
  <script>
(function easyAdminEnable(){
  const ADMIN_UIDS = ['NteMlemGVzY9RjqgpiabIJ9LbPh1']; // your UID

  function addAdminMenu() {
    const u = window.firebase?.auth?.().currentUser;
    if (!u || !ADMIN_UIDS.includes(u.uid)) return;

    // Add Admin button to the Account menu if missing
    const menu = document.getElementById('profileMenu');
    if (!menu || document.getElementById('menuAdmin')) return;
    const anchor = document.getElementById('menuSupport') || document.getElementById('menuWallet') || document.getElementById('menuProfile');

    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.id = 'menuAdmin';
    btn.type = 'button';
    btn.textContent = '🛡️ Admin';
    btn.onclick = () => {
      const m = document.getElementById('profileMenu');
      if (m) m.style.display = 'none';
      if (typeof window.openAdmin === 'function') window.openAdmin();
      else if (typeof window.showPage === 'function') window.showPage('admin');
    };

    if (anchor) anchor.insertAdjacentElement('beforebegin', btn); else menu.prepend(btn);

    // Deep link: /#/admin or ?admin=1
    const wantAdmin = location.hash.toLowerCase()==='#/admin' || location.search.toLowerCase().includes('admin=1');
    if (wantAdmin) btn.click();
  }

  try {
    // Run on login changes
    window.firebase.auth().onAuthStateChanged(() => setTimeout(addAdminMenu, 100));
  } catch {
    // Fallback run after DOM ready
    document.addEventListener('DOMContentLoaded', () => setTimeout(addAdminMenu, 300));
  }
})();
</script>
  <script>
(function easyAdminEnable(){
  const ADMIN_UIDS = ['NteMlemGVzY9RjqgpiabIJ9LbPh1']; // your UID

  function addAdminMenu() {
    const u = window.firebase?.auth?.().currentUser;
    if (!u || !ADMIN_UIDS.includes(u.uid)) return;

    // Add Admin button to the Account menu if missing
    const menu = document.getElementById('profileMenu');
    if (!menu || document.getElementById('menuAdmin')) return;
    const anchor = document.getElementById('menuSupport') || document.getElementById('menuWallet') || document.getElementById('menuProfile');

    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.id = 'menuAdmin';
    btn.type = 'button';
    btn.textContent = '🛡️ Admin';
    btn.onclick = () => {
      const m = document.getElementById('profileMenu');
      if (m) m.style.display = 'none';
      if (typeof window.openAdmin === 'function') window.openAdmin();
      else if (typeof window.showPage === 'function') window.showPage('admin');
    };

    if (anchor) anchor.insertAdjacentElement('beforebegin', btn); else menu.prepend(btn);

    // Deep link: /#/admin or ?admin=1
    const wantAdmin = location.hash.toLowerCase()==='#/admin' || location.search.toLowerCase().includes('admin=1');
    if (wantAdmin) btn.click();
  }

  try {
    // Run on login changes
    window.firebase.auth().onAuthStateChanged(() => setTimeout(addAdminMenu, 100));
  } catch {
    // Fallback run after DOM ready
    document.addEventListener('DOMContentLoaded', () => setTimeout(addAdminMenu, 300));
  }
})();
</script>
  <script>
(function forceAdminButton(){
  const ADMIN_UIDS = ['NteMlemGVzY9RjqgpiabIJ9LbPh1'];

  function isAdminUid(){
    try {
      const u = window.firebase?.auth?.().currentUser;
      return !!(u && ADMIN_UIDS.includes(u.uid));
    } catch { return false; }
  }

  function injectAdminButton(){
    if (!isAdminUid()) return;
    const menu = document.getElementById('profileMenu');
    if (!menu) return;
    if (document.getElementById('menuAdmin')) return;

    const anchor = document.getElementById('menuSupport')
                || document.getElementById('menuWallet')
                || document.getElementById('menuProfile');

    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.id = 'menuAdmin';
    btn.type = 'button';
    btn.textContent = '🛡️ Admin';
    btn.onclick = () => {
      menu.style.display = 'none';
      if (typeof window.openAdmin === 'function') window.openAdmin();
      else if (typeof window.showPage === 'function') window.showPage('admin');
      else alert('Admin page not installed yet in this file.');
    };

    if (anchor) anchor.insertAdjacentElement('beforebegin', btn);
    else menu.prepend(btn);
  }

  // Run when auth changes
  try {
    window.firebase.auth().onAuthStateChanged(() => setTimeout(injectAdminButton, 100));
  } catch {}

  // Run whenever the Account menu is opened
  document.getElementById('profileBtn')?.addEventListener('click', () => setTimeout(injectAdminButton, 50));

  // Watch DOM (in case menu is rendered later)
  const mo = new MutationObserver(() => injectAdminButton());
  mo.observe(document.body, { childList:true, subtree:true });

  // Deep link support: https://your-site/#/admin
  if (location.hash.toLowerCase() === '#/admin') {
    const tryOpen = () => {
      if (isAdminUid()) {
        if (typeof window.openAdmin === 'function') window.openAdmin();
        else if (typeof window.showPage === 'function') window.showPage('admin');
      } else {
        alert('Sign in first with your admin account.');
      }
    };
    setTimeout(tryOpen, 300);
  }
})();
</script>
</body>
</html>
