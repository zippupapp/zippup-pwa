<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>

  <!-- Leaflet (live tracking map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Stripe.js -->
  <script defer src="https://js.stripe.com/v3"></script>

  <style>
    :root { --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.08) }
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }
    header { position:sticky; top:0; z-index:20; background:var(--card); border-bottom:1px solid var(--border) }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px }
    .greet { display:flex; flex-direction:column }
    .small { color:var(--muted); font-size:13px }
    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .service { cursor:pointer; transition:transform .1s ease }
    .service:hover { transform:translateY(-2px) }
    .row { display:flex; gap:10px; align-items:center }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }
    .floating-panic { position:fixed; right:16px; bottom:80px; width:60px; height:60px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:16; display:flex; align-items:center; justify-content:center }
    .nav { position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:space-around; background:#fff; border-top:1px solid var(--border); padding:8px 0; z-index:15 }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }
    .page { display:none; padding-bottom:80px }
    .page.active { display:block }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow) }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px }
    .list { display:flex; flex-direction:column; gap:12px }
    .provider { border:1px solid var(--border); border-radius:14px; padding:12px }
    .controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
    #track-map { width:100%; height:360px; border-radius:12px; border:1px solid var(--border) }
    #profileMenu { position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:180px; z-index:30 }
    #profileMenu .btn { width:100%; justify-content:flex-start }
    /* Marketplace */
    .product { display:flex; flex-direction:column; gap:8px }
    .product img { width:100%; height:140px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }
    .price { font-weight:700; color:#111 }
    .cart-fab { position:fixed; right:16px; bottom:140px; z-index:16 }
    .qty { display:flex; gap:8px; align-items:center }
    .qty button { width:30px; height:30px; border-radius:8px; }
    .terms { display:flex; gap:8px; align-items:flex-start; font-size:13px; color:#333 }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="greet">
        <strong>Hello, <span id="userName">Guest</span></strong>
        <span class="small">üìç <span id="userLoc">Detecting location‚Ä¶</span></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="notifBtn" type="button">üîî</button>
        <div style="position:relative">
          <button class="btn ghost" id="cartBtn" type="button">üõí</button>
          <span id="headerCartBadge" style="position:absolute; top:-6px; right:-6px; background:#DC2626; color:#fff; border-radius:999px; font-size:12px; padding:0 6px; line-height:18px; min-width:18px; text-align:center;">0</span>
        </div>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn" type="button">üë§ Account</button>
          <div id="profileMenu">
            <button class="btn ghost" id="menuProfile" type="button">üë§ Profile</button>
            <button class="btn ghost" id="menuWallet" type="button">üí∞ Wallet</button>
            <button class="btn ghost" id="menuTopup" type="button">‚ö° Top‚Äëup</button>
            <button class="btn ghost" id="menuLogout" type="button">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Home -->
  <main id="page-home" class="page active">
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency‚Ä¶"/>
        <button class="btn ghost" id="voiceBtn" type="button">üé§</button>
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </section>

    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>

    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>

    <section class="section">
      <div class="title">Recent</div>
      <div id="recentList"></div>
    </section>
  </main>

  <!-- Services landing -->
  <main id="page-services" class="page">
    <section class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesAllGrid"></div>
    </section>
  </main>

  <!-- Bookings landing -->
  <main id="page-bookings" class="page">
    <section class="section">
      <div class="title">My Bookings</div>
      <div id="bookingsList"></div>
    </section>
  </main>

  <!-- Marketplace landing -->
  <main id="page-marketplace" class="page">
    <section class="search">
      <div class="box">
        <input id="mpSearch" placeholder="Search products (e.g., phone, shoes, blender)‚Ä¶"/>
        <button class="btn ghost" id="mpVoice" type="button">üé§</button>
        <button class="btn primary" id="mpSearchBtn" type="button">Search</button>
      </div>
    </section>
    <section class="section">
      <div class="controls" id="mpChips"></div>
    </section>
    <section class="section">
      <div class="title">Products</div>
      <div class="grid" id="mpGrid"></div>
    </section>
    <div class="cart-fab">
      <button class="btn primary" id="openCartBtn" type="button">üõí Cart (<span id="cartCount">0</span>)</button>
    </div>
  </main>

  <!-- Profile -->
  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <div style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">üë§</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Demo User</strong></div>
              <div class="small" id="profEmail">demo@zippup.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn" type="button">Manage Products</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
        <button class="btn ghost" id="availToggleBtn" type="button">Go Offline / Available</button>
      </div>
    </section>
  </main>

  <!-- Wallet -->
  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong>$245.80</strong></div>
    </section>
  </main>

  <!-- Top-up -->
  <main id="page-topup" class="page">
    <section class="section">
      <div class="title">Top‚Äëup (Digital)</div>
      <div class="grid">
        <div class="card service" data-topup="airtime"><div class="row"><div style="font-size:24px">üìû</div><h4>Buy Airtime</h4></div></div>
        <div class="card service" data-topup="data"><div class="row"><div style="font-size:24px">üì∂</div><h4>Data Bundles</h4></div></div>
        <div class="card service" data-topup="bills"><div class="row"><div style="font-size:24px">üí°</div><h4>Pay Bills</h4></div></div>
      </div>
    </section>
  </main>

  <button class="floating-panic" id="panicBtn" type="button">üö®</button>

  <nav class="nav">
    <button data-page="home" class="active" type="button">üè† Home</button>
    <button data-page="services" type="button">üîß Services</button>
    <button data-page="bookings" type="button">üìã Bookings</button>
    <button data-page="marketplace" type="button">üõçÔ∏è Marketplace</button>
  </nav>

  <!-- Providers Modal -->
  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <!-- Booking Form Modal -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking" type="button">‚úñ</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <div class="small">Date</div>
              <input id="bkDate" type="date" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Time</div>
              <input id="bkTime" type="time" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div>
            <div class="small">Address or use current</div>
            <input id="bkAddress" placeholder="Enter address (optional)" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          </div>
          <div>
            <div class="small">Details</div>
            <textarea id="bkDesc" rows="3" placeholder="Describe the job‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          </div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Instant Request Modal (90s) -->
  <div class="modal" id="instantModal">
    <div class="sheet">
      <div class="head">
        <strong id="instantTitle">Contacting provider‚Ä¶</strong>
        <button class="btn ghost" id="cancelInstant" type="button">Cancel</button>
      </div>
      <div class="body">
        <div class="card">
          <div>Time left: <strong id="countdown">90</strong>s</div>
          <div class="small muted" id="instantHint">Waiting for provider to accept‚Ä¶</div>
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="findOthers" type="button">Find other providers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong>Live Tracking</strong>
        <button class="btn ghost" id="closeTrack" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="trackStatus" class="small muted">Provider accepted. En route‚Ä¶</div>
        <div id="trackMapWrap" style="margin-top:10px"><div id="track-map"></div></div>
      </div>
    </div>
  </div>

  <!-- Category Options Modal (Transport / Food) -->
  <div class="modal" id="categoryOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong id="categoryOptionsTitle">Options</strong>
        <button class="btn ghost" id="closeCategoryOptions" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="categoryOptionsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Items/Search Modal -->
  <div class="modal" id="itemsModal">
    <div class="sheet">
      <div class="head">
        <strong id="itemsTitle">Find Items</strong>
        <button class="btn ghost" id="closeItems" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="itemSearch" placeholder="Say or type what you need (e.g., pizza, plumber, tire)‚Ä¶" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <button class="btn ghost" id="itemVoice" type="button">üé§</button>
          <button class="btn primary" id="itemGo" type="button">Search</button>
        </div>
        <div id="itemChips" class="controls"></div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head">
        <strong>My Cart</strong>
        <button class="btn ghost" id="closeCart" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="cartList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="cartTotal">0.00</span></div>
          <button class="btn primary" id="checkoutBtn" type="button">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" id="checkoutModal">
    <div class="sheet">
      <div class="head">
        <strong>Checkout</strong>
        <button class="btn ghost" id="closeCheckout" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <div class="small">Full Name</div>
              <input id="chkName" placeholder="Your full name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Phone</div>
              <input id="chkPhone" placeholder="e.g. +1234567890" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div class="row" style="gap:12px">
            <div style="flex:2">
              <div class="small">Street / Address</div>
              <input id="chkAddress" placeholder="e.g. 12 Main St" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Flat / House No.</div>
              <input id="chkUnit" placeholder="e.g. Apt 2B" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div>
            <div class="small">Delivery Notes</div>
            <textarea id="chkNotes" rows="3" placeholder="Any special instructions‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          </div>
          <div>
            <div class="small">Payment Method</div>
            <div class="controls">
              <label><input type="radio" name="payMethod" value="card" checked/> Card (funds held until delivery)</label>
              <label><input type="radio" name="payMethod" value="cash"/> Cash (you accept the risk)</label>
            </div>
          </div>
          <label class="terms">
            <input type="checkbox" id="chkTerms"/>
            <span>I accept the Terms. Cash is at your own risk. For card, funds are held until seller enters the delivery code. Disputes up to 7 days. 5% platform fee on non‚Äëcash; unpaid cash fees limit selling to one more item.</span>
          </label>
          <button class="btn primary" id="placeOrderBtn" type="button">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Status Modal -->
  <div class="modal" id="orderModal">
    <div class="sheet">
      <div class="head">
        <strong>Order Status</strong>
        <button class="btn ghost" id="closeOrder" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="orderInfo" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // Config
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';
    const FALLBACK_PAYMENT_LINK = ''; // optional

    let user = { name:'Guest', email:'demo@zippup.com' };
    let coords = null;
    let selectedProvider = null;
    let requestId = null;
    let instantTimer = null;
    let instantLeft = 90;
    let map, userMarker, providerMarker, trackPoll = null;

    // Elements
    const userNameEl = document.getElementById('userName');
    const userLocEl  = document.getElementById('userLoc');

    const servicesGrid = document.getElementById('servicesGrid');
    const servicesAllGrid = document.getElementById('servicesAllGrid');
    const emergencyGrid = document.getElementById('emergencyGrid');
    const recentList = document.getElementById('recentList');

    const providersModal = document.getElementById('providersModal');
    const providersList  = document.getElementById('providersList');
    const providersTitle = document.getElementById('providersTitle');
    document.getElementById('closeProviders').onclick = () => providersModal.classList.remove('open');

    const bookingModal = document.getElementById('bookingModal');
    const bookingForm  = document.getElementById('bookingForm');
    document.getElementById('closeBooking').onclick = () => bookingModal.classList.remove('open');

    const instantModal = document.getElementById('instantModal');
    const countdownEl  = document.getElementById('countdown');
    document.getElementById('cancelInstant').onclick = cancelInstant;
    document.getElementById('findOthers').onclick = () => { instantModal.classList.remove('open'); providersModal.classList.add('open'); };

    const trackModal = document.getElementById('trackModal');
    const trackStatus= document.getElementById('trackStatus');
    document.getElementById('closeTrack').onclick = () => { stopTracking(); trackModal.classList.remove('open'); };

    const categoryOptionsModal = document.getElementById('categoryOptionsModal');
    const categoryOptionsTitle = document.getElementById('categoryOptionsTitle');
    const categoryOptionsList  = document.getElementById('categoryOptionsList');
    document.getElementById('closeCategoryOptions').onclick = () => categoryOptionsModal.classList.remove('open');

    const itemsModal = document.getElementById('itemsModal');
    const itemsTitle = document.getElementById('itemsTitle');
    const itemSearch = document.getElementById('itemSearch');
    const itemVoice  = document.getElementById('itemVoice');
    const itemGo     = document.getElementById('itemGo');
    const itemChips  = document.getElementById('itemChips');
    document.getElementById('closeItems').onclick = () => itemsModal.classList.remove('open');

    const notifBtn = document.getElementById('notifBtn');
    const cartBtn  = document.getElementById('cartBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu= document.getElementById('profileMenu');
    notifBtn.onclick = () => alert('Notifications (coming soon)');
    profileBtn.onclick = (e) => { e.stopPropagation(); profileMenu.style.display = profileMenu.style.display==='block' ? 'none' : 'block'; };
    document.addEventListener('click', () => profileMenu.style.display='none');
    document.getElementById('menuProfile').onclick = () => { profileMenu.style.display='none'; showPage('profile'); };
    document.getElementById('menuWallet').onclick  = () => { profileMenu.style.display='none'; showPage('wallet'); };
    document.getElementById('menuTopup').onclick   = () => { profileMenu.style.display='none'; showPage('topup'); };
    document.getElementById('menuLogout').onclick  = () => { profileMenu.style.display='none'; alert('Logged out'); };

    // Footer nav
    document.querySelectorAll('.nav button').forEach(b=>{
      b.onclick = () => {
        document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        showPage(b.dataset.page);
      };
    });

    // Home search
    const voiceBtn = document.getElementById('voiceBtn');
    const searchInp= document.getElementById('search');
    voiceBtn.onclick = () => voiceToInput(searchInp, () => runHomeSearch());
    document.getElementById('searchBtn').onclick = runHomeSearch;

    // Top-up
    document.querySelectorAll('[data-topup]').forEach(el=>{
      el.onclick = () => alert('Top-up: ' + el.dataset.topup);
    });

    // Cart / checkout elements
    const mpSearch = document.getElementById('mpSearch');
    const mpVoice  = document.getElementById('mpVoice');
    const mpSearchBtn = document.getElementById('mpSearchBtn');
    const mpChips  = document.getElementById('mpChips');
    const mpGrid   = document.getElementById('mpGrid');
    const openCartBtn = document.getElementById('openCartBtn');
    const cartModal = document.getElementById('cartModal');
    const closeCart = document.getElementById('closeCart');
    const cartList  = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartCountEl = document.getElementById('cartCount');
    const checkoutModal = document.getElementById('checkoutModal');
    const closeCheckout = document.getElementById('closeCheckout');
    const chkTerms = document.getElementById('chkTerms');
    const chkAddress = document.getElementById('chkAddress');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const orderModal = document.getElementById('orderModal');
    const closeOrder = document.getElementById('closeOrder');
    const orderInfo = document.getElementById('orderInfo');
    const chkName  = document.getElementById('chkName');
    const chkPhone = document.getElementById('chkPhone');
    const chkUnit  = document.getElementById('chkUnit');
    const chkNotes = document.getElementById('chkNotes');

    // Header cart opens modal and goes to marketplace
    cartBtn.onclick  = (e) => { e.preventDefault(); e.stopPropagation(); showPage('marketplace'); renderCart(); setTimeout(()=>cartModal.classList.add('open'),0); };
    closeCart.onclick = () => cartModal.classList.remove('open');
    openCartBtn.onclick = () => { renderCart(); cartModal.classList.add('open'); };
    checkoutBtn.onclick = () => { cartModal.classList.remove('open'); checkoutModal.classList.add('open'); };
    closeCheckout.onclick = () => checkoutModal.classList.remove('open');
    closeOrder.onclick = () => orderModal.classList.remove('open');

    // Panic button
    document.getElementById('panicBtn').onclick = async () => {
      const ok = confirm('Confirm PANIC alert?\n\nThis will send your live location to your 5 contacts and the national line.');
      if (!ok) return;
      await triggerPanic();
    };

    // Init on load
    document.addEventListener('DOMContentLoaded', () => {
      try { userNameEl.textContent = user.name; } catch {}
      try { initLocation(); } catch (e) { console.error(e); }
      try { renderServices(); } catch (e) { console.error(e); }
      try { renderEmergency(); } catch (e) { console.error(e); }
      try { renderRecent(); } catch (e) { console.error(e); }
      try { renderServicesAll(); } catch (e) { console.error(e); }
      try { renderBookings(); } catch (e) { console.error(e); }
      try { initMarketplace(); } catch (e) { console.error(e); }
      [providersModal, bookingModal, instantModal, trackModal, categoryOptionsModal, itemsModal, cartModal, checkoutModal, orderModal]
        .forEach(m => m && m.addEventListener('click', (e)=>{ if (e.target === m) m.classList.remove('open'); }));
      // PWA: register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      }
    });

    // Pages
    function showPage(page){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const el = document.getElementById('page-'+page);
      (el || document.getElementById('page-home')).classList.add('active');
    }

    // Services catalog
    const SERVICES = [
      { id:'transport',    name:'Transport',         icon:'üöó', desc:'Ride & moving',               instant:true,  scheduled:true },
      { id:'food',         name:'Food',              icon:'üçî', desc:'Restaurant & grocery',       instant:true,  scheduled:true },
      { id:'tech',         name:'Tech Services',     icon:'üîß', desc:'Phone/computer repair',      instant:true,  scheduled:true },
      { id:'home',         name:'Home Services',     icon:'üè†', desc:'Cleaning & maintenance',     instant:true,  scheduled:true },
      { id:'construction', name:'Construction',      icon:'üèóÔ∏è', desc:'Builders & electricians',   instant:false, scheduled:true },
      { id:'auto',         name:'Automobile Repair', icon:'üõ†Ô∏è', desc:'Mechanics, tires, roadside', instant:true,  scheduled:true },
      { id:'others',       name:'Others',            icon:'üéØ', desc:'Events, tutors, more',       instant:false, scheduled:true },
    ];

    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance',     icon:'üöë' },
      { id:'fire',      name:'Fire Service',  icon:'üöí' },
      { id:'towing',    name:'Towing',        icon:'üöõ' },
      { id:'security',  name:'Security',      icon:'üõ°Ô∏è' },
      { id:'roadside',  name:'Roadside',      icon:'üîß' },
    ];

    function renderServices(){
      const grid = document.getElementById('servicesGrid');
      if (!grid) return;
      grid.innerHTML = '';
      SERVICES.forEach(s => {
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `
          <div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div>
          <div class="small muted" style="margin-top:6px">${s.desc}</div>
          <div class="row" style="margin-top:8px">
            ${s.instant ? '<span class="pill">Instant</span>' : ''}
            ${s.scheduled ? '<span class="pill">Scheduled</span>' : ''}
          </div>
        `;
        el.onclick = () => openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }

    function renderServicesAll(){
      const grid = document.getElementById('servicesAllGrid');
      if (!grid) return;
      grid.innerHTML = '';
      SERVICES.forEach(s=>{
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = () => openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }

    function renderEmergency(){
      const grid = document.getElementById('emergencyGrid');
      if (!grid) return;
      grid.innerHTML = '';
      EMERGENCY.forEach(e => {
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `
          <div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div>
          <div class="small muted" style="margin-top:6px">${e.id==='roadside' ? 'Describe the issue' : 'Find nearest/available'}</div>
          <div class="row" style="margin-top:8px"><span class="pill">Instant</span></div>
        `;
        el.onclick = () => {
          if (e.id==='roadside') openItemsModal('roadside');
          else openEmergency(e.id, e.name);
        };
        grid.appendChild(el);
      });
    }

    function renderRecent(){
      recentList.innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
      `;
    }

    async function initLocation() {
      try {
        const pos = await new Promise((res, rej) =>
          navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 })
        );
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const name = await reverseGeocode(coords.lat, coords.lng);
        userLocEl.textContent = name || 'Unknown';
      } catch {
        userLocEl.textContent = 'Location unavailable';
      }
    }
    async function reverseGeocode(lat,lng){
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json();
        return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || '');
      } catch { return null; }
    }

    // Category flows
    async function openCategory(catId, label){
      if (catId === 'transport') {
        openCategoryOptions('Transport Options', [
          { id:'ride',   name:'Ride / Taxi', icon:'üöó' },
          { id:'moving', name:'Truck / Backie', icon:'üöö' },
        ], (opt) => {
          categoryOptionsModal.classList.remove('open');
          providersTitle.textContent = opt.name + ' ‚Äî Providers';
          fetchProviders('transport', opt.id).then(renderProviders);
          providersModal.classList.add('open');
        });
        return;
      }
      if (catId === 'food') {
        openCategoryOptions('Food Options', [
          { id:'fastfood', name:'Fast Food', icon:'üçî' },
          { id:'grocery',  name:'Groceries', icon:'üõí' },
        ], (opt) => {
          categoryOptionsModal.classList.remove('open');
          openItemsModal(opt.id);
        });
        return;
      }
      const itemsMap = {
        home:       { title:'Home Services', chips:['cleaning','gardening','painting','plumber','electrician'] },
        tech:       { title:'Tech Services', chips:['phone repair','computer','tv repair','software'] },
        auto:       { title:'Automobile', chips:['mechanic','tires','battery','car wash'] },
        construction:{ title:'Construction', chips:['builder','carpenter','electrician','plumber'] },
        others:     { title:'Other Services', chips:['events','tutor','legal','photography'] },
        roadside:   { title:'Roadside Help', chips:['flat tire','jumpstart','fuel','lockout'] },
      };
      if (itemsMap[catId]) {
        openItemsModal(catId, itemsMap[catId].title, itemsMap[catId].chips);
        return;
      }
      providersTitle.textContent = label + ' ‚Äî Providers';
      const list = await fetchProviders(catId);
      renderProviders(list);
      providersModal.classList.add('open');
    }

    function openCategoryOptions(title, options, onPick){
      categoryOptionsTitle.textContent = title;
      categoryOptionsList.innerHTML = '';
      options.forEach(o => {
        const el = document.createElement('div');
        el.className = 'provider';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row"><div style="font-size:24px">${o.icon||'‚Ä¢'}</div><div><strong>${o.name}</strong></div></div>
            <button class="btn primary" type="button">Choose</button>
          </div>
        `;
        el.querySelector('button').onclick = () => onPick(o);
        categoryOptionsList.appendChild(el);
      });
      categoryOptionsModal.classList.add('open');
    }

    function openItemsModal(kind, customTitle, customChips){
      const title = customTitle || (kind === 'fastfood' ? 'Fast Food' : kind === 'grocery' ? 'Groceries' : 'Find Service');
      const chipDefaults = {
        fastfood:['pizza','burger','fries','chicken','drinks','meat'],
        grocery: ['milk','bread','eggs','rice','fruits','vegetables','water'],
        home:    ['cleaning','gardening','painting','plumber','electrician'],
        tech:    ['phone repair','computer','tv repair','software'],
        auto:    ['mechanic','tires','battery','car wash'],
        construction:['builder','carpenter','electrician','plumber'],
        others:  ['events','tutor','legal','photography'],
        roadside:['flat tire','jumpstart','fuel','lockout'],
      };
      itemsTitle.textContent = title;
      const chips = customChips || chipDefaults[kind] || [];
      renderItemChips(chips);
      itemsModal.classList.add('open');

      itemGo.onclick = async () => {
        const q = (itemSearch.value||'').trim().toLowerCase();
        itemsModal.classList.remove('open');
        providersTitle.textContent = (q ? q : title) + ' ‚Äî Providers';
        const list = await fetchProviders(kind, q || kind);
        renderProviders(list);
        providersModal.classList.add('open');
      };

      itemVoice.onclick = () => voiceToInput(itemSearch, () => itemGo.click());
    }
    function renderItemChips(chips){
      itemChips.innerHTML = '';
      chips.forEach(text => {
        const b = document.createElement('button');
        b.className = 'btn ghost';
        b.type = 'button';
        b.textContent = text;
        b.onclick = () => { itemSearch.value = text; itemGo.click(); };
        itemChips.appendChild(b);
      });
    }

    async function openEmergency(emId, label){
      providersTitle.textContent = label + ' ‚Äî Nearest';
      const list = await fetchProviders('emergency', emId);
      renderProviders(list);
      providersModal.classList.add('open');
    }

    async function fetchProviders(category, sub=null){
      try{
        const q = new URLSearchParams({ category, sub: sub || '', lat: coords?.lat || '', lng: coords?.lng || '' });
        const r = await fetch(`${BASE_API}/api/providers/nearby?${q.toString()}`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return d.providers || [];
      }catch{
        return [
          { id:'p1', name:'Pro One', icon:'üë§', distance:'0.8km', eta:'6-9m', fee:'$8-12', available:true },
          { id:'p2', name:'Quick Help', icon:'‚ö°', distance:'1.2km', eta:'8-12m', fee:'$10-15', available:true },
          { id:'p3', name:'Nearby Tech', icon:'üîß', distance:'2.1km', eta:'12-18m', fee:'$12-18', available:true },
        ];
      }
    }
    function renderProviders(list){
      providersList.innerHTML = '';
      if (!list?.length){ providersList.innerHTML = '<div class="small muted">No providers found nearby.</div>'; return; }
      list.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'provider';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row"><div style="font-size:24px">${p.icon || 'üë§'}</div><div><strong>${p.name}</strong><div class="small muted">${p.distance || '‚Äî'} ‚Ä¢ ETA ${p.eta || '‚Äî'} ‚Ä¢ Fee ${p.fee || '‚Äî'}</div></div></div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="controls">
            <button class="btn primary" data-k="instant" type="button">Instant Request</button>
            <button class="btn ghost" data-k="schedule" type="button">Schedule</button>
          </div>
        `;
        el.querySelectorAll('button[data-k]').forEach(b=>{
          b.onclick = () => (b.dataset.k === 'instant' ? startInstant(p) : openBooking(p));
        });
        providersList.appendChild(el);
      });
    }

    async function triggerPanic(){
      try{
        const body = { type:'panic', location: coords ? { latitude:coords.lat, longitude:coords.lng } : null, message:'User triggered PANIC alert' };
        const r = await fetch(`${BASE_API}/api/emergency/alert`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json().catch(()=>({}));
        if (r.ok){
          alert('Panic alert sent.');
          if (d.trackingUrl) location.href = d.trackingUrl;
          else if (d.alertId) location.href = `/emergency/track/${d.alertId}`;
        } else {
          alert('Alert sent (fallback).');
        }
      }catch{ alert('Alert sent (no GPS).'); }
    }

    async function startInstant(provider){
      selectedProvider = provider;
      providersModal.classList.remove('open');
      instantLeft = 90;
      countdownEl.textContent = String(instantLeft);
      instantModal.classList.add('open');

      try{
        const r = await fetch(`${BASE_API}/api/requests`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'instant', providerId: provider.id, location: coords ? { latitude:coords.lat, longitude:coords.lng } : null })
        });
        const d = await r.json().catch(()=>({}));
        requestId = d.requestId || 'demo-'+Date.now();
      }catch{ requestId = 'demo-'+Date.now(); }

      instantTimer = setInterval(async () => {
        instantLeft -= 1;
        countdownEl.textContent = String(instantLeft);

        if (instantLeft % 3 === 0) {
          const status = await getRequestStatus(requestId);
          if (status === 'accepted'){ stopInstant(); openTracking(); return; }
          if (status === 'rejected'){ stopInstant(); alert('Provider rejected.'); instantModal.classList.remove('open'); return; }
        }
        if (instantLeft <= 0) {
          stopInstant(); alert('No response. Try others.');
          instantModal.classList.remove('open');
        }
      }, 1000);
    }
    function stopInstant(){ if (instantTimer) clearInterval(instantTimer); instantTimer = null; }
    async function cancelInstant(){
      stopInstant();
      if (requestId){ try{ await fetch(`${BASE_API}/api/requests/${encodeURIComponent(requestId)}`, { method:'DELETE' }); }catch{} }
      instantModal.classList.remove('open');
    }
    async function getRequestStatus(id){
      try{
        const r = await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return d.status || 'pending';
      }catch{
        if (instantLeft < 78) return 'accepted';
        return 'pending';
      }
    }

    function openTracking(){
      instantModal.classList.remove('open');
      trackModal.classList.add('open');
      setTimeout(initMap, 50);
      startTracking();
    }
    function initMap(){
      if (!map){
        map = L.map('track-map', { zoomControl:true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OSM' }).addTo(map);
      }
      const userLatLng = coords ? [coords.lat, coords.lng] : [0,0];
      map.setView(userLatLng, 14);
      if (userMarker) userMarker.remove();
      userMarker = L.marker(userLatLng, { title:'You' }).addTo(map);
      if (providerMarker) providerMarker.remove();
    }
    function startTracking(){
      if (trackPoll) clearInterval(trackPoll);
      trackPoll = setInterval(async () => {
        const pos = await getProviderPosition(requestId);
        if (!pos) return;
        const latlng = [pos.lat, pos.lng];
        if (!providerMarker) providerMarker = L.marker(latlng, { title:'Provider', icon: defaultIcon() }).addTo(map);
        else providerMarker.setLatLng(latlng);
        trackStatus.textContent = `Provider en route ‚Ä¢ ${pos.eta || 'ETA ‚Äî'}`;
      }, 3000);
    }
    function stopTracking(){ if (trackPoll) clearInterval(trackPoll); trackPoll = null; }
    function defaultIcon(){
      return L.icon({
        iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:[25,41], iconAnchor:[12,41]
      });
    }
    async function getProviderPosition(id){
      try{
        const r = await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}/position`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return { lat:d.provider?.lat, lng:d.provider?.lng, eta: d.eta };
      }catch{
        const base = coords ? { lat: coords.lat + (Math.random()-0.5)/100, lng: coords.lng + (Math.random()-0.5)/100 } : { lat:0, lng:0 };
        return { lat: base.lat, lng: base.lng, eta: '8 min' };
      }
    }

    function openBooking(provider){ selectedProvider = provider; bookingModal.classList.add('open'); }
    bookingForm.onsubmit = async (e) => {
      e.preventDefault();
      const date = document.getElementById('bkDate').value;
      const time = document.getElementById('bkTime').value;
      const address = document.getElementById('bkAddress').value;
      const desc = document.getElementById('bkDesc').value;
      if (!date || !time){ alert('Pick date and time'); return; }
      try{
        const r = await fetch(`${BASE_API}/api/bookings`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            providerId: selectedProvider.id,
            bookingType:'scheduled', date, time, address, description:desc,
            location: coords ? { latitude:coords.lat, longitude:coords.lng } : null
          })
        });
        if (!r.ok) throw new Error();
        alert('Booking request sent. Check My Bookings for status.');
      }catch{
        alert('Booking sent (demo). Provider will confirm soon.');
      } finally { bookingModal.classList.remove('open'); }
    };

    // Voice helper
    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR();
      rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = (e) => {
        const text = e.results[0][0].transcript || '';
        inputEl.value = text;
        if (onResult) onResult(text);
      };
      rec.onerror = () => {};
      rec.start();
    }

    function runHomeSearch(){
      const q = (searchInp.value||'').trim().toLowerCase();
      if (!q) return;
      if (/(ride|taxi|cab|uber|bolt)/.test(q)) { openCategory('transport','Transport'); return; }
      if (/(truck|backie|moving|load)/.test(q)) {
        openCategoryOptions('Transport Options',[{id:'moving',name:'Truck / Backie',icon:'üöö'}],o=>{
          categoryOptionsModal.classList.remove('open');
          providersTitle.textContent = o.name + ' ‚Äî Providers';
          fetchProviders('transport','moving').then(renderProviders);
          providersModal.classList.add('open');
        });
        return;
      }
      if (/(food|pizza|burger|fries|chicken|drinks)/.test(q)) { openItemsModal('fastfood'); return; }
      if (/(grocery|milk|bread|eggs|rice|fruit|vegetable|vegetables)/.test(q)) { openItemsModal('grocery'); return; }
      if (/(ambulance|medical)/.test(q)) { openEmergency('ambulance','Ambulance'); return; }
      if (/(fire)/.test(q)) { openEmergency('fire','Fire Service'); return; }
      if (/(towing|tow)/.test(q)) { openEmergency('towing','Towing'); return; }
      if (/(security|police)/.test(q)) { openEmergency('security','Security'); return; }
      if (/(plumber|electrician|clean|garden|paint)/.test(q)) { openItemsModal('home'); return; }
      if (/(mechanic|tire|battery|car wash)/.test(q)) { openItemsModal('auto'); return; }
      if (/(phone|computer|laptop|tv|repair|software)/.test(q)) { openItemsModal('tech'); return; }
      if (/(builder|carpenter|construction)/.test(q)) { openItemsModal('construction'); return; }
      if (/(event|tutor|legal|photo|photography)/.test(q)) { openItemsModal('others'); return; }
      if (/(flat|jumpstart|fuel|lockout|road)/.test(q)) { openItemsModal('roadside'); return; }
      providersTitle.textContent = q + ' ‚Äî Providers';
      fetchProviders('search', q).then(renderProviders);
      providersModal.classList.add('open');
    }

    function renderBookings(){
      const el = document.getElementById('bookingsList');
      if (!el) return;
      el.innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
      `;
    }

    // Marketplace
    const MP_CATEGORIES = [
      { id:'electronics', name:'Electronics' },
      { id:'fashion',     name:'Fashion' },
      { id:'home',        name:'Home & Garden' },
      { id:'sports',      name:'Sports' },
      { id:'automobile',  name:'Automobile' },
      { id:'spares',      name:'Spare Parts' },
      { id:'others',      name:'Others' },
    ];
    const MP_PRODUCTS = [
      { id:'p100', title:'Smartphone X',     cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop' },
      { id:'p101', title:'Wireless Earbuds', cat:'electronics', price:59,  stock:34, img:'https://images.unsplash.com/photo-1585386959984-a41552231658?q=80&w=800&auto=format&fit=crop' },
      { id:'p200', title:'Running Shoes',    cat:'fashion',     price:79,  stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop' },
      { id:'p201', title:'Denim Jacket',     cat:'fashion',     price:69,  stock:9,  img:'https://images.unsplash.com/photo-1542060748-10c28b62716b?q=80&w=800&auto=format&fit=crop' },
      { id:'p300', title:'Blender Pro',      cat:'home',        price:49,  stock:22, img:'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=800&auto=format&fit=crop' },
      { id:'p301', title:'Desk Lamp',        cat:'home',        price:25,  stock:41, img:'https://images.unsplash.com/photo-1505685296765-3a2736de412f?q=80&w=800&auto=format&fit=crop' },
      { id:'p400', title:'Football',         cat:'sports',      price:19,  stock:27, img:'https://images.unsplash.com/photo-1521417530178-1f1f06f9a70b?q=80&w=800&auto=format&fit=crop' },
      { id:'p401', title:'Yoga Mat',         cat:'sports',      price:29,  stock:15, img:'https://images.unsplash.com/photo-1599050751795-5a9e3d0f5f7b?q=80&w=800&auto=format&fit=crop' },
      { id:'p500', title:'Engine Oil 5W-30', cat:'automobile',  price:35,  stock:20, img:'https://images.unsplash.com/photo-1584448099095-530a1a9b55d8?q=80&w=800&auto=format&fit=crop' },
      { id:'p501', title:'Car Tyre 17\"',    cat:'automobile',  price:89,  stock:16, img:'https://images.unsplash.com/photo-1580674285055-c64b4d5d6a2f?q=80&w=800&auto=format&fit=crop' },
      { id:'p600', title:'Brake Pads',       cat:'spares',      price:24,  stock:28, img:'https://images.unsplash.com/photo-1607863680058-5b5b7762dd44?q=80&w=800&auto=format&fit=crop' },
      { id:'p601', title:'Spark Plugs (4)',  cat:'spares',      price:19,  stock:35, img:'https://images.unsplash.com/photo-1610465299997-91a2b74a53b0?q=80&w=800&auto=format&fit=crop' },
      { id:'p700', title:'Gift Box',         cat:'others',      price:12,  stock:50, img:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=800&auto=format&fit=crop' },
      { id:'p701', title:'Photo Frame',      cat:'others',      price:15,  stock:33, img:'https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?q=80&w=800&auto=format&fit=crop' },
    ];

    // Cart store
    let cart = loadCart();
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('mp_cart')||'{"items":[]}'); }catch{ return { items:[] }; } }
    function saveCart(){ localStorage.setItem('mp_cart', JSON.stringify(cart)); }
    function updateCartCount(){
      const count = cart.items.reduce((a,b)=>a+b.qty,0);
      const headerBadge = document.getElementById('headerCartBadge');
      if (cartCountEl) cartCountEl.textContent = String(count);
      if (headerBadge) headerBadge.textContent = String(count);
    }

    // Marketplace init/search/render
    mpVoice.onclick = () => voiceToInput(mpSearch, () => runMarketplaceSearch());
    mpSearchBtn.onclick = runMarketplaceSearch;

    function initMarketplace(){
      mpChips.innerHTML = '';
      MP_CATEGORIES.forEach(c=>{
        const b = document.createElement('button');
        b.className = 'btn ghost';
        b.type='button';
        b.textContent = c.name;
        b.onclick = () => { renderMarketplace(c.id, mpSearch.value.trim().toLowerCase()); };
        mpChips.appendChild(b);
      });
      renderMarketplace();
      updateCartCount();
    }
    function runMarketplaceSearch(){
      const q = mpSearch.value.trim().toLowerCase();
      renderMarketplace(null, q);
    }
    function renderMarketplace(category=null, query=''){
      mpGrid.innerHTML = '';
      let list = MP_PRODUCTS.slice();
      if (category) list = list.filter(p => p.cat === category);
      if (query) list = list.filter(p => p.title.toLowerCase().includes(query) || p.cat.includes(query));
      if (!list.length){
        mpGrid.innerHTML = '<div class="small muted">No products found.</div>';
        return;
      }
      list.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'card product';
        el.dataset.id = p.id;
        el.innerHTML = `
          <img src="${p.img}" alt="${p.title}"/>
          <div><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between">
            <div class="price">$${p.price.toFixed(2)}</div>
            <div class="small muted">Stock: ${p.stock}</div>
          </div>
          <button class="btn primary" type="button">${p.stock > 0 ? 'Add to Cart' : 'Out of Stock'}</button>
        `;
        const btn = el.querySelector('button');
        btn.disabled = p.stock <= 0;
        btn.onclick = () => addToCart(p.id);
        mpGrid.appendChild(el);
      });
    }
    function addToCart(productId){
      const prod = MP_PRODUCTS.find(p=>p.id===productId);
      if (!prod || prod.stock <= 0) return;
      const i = cart.items.findIndex(x=>x.id===productId);
      if (i>=0) cart.items[i].qty += 1;
      else cart.items.push({ id:prod.id, title:prod.title, price:prod.price, img:prod.img, qty:1 });
      saveCart(); updateCartCount();
    }
    function renderCart(){
      cartList.innerHTML = '';
      if (!cart.items.length){
        cartList.innerHTML = '<div class="small muted">Your cart is empty.</div>';
        cartTotalEl.textContent = '0.00';
        return;
      }
      let total = 0;
      cart.items.forEach(item=>{
        total += item.price * item.qty;
        const row = document.createElement('div');
        row.className = 'card';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row">
              <img src="${item.img}" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/>
              <div style="margin-left:8px">
                <strong>${item.title}</strong>
                <div class="small muted">$${item.price.toFixed(2)}</div>
              </div>
            </div>
            <div class="qty">
              <button class="btn ghost" data-k="dec" type="button">‚àí</button>
              <div>${item.qty}</div>
              <button class="btn ghost" data-k="inc" type="button">Ôºã</button>
              <button class="btn ghost" data-k="rm" type="button">‚úñ</button>
            </div>
          </div>
        `;
        const [dec, , inc, rm] = row.querySelectorAll('button');
        dec.onclick = () => { item.qty = Math.max(1, item.qty-1); saveCart(); renderCart(); updateCartCount(); };
        inc.onclick = () => { item.qty += 1; saveCart(); renderCart(); updateCartCount(); };
        rm.onclick  = () => { cart.items = cart.items.filter(x=>x.id!==item.id); saveCart(); renderCart(); updateCartCount(); };
        cartList.appendChild(row);
      });
      cartTotalEl.textContent = total.toFixed(2);
    }

    // Checkout
    placeOrderBtn.onclick = async () => {
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      if (!chkTerms.checked){ alert('Please accept the Terms'); return; }
      if (!chkAddress.value.trim()){ alert('Enter delivery address'); return; }
      if (!chkName.value.trim() || !chkPhone.value.trim()){ alert('Enter name and phone'); return; }
      if (!cart.items.length){ alert('Cart is empty'); return; }

      const payload = {
        items: cart.items.map(i=>({ id:i.id, title:i.title, qty:i.qty, price:i.price })),
        name: chkName.value.trim(),
        phone: chkPhone.value.trim(),
        address: chkAddress.value.trim(),
        unit: (chkUnit.value||'').trim(),
        notes: (chkNotes.value||'').trim(),
      };

      if (method === 'card') {
        try {
          const r = await fetch(`${BASE_API}/api/payments/checkout-session`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              ...payload,
              successUrl: window.location.origin + '/?checkout=success',
              cancelUrl: window.location.origin + '/?checkout=cancel'
            })
          });
          const d = await r.json().catch(()=>({}));
          if (d?.url) {
            cart.items = []; saveCart(); updateCartCount();
            window.location.href = d.url;
            return;
          }
          if ((d?.id || d?.sessionId) && window.Stripe) {
            const stripe = window.Stripe(STRIPE_PK);
            cart.items = []; saveCart(); updateCartCount();
            await stripe.redirectToCheckout({ sessionId: d.id || d.sessionId });
            return;
          }
          if (FALLBACK_PAYMENT_LINK) {
            cart.items = []; saveCart(); updateCartCount();
            window.location.href = FALLBACK_PAYMENT_LINK;
            return;
          }
          alert('Payment session error. Falling back to cash/demo flow.');
        } catch {
          if (FALLBACK_PAYMENT_LINK) {
            cart.items = []; saveCart(); updateCartCount();
            window.location.href = FALLBACK_PAYMENT_LINK;
            return;
          }
          alert('Payment session error. Falling back to cash/demo flow.');
        }
      }

      // Cash (or fallback)
      let orderId = 'demo-' + Date.now();
      let code = String(Math.floor(100000 + Math.random()*900000));
      try {
        const r2 = await fetch(`${BASE_API}/api/marketplace/orders`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ...payload, paymentMethod: method })
        });
        const d2 = await r2.json().catch(()=>({}));
        orderId = d2.orderId || orderId;
        code = d2.deliveryCode || code;
      } catch {}

      checkoutModal.classList.remove('open');
      showOrderStatus(orderId, code, method);
      cart.items = []; saveCart(); updateCartCount();
    };

    function showOrderStatus(orderId, code, method){
      orderInfo.innerHTML = `
        <div class="card">
          <div><strong>Order ID:</strong> ${orderId}</div>
          <div style="margin-top:6px"><strong>Status:</strong> <span id="ordStatus">pending</span></div>
          <div style="margin-top:6px"><strong>Delivery code for seller to enter:</strong> <span style="font-family:monospace">${code}</span></div>
          <div class="small muted" style="margin-top:6px">
            ${method==='card'
              ? 'Funds are held. Seller must accept within 48h and enter the delivery code at handover to release funds.'
              : 'Cash selected: buyer and seller accept the risk. Delivery code still marks the item delivered.'}
          </div>
        </div>
      `;
      orderModal.classList.add('open');

      const ordStatusEl = document.getElementById('ordStatus');
      let t = 0;
      const poll = setInterval(async ()=>{
        t += 3;
        let status;
        try{
          const r = await fetch(`${BASE_API}/api/marketplace/orders/${encodeURIComponent(orderId)}`);
          const d = await r.json().catch(()=>({}));
          status = d.status;
        }catch{
          if (t>=6 && t<12) status = 'accepted';
          else if (t>=12 && t<18) status = 'out_for_delivery';
          else if (t>=18) status = 'delivered';
          else status = 'pending';
        }
        ordStatusEl.textContent = status || 'pending';
        if (status==='delivered' || t>=24) clearInterval(poll);
      }, 3000);
    }
  </script>
  <script>
// Checkout hotfix: reliably opens checkout modal and redirects to Stripe (card) or creates cash order
(function () {
  function $(id){ return document.getElementById(id); }

  const cartModal      = $('cartModal');
  const checkoutModal  = $('checkoutModal');
  const checkoutBtn    = $('checkoutBtn');
  const placeOrderBtn  = $('placeOrderBtn');

  const chkName    = $('chkName');
  const chkPhone   = $('chkPhone');
  const chkAddress = $('chkAddress');
  const chkUnit    = $('chkUnit');
  const chkNotes   = $('chkNotes');
  const chkTerms   = $('chkTerms');

  // Ensure cart store/helpers exist
  if (!window.cart) {
    try { window.cart = JSON.parse(localStorage.getItem('mp_cart') || '{"items":[]}'); } catch { window.cart = { items: [] }; }
  }
  if (typeof window.saveCart !== 'function') {
    window.saveCart = function saveCart() { localStorage.setItem('mp_cart', JSON.stringify(window.cart)); };
  }
  if (typeof window.updateCartCount !== 'function') {
    window.updateCartCount = function updateCartCount() {
      const count = window.cart.items.reduce((a,b)=>a+b.qty,0);
      const headerBadge = document.getElementById('headerCartBadge');
      const cartCountEl = document.getElementById('cartCount');
      if (headerBadge) headerBadge.textContent = String(count);
      if (cartCountEl)  cartCountEl.textContent  = String(count);
    };
  }

  // Open checkout modal from cart
  if (checkoutBtn) {
    checkoutBtn.onclick = (e) => {
      e.preventDefault();
      if (cartModal)   cartModal.classList.remove('open');
      if (checkoutModal) checkoutModal.classList.add('open');
    };
  }

  async function placeOrder() {
    try {
      // Validate
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      if (!chkTerms?.checked)            { alert('Please accept the Terms'); return; }
      if (!chkAddress?.value?.trim())    { alert('Enter delivery address'); return; }
      if (!chkName?.value?.trim() || !chkPhone?.value?.trim()) { alert('Enter name and phone'); return; }
      if (!window.cart.items.length)     { alert('Cart is empty'); return; }

      const payload = {
        items: window.cart.items.map(i=>({ id:i.id, title:i.title, qty:i.qty, price:i.price })),
        name: (chkName.value||'').trim(),
        phone: (chkPhone.value||'').trim(),
        address: (chkAddress.value||'').trim(),
        unit: (chkUnit?.value||'').trim(),
        notes: (chkNotes?.value||'').trim(),
      };

      // Card ‚Üí create checkout session and redirect
      if (method === 'card') {
        const r = await fetch(`${BASE_API}/api/payments/checkout-session`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            ...payload,
            successUrl: window.location.origin + '/?checkout=success',
            cancelUrl:  window.location.origin + '/?checkout=cancel'
          })
        });
        const d = await r.json().catch(()=>({}));

        if (d?.url) {
          window.cart.items = []; window.saveCart(); window.updateCartCount();
          window.location.href = d.url;
          return;
        }
        if ((d?.id || d?.sessionId) && window.Stripe && typeof STRIPE_PK === 'string' && STRIPE_PK) {
          const stripe = window.Stripe(STRIPE_PK);
          window.cart.items = []; window.saveCart(); window.updateCartCount();
          await stripe.redirectToCheckout({ sessionId: d.id || d.sessionId });
          return;
        }
        if (typeof FALLBACK_PAYMENT_LINK === 'string' && FALLBACK_PAYMENT_LINK) {
          window.cart.items = []; window.saveCart(); window.updateCartCount();
          window.location.href = FALLBACK_PAYMENT_LINK;
          return;
        }
        alert('Payment session error. Please try again or select Cash.');
        return;
      }

      // Cash (or fallback)
      let orderId = 'demo-' + Date.now();
      let code = String(Math.floor(100000 + Math.random()*900000));
      try {
        const r2 = await fetch(`${BASE_API}/api/marketplace/orders`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ ...payload, paymentMethod: method })
        });
        const d2 = await r2.json().catch(()=>({}));
        orderId = d2.orderId || orderId;
        code    = d2.deliveryCode || code;
      } catch {}

      if (checkoutModal) checkoutModal.classList.remove('open');
      // Show status modal (reuse existing function if present)
      if (typeof window.showOrderStatus === 'function') {
        window.showOrderStatus(orderId, code, method);
      } else {
        alert(`Order created (${orderId}). Delivery code: ${code}`);
      }
      window.cart.items = []; window.saveCart(); window.updateCartCount();
    } catch (err) {
      alert('Checkout error. Please try again.');
    }
  }

  if (placeOrderBtn) {
    placeOrderBtn.onclick = async (e) => { e.preventDefault(); await placeOrder(); };
  }

  // Ensure wiring on load (in case earlier scripts set other handlers)
  window.addEventListener('DOMContentLoaded', () => {
    if (checkoutBtn && (!checkoutBtn.onclick || checkoutBtn.onclick.toString().includes('showPage'))) {
      checkoutBtn.onclick = (e) => {
        e.preventDefault();
        if (cartModal)   cartModal.classList.remove('open');
        if (checkoutModal) checkoutModal.classList.add('open');
      };
    }
    if (placeOrderBtn && (!placeOrderBtn.onclick || placeOrderBtn.onclick.length === 0)) {
      placeOrderBtn.onclick = async (e) => { e.preventDefault(); await placeOrder(); };
    }
  });
})();
</script>
  <script>
// Checkout fix (delegated, non-destructive)
(function () {
  const get = (id) => document.getElementById(id);
  const FALLBACK = (typeof FALLBACK_PAYMENT_LINK === 'string') ? FALLBACK_PAYMENT_LINK : '';
  const API = (typeof BASE_API === 'string' && BASE_API) ? BASE_API : '';

  // Helpers
  function readCart() {
    try { return JSON.parse(localStorage.getItem('mp_cart') || '{"items":[]}'); }
    catch { return { items: [] }; }
  }
  function writeCart(cart) {
    localStorage.setItem('mp_cart', JSON.stringify(cart));
  }
  function updateCount(cart) {
    const count = cart.items.reduce((a,b)=>a+b.qty,0);
    const badge = get('headerCartBadge'); const cnt = get('cartCount');
    if (badge) badge.textContent = String(count);
    if (cnt)   cnt.textContent   = String(count);
  }
  async function createStripeSession(payload) {
    const res = await fetch(`${API}/api/payments/checkout-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit',
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || 'Failed to create checkout session');
    return data;
  }
  async function createCashOrder(payload) {
    try {
      const res = await fetch(`${API}/api/marketplace/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, paymentMethod: 'cash' }),
        mode: 'cors',
        credentials: 'omit',
      });
      return await res.json().catch(() => ({}));
    } catch {
      return {};
    }
  }

  // Open Checkout modal from Cart (reliable)
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'checkoutBtn') {
      e.preventDefault();
      const cartModal = get('cartModal');
      const checkoutModal = get('checkoutModal');
      if (cartModal) cartModal.classList.remove('open');
      if (checkoutModal) checkoutModal.classList.add('open');
    }
  });

  // Place Order (Card -> Stripe; Cash -> Order + code)
  document.addEventListener('click', async (e) => {
    if (!(e.target && e.target.id === 'placeOrderBtn')) return;
    e.preventDefault();

    const cart = readCart();
    const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
    const name    = get('chkName')?.value?.trim();
    const phone   = get('chkPhone')?.value?.trim();
    const address = get('chkAddress')?.value?.trim();
    const unit    = get('chkUnit')?.value?.trim() || '';
    const notes   = get('chkNotes')?.value?.trim() || '';
    const termsOk = !!get('chkTerms')?.checked;

    if (!cart.items.length)         return alert('Cart is empty');
    if (!termsOk)                   return alert('Please accept the Terms');
    if (!name || !phone || !address)return alert('Enter name, phone and address');

    const payload = {
      items: cart.items.map(i => ({ id:i.id, title:i.title, qty:i.qty, price:i.price })),
      name, phone, address, unit, notes,
      successUrl: window.location.origin + '/?checkout=success',
      cancelUrl:  window.location.origin + '/?checkout=cancel',
    };

    try {
      if (method === 'card') {
        const data = await createStripeSession(payload);
        // Redirect preference order
        if (data?.url) {
          cart.items = []; writeCart(cart); updateCount(cart);
          return (window.location.href = data.url);
        }
        if ((data?.id || data?.sessionId) && window.Stripe && typeof STRIPE_PK === 'string' && STRIPE_PK) {
          const stripe = window.Stripe(STRIPE_PK);
          cart.items = []; writeCart(cart); updateCount(cart);
          const sid = data.id || data.sessionId;
          const { error } = await stripe.redirectToCheckout({ sessionId: sid });
          if (error) throw error;
          return;
        }
        if (FALLBACK) {
          cart.items = []; writeCart(cart); updateCount(cart);
          return (window.location.href = FALLBACK);
        }
        throw new Error('Stripe session not returned. Try Cash or contact support.');
      } else {
        const data = await createCashOrder(payload);
        const orderId = data?.orderId || ('demo-' + Date.now());
        const code    = data?.deliveryCode || String(Math.floor(100000 + Math.random()*900000));
        const checkoutModal = get('checkoutModal');
        if (checkoutModal) checkoutModal.classList.remove('open');
        if (typeof window.showOrderStatus === 'function') {
          window.showOrderStatus(orderId, code, 'cash');
        } else {
          alert(`Order created (${orderId}). Delivery code: ${code}`);
        }
        cart.items = []; writeCart(cart); updateCount(cart);
      }
    } catch (err) {
      if (FALLBACK && method === 'card') {
        cart.items = []; writeCart(cart); updateCount(cart);
        return (window.location.href = FALLBACK);
      }
      alert((err && err.message) ? err.message : 'Checkout error. Please try again.');
    }
  });

  // Ensure header cart opens cart + stays on marketplace
  const headerCart = document.getElementById('cartBtn');
  if (headerCart) {
    headerCart.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      try { showPage('marketplace'); } catch {}
      try { window.renderCart && window.renderCart(); } catch {}
      const cartModal = get('cartModal');
      if (cartModal) setTimeout(() => cartModal.classList.add('open'), 0);
    });
  }
})();
</script>
  <script>
// Cart edit hotfix (inc/dec/remove) ‚Äî non-destructive
(function () {
  const $ = (id) => document.getElementById(id);

  function ensureCart() {
    if (!window.cart) {
      try { window.cart = JSON.parse(localStorage.getItem('mp_cart') || '{"items":[]}'); }
      catch { window.cart = { items: [] }; }
    }
  }
  function save() {
    localStorage.setItem('mp_cart', JSON.stringify(window.cart));
  }
  function updateCount() {
    const count = window.cart.items.reduce((a,b)=>a+b.qty,0);
    const badge = $('headerCartBadge');
    const cnt   = $('cartCount');
    if (badge) badge.textContent = String(count);
    if (cnt)   cnt.textContent   = String(count);
  }
  function annotateRows() {
    const list = $('cartList');
    if (!list) return;
    list.querySelectorAll('.card').forEach(row => {
      if (row.dataset.id) return;
      const title = row.querySelector('strong')?.textContent?.trim();
      if (!title) return;
      const item = window.cart.items.find(i => i.title === title);
      if (item) {
        row.dataset.id = item.id;
        const qtyEl = row.querySelector('.qty div');
        if (qtyEl) qtyEl.textContent = String(item.qty);
      }
    });
  }

  // Keep rows annotated whenever cart UI re-renders
  const cartListEl = $('cartList');
  if (cartListEl) {
    new MutationObserver(annotateRows).observe(cartListEl, { childList: true, subtree: true });
  }

  // Delegate clicks for + / ‚àí / remove
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#cartList [data-k]');
    if (!btn) return;

    e.preventDefault();
    ensureCart();

    const row = btn.closest('.card');
    if (!row) return;

    let id = row.dataset.id;
    if (!id) {
      // Fallback by title if data-id missing
      const title = row.querySelector('strong')?.textContent?.trim();
      const found = window.cart.items.find(i => i.title === title);
      if (found) id = found.id;
    }
    if (!id) return;

    const idx = window.cart.items.findIndex(i => i.id === id);
    if (idx < 0) return;

    const action = btn.getAttribute('data-k');
    if (action === 'dec') window.cart.items[idx].qty = Math.max(1, window.cart.items[idx].qty - 1);
    if (action === 'inc') window.cart.items[idx].qty = window.cart.items[idx].qty + 1;
    if (action === 'rm')  window.cart.items.splice(idx, 1);

    save(); updateCount();

    // Re-render using your existing function if present
    if (typeof window.renderCart === 'function') {
      window.renderCart();
    } else {
      annotateRows();
      const totalEl = $('cartTotal');
      if (totalEl) {
        const total = window.cart.items.reduce((s, i) => s + i.price * i.qty, 0);
        totalEl.textContent = total.toFixed(2);
      }
    }
  });

  // Initialize
  window.addEventListener('DOMContentLoaded', () => {
    ensureCart(); updateCount(); annotateRows();
  });
})();
</script>
</body>
</html>
