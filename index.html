<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- SDKs -->
  <script src="https://js.stripe.com/v3"></script>
  <script src="https://checkout.flutterwave.com/v3.js"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827;
      --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --header-h:56px; --nav-h:64px;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; max-width:100%; overflow-x:hidden; -webkit-text-size-adjust:100% }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }

    header {
      position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:100;
      background:var(--card); border-bottom:1px solid var(--border); display:flex; align-items:center;
      padding-top: env(safe-area-inset-top, 0px);
    }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 16px; width:100% }
    .small { color:var(--muted); font-size:13px }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }

    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; max-width:100% }
    @media(min-width:768px) { .grid { grid-template-columns:repeat(3,minmax(0,1fr)) } }
    @media(min-width:1024px) { .grid { grid-template-columns:repeat(4,minmax(0,1fr)) } }

    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow) }
    .card img { width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:12px }
    .card .name { font-weight:600; margin-bottom:4px }
    .card .desc { color:var(--muted); font-size:14px; margin-bottom:8px }
    .card .price { font-weight:600; color:var(--primary) }

    .modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.5); z-index:1000; display:none; align-items:center; justify-content:center; padding:20px }
    .modal.open { display:flex }
    .modal .content { background:var(--card); border-radius:var(--radius); max-width:500px; width:100%; max-height:90vh; overflow-y:auto }
    .modal .header { padding:20px 20px 0; border-bottom:1px solid var(--border); padding-bottom:16px }
    .modal .body { padding:20px }
    .modal .footer { padding:0 20px 20px; border-top:1px solid var(--border); padding-top:16px }

    .field { margin-bottom:16px }
    .field label { display:block; margin-bottom:6px; font-weight:500 }
    .field input, .field select, .field textarea { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:14px }
    .field textarea { min-height:80px; resize:vertical }
    .controls { display:flex; gap:12px; align-items:center }
    .controls label { display:flex; align-items:center; gap:6px; cursor:pointer }

    .nav { position:fixed; bottom:0; left:0; right:0; height:var(--nav-h); background:var(--card); border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-around; padding-bottom: env(safe-area-inset-bottom, 0px) }
    .nav .item { display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px; cursor:pointer; color:var(--muted); transition:color .2s }
    .nav .item.active { color:var(--primary) }
    .nav .item .icon { font-size:20px }
    .nav .item .label { font-size:11px; font-weight:500 }

    .page { display:none; padding-top:var(--header-h); padding-bottom:var(--nav-h) }
    .page.active { display:block }

    .badge { background:var(--danger); color:#fff; border-radius:50%; min-width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:600 }

    .muted { color:var(--muted) }
    .success { color:var(--success) }
    .danger { color:var(--danger) }

    .image-upload { border:2px dashed var(--border); border-radius:8px; padding:20px; text-align:center; cursor:pointer; transition:border-color .2s }
    .image-upload:hover { border-color:var(--primary) }
    .image-upload input { display:none }
    .image-preview { display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:8px; margin-top:12px }
    .image-preview img { width:100%; height:80px; object-fit:cover; border-radius:6px; border:2px solid var(--border) }
    .image-preview .remove { position:absolute; top:-5px; right:-5px; background:var(--danger); color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer }

    .loading { display:inline-block; width:20px; height:20px; border:2px solid var(--border); border-top:2px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin { 0% { transform:rotate(0deg) } 100% { transform:rotate(360deg) } }

    .hidden { display:none !important }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="row">
      <div class="logo">üöÄ ZippUp</div>
      <div class="user-info">
        <span id="userName">Guest</span>
        <button id="authBtn" class="btn ghost">Sign In</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Home Page -->
    <div id="homePage" class="page active">
      <div class="search">
        <div class="box">
          <input type="text" placeholder="Search for services, food, or products..." id="searchInput">
          <button class="btn primary">üîç</button>
        </div>
      </div>

      <div class="section">
        <div class="title">Quick Services</div>
        <div class="grid" id="quickServices">
          <!-- Services will be loaded from Firebase -->
        </div>
      </div>

      <div class="section">
        <div class="title">Popular Food</div>
        <div class="grid" id="popularFood">
          <!-- Food items will be loaded from Firebase -->
        </div>
      </div>

      <div class="section">
        <div class="title">Marketplace</div>
        <div class="grid" id="marketplace">
          <!-- Marketplace items will be loaded from Firebase -->
        </div>
      </div>
    </div>

    <!-- Services Page -->
    <div id="servicesPage" class="page">
      <div class="section">
        <div class="title">Add Service</div>
        <div class="card">
          <div class="field">
            <label>Category</label>
            <select id="msCategory">
              <option value="transport">üöó Transport</option>
              <option value="food">üçî Food</option>
              <option value="tech">üîß Tech</option>
              <option value="home">üè† Home</option>
              <option value="construction">üèóÔ∏è Construction</option>
              <option value="automobile">üõ†Ô∏è Automobile</option>
              <option value="digital">üí≥ Digital</option>
              <option value="marketplace">üõçÔ∏è Marketplace</option>
              <option value="emergency">üöë Emergency</option>
            </select>
          </div>
          <div class="field">
            <label>Subcategory (Transport)</label>
            <select id="msTransportSub" style="display:none">
              <option value="ride">Ride</option>
              <option value="moving">Moving</option>
              <option value="delivery">Delivery</option>
            </select>
          </div>
          <div class="field">
            <label>Service Type *</label>
            <input type="text" id="msType" placeholder="e.g., Food Delivery, Car Repair">
          </div>
          <div class="field">
            <label>Details *</label>
            <textarea id="msDetails" placeholder="Describe your service..."></textarea>
          </div>
          <div class="field">
            <label>Price *</label>
            <input type="number" id="msPrice" placeholder="0.00" step="0.01">
          </div>
          <div class="field">
            <label>Images (Max 5)</label>
            <div class="image-upload" onclick="document.getElementById('msImages').click()">
              <input type="file" id="msImages" multiple accept="image/*" onchange="handleImageUpload(this, 'msImagePreview')">
              <div>üì∑ Click to upload images</div>
            </div>
            <div id="msImagePreview" class="image-preview"></div>
          </div>
          <button id="msAdd" class="btn primary block">Add Service</button>
        </div>
      </div>

      <div class="section">
        <div class="title">My Services</div>
        <div id="msList">
          <!-- Services will be loaded from Firebase -->
        </div>
      </div>
    </div>

    <!-- Food Page -->
    <div id="foodPage" class="page">
      <div class="section">
        <div class="title">Add Food Item</div>
        <div class="card">
          <div class="field">
            <label>Category</label>
            <select id="foodCategory">
              <option value="fastfood">üçî Fast Food</option>
              <option value="grocery">üõí Grocery</option>
            </select>
          </div>
          <div class="field">
            <label>Name *</label>
            <input type="text" id="foodName" placeholder="Food item name">
          </div>
          <div class="field">
            <label>Description *</label>
            <textarea id="foodDescription" placeholder="Describe the food item..."></textarea>
          </div>
          <div class="field">
            <label>Price *</label>
            <input type="number" id="foodPrice" placeholder="0.00" step="0.01">
          </div>
          <div class="field">
            <label>Images (Max 5)</label>
            <div class="image-upload" onclick="document.getElementById('foodImages').click()">
              <input type="file" id="foodImages" multiple accept="image/*" onchange="handleImageUpload(this, 'foodImagePreview')">
              <div>üì∑ Click to upload images</div>
            </div>
            <div id="foodImagePreview" class="image-preview"></div>
          </div>
          <button id="foodAdd" class="btn primary block">Add Food Item</button>
        </div>
      </div>

      <div class="section">
        <div class="title">My Food Items</div>
        <div id="foodList">
          <!-- Food items will be loaded from Firebase -->
        </div>
      </div>
    </div>

    <!-- Marketplace Page -->
    <div id="marketplacePage" class="page">
      <div class="section">
        <div class="title">Add Marketplace Item</div>
        <div class="card">
          <div class="field">
            <label>Category</label>
            <select id="mpCategory">
              <option value="electronics">üì± Electronics</option>
              <option value="clothing">üëï Clothing</option>
              <option value="books">üìö Books</option>
              <option value="furniture">ü™ë Furniture</option>
              <option value="vehicles">üöó Vehicles</option>
              <option value="other">üéØ Other</option>
            </select>
          </div>
          <div class="field">
            <label>Title *</label>
            <input type="text" id="mpTitle" placeholder="Item title">
          </div>
          <div class="field">
            <label>Description *</label>
            <textarea id="mpDescription" placeholder="Describe the item..."></textarea>
          </div>
          <div class="field">
            <label>Price *</label>
            <input type="number" id="mpPrice" placeholder="0.00" step="0.01">
          </div>
          <div class="field">
            <label>Images (Max 10)</label>
            <div class="image-upload" onclick="document.getElementById('mpImages').click()">
              <input type="file" id="mpImages" multiple accept="image/*" onchange="handleImageUpload(this, 'mpImagePreview')">
              <div>üì∑ Click to upload images</div>
            </div>
            <div id="mpImagePreview" class="image-preview"></div>
          </div>
          <button id="mpAdd" class="btn primary block">Add Marketplace Item</button>
        </div>
      </div>

      <div class="section">
        <div class="title">My Marketplace Items</div>
        <div id="mpList">
          <!-- Marketplace items will be loaded from Firebase -->
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="page">
      <div class="section">
        <div class="title">Profile</div>
        <div class="card">
          <div class="field">
            <label>Profile Picture</label>
            <div class="image-upload" onclick="document.getElementById('profileImage').click()">
              <input type="file" id="profileImage" accept="image/*" onchange="handleProfileImageUpload(this)">
              <div>üì∑ Click to upload profile picture</div>
            </div>
            <div id="profileImagePreview" class="image-preview"></div>
          </div>
          <div class="field">
            <label>Name</label>
            <input type="text" id="profileName" placeholder="Your name">
          </div>
          <div class="field">
            <label>Phone</label>
            <input type="tel" id="profilePhone" placeholder="Your phone number">
          </div>
          <div class="field">
            <label>Address</label>
            <textarea id="profileAddress" placeholder="Your address"></textarea>
          </div>
          <button id="saveProfile" class="btn primary block">Save Profile</button>
        </div>
      </div>

      <div class="section">
        <div class="title">Orders</div>
        <div id="ordersList">
          <!-- Orders will be loaded from Firebase -->
        </div>
      </div>
    </div>
  </main>

  <!-- Navigation -->
  <nav class="nav">
    <div class="item active" data-page="homePage">
      <div class="icon">üè†</div>
      <div class="label">Home</div>
    </div>
    <div class="item" data-page="servicesPage">
      <div class="icon">üîß</div>
      <div class="label">Services</div>
    </div>
    <div class="item" data-page="foodPage">
      <div class="icon">üçî</div>
      <div class="label">Food</div>
    </div>
    <div class="item" data-page="marketplacePage">
      <div class="icon">üõçÔ∏è</div>
      <div class="label">Market</div>
    </div>
    <div class="item" data-page="profilePage">
      <div class="icon">üë§</div>
      <div class="label">Profile</div>
    </div>
  </nav>

  <!-- Modals -->
  <div id="authModal" class="modal">
    <div class="content">
      <div class="header">
        <h3>Sign In / Sign Up</h3>
      </div>
      <div class="body">
        <div class="field">
          <label>Email</label>
          <input type="email" id="authEmail" placeholder="your@email.com">
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="authPassword" placeholder="Password">
        </div>
        <button id="signInBtn" class="btn primary block">Sign In</button>
        <button id="signUpBtn" class="btn ghost block">Sign Up</button>
        <button id="googleSignInBtn" class="btn ghost block">Sign in with Google</button>
      </div>
    </div>
  </div>

  <div id="checkoutModal" class="modal">
    <div class="content">
      <div class="header">
        <h3>Checkout</h3>
      </div>
      <div class="body">
        <div id="cartItems"></div>
        <div class="field">
          <label>Payment Method</label>
          <div class="controls">
            <label><input type="radio" name="payMethod" value="stripe" checked/> Stripe</label>
            <label><input type="radio" name="payMethod" value="cash"/> Cash</label>
          </div>
        </div>
        <div class="field">
          <label><input type="checkbox" id="chkTerms"/> I agree to terms</label>
        </div>
      </div>
      <div class="footer">
        <button id="placeOrderBtn" class="btn primary block">Place Order</button>
      </div>
    </div>
  </div>

  <div id="orderModal" class="modal">
    <div class="content">
      <div class="header">
        <h3>Order Confirmed</h3>
      </div>
      <div class="body">
        <div id="orderInfo"></div>
      </div>
      <div class="footer">
        <button class="btn primary block" onclick="closeModal('orderModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Global Variables
    let user = { name: 'Guest', email: 'guest@example.com', uid: null };
    let cart = { items: [], vendorId: null, vendorName: '' };

    // Initialize App
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      setupEventListeners();
      setupNavigation();
    });

    // Initialize Firebase and App
    async function initializeApp() {
      try {
        // Listen for auth state changes
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            console.log('User signed in:', user.uid);
            await loadUserData(user.uid);
            updateUI();
          } else {
            console.log('User signed out');
            resetUserData();
            updateUI();
          }
        });

        // Load initial data
        await loadPublicData();
      } catch (error) {
        console.error('Initialization error:', error);
      }
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Auth buttons
      document.getElementById('authBtn').onclick = () => showModal('authModal');
      document.getElementById('signInBtn').onclick = signIn;
      document.getElementById('signUpBtn').onclick = signUp;
      document.getElementById('googleSignInBtn').onclick = signInWithGoogle;

      // Service buttons
      document.getElementById('msAdd').onclick = addService;
      document.getElementById('foodAdd').onclick = addFoodItem;
      document.getElementById('mpAdd').onclick = addMarketplaceItem;
      document.getElementById('saveProfile').onclick = saveProfile;

      // Category change handlers
      document.getElementById('msCategory').onchange = handleCategoryChange;
      document.getElementById('foodCategory').onchange = handleFoodCategoryChange;

      // Checkout
      document.getElementById('placeOrderBtn').onclick = placeOrder;

      // Close modals on outside click
      document.querySelectorAll('.modal').forEach(modal => {
        modal.onclick = (e) => {
          if (e.target === modal) closeModal(modal.id);
        };
      });
    }

    // Navigation
    function setupNavigation() {
      document.querySelectorAll('.nav .item').forEach(item => {
        item.onclick = () => {
          const page = item.dataset.page;
          showPage(page);
          
          // Update active nav
          document.querySelectorAll('.nav .item').forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
        };
      });
    }

    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      // Load page-specific data
      if (pageId === 'servicesPage') loadUserServices();
      else if (pageId === 'foodPage') loadUserFood();
      else if (pageId === 'marketplacePage') loadUserMarketplace();
      else if (pageId === 'profilePage') loadUserProfile();
    }

    // Firebase Functions
    async function signIn() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        closeModal('authModal');
      } catch (error) {
        alert('Sign in failed: ' + error.message);
      }
    }

    async function signUp() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      
      try {
        const result = await auth.createUserWithEmailAndPassword(email, password);
        await createUserProfile(result.user);
        closeModal('authModal');
      } catch (error) {
        alert('Sign up failed: ' + error.message);
      }
    }

    async function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        await createUserProfile(result.user);
        closeModal('authModal');
      } catch (error) {
        alert('Google sign in failed: ' + error.message);
      }
    }

    async function createUserProfile(firebaseUser) {
      try {
        const userRef = db.collection('users').doc(firebaseUser.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
          await userRef.set({
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            name: firebaseUser.displayName || firebaseUser.email.split('@')[0],
            phone: '',
            address: '',
            profileImage: '',
            createdAt: new Date(),
            updatedAt: new Date()
          });
        }
      } catch (error) {
        console.error('Error creating user profile:', error);
      }
    }

    async function loadUserData(uid) {
      try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
          user = { ...userDoc.data(), uid };
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }

    function resetUserData() {
      user = { name: 'Guest', email: 'guest@example.com', uid: null };
    }

    async function loadPublicData() {
      try {
        // Load services
        const servicesSnapshot = await db.collection('services').where('available', '==', true).limit(8).get();
        const services = servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayServices(services, 'quickServices');

        // Load food items
        const foodSnapshot = await db.collection('foodItems').where('available', '==', true).limit(8).get();
        const foodItems = foodSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayFoodItems(foodItems, 'popularFood');

        // Load marketplace items
        const marketplaceSnapshot = await db.collection('marketplaceItems').where('available', '==', true).limit(8).get();
        const marketplaceItems = marketplaceSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayMarketplaceItems(marketplaceItems, 'marketplace');
      } catch (error) {
        console.error('Error loading public data:', error);
      }
    }

    // Service Functions
    async function addService() {
      if (!user.uid) {
        alert('Please sign in to add services');
        return;
      }

      const category = document.getElementById('msCategory').value;
      const transportSub = document.getElementById('msTransportSub').value || '';
      const type = document.getElementById('msType').value.trim();
      const details = document.getElementById('msDetails').value.trim();
      const price = parseFloat(document.getElementById('msPrice').value || '0');
      const images = document.getElementById('msImages').files;

      if (!type || !details || !price) {
        alert('Please fill all required fields');
        return;
      }

      try {
        const service = {
          category,
          subcategory: transportSub,
          type,
          details,
          price,
          userId: user.uid,
          userName: user.name,
          available: true,
          createdAt: new Date(),
          updatedAt: new Date()
        };

        // Upload images if any
        if (images.length > 0) {
          const imageUrls = await uploadImages(images, 'services');
          service.images = imageUrls;
        }

        await db.collection('services').add(service);
        
        alert('Service added successfully!');
        clearServiceForm();
        loadUserServices();
      } catch (error) {
        console.error('Error adding service:', error);
        alert('Failed to add service. Please try again.');
      }
    }

    async function loadUserServices() {
      if (!user.uid) return;
      
      try {
        const snapshot = await db.collection('services').where('userId', '==', user.uid).get();
        const services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayUserServices(services);
      } catch (error) {
        console.error('Error loading user services:', error);
      }
    }

    function displayUserServices(services) {
      const list = document.getElementById('msList');
      if (services.length === 0) {
        list.innerHTML = '<div class="small muted">No services yet</div>';
        return;
      }

      list.innerHTML = services.map(service => `
        <div class="card">
          <div class="name">${service.type}</div>
          <div class="desc">${service.details}</div>
          <div class="price">$${service.price}</div>
          <div class="small muted">${service.category} ‚Ä¢ ${service.subcategory || 'N/A'}</div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="editService('${service.id}')">Edit</button>
            <button class="btn danger" onclick="deleteService('${service.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Food Functions
    async function addFoodItem() {
      if (!user.uid) {
        alert('Please sign in to add food items');
        return;
      }

      const category = document.getElementById('foodCategory').value;
      const name = document.getElementById('foodName').value.trim();
      const description = document.getElementById('foodDescription').value.trim();
      const price = parseFloat(document.getElementById('foodPrice').value || '0');
      const images = document.getElementById('foodImages').files;

      if (!name || !description || !price) {
        alert('Please fill all required fields');
        return;
      }

      try {
        const foodItem = {
          category,
          name,
          description,
          price,
          userId: user.uid,
          userName: user.name,
          available: true,
          createdAt: new Date(),
          updatedAt: new Date()
        };

        // Upload images if any
        if (images.length > 0) {
          const imageUrls = await uploadImages(images, 'food');
          foodItem.images = imageUrls;
        }

        await db.collection('foodItems').add(foodItem);
        
        alert('Food item added successfully!');
        clearFoodForm();
        loadUserFood();
      } catch (error) {
        console.error('Error adding food item:', error);
        alert('Failed to add food item. Please try again.');
      }
    }

    async function loadUserFood() {
      if (!user.uid) return;
      
      try {
        const snapshot = await db.collection('foodItems').where('userId', '==', user.uid).get();
        const foodItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayUserFood(foodItems);
      } catch (error) {
        console.error('Error loading user food:', error);
      }
    }

    function displayUserFood(foodItems) {
      const list = document.getElementById('foodList');
      if (foodItems.length === 0) {
        list.innerHTML = '<div class="small muted">No food items yet</div>';
        return;
      }

      list.innerHTML = foodItems.map(item => `
        <div class="card">
          <div class="name">${item.name}</div>
          <div class="desc">${item.description}</div>
          <div class="price">$${item.price}</div>
          <div class="small muted">${item.category}</div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="editFoodItem('${item.id}')">Edit</button>
            <button class="btn danger" onclick="deleteFoodItem('${item.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Marketplace Functions
    async function addMarketplaceItem() {
      if (!user.uid) {
        alert('Please sign in to add marketplace items');
        return;
      }

      const category = document.getElementById('mpCategory').value;
      const title = document.getElementById('mpTitle').value.trim();
      const description = document.getElementById('mpDescription').value.trim();
      const price = parseFloat(document.getElementById('mpPrice').value || '0');
      const images = document.getElementById('mpImages').files;

      if (!title || !description || !price) {
        alert('Please fill all required fields');
        return;
      }

      try {
        const marketplaceItem = {
          category,
          title,
          description,
          price,
          userId: user.uid,
          userName: user.name,
          available: true,
          createdAt: new Date(),
          updatedAt: new Date()
        };

        // Upload images if any
        if (images.length > 0) {
          const imageUrls = await uploadImages(images, 'marketplace');
          foodItem.images = imageUrls;
        }

        await db.collection('marketplaceItems').add(marketplaceItem);
        
        alert('Marketplace item added successfully!');
        clearMarketplaceForm();
        loadUserMarketplace();
      } catch (error) {
        console.error('Error adding marketplace item:', error);
        alert('Failed to add marketplace item. Please try again.');
      }
    }

    async function loadUserMarketplace() {
      if (!user.uid) return;
      
      try {
        const snapshot = await db.collection('marketplaceItems').where('userId', '==', user.uid).get();
        const marketplaceItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayUserMarketplace(marketplaceItems);
      } catch (error) {
        console.error('Error loading user marketplace:', error);
      }
    }

    function displayUserMarketplace(marketplaceItems) {
      const list = document.getElementById('mpList');
      if (marketplaceItems.length === 0) {
        list.innerHTML = '<div class="small muted">No marketplace items yet</div>';
        return;
      }

      list.innerHTML = marketplaceItems.map(item => `
        <div class="card">
          <div class="name">${item.title}</div>
          <div class="desc">${item.description}</div>
          <div class="price">$${item.price}</div>
          <div class="small muted">${item.category}</div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="editMarketplaceItem('${item.id}')">Edit</button>
            <button class="btn danger" onclick="deleteMarketplaceItem('${item.id}')">Delete</button>
          </div>
        </div>
      `);
    }

    // Profile Functions
    async function saveProfile() {
      if (!user.uid) return;

      const name = document.getElementById('profileName').value.trim();
      const phone = document.getElementById('profilePhone').value.trim();
      const address = document.getElementById('profileAddress').value.trim();

      try {
        await db.collection('users').doc(user.uid).update({
          name,
          phone,
          address,
          updatedAt: new Date()
        });

        user.name = name;
        user.phone = phone;
        user.address = address;

        alert('Profile updated successfully!');
        updateUI();
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile. Please try again.');
      }
    }

    async function loadUserProfile() {
      if (!user.uid) return;

      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          document.getElementById('profileName').value = userData.name || '';
          document.getElementById('profilePhone').value = userData.phone || '';
          document.getElementById('profileAddress').value = userData.address || '';
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
      }
    }

    // Image Upload Functions
    async function uploadImages(files, folder) {
      const imageUrls = [];
      
      for (let i = 0; i < Math.min(files.length, 5); i++) {
        const file = files[i];
        const fileName = `${folder}/${user.uid}/${Date.now()}_${i}.jpg`;
        const storageRef = storage.ref().child(fileName);
        
        try {
          const snapshot = await storageRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
          imageUrls.push(downloadURL);
        } catch (error) {
          console.error('Error uploading image:', error);
        }
      }
      
      return imageUrls;
    }

    function handleImageUpload(input, previewId) {
      const preview = document.getElementById(previewId);
      const files = input.files;
      
      preview.innerHTML = '';
      
      for (let i = 0; i < Math.min(files.length, 5); i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.position = 'relative';
          
          const removeBtn = document.createElement('div');
          removeBtn.className = 'remove';
          removeBtn.innerHTML = '√ó';
          removeBtn.onclick = function() {
            img.remove();
            removeBtn.remove();
          };
          
          img.appendChild(removeBtn);
          preview.appendChild(img);
        };
        
        reader.readAsDataURL(file);
      }
    }

    function handleProfileImageUpload(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImagePreview').innerHTML = `
            <img src="${e.target.result}" alt="Profile" style="width:100px; height:100px; object-fit:cover; border-radius:50%">
          `;
        };
        reader.readAsDataURL(file);
      }
    }

    // Utility Functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('open');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('open');
    }

    function updateUI() {
      document.getElementById('userName').textContent = user.name;
      document.getElementById('authBtn').textContent = user.uid ? 'Sign Out' : 'Sign In';
      document.getElementById('authBtn').onclick = user.uid ? signOut : () => showModal('authModal');
    }

    async function signOut() {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    function clearServiceForm() {
      document.getElementById('msType').value = '';
      document.getElementById('msDetails').value = '';
      document.getElementById('msPrice').value = '';
      document.getElementById('msImages').value = '';
      document.getElementById('msImagePreview').innerHTML = '';
    }

    function clearFoodForm() {
      document.getElementById('foodName').value = '';
      document.getElementById('foodDescription').value = '';
      document.getElementById('foodPrice').value = '';
      document.getElementById('foodImages').value = '';
      document.getElementById('foodImagePreview').innerHTML = '';
    }

    function clearMarketplaceForm() {
      document.getElementById('mpTitle').value = '';
      document.getElementById('mpDescription').value = '';
      document.getElementById('mpPrice').value = '';
      document.getElementById('mpImages').value = '';
      document.getElementById('mpImagePreview').innerHTML = '';
    }

    function handleCategoryChange() {
      const category = document.getElementById('msCategory').value;
      const transportSub = document.getElementById('msTransportSub');
      
      if (category === 'transport') {
        transportSub.style.display = 'block';
      } else {
        transportSub.style.display = 'none';
      }
    }

    function handleFoodCategoryChange() {
      // Handle food category specific logic if needed
    }

    // Display Functions
    function displayServices(services, containerId) {
      const container = document.getElementById(containerId);
      if (services.length === 0) {
        container.innerHTML = '<div class="small muted">No services available</div>';
        return;
      }

      container.innerHTML = services.map(service => `
        <div class="card">
          <div class="name">${service.type}</div>
          <div class="desc">${service.details}</div>
          <div class="price">$${service.price}</div>
          <div class="small muted">${service.category}</div>
        </div>
      `).join('');
    }

    function displayFoodItems(foodItems, containerId) {
      const container = document.getElementById(containerId);
      if (foodItems.length === 0) {
        container.innerHTML = '<div class="small muted">No food items available</div>';
        return;
      }

      container.innerHTML = foodItems.map(item => `
        <div class="card">
          <div class="name">${item.name}</div>
          <div class="desc">${item.description}</div>
          <div class="price">$${item.price}</div>
          <div class="small muted">${item.category}</div>
        </div>
      `).join('');
    }

    function displayMarketplaceItems(marketplaceItems, containerId) {
      const container = document.getElementById(containerId);
      if (marketplaceItems.length === 0) {
        container.innerHTML = '<div class="small muted">No marketplace items available</div>';
        return;
      }

      container.innerHTML = marketplaceItems.map(item => `
        <div class="card">
          <div class="name">${item.title}</div>
          <div class="desc">${item.description}</div>
          <div class="price">$${item.price}</div>
          <div class="small muted">${item.category}</div>
        </div>
      `).join('');
    }

    // Placeholder functions for edit/delete operations
    function editService(serviceId) {
      alert('Edit service functionality coming soon');
    }

    function deleteService(serviceId) {
      if (confirm('Are you sure you want to delete this service?')) {
        db.collection('services').doc(serviceId).delete()
          .then(() => {
            alert('Service deleted successfully');
            loadUserServices();
          })
          .catch(error => {
            console.error('Error deleting service:', error);
            alert('Failed to delete service');
          });
      }
    }

    function editFoodItem(foodId) {
      alert('Edit food item functionality coming soon');
    }

    function deleteFoodItem(foodId) {
      if (confirm('Are you sure you want to delete this food item?')) {
        db.collection('foodItems').doc(foodId).delete()
          .then(() => {
            alert('Food item deleted successfully');
            loadUserFood();
          })
          .catch(error => {
            console.error('Error deleting food item:', error);
            alert('Failed to delete food item');
          });
      }
    }

    function editMarketplaceItem(marketplaceId) {
      alert('Edit marketplace item functionality coming soon');
    }

    function deleteMarketplaceItem(marketplaceId) {
      if (confirm('Are you sure you want to delete this marketplace item?')) {
        db.collection('marketplaceItems').doc(marketplaceId).delete()
          .then(() => {
            alert('Marketplace item deleted successfully');
            loadUserMarketplace();
          })
          .catch(error => {
            console.error('Error deleting marketplace item:', error);
            alert('Failed to delete marketplace item');
          });
      }
    }

    // Order Functions
    async function placeOrder() {
      if (!user.uid) {
        alert('Please sign in to place an order');
        return;
      }

      if (!document.getElementById('chkTerms').checked) {
        alert('Please accept the terms');
        return;
      }

      if (cart.items.length === 0) {
        alert('Cart is empty');
        return;
      }

      const method = document.querySelector('input[name="payMethod"]:checked')?.value || 'stripe';
      const orderId = 'ord-' + Date.now();
      const code = String(Math.floor(100000 + Math.random() * 900000));

      try {
        const order = {
          id: orderId,
          code: code,
          userId: user.uid,
          userName: user.name,
          items: cart.items,
          total: cart.items.reduce((sum, item) => sum + (item.price * item.qty), 0),
          paymentMethod: method,
          status: method === 'cash' ? 'pending' : 'processing',
          createdAt: new Date(),
          updatedAt: new Date()
        };

        // Save order to Firestore
        await db.collection('orders').doc(orderId).set(order);

        if (method === 'stripe') {
          // Handle Stripe payment
          await processStripePayment(order);
        } else {
          // Cash payment - order already saved
          showOrderConfirmation(orderId, code);
        }

        // Clear cart and close modal
        cart = { items: [], vendorId: null, vendorName: '' };
        closeModal('checkoutModal');
        
      } catch (error) {
        console.error('Error placing order:', error);
        alert('Failed to place order. Please try again.');
      }
    }

    async function processStripePayment(order) {
      try {
        // Create payment intent with your backend
        const response = await fetch('/api/payments/stripe/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: order.total * 100, // Convert to cents
            currency: 'usd',
            orderId: order.id
          })
        });

        if (!response.ok) {
          throw new Error('Payment intent creation failed');
        }

        const { clientSecret } = await response.json();

        // Redirect to Stripe Checkout
        const stripe = Stripe('YOUR_STRIPE_PUBLISHABLE_KEY');
        const { error } = await stripe.confirmCardPayment(clientSecret);

        if (error) {
          throw new Error(error.message);
        }

        // Payment successful
        await db.collection('orders').doc(order.id).update({
          status: 'confirmed',
          paymentStatus: 'paid',
          updatedAt: new Date()
        });

        showOrderConfirmation(order.id, order.code);

      } catch (error) {
        console.error('Stripe payment error:', error);
        alert('Payment failed: ' + error.message);
        
        // Update order status to failed
        await db.collection('orders').doc(order.id).update({
          status: 'failed',
          paymentStatus: 'failed',
          updatedAt: new Date()
        });
      }
    }

    function showOrderConfirmation(orderId, code) {
      document.getElementById('orderInfo').innerHTML = `
        <div class="card">
          <div><strong>Order ID:</strong> ${orderId}</div>
          <div style="margin-top:6px"><strong>Status:</strong> <span>preparing (15 min)</span></div>
          <div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div>
          <div class="small muted" style="margin-top:6px">Please don't share this code with the seller until your goods are delivered and confirmed. You can always view it under Manage Orders.</div>
        </div>
      `;
      showModal('orderModal');
    }

    // Load user orders
    async function loadUserOrders() {
      if (!user.uid) return;

      try {
        const snapshot = await db.collection('orders').where('userId', '==', user.uid).orderBy('createdAt', 'desc').get();
        const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displayUserOrders(orders);
      } catch (error) {
        console.error('Error loading user orders:', error);
      }
    }

    function displayUserOrders(orders) {
      const container = document.getElementById('ordersList');
      if (orders.length === 0) {
        container.innerHTML = '<div class="small muted">No orders yet</div>';
        return;
      }

      container.innerHTML = orders.map(order => `
        <div class="card">
          <div class="name">Order #${order.code}</div>
          <div class="desc">${order.items.length} items ‚Ä¢ $${order.total}</div>
          <div class="small muted">Status: ${order.status} ‚Ä¢ ${new Date(order.createdAt.toDate()).toLocaleDateString()}</div>
        </div>
      `).join('');
    }

    // Initialize category handlers
    handleCategoryChange();
    handleFoodCategoryChange();

    // Load initial data when page loads
    loadPublicData();
  </script>
</body>
</html>
