<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- SDKs -->
  <script src="https://js.stripe.com/v3"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827;
      --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --header-h:56px; --nav-h:64px;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body { width:100%; height:100%; max-width:100%; overflow-x:hidden; -webkit-text-size-adjust:100% }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }

    /* Header safe-area fix: height includes notch, page offset matches it */
    header {
      position:fixed; top:0; left:0; right:0;
      height: calc(var(--header-h) + env(safe-area-inset-top, 0px));
      padding-top: env(safe-area-inset-top, 0px);
      z-index:100; background:var(--card); border-bottom:1px solid var(--border);
      display:flex; align-items:flex-end;
    }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 16px; width:100% }
    .greet { display:flex; flex-direction:column; min-width:0 }
    .greet strong, .greet .small { white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .small { color:var(--muted); font-size:13px }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }

    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; max-width:100% }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#eef2ff; display:flex; align-items:center; justify-content:center; font-size:18px }
    .rating { color:#F59E0B; font-size:12px }
    .verify { color:#2563EB; font-size:14px }
    .field { display:flex; flex-direction:column; gap:6px }
    .field input, .field textarea, .field select { padding:10px; border:1px solid var(--border); border-radius:10px }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:100% }
    .price { font-weight:700; color:#111 }
    .hint { font-size:12px; color:#6b7280 }

    .nav {
      position:fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      display:flex; align-items:center; justify-content:space-around; background:#fff; border-top:1px solid var(--border); z-index:90;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }

    .page {
      position:fixed;
      top: calc(var(--header-h) + env(safe-area-inset-top, 0px));
      bottom: var(--nav-h);
      left:0; right:0;
      overflow-y:auto; overflow-x:hidden; display:none; -webkit-overflow-scrolling:touch; background:var(--bg);
    }
    .page.active { display:block }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:200; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow); max-width:100% }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px }

    /* Panic floating button */
    .floating-panic { position:fixed; right:16px; bottom:80px; width:60px; height:60px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:96; display:flex; align-items:center; justify-content:center }

    /* Hide header cart entirely, keep Account visible */
    #cartBtn, #headerCartBadge { display:none !important; }

    /* Checkout full-screen and scrollable */
    #checkoutModal .sheet { height: calc(100vh - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px)); display:flex; flex-direction:column }
    #checkoutModal .sheet .body { flex:1; overflow:auto }

    /* Terms modal */
    #termsModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; padding:16px }
    #termsModal .modal-content { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); overflow:hidden }
    #termsModal .modal-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    #termsModal .modal-body { padding:16px; max-height:65vh; overflow:auto }

    /* Notifications modal */
    #notifModal .sheet { max-width:560px }

    /* Product cards uniform sizes */
    .product { display:flex; flex-direction:column }
    .product img { width:100%; height:160px; object-fit:cover; border-radius:10px; border:1px solid var(--border) }

    /* Back bar */
    .backbar { position:sticky; top:0; background:#fff; z-index:5; padding:8px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px }
    .backbar .backbtn { background:#F3F4F6; border:0; border-radius:10px; padding:8px 10px; cursor:pointer }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="row">
      <div class="greet">
        <strong>Hello, <span id="userName">Guest</span></strong>
        <span class="small">üìç <span id="userLoc">Detecting location‚Ä¶</span></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="notifBtn" type="button" title="Notifications">üîî</button>
        <div style="position:relative">
          <button class="btn ghost" id="cartBtn" type="button">üõí</button>
          <span id="headerCartBadge" style="position:absolute; top:-6px; right:-6px; background:#DC2626; color:#fff; border-radius:999px; font-size:12px; padding:0 6px; line-height:18px; min-width:18px; text-align:center;">0</span>
        </div>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn" type="button">üë§ Account</button>
          <div id="profileMenu" style="position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:220px; z-index:300; padding:6px">
            <button class="btn ghost" id="menuProfile" type="button">üë§ Profile</button>
            <button class="btn ghost" id="menuOrders" type="button">üì¶ Manage Orders</button>
            <button class="btn ghost" id="menuWallet" type="button">üí∞ Wallet</button>
            <button class="btn ghost" id="menuTopup" type="button">‚ö° Top‚Äëup</button>
            <!-- Contact Support removed -->
            <button class="btn ghost" id="menuLogout" type="button">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Pages -->
  <main id="page-home" class="page active">
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency‚Ä¶"/>
        <button class="btn ghost" id="voiceBtn" type="button">üé§</button>
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </section>

    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>

    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>

    <section class="section">
      <div class="title">Recent</div>
      <div id="recentList"></div>
    </section>
  </main>

  <main id="page-services" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Services</strong></div>
    <section class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesAllGrid"></div>
    </section>
  </main>

  <main id="page-bookings" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>My Bookings</strong></div>
    <section class="section">
      <div id="bookingsList"></div>
    </section>
  </main>

  <main id="page-marketplace" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Marketplace</strong></div>
    <section class="section">
      <button class="btn primary" id="sellBtn" type="button">üõçÔ∏è Sell products</button>
    </section>
    <section class="search">
      <div class="box">
        <input id="mpSearch" placeholder="Search products‚Ä¶"/>
        <button class="btn ghost" id="mpVoice" type="button">üé§</button>
        <button class="btn primary" id="mpSearchBtn" type="button">Search</button>
      </div>
    </section>
    <section class="section">
      <div class="controls" id="mpChips"></div>
    </section>
    <section class="section">
      <div class="title">Products</div>
      <div class="grid" id="mpGrid"></div>
    </section>
  </main>

  <main id="page-profile" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Profile</strong></div>
    <section class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row">
            <div id="user-avatar" style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">üë§</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Demo User</strong> <span class="small muted">(Public name)</span></div>
              <div class="small" id="profEmail">demo@zippup.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><strong>Availability</strong><div class="small muted">Go Offline / Available</div></div>
          <label style="position:relative;display:inline-block;width:48px;height:28px">
            <input id="availToggle" type="checkbox" style="display:none"/>
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;border-radius:999px"></span>
            <span style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s" id="availKnob"></span>
          </label>
        </div>
      </div>

      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageFoodMenuBtn" type="button">Manage Food Menu (for food vendors only)</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
      </div>
    </section>
  </main>

  <main id="page-orders" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Manage Orders</strong></div>
    <section class="section">
      <div class="card">
        <div class="list">
          <div class="small muted">Buyer view</div>
          <div id="buyerOrders" class="list"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="list">
          <div class="small muted">Seller view</div>
          <div id="sellerOrders" class="list"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="page-wallet" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Wallet</strong></div>
    <section class="section">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>Balance: <strong id="walletBalance">$245.80</strong></div>
          <div class="row" style="gap:8px">
            <button class="btn primary" id="walletAdd" type="button">Add funds</button>
            <button class="btn ghost" id="walletCashOut" type="button">Cash out</button>
            <button class="btn ghost" id="walletSend" type="button">Send to user</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Transactions</strong>
        <div id="walletTx" class="list" style="margin-top:8px"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <strong>Saved cards</strong>
        <div id="walletCards" class="list" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <main id="page-topup" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Top‚Äëup (Coming soon)</strong></div>
    <section class="section">
      <div class="grid">
        <div class="card service" data-topup="airtime"><div class="row"><div style="font-size:24px">üìû</div><h4>Buy Airtime</h4></div></div>
        <div class="card service" data-topup="data"><div class="row"><div style="font-size:24px">üì∂</div><h4>Data Bundles</h4></div></div>
        <div class="card service" data-topup="bills"><div class="row"><div style="font-size:24px">üí°</div><h4>Pay Bills</h4></div></div>
      </div>
      <div class="small muted" style="margin-top:8px">In‚Äëapp purchases API coming soon.</div>
    </section>
  </main>

  <main id="page-manage-services" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Manage Services</strong></div>
    <section class="section">
      <div class="card">
        <div class="list">
          <div class="grid-2">
            <div class="field">
              <label class="small">Category</label>
              <select id="msCategory">
                <option value="transport">Transport</option>
                <option value="food">Food</option>
                <option value="tech">Tech Services</option>
                <option value="home">Home Services</option>
                <option value="construction">Construction</option>
                <option value="auto">Automobile Repair</option>
                <option value="others">Others</option>
              </select>
            </div>
            <div class="field">
              <label class="small">Service type</label>
              <input id="msType" placeholder="e.g., Driver, Plumber"/>
            </div>
          </div>
          <div class="field">
            <label class="small">Details</label>
            <textarea id="msDetails" rows="3" placeholder="Describe your service‚Ä¶"></textarea>
          </div>
          <div class="grid-2">
            <div class="field">
              <label class="small">Price (per 1‚Äì2hr)</label>
              <input id="msPrice" type="number" min="0" step="0.01" placeholder="e.g., 50"/>
            </div>
            <div class="field">
              <label class="small">Catalog images (up to 4)</label>
              <input id="msImages" type="file" accept="image/*" multiple/>
              <div class="hint">Optional</div>
            </div>
          </div>
          <button class="btn primary" id="msAdd" type="button">+ Add Service</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="msList"></div>
    </section>
  </main>

  <!-- Manage Food Menu (vendors) -->
  <main id="page-manage-food" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Manage Food Menu</strong></div>
    <section class="section">
      <div class="card">
        <div class="list" id="fmForm">
          <div class="grid-2">
            <div class="field">
              <label class="small">Food category</label>
              <select id="fmKind">
                <option value="fastfood">Fast food</option>
                <option value="grocery">Groceries</option>
              </select>
            </div>
            <div class="field">
              <label class="small">Payment options</label>
              <div class="row"><label><input type="checkbox" id="fmPayCard" checked/> Card</label><label><input type="checkbox" id="fmPayCash" checked/> Cash</label></div>
            </div>
          </div>
          <div id="fmItems" class="list"></div>
          <div class="row" style="gap:8px">
            <button class="btn ghost" id="fmAddItem" type="button">+ Add another item</button>
            <button class="btn primary" id="fmSaveAll" type="button">Save Menu</button>
          </div>
          <div class="hint">You can add unlimited items; each can include up to 5 images.</div>
        </div>
      </div>
      <div class="list" style="margin-top:12px" id="fmList"></div>
    </section>
  </main>

  <main id="page-emergency-contacts" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Emergency Contacts</strong></div>
    <section class="section">
      <div class="card">
        <div class="small muted">Add up to 5 contacts (name and phone).</div>
        <div id="ecForm" class="list" style="margin-top:10px"></div>
        <button class="btn primary" id="ecSave" type="button">Save Contacts</button>
      </div>
    </section>
  </main>

  <main id="page-verify-provider" class="page">
    <div class="backbar"><button class="backbtn" data-back>‚Üê Back</button><strong>Become Verified Provider</strong></div>
    <section class="section">
      <div class="card">
        <div class="list">
          <div class="field"><label class="small">Full name</label><input id="vpName" placeholder="Your name"/></div>
          <div class="field"><label class="small">Service category</label><input id="vpCategory" placeholder="e.g., Driver, Plumber"/></div>
          <div class="field"><label class="small">ID number</label><input id="vpId" placeholder="Your ID"/></div>
          <div class="field"><label class="small">ID/Passport docs</label><input id="vpIdDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <div class="field"><label class="small">Business/License docs</label><input id="vpBizDocs" type="file" accept="image/*,application/pdf" multiple/></div>
          <button class="btn primary" id="vpSubmit" type="button">Submit for Verification</button>
          <div id="vpStatus" class="small" style="color:#2563EB"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="nav">
    <button data-page="home" class="active" type="button">üè† Home</button>
    <button data-page="services" type="button">üîß Services</button>
    <button data-page="bookings" type="button">üìã Bookings</button>
    <button data-page="marketplace" type="button">üõçÔ∏è Marketplace</button>
  </nav>

  <!-- Providers -->
  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="search" id="providersSearchWrap" style="display:none">
          <div class="box">
            <input id="providersSearch" placeholder="Filter provider type or name‚Ä¶"/>
            <button class="btn primary" id="providersSearchBtn" type="button">Search</button>
          </div>
        </div>
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking" type="button">‚úñ</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="grid-2">
            <div class="field"><label class="small">Date</label><input id="bkDate" type="date" required/></div>
            <div class="field"><label class="small">Time</label><input id="bkTime" type="time" required/></div>
          </div>
          <div class="field">
            <label class="small">Address</label>
            <div class="row" style="gap:8px">
              <input id="bkAddress" required placeholder="Enter address" style="flex:1"/>
              <button class="btn ghost" id="bkUseCurrent" type="button">üìç Use current</button>
            </div>
          </div>
          <div class="field"><label class="small">Details</label><textarea id="bkDesc" rows="3" placeholder="Describe the job‚Ä¶"></textarea></div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Transport Instant -->
  <div class="modal" id="tiModal">
    <div class="sheet">
      <div class="head">
        <strong>Ride Details</strong>
        <button class="btn ghost" id="tiClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="field">
            <label class="small">Pickup address</label>
            <div class="row" style="gap:8px; width:100%">
              <input id="tiPickup" placeholder="Your current or preferred pickup‚Ä¶" style="flex:1"/>
              <button class="btn ghost" id="tiUseCurrent" type="button">üìç Use current</button>
            </div>
          </div>
          <div class="field">
            <label class="small">Destination address</label>
            <input id="tiDestination" placeholder="Where are you going?"/>
          </div>
          <div class="field">
            <label class="small">Stops (optional, max 5)</label>
            <div id="tiStops" class="list"></div>
            <div class="row" style="gap:8px;margin-top:6px">
              <button class="btn ghost" id="tiAddStop" type="button">Ôºã Add stop</button>
              <button class="btn ghost" id="tiRemoveStop" type="button">‚àí Remove stop</button>
            </div>
          </div>
          <button class="btn primary" id="tiStart" type="button">Start Instant Request</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Instant Request -->
  <div class="modal" id="instantModal">
    <div class="sheet">
      <div class="head">
        <strong id="instantTitle">Contacting provider‚Ä¶</strong>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="cancelInstant" type="button">Cancel</button>
          <button class="btn ghost" id="instantClose" type="button">‚úñ</button>
        </div>
      </div>
      <div class="body">
        <div class="card">
          <div>Time left: <strong id="countdown">90</strong>s</div>
          <div class="small muted" id="instantHint">Waiting for provider to accept‚Ä¶</div>
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="findOthers" type="button">Find other providers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cancel Reasons -->
  <div class="modal" id="cancelReasonsModal">
    <div class="sheet">
      <div class="head"><strong>Cancel request</strong><button class="btn ghost" id="crClose" type="button">‚úñ</button></div>
      <div class="body">
        <div id="crList" class="list"></div>
        <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn ghost" id="crBack" type="button">Back</button>
          <button class="btn primary" id="crConfirm" type="button">Confirm cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking -->
  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong>Live Tracking</strong>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="trackCancelBtn" type="button">Cancel</button>
          <button class="btn ghost" id="closeTrack" type="button">‚úñ</button>
        </div>
      </div>
      <div class="body">
        <div id="trackStatus" class="small muted">Provider accepted. En route‚Ä¶</div>
        <div id="trackMapWrap" style="margin-top:10px"><div id="track-map" style="width:100%;height:360px;border-radius:12px;border:1px solid var(--border)"></div></div>
      </div>
    </div>
  </div>

  <!-- Options -->
  <div class="modal" id="categoryOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong id="categoryOptionsTitle">Options</strong>
        <button class="btn ghost" id="closeCategoryOptions" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="categoryOptionsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Food Options -->
  <div class="modal" id="foodOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong>Food</strong>
        <button class="btn ghost" id="closeFoodOptions" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="search">
          <div class="box">
            <input id="foodSearch" placeholder="Search vendors or food‚Ä¶"/>
            <button class="btn primary" id="foodSearchBtn" type="button">Search</button>
          </div>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button class="btn primary" id="foodFastBtn" type="button">üçî Fast food</button>
          <button class="btn ghost" id="foodGroceryBtn" type="button">üõí Groceries</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Items/Search -->
  <div class="modal" id="itemsModal">
    <div class="sheet">
      <div class="head">
        <strong id="itemsTitle">Find Items</strong>
        <button class="btn ghost" id="closeItems" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="itemSearch" placeholder="Say or type what you need‚Ä¶" style="flex:1"/>
          <button class="btn ghost" id="itemVoice" type="button">üé§</button>
          <button class="btn primary" id="itemGo" type="button">Search</button>
        </div>
        <div id="itemChips" class="controls"></div>
      </div>
    </div>
  </div>

  <!-- Food Vendors -->
  <div class="modal" id="foodVendorsModal">
    <div class="sheet">
      <div class="head">
        <strong id="foodVendorsTitle">Food Vendors</strong>
        <button class="btn ghost" id="closeFoodVendors" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="foodVendorsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Food Menu -->
  <div class="modal" id="foodMenuModal">
    <div class="sheet">
      <div class="head">
        <strong id="foodMenuTitle">Menu</strong>
        <button class="btn ghost" id="closeFoodMenu" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="foodMenuList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="foodCartTotal">0.00</span></div>
          <button class="btn primary" id="foodCheckoutBtn" type="button">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart (Food/Grocery) -->
  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head">
        <strong>My Cart</strong>
        <button class="btn ghost" id="closeCart" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="cartList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="cartTotal">0.00</span></div>
          <button class="btn primary" id="checkoutBtn" type="button">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout -->
  <div class="modal" id="checkoutModal">
    <div class="sheet">
      <div class="head">
        <strong>Checkout</strong>
        <button class="btn ghost" id="closeCheckout" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list" id="chkFormList">
          <div class="grid-2">
            <div class="field"><label class="small">Full Name</label><input id="chkName"/></div>
            <div class="field"><label class="small">Phone</label><input id="chkPhone"/></div>
          </div>
          <div class="grid-2">
            <div class="field"><label class="small">Street / Address</label><input id="chkAddress"/></div>
            <div class="field"><label class="small">Flat / House No.</label><input id="chkUnit"/></div>
          </div>
          <div class="field"><label class="small">Delivery Notes</label><textarea id="chkNotes" rows="3"></textarea></div>
          <div class="field">
            <label class="small">Payment Method</label>
            <div class="controls">
              <label><input type="radio" name="payMethod" value="card" checked/> Card</label>
              <label><input type="radio" name="payMethod" value="cash"/> Cash</label>
            </div>
            <div class="small muted" id="vendorPayHint"></div>
          </div>
          <label class="row" style="align-items:flex-start;gap:8px"><input type="checkbox" id="chkTerms"/> <span>I accept the Terms. <a href="#" id="readTerms">Read Terms</a></span></label>
          <div id="chkItemsList" class="list"></div>
          <button class="btn primary" id="placeOrderBtn" type="button">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Status -->
  <div class="modal" id="orderModal">
    <div class="sheet">
      <div class="head">
        <strong>Order Status</strong>
        <button class="btn ghost" id="closeOrder" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="orderInfo" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Terms -->
  <div id="termsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Terms and Conditions</h3>
        <button id="termsClose" class="btn ghost" type="button">√ó</button>
      </div>
      <div class="modal-body">
        <p><strong>Payments and delivery:</strong> Your payment is held in escrow until the seller enters the one‚Äëtime delivery code you provide after you receive goods.</p>
        <p><strong>Safety:</strong> Do not share your delivery code until the goods are delivered and verified in good condition.</p>
        <p><strong>Refunds:</strong> If there‚Äôs an issue, do not share your code; contact support immediately.</p>
        <p><strong>Privacy:</strong> We only share essential order details with the seller to fulfill your order.</p>
      </div>
    </div>
  </div>

  <!-- Confirm Delivery -->
  <div id="confirmDeliveryModal" class="modal">
    <div class="sheet">
      <div class="head">
        <strong>Confirm Delivery</strong>
        <button id="confirmClose" class="btn ghost" type="button">√ó</button>
      </div>
      <div class="body">
        <div class="small muted">Seller: ask buyer for the one‚Äëtime delivery code and enter it below to mark delivery complete and release payment.</div>
        <input id="confirmCode" placeholder="Enter 6‚Äëdigit code" inputmode="numeric" maxlength="6" style="margin-top:8px"/>
        <button id="confirmSubmit" class="btn primary" type="button" style="margin-top:8px">Submit Code</button>
        <div id="confirmStatus" class="small muted" style="margin-top:6px"></div>
      </div>
    </div>
  </div>

  <!-- Last Order -->
  <div id="lastOrderModal" class="modal">
    <div class="sheet">
      <div class="head">
        <strong>Your Last Order</strong>
        <button id="lastOrderClose" class="btn ghost" type="button">√ó</button>
      </div>
      <div class="body">
        <div id="lastOrderInfo" class="small"></div>
        <div class="row" style="gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="sendCodeSMS" class="btn ghost" type="button">Send Code by SMS</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notifModal" class="modal">
    <div class="sheet">
      <div class="head">
        <strong>Notifications</strong>
        <button class="btn ghost" id="closeNotif" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="notifList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Sell Products (marketplace uploader) -->
  <div class="modal" id="sellModal">
    <div class="sheet">
      <div class="head">
        <strong>Sell Products</strong>
        <button class="btn ghost" id="sellClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="grid-2">
            <div class="field"><label class="small">Category</label>
              <select id="sellCat">
                <option value="electronics">Electronics</option>
                <option value="fashion">Fashion</option>
                <option value="home">Home & Garden</option>
                <option value="sports">Sports</option>
                <option value="automobile">Automobile</option>
                <option value="spares">Spare Parts</option>
                <option value="others">Others</option>
              </select>
            </div>
            <div class="field"><label class="small">Type</label><input id="sellType" placeholder="e.g., Phone, Shoes"/></div>
          </div>
          <div class="grid-2">
            <div class="field"><label class="small">Title</label><input id="sellTitle"/></div>
            <div class="field"><label class="small">Price</label><input id="sellPrice" type="number" min="0" step="0.01"/></div>
          </div>
          <div class="field"><label class="small">Stock</label><input id="sellStock" type="number" min="0" step="1"/></div>
          <div class="field"><label class="small">Description</label><textarea id="sellDesc" rows="3"></textarea></div>
          <div class="field"><label class="small">Images (up to 10)</label><input id="sellImages" type="file" accept="image/*" multiple/></div>
          <div class="row" style="gap:8px">
            <button class="btn primary" id="sellSave" type="button">Save</button>
          </div>
          <div class="hint">You can edit or renew listings later.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panic button -->
  <button class="floating-panic" id="panicBtn" type="button">üö®</button>

  <!-- Splash -->
  <div id="splash" style="position:fixed;inset:0;background:linear-gradient(135deg,#2563EB 0%,#1D4ED8 100%);z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff">
    <svg width="160" height="160" viewBox="0 0 256 256" aria-hidden="true">
      <defs><linearGradient id="g2" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#2563EB"/><stop offset="1" stop-color="#1D4ED8"/></linearGradient></defs>
      <rect x="8" y="8" width="240" height="240" rx="48" fill="url(#g2)"/>
      <path d="M58 184 L152 68 H90 L98 48 H198 L104 168 H170 L162 188 Z" fill="#fff"/>
      <circle cx="172" cy="82" r="10" fill="#fff"/>
      <path d="M168 96 L150 120 L128 114 L124 126 L146 132 L160 112 L170 126 L182 124 L174 108 L186 100 L180 92 L168 96 Z" fill="#fff"/>
      <rect x="182" y="94" width="8" height="14" rx="1.5" fill="#0EA5E9"/>
      <rect x="184" y="96" width="4" height="8" rx="1" fill="#22C55E"/>
    </svg>
    <div style="font-size:28px;font-weight:800;margin-top:12px">ZippUp</div>
    <div style="opacity:.9;margin-top:4px">On‚Äëdemand services, fast.</div>
  </div>

  <!-- Core App Script -->
  <script>
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';

    // Firebase init (auth only)
    const firebaseConfig = {
      apiKey: "AIzaSyApgmcfu5qGFn9tw872dQ2KkdDz_GPmL70",
      authDomain: "zippup-535ca.firebaseapp.com",
      projectId: "zippup-535ca",
      appId: "1:382212325227:web:c04d91386817c7cff7d62e",
      messagingSenderId: "382212325227",
      measurementId: "G-YKJEVL8M6V"
    };
    if (!window.firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // State
    let user = { name:'Guest', email:'guest@example.com' };
    let coords = null, map=null, userMarker=null, providerMarker=null, trackPoll=null;
    let selectedProvider = null, lastCategory = null, requestId = null, instantTimer = null, instantLeft = 90;

    // Food cart
    let cart = loadCart(); // { vendorId:null, vendorName:null, vendorPayment:['card','cash'], items:[] }
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('food_cart')||'{"vendorId":null,"vendorName":null,"vendorPayment":[],"items":[]}'); }catch{ return { vendorId:null, vendorName:null, vendorPayment:[], items:[] } } }
    function saveCart(){ localStorage.setItem('food_cart', JSON.stringify(cart)); }
    function resetCart(){ cart={ vendorId:null, vendorName:null, vendorPayment:[], items:[] }; saveCart(); }

    const $ = (id)=>document.getElementById(id);
    function showPage(page){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); (document.getElementById('page-'+page) || document.getElementById('page-home')).classList.add('active'); }

    // Header interactions
    $('profileBtn').onclick = (e)=>{ e.stopPropagation(); const m=$('profileMenu'); m.style.display = (m.style.display==='block'?'none':'block'); };
    document.addEventListener('click', ()=>{ const m=$('profileMenu'); if (m) m.style.display='none'; });
    $('menuProfile').onclick = ()=>{ $('profileMenu').style.display='none'; showPage('profile'); updateProfileUI(); };
    $('menuOrders').onclick  = ()=>{ $('profileMenu').style.display='none'; showPage('orders'); renderOrders(); };
    $('menuWallet').onclick  = ()=>{ $('profileMenu').style.display='none'; showPage('wallet'); };
    $('menuTopup').onclick   = ()=>{ $('profileMenu').style.display='none'; showPage('topup'); };
    $('menuLogout').onclick  = async ()=>{ $('profileMenu').style.display='none'; try{ await auth.signOut(); }catch{} ensureGate(); };

    // Backbars
    document.querySelectorAll('[data-back]').forEach(btn=>{
      btn.onclick=()=> history.length > 1 ? history.back() : showPage('home');
    });

    // Nav
    document.querySelectorAll('.nav button').forEach(b=>{
      b.onclick = ()=>{ document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showPage(b.dataset.page); if (b.dataset.page==='marketplace') renderMarketplace(); };
    });

    // Availability toggle
    const availKey='zippup_availability'; const knob=$('availKnob'); const toggle=$('availToggle');
    toggle.checked = localStorage.getItem(availKey) === 'on'; knob.style.transform = toggle.checked ? 'translateX(20px)' : 'translateX(0)';
    toggle.onchange = (e)=>{ localStorage.setItem(availKey, e.target.checked?'on':'off'); knob.style.transform = e.target.checked?'translateX(20px)':'translateX(0)'; knob.previousElementSibling.style.background = e.target.checked ? '#10B981' : '#d1d5db'; };

    // Notifications
    (function wireNotifications(){
      const bell = $('notifBtn');
      const modal = $('notifModal');
      const list  = $('notifList');
      const badge = document.createElement('span'); badge.id='notifBellBadge'; badge.style.cssText='position:absolute; top:-4px; right:-4px; background:#DC2626; color:#fff; border-radius:999px; font-size:11px; padding:0 5px; line-height:16px; min-width:16px; text-align:center; display:none';
      bell.style.position='relative'; bell.appendChild(badge);
      $('closeNotif').onclick = ()=> modal.classList.remove('open');
      modal.addEventListener('click',(e)=>{ if (e.target===modal) modal.classList.remove('open'); });

      function getFoodCartCount(){ try{ const c=loadCart(); return c.items.reduce((a,b)=>a+(b.qty||0),0); }catch{return 0} }
      function updateBadge(){ const n=getFoodCartCount(); badge.style.display = n>0 ? 'inline-block' : 'none'; badge.textContent = n || ''; }
      function openCartModal(){ renderCart(); $('cartModal').classList.add('open'); }
      function renderNotif(){
        list.innerHTML='';
        const items=[];
        const n=getFoodCartCount();
        if (n>0) items.push({ icon:'üõí', title:'Items in your Food cart', text:`You have ${n} item${n>1?'s':''} in your cart for ${cart.vendorName||'current vendor'}.`, action: openCartModal });
        if (!items.length){ list.innerHTML='<div class="small muted">No new notifications.</div>'; return; }
        items.forEach(x=>{
          const row=document.createElement('div'); row.className='card'; row.style.cursor='pointer';
          row.innerHTML=`<div class="row" style="justify-content:space-between; align-items:flex-start"><div class="row" style="align-items:center; gap:10px"><div style="font-size:20px">${x.icon}</div><div><div><strong>${x.title}</strong></div><div class="small muted">${x.text}</div></div></div><div>‚Ä∫</div></div>`;
          row.onclick=()=>{ try{x.action&&x.action()}finally{modal.classList.remove('open')} };
          list.appendChild(row);
        });
      }
      bell.onclick = ()=>{ renderNotif(); modal.classList.add('open'); };
      updateBadge();
      window.updateBellBadge = updateBadge;
    })();

    // Panic modal
    (function wirePanic(){
      const modal=$('panicModal');
      function updateLocHint(){ $('panicLocHint').textContent = coords ? (coords.lat.toFixed(5)+', '+coords.lng.toFixed(5)) : 'Unknown (we will try to fetch)'; }
      $('panicBtn').onclick = ()=>{ updateLocHint(); $('panicStatus').textContent=''; $('panicMsg').value=''; modal.classList.add('open'); };
      $('panicClose').onclick=()=> modal.classList.remove('open');
      $('panicCancel').onclick=()=> modal.classList.remove('open');
      modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('open'); });
      $('panicSend').onclick = async ()=>{
        const btn=$('panicSend'); const st=$('panicStatus'); btn.disabled=true; st.textContent='Sending alert‚Ä¶';
        try{
          if (!coords) { try { await initLocation(); } catch{} }
          const body={ type:'panic', userPublicName:(user?.name||'User'), message:($('panicMsg').value||'').trim()||undefined, location:coords?{latitude:coords.lat,longitude:coords.lng}:null, note:'We\\'ll notify your contacts and nearby security with your location.' };
          const r=await fetch(`${BASE_API}/api/emergency/alert`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
          const d=await r.json().catch(()=>({}));
          st.textContent = r.ok ? 'Alert sent.' : 'Alert sent (fallback).';
          if (d.trackingUrl) { modal.classList.remove('open'); location.href=d.trackingUrl; }
        }catch{ st.textContent='Could not reach server. Alert noted.' } finally { btn.disabled=false; }
      };
    })();

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      $('userName').textContent = user.name;
      updateProfileUI();
      initLocation();
      renderServices(); renderEmergency(); renderRecent(); renderServicesAll(); renderBookings();
      initMarketplace();
      wireProfilePages();
      wireSupport();
      wireFoodFlow();

      // Cart/Checkout modal wiring
      $('closeCart').onclick = ()=> $('cartModal').classList.remove('open');
      $('checkoutBtn').onclick = ()=>{ $('cartModal').classList.remove('open'); openCheckout(); };
      $('closeCheckout').onclick = ()=> $('checkoutModal').classList.remove('open');
      $('closeOrder').onclick = ()=> $('orderModal').classList.remove('open');

      // Terms
      $('readTerms').onclick = (e)=>{ e.preventDefault(); $('termsModal').style.display='flex'; };
      $('termsClose').onclick = ()=> $('termsModal').style.display='none';
      $('termsModal').addEventListener('click',(e)=>{ if(e.target===$('termsModal')) $('termsModal').style.display='none'; });

      // Splash
      window.addEventListener('load', ()=> setTimeout(()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(),250); } }, 250));

      // Sell products modal
      $('sellBtn').onclick = ()=> $('sellModal').classList.add('open');
      $('sellClose').onclick = ()=> $('sellModal').classList.remove('open');
      $('sellSave').onclick = saveMarketplaceListing;
    });

    // Location
    async function initLocation(){
      try {
        const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 }));
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const name = await reverseGeocode(coords.lat, coords.lng);
        $('userLoc').textContent = name || 'Unknown';
      } catch { $('userLoc').textContent = 'Location unavailable'; }
    }
    async function reverseGeocode(lat,lng){
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json(); return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || '');
      } catch { return null; }
    }

    // Data
    const SERVICES = [
      { id:'transport', name:'Transport', icon:'üöó', desc:'Ride & moving', instant:true,  scheduled:true },
      { id:'food',      name:'Food',      icon:'üçî', desc:'Restaurants & groceries', instant:true,  scheduled:true },
      { id:'tech',      name:'Tech',      icon:'üîß', desc:'Phone/computer repair', instant:true,  scheduled:true },
      { id:'home',      name:'Home',      icon:'üè†', desc:'Cleaning & maintenance', instant:true,  scheduled:true },
      { id:'construction', name:'Construction', icon:'üèóÔ∏è', desc:'Builders & electricians', instant:false, scheduled:true },
      { id:'auto',      name:'Automobile', icon:'üõ†Ô∏è', desc:'Mechanics, tires, roadside', instant:true,  scheduled:true },
      { id:'others',    name:'Others',    icon:'üéØ', desc:'Events, tutors, more', instant:false, scheduled:true },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance', icon:'üöë' },
      { id:'fire',      name:'Fire Service', icon:'üöí' },
      { id:'towing',    name:'Towing', icon:'üöõ' },
      { id:'security',  name:'Security', icon:'üõ°Ô∏è' },
      { id:'roadside',  name:'Roadside', icon:'üîß' },
    ];

    // Marketplace categories and sample products
    const MP_CATEGORIES = [
      { id:'electronics', name:'Electronics' },
      { id:'fashion',     name:'Fashion' },
      { id:'home',        name:'Home & Garden' },
      { id:'sports',      name:'Sports' },
      { id:'automobile',  name:'Automobile' },
      { id:'spares',      name:'Spare Parts' },
      { id:'others',      name:'Others' },
    ];
    let MP_PRODUCTS = [
      { id:'p100', title:'Smartphone X', cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop', seller:'Tony', phone:'+1234567890', whatsapp:'+1234567890', ts:Date.now() },
      { id:'p101', title:'Wireless Earbuds', cat:'electronics', price:59,  stock:34, img:'https://images.unsplash.com/photo-1585386959984-a41552231658?q=80&w=800&auto=format&fit=crop', seller:'Mary', phone:'+234810000001', whatsapp:'+234810000001', ts:Date.now()-1 },
      { id:'p200', title:'Running Shoes', cat:'fashion', price:79,  stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop', seller:'Kelvin', phone:'+233540000002', whatsapp:'+233540000002', ts:Date.now()-2 },
      { id:'p201', title:'Denim Jacket', cat:'fashion', price:69,  stock:9,  img:'https://images.unsplash.com/photo-1542060748-10c28b62716b?q=80&w=800&auto=format&fit=crop', seller:'Anita', phone:'+254710000003', whatsapp:'+254710000003', ts:Date.now()-3 }
    ];

    // Food vendors and menus
    const VENDORS = [
      { id:'v1', name:'Burger Place', kind:'fastfood', payment:['card','cash'], phone:'+12345001', whatsapp:'+12345001' },
      { id:'v2', name:'Pizza Town',  kind:'fastfood', payment:['card'], phone:'+12345002', whatsapp:'+12345002' },
      { id:'v3', name:'Green Grocer', kind:'grocery', payment:['cash'], phone:'+12345003', whatsapp:'+12345003' }
    ];
    const MENUS = {
      v1: [
        { id:'m1', title:'Cheeseburger', price:8.5, img:'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=800&auto=format&fit=crop' },
        { id:'m2', title:'Fries',        price:3.0, img:'https://images.unsplash.com/photo-1541592106381-b31e9677c0e5?q=80&w=800&auto=format&fit=crop' },
        { id:'m3', title:'Soda',         price:2.0, img:'https://images.unsplash.com/photo-1513558161293-cdaf765ed2fd?q=80&w=800&auto=format&fit=crop' }
      ],
      v2: [
        { id:'m4', title:'Pepperoni Pizza', price:12.0, img:'https://images.unsplash.com/photo-1548365328-9f547fb09530?q=80&w=800&auto=format&fit=crop' },
        { id:'m5', title:'Margherita',      price:10.0, img:'https://images.unsplash.com/photo-1541745537413-b804b0c424d6?q=80&w=800&auto=format&fit=crop' }
      ],
      v3: [
        { id:'m6', title:'Bananas (1kg)', price:2.5, img:'https://images.unsplash.com/photo-1571772805064-2073979f0d4a?q=80&w=800&auto=format&fit=crop' },
        { id:'m7', title:'Tomatoes (1kg)', price:3.2, img:'https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=800&auto=format&fit=crop' }
      ]
    };

    // Services render
    function renderServices(){
      const grid = $('servicesGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div><div class="row" style="margin-top:8px">${s.instant?'<span class="pill">Instant</span>':''}${s.scheduled?'<span class="pill">Scheduled</span>':''}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderServicesAll(){
      const grid = $('servicesAllGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderEmergency(){
      const grid = $('emergencyGrid'); grid.innerHTML='';
      EMERGENCY.forEach(e=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div><div class="small muted" style="margin-top:6px">${e.id==='roadside'?'Describe the issue':'Find nearest/available'}</div><div class="row" style="margin-top:8px"><span class="pill">Instant</span></div>`;
        el.onclick = ()=>{ if (e.id==='roadside') openItemsModal('roadside'); else openEmergency(e.id, e.name); };
        grid.appendChild(el);
      });
    }
    function renderRecent(){
      $('recentList').innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>`;
    }
    function renderBookings(){
      $('bookingsList').innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>`;
    }

    // Category open
    function openCategory(catId, label){
      lastCategory = catId;
      if (catId==='transport') {
        openCategoryOptions('Transport Options', [
          { id:'ride',   name:'Ride / Taxi', icon:'üöó' },
          { id:'moving', name:'Truck / Backie', icon:'üöö' },
        ], opt=>{
          $('categoryOptionsModal').classList.remove('open');
          $('providersTitle').textContent = opt.name + ' ‚Äî Providers';
          ensureProvidersSearch(true); // show search
          fetchProviders('transport', opt.id).then(renderProviders);
          $('providersModal').classList.add('open');
        });
        return;
      }
      if (catId==='food') {
        openFoodOptions();
        return;
      }
      $('providersTitle').textContent = label + ' ‚Äî Providers';
      ensureProvidersSearch(true); // show search for other services
      fetchProviders(catId).then(renderProviders);
      $('providersModal').classList.add('open');
    }
    function openCategoryOptions(title, options, onPick){
      $('categoryOptionsTitle').textContent = title;
      $('categoryOptionsList').innerHTML='';
      options.forEach(o=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row" style="justify-content:space-between"><div class="row"><div style="font-size:24px">${o.icon||'‚Ä¢'}</div><div><strong>${o.name}</strong></div></div><button class="btn primary" type="button">Choose</button></div>`;
        el.querySelector('button').onclick=()=>onPick(o);
        $('categoryOptionsList').appendChild(el);
      });
      $('categoryOptionsModal').classList.add('open');
      $('closeCategoryOptions').onclick=()=>$('categoryOptionsModal').classList.remove('open');
    }
    $('closeProviders').onclick = ()=>$('providersModal').classList.remove('open');

    function ensureProvidersSearch(show){
      const wrap=$('providersSearchWrap');
      wrap.style.display = show ? 'block' : 'none';
      $('providersSearchBtn').onclick = ()=>{
        const q = ($('providersSearch').value||'').toLowerCase().trim();
        if (!q) return;
        // Simple local filter of already-rendered list
        Array.from(document.querySelectorAll('#providersList .card')).forEach(card=>{
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(q) ? '' : 'none';
        });
      };
    }

    // Providers
    async function fetchProviders(category, sub=null){
      try{
        const q = new URLSearchParams({ category, sub: sub||'', lat: coords?.lat||'', lng: coords?.lng||'' });
        const r = await fetch(`${BASE_API}/api/providers/nearby?${q.toString()}`);
        if (!r.ok) throw 0; const d = await r.json(); return d.providers||[];
      }catch{
        return [
          { id:'p1', publicName:'Alex M.', jobTitle:'Driver', verified:true, rating:4.8, phone:'+123456789', icon:'üë§', distance:'0.8km', eta:'6-9m', fareMin:120, fareMax:130, currency:'$', available:true },
          { id:'p2', publicName:'Quick Help', jobTitle:'Mechanic', verified:false, rating:4.5, phone:null, icon:'‚ö°', distance:'1.2km', eta:'8-12m', fareMin:10, fareMax:15, currency:'$', available:true }
        ];
      }
    }
    function renderProviders(list){
      const box=$('providersList'); box.innerHTML='';
      if (!list?.length){ box.innerHTML='<div class="small muted">No providers found nearby.</div>'; return; }
      list.forEach(p=>{
        const name = p.publicName || p.name || 'Provider';
        const title= p.jobTitle ? ` ‚Ä¢ ${p.jobTitle}` : '';
        const verified = p.verified ? `<span class="verify">‚úîÔ∏è</span>` : `<span class="small muted">unverified</span>`;
        const rating = p.rating ? ` <span class="rating">‚òÖ ${(+p.rating).toFixed ? (+p.rating).toFixed(1) : p.rating}</span>` : '';
        const avatar = `<div class="avatar">${(p.icon||'üë§')}</div>`;
        const fare = (p.fareMin && p.fareMax) ? `${p.currency||'$'}${p.fareMin}‚Äë${p.fareMax}` : (p.fee||'‚Äî');

        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row" style="align-items:center">
              ${avatar}
              <div>
                <div><strong>${name}</strong> ${verified} ${rating}</div>
                <div class="small muted">${p.distance || '‚Äî'} ‚Ä¢ ETA ${p.eta || '‚Äî'}${title}</div>
                <div class="small"><strong>Est. fare:</strong> ${fare}</div>
              </div>
            </div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="row" style="gap:8px; margin-top:6px">
            <button class="btn primary" data-k="instant" type="button">Instant</button>
            <button class="btn ghost" data-k="schedule" type="button">Schedule</button>
          </div>`;
        el.querySelector('[data-k="instant"]').onclick = ()=> startInstantEntry(p);
        el.querySelector('[data-k="schedule"]').onclick = ()=> openBooking(p);
        box.appendChild(el);
      });
    }

    // Booking (scheduled)
    function openBooking(provider){
      selectedProvider = provider;
      $('bookingModal').classList.add('open');
      $('bookingForm').onsubmit = async (e)=>{
        e.preventDefault();
        const date=$('bkDate').value, time=$('bkTime').value, address=$('bkAddress').value, desc=$('bkDesc').value;
        if (!date||!time||!address) return alert('Fill date, time, address');
        try{
          await fetch(`${BASE_API}/api/requests`,{ method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ type:'scheduled', category:lastCategory||'general', providerId:provider?.id, userPublicName:user.name, date, time, address, details:desc })});
        }catch{}
        $('bookingModal').classList.remove('open');
        alert('Booking requested');
      };
      $('closeBooking').onclick = ()=> $('bookingModal').classList.remove('open');
    }

    // Instant transport
    const tiModal=$('tiModal'), tiPickup=$('tiPickup'), tiDestination=$('tiDestination'), tiStops=$('tiStops');
    let tiStopCount=0;
    $('tiClose').onclick = ()=> tiModal.classList.remove('open');
    $('tiUseCurrent').onclick = async ()=>{ if (coords) { tiPickup.value = await reverseGeocode(coords.lat, coords.lng) || ''; } else { await initLocation(); if (coords) tiPickup.value = await reverseGeocode(coords.lat, coords.lng) || ''; } };
    $('tiAddStop').onclick = ()=>{ if (tiStopCount>=5) return alert('Max 5 stops'); tiStopCount++; const wrap=document.createElement('div'); wrap.className='row'; wrap.innerHTML=`<label class="small" style="min-width:56px">Stop ${tiStopCount}</label><input class="tiStopInput" placeholder="Enter stop ${tiStopCount} address" style="flex:1"/>`; tiStops.appendChild(wrap); };
    $('tiRemoveStop').onclick = ()=>{ if (tiStopCount<=0) return; tiStops.removeChild(tiStops.lastElementChild); tiStopCount--; };

    function startInstantEntry(provider){
      selectedProvider = provider;
      if (lastCategory==='transport'){
        tiModal.classList.add('open');
        $('tiStart').onclick = ()=> startInstantTransport(provider);
      } else startInstant(provider);
    }
    async function startInstantTransport(provider){
      const pickup=(tiPickup.value||'').trim(), destination=(tiDestination.value||'').trim();
      if (!pickup||!destination) return alert('Pickup and Destination are required');
      const stops = Array.from(document.querySelectorAll('.tiStopInput')).map(i=>i.value.trim()).filter(Boolean).slice(0,5);
      startInstantCountdownInit();
      try{
        const r=await fetch(`${BASE_API}/api/requests`,{ method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ type:'instant', category:'transport', providerId:provider.id, userPublicName:user.name, pickup, destination, stops, location:coords?{latitude:coords.lat,longitude:coords.lng}:null })});
        const d=await r.json().catch(()=>({})); requestId=d.requestId||('demo-'+Date.now());
      }catch{ requestId='demo-'+Date.now(); }
      tiModal.classList.remove('open');
      openTrackingPending();
      startInstantCountdown('transport');
    }
    async function startInstant(provider){
      startInstantCountdownInit();
      try{
        const r=await fetch(`${BASE_API}/api/requests`,{ method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ type:'instant', category:lastCategory||'general', providerId:provider.id, userPublicName:user.name, location:coords?{latitude:coords.lat,longitude:coords.lng}:null })});
        const d=await r.json().catch(()=>({})); requestId=d.requestId||('demo-'+Date.now());
      }catch{ requestId='demo-'+Date.now(); }
      openTrackingPending();
      startInstantCountdown(lastCategory||'general');
    }
    function startInstantCountdownInit(){ instantLeft=90; $('countdown').textContent=String(instantLeft); $('instantHint').textContent='Waiting for provider to accept‚Ä¶'; $('instantModal').classList.add('open'); }
    function stopInstant(){ if (instantTimer) clearInterval(instantTimer); instantTimer=null; }
    async function getRequestStatus(id){
      try{ const r=await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}`); if(!r.ok) throw 0; const d=await r.json(); return d.status||'pending'; }
      catch{ return (instantLeft<78)?'accepted':'pending'; }
    }
    function startInstantCountdown(category){
      $('instantClose').onclick = ()=>{ $('instantModal').classList.remove('open'); };
      $('cancelInstant').onclick = (e)=>{ e.preventDefault(); openCancelReasons(); };
      $('findOthers').onclick = ()=>{ $('instantModal').classList.remove('open'); $('providersModal').classList.add('open'); };
      instantTimer=setInterval(async ()=>{
        instantLeft-=1; $('countdown').textContent=String(instantLeft);
        if (instantLeft%3===0){
          const status=await getRequestStatus(requestId);
          if (status==='accepted'){ stopInstant(); openTracking(); return; }
          if (status==='rejected'){ stopInstant(); alert('Provider rejected.'); $('instantModal').classList.remove('open'); return; }
        }
        if (instantLeft<=0){ stopInstant(); alert('No response. Try others.'); $('instantModal').classList.remove('open'); }
      },1000);
    }
    function openTrackingPending(){ $('instantModal').classList.remove('open'); $('trackModal').classList.add('open'); setTimeout(initMap,50); $('trackStatus').textContent='Waiting for provider to accept‚Ä¶'; }
    function openTracking(){ $('instantModal').classList.remove('open'); $('trackModal').classList.add('open'); setTimeout(initMap,50); startTracking(); }
    function initMap(){
      if (!map){ map=L.map('track-map',{zoomControl:true}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM' }).addTo(map); }
      const userLatLng = coords ? [coords.lat, coords.lng] : [0,0];
      map.setView(userLatLng, 14); if (userMarker) userMarker.remove(); userMarker=L.marker(userLatLng,{title:'You'}).addTo(map); if (providerMarker) providerMarker.remove();
    }
    function startTracking(){
      if (trackPoll) clearInterval(trackPoll);
      trackPoll=setInterval(async ()=>{
        const pos=await getProviderPosition(requestId); if (!pos) return;
        const latlng=[pos.lat,pos.lng]; if (!providerMarker) providerMarker=L.marker(latlng,{title:'Provider',icon: L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map);
        else providerMarker.setLatLng(latlng);
        $('trackStatus').textContent = `Provider en route ‚Ä¢ ${pos.eta || 'ETA ‚Äî'}`;
      },3000);
    }
    async function getProviderPosition(id){
      try{ const r=await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}/position`); if(!r.ok) throw 0; const d=await r.json(); return {lat:d.provider?.lat,lng:d.provider?.lng,eta:d.eta}; }
      catch{ const base=coords?{lat:coords.lat+(Math.random()-0.5)/100,lng:coords.lng+(Math.random()-0.5)/100}:{lat:0,lng:0}; return {lat:base.lat,lng:base.lng,eta:'8 min'}; }
    }
    $('closeTrack').onclick = ()=>{ if (trackPoll) clearInterval(trackPoll); $('trackModal').classList.remove('open'); };

    // Cancel request
    $('trackCancelBtn').onclick = ()=> openCancelReasons();
    function openCancelReasons() {
      const modal = $('cancelReasonsModal'), crList=$('crList'); modal.classList.add('open'); crList.innerHTML='';
      ['Changed my mind','Wait is too long','Found another provider','Wrong service','Other'].forEach((r,i)=>{
        const row=document.createElement('label'); row.className='row';
        row.innerHTML = `<input type="radio" name="cr" value="${r}" ${i===0?'checked':''}/> <span>${r}</span>`;
        crList.appendChild(row);
      });
      const other = document.createElement('input');
      other.id = 'crOther'; other.placeholder = 'If Other, describe‚Ä¶'; other.style.cssText='width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin-top:6px';
      crList.appendChild(other);
      $('crClose').onclick = ()=> modal.classList.remove('open');
      $('crBack').onclick  = ()=> modal.classList.remove('open');
      $('crConfirm').onclick = async ()=> {
        const picked = document.querySelector('input[name="cr"]:checked')?.value || 'Other';
        const reason = picked === 'Other' ? (other.value.trim()||'Other') : picked;
        try { if (requestId) await fetch(`${BASE_API}/api/requests/${encodeURIComponent(requestId)}?reason=${encodeURIComponent(reason)}`, { method:'DELETE' }); } catch {}
        if (trackPoll) clearInterval(trackPoll); requestId=null; instantLeft=0; stopInstant();
        providerMarker && providerMarker.remove(); providerMarker = null;
        $('cancelReasonsModal').classList.remove('open');
        $('instantModal').classList.remove('open');
        $('trackModal').classList.remove('open');
        showPage('services');
        alert('Request cancelled');
      };
    }

    // Search + voice
    $('voiceBtn').onclick = ()=> voiceToInput($('search'), ()=>runHomeSearch());
    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{ const text=e.results[0][0].transcript||''; inputEl.value=text; onResult&&onResult(text); };
      rec.start();
    }
    $('searchBtn').onclick = runHomeSearch;
    function runHomeSearch(){
      const q = ($('search').value||'').trim().toLowerCase(); if (!q) return;
      if (/(ride|taxi|cab|uber|bolt)/.test(q)) return openCategory('transport','Transport');
      if (/(truck|backie|moving|load)/.test(q)) {
        openCategoryOptions('Transport Options',[{id:'moving',name:'Truck / Backie',icon:'üöö'}],o=>{
          $('categoryOptionsModal').classList.remove('open');
          $('providersTitle').textContent = o.name + ' ‚Äî Providers';
          ensureProvidersSearch(true);
          fetchProviders('transport','moving').then(renderProviders);
          $('providersModal').classList.add('open');
        });
        return;
      }
      if (/(food|pizza|burger|fries|chicken|drinks)/.test(q)) return openCategory('food','Food');
      if (/(grocery|milk|bread|eggs|rice|fruit|vegetable|vegetables)/.test(q)) return openCategory('food','Food');
      if (/(ambulance|medical)/.test(q)) return openEmergency('ambulance','Ambulance');
      if (/(fire)/.test(q)) return openEmergency('fire','Fire Service');
      if (/(towing|tow)/.test(q)) return openEmergency('towing','Towing');
      if (/(security|police)/.test(q)) return openEmergency('security','Security');
      $('providersTitle').textContent = q + ' ‚Äî Providers';
      ensureProvidersSearch(true);
      fetchProviders('search', q).then(renderProviders);
      $('providersModal').classList.add('open');
    }

    async function openEmergency(emId, label){
      $('providersTitle').textContent = label + ' ‚Äî Nearest';
      const showSearch = !['ambulance','fire','towing','security','transport'].includes(emId);
      ensureProvidersSearch(showSearch);
      const list = await fetchProviders('emergency', emId);
      renderProviders(list);
      $('providersModal').classList.add('open');
    }

    // Items modal (roadside and others)
    function openItemsModal(kind){
      $('itemsTitle').textContent = 'Find ' + (kind==='roadside'?'Roadside Help':'Service');
      const chipsMap = {
        roadside:['flat tire','jumpstart','fuel','lockout','tow'],
        home:['electrician','plumber','cleaning','gardening','painting','carpentry','ac repair'],
        tech:['phone repair','computer','tv repair','software','cctv','network'],
        auto:['mechanic','tires','battery','car wash','towing'],
        construction:['builder','welder','bricklayer','laborer','mason','roofer','scaffolding'],
        others:['events','tutor','legal','photography','translator','driver hire'],
      };
      const wrap=$('itemChips'); wrap.innerHTML='';
      (chipsMap[kind]||chipsMap.others).forEach(text=>{
        const b=document.createElement('button'); b.className='btn ghost'; b.type='button'; b.textContent=text;
        b.onclick=()=>{ $('itemSearch').value=text; $('itemGo').click(); };
        wrap.appendChild(b);
      });
      $('itemsModal').classList.add('open');
      $('closeItems').onclick=()=>$('itemsModal').classList.remove('open');
      $('itemVoice').onclick = ()=> voiceToInput($('itemSearch'), ()=>$('itemGo').click());
      $('itemGo').onclick = async ()=>{
        const q = ($('itemSearch').value||'').trim().toLowerCase();
        $('itemsModal').classList.remove('open');
        $('providersTitle').textContent = (q||'Results') + ' ‚Äî Providers';
        ensureProvidersSearch(true);
        const list = await fetchProviders(kind, q||kind);
        renderProviders(list);
        $('providersModal').classList.add('open');
      };
    }

    // Marketplace
    $('mpVoice').onclick = ()=> voiceToInput($('mpSearch'), ()=> runMarketplaceSearch());
    $('mpSearchBtn').onclick = runMarketplaceSearch;
    function initMarketplace(){
      $('mpChips').innerHTML='';
      MP_CATEGORIES.forEach(c=>{
        const b=document.createElement('button'); b.className='btn ghost'; b.type='button'; b.textContent=c.name;
        b.onclick=()=> renderMarketplace(c.id, $('mpSearch').value.trim().toLowerCase());
        $('mpChips').appendChild(b);
      });
      renderMarketplace();
    }
    function runMarketplaceSearch(){ renderMarketplace(null, $('mpSearch').value.trim().toLowerCase()); }
    function getUserListings(){ try { return JSON.parse(localStorage.getItem('zup_market_listings')||'[]'); } catch { return []; } }
    function setUserListings(arr){ localStorage.setItem('zup_market_listings', JSON.stringify(arr||[])); }
    function renderMarketplace(category=null, query=''){
      const grid=$('mpGrid'); grid.innerHTML='';
      let userListings=getUserListings();
      let list = MP_PRODUCTS.concat(userListings).sort((a,b)=>(b.ts||0)-(a.ts||0));
      if (category) list = list.filter(p=>p.cat===category);
      if (query) list = list.filter(p=>(p.title||'').toLowerCase().includes(query)||(p.cat||'').includes(query));
      if (!list.length){ grid.innerHTML='<div class="small muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card product';
        el.innerHTML=`<img src="${p.img}" alt="${p.title}"/><div><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between"><div class="price">$${Number(p.price).toFixed(2)}</div><div class="small muted">${p.seller?('Seller: '+p.seller):''}</div></div>
          <div class="row" style="gap:8px;margin-top:6px">
            ${p.user?'<button class="btn ghost" data-k="edit">Edit</button><button class="btn ghost" data-k="renew">Renew</button>':'<button class="btn primary" data-k="chat">üí¨ Chat</button><button class="btn ghost" data-k="call">üìû</button><button class="btn ghost" data-k="wa">üü¢</button>'}
          </div>`;
        const btns=el.querySelectorAll('button');
        if (p.user){
          btns[0].onclick = ()=> editListing(p.id);
          btns[1].onclick = ()=> renewListing(p.id);
        } else {
          btns[0].onclick = ()=> alert('In‚Äëapp chat coming soon.');
          btns[1].onclick = ()=> location.href = `tel:${encodeURIComponent(p.phone||'')}`;
          btns[2].onclick   = ()=> location.href = `https://wa.me/${encodeURIComponent((p.whatsapp||'').replace(/\D/g,''))}`;
        }
        grid.appendChild(el);
      });
    }
    function saveMarketplaceListing(){
      const cat=$('sellCat').value, type=($('sellType').value||'').trim(), title=($('sellTitle').value||'').trim(), price=Number($('sellPrice').value||0), stock=Number($('sellStock').value||0), desc=$('sellDesc').value||'';
      if (!title || !price) return alert('Title and price required');
      const files=Array.from(($('sellImages').files||[])).slice(0,10);
      const images=[]; if (!files.length){ commit(); } else {
        let left=files.length;
        files.forEach(f=>{ const fr=new FileReader(); fr.onload=()=>{ images.push(fr.result); if(--left===0) commit(); }; fr.readAsDataURL(f); });
      }
      function commit(){
        const me = auth.currentUser?.email || 'me';
        const arr=getUserListings();
        const id='ml'+Date.now();
        const img=images[0] || 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=800&auto=format&fit=crop';
        arr.push({ id, title, cat, type, price, stock, desc, img, images, user:true, seller:me, ts:Date.now() });
        setUserListings(arr);
        $('sellModal').classList.remove('open');
        renderMarketplace();
        alert('Listing saved');
      }
    }
    function editListing(id){
      const arr=getUserListings(); const item=arr.find(x=>x.id===id); if(!item) return;
      $('sellModal').classList.add('open');
      $('sellCat').value=item.cat||'others';
      $('sellType').value=item.type||'';
      $('sellTitle').value=item.title||'';
      $('sellPrice').value=item.price||0;
      $('sellStock').value=item.stock||0;
      $('sellDesc').value=item.desc||'';
      $('sellImages').value='';
      $('sellSave').onclick = ()=>{
        item.cat=$('sellCat').value; item.type=$('sellType').value.trim(); item.title=$('sellTitle').value.trim(); item.price=Number($('sellPrice').value||0); item.stock=Number($('sellStock').value||0); item.desc=$('sellDesc').value||'';
        const files=Array.from(($('sellImages').files||[])).slice(0,10);
        if (files.length){
          let left=files.length, images=[];
          files.forEach(f=>{ const fr=new FileReader(); fr.onload=()=>{ images.push(fr.result); if(--left===0){ item.images=images; item.img=images[0]||item.img; finalize(); } }; fr.readAsDataURL(f); });
        } else finalize();
        function finalize(){ setUserListings(arr); $('sellModal').classList.remove('open'); renderMarketplace(); alert('Listing updated'); }
      };
    }
    function renewListing(id){
      const arr=getUserListings(); const item=arr.find(x=>x.id===id); if(!item) return;
      item.ts=Date.now(); setUserListings(arr); renderMarketplace(); alert('Listing renewed');
    }

    // Manage Products renamed to Food Menu (vendors)
    $('manageFoodMenuBtn').onclick = ()=>{ showPage('manage-food'); renderFoodMenuManage(); };
    function getFoodMenu(){ try { return JSON.parse(localStorage.getItem('zup_food_menu')||'[]'); } catch { return []; } }
    function setFoodMenu(arr){ localStorage.setItem('zup_food_menu', JSON.stringify(arr||[])); }
    $('fmAddItem').onclick = addFoodItemRow;
    function addFoodItemRow(pref){
      const wrap=$('fmItems');
      const idx = Date.now();
      const row=document.createElement('div'); row.className='card'; row.dataset.idx=idx;
      row.innerHTML = `
        <div class="grid-2">
          <div class="field"><label class="small">Title</label><input data-f="title" value="${pref?.title||''}"/></div>
          <div class="field"><label class="small">Price</label><input data-f="price" type="number" min="0" step="0.01" value="${pref?.price||''}"/></div>
        </div>
        <div class="field"><label class="small">Description</label><textarea data-f="desc" rows="2">${pref?.desc||''}</textarea></div>
        <div class="field"><label class="small">Images (up to 5)</label><input data-f="images" type="file" accept="image/*" multiple/></div>
        <div class="row" style="gap:8px;justify-content:flex-end"><button class="btn ghost" data-k="remove" type="button">Remove</button></div>`;
      row.querySelector('[data-k="remove"]').onclick = ()=> row.remove();
      wrap.appendChild(row);
    }
    $('fmSaveAll').onclick = ()=>{
      const entries = Array.from(document.querySelectorAll('#fmItems .card')).map(row=>{
        return new Promise(res=>{
          const title=row.querySelector('[data-f="title"]').value.trim();
          const price=Number(row.querySelector('[data-f="price"]').value||0);
          const desc =row.querySelector('[data-f="desc"]').value||'';
          const files=Array.from((row.querySelector('[data-f="images"]').files||[])).slice(0,5);
          if (!title || !price){ res(null); return; }
          if (!files.length){ res({ title, price, desc, images:[] }); }
          else {
            let left=files.length, images=[];
            files.forEach(f=>{ const fr=new FileReader(); fr.onload=()=>{ images.push(fr.result); if(--left===0) res({ title, price, desc, images }); }; fr.readAsDataURL(f); });
          }
        });
      });
      Promise.all(entries).then(items=>{
        const keep = items.filter(Boolean).map((x,i)=>({ id:'fm'+(Date.now()+i), ...x, kind: $('fmKind').value, payment: ['card',$('fmPayCard').checked], payment2:['cash',$('fmPayCash').checked] }));
        const payFilter = (p)=>(p[1]===true);
        keep.forEach(x=> x.payment = [x.payment, x.payment2].filter(payFilter).map(p=>p[0]));
        const all = getFoodMenu().concat(keep);
        setFoodMenu(all);
        $('fmItems').innerHTML='';
        renderFoodMenuManage();
        alert('Menu saved');
      });
    };
    function renderFoodMenuManage(){
      const box=$('fmList'); box.innerHTML='';
      const list=getFoodMenu();
      if (!list.length){ box.innerHTML='<div class="small muted">No food items yet.</div>'; return; }
      list.forEach(it=>{
        const el=document.createElement('div'); el.className='card';
        const imgs=(it.images||[]).map(src=>`<img src="${src}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/>`).join('');
        el.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>${it.title}</strong> <span class="small muted">[${it.kind}]</span></div><div class="small muted">${it.desc||''}</div><div class="small">Price: $${Number(it.price).toFixed(2)} ‚Ä¢ Pay: ${(it.payment||[]).join(', ')||'‚Äî'}</div></div>
          <div class="row"><button class="btn ghost" data-k="edit">Edit</button><button class="btn ghost" data-k="del">Delete</button></div>
        </div>
        <div class="row" style="gap:6px;flex-wrap:wrap;margin-top:6px">${imgs||'<span class="small muted">No images</span>'}</div>`;
        const [editBtn, delBtn]=el.querySelectorAll('button');
        editBtn.onclick=()=>{ addFoodItemRow(it); };
        delBtn.onclick=()=>{ const rest=getFoodMenu().filter(x=>x!==it); setFoodMenu(rest); renderFoodMenuManage(); };
        box.appendChild(el);
      });
    }

    // Emergency contacts
    $('ecSave').onclick = ()=>{
      const arr=[]; for(let i=0;i<5;i++){ const name=$('ecName'+i).value.trim(), phone=$('ecPhone'+i).value.trim(); if (name||phone) arr.push({name,phone}); }
      localStorage.setItem('zup_contacts', JSON.stringify(arr)); alert('Contacts saved');
    };
    function loadContactsForm(){
      const wrap=$('ecForm'); wrap.innerHTML='';
      const saved=loadContacts();
      for (let i=0;i<5;i++){
        const row=document.createElement('div'); row.className='grid-2';
        row.innerHTML=`<div class="field"><label class="small">Name ${i+1}</label><input id="ecName${i}" value="${saved[i]?.name||''}"/></div>
                       <div class="field"><label class="small">Phone ${i+1}</label><input id="ecPhone${i}" value="${saved[i]?.phone||''}"/></div>`;
        wrap.appendChild(row);
      }
    }
    function loadContacts(){ try { return JSON.parse(localStorage.getItem('zup_contacts')||'[]'); } catch { return []; } }

    // Support stub
    function wireSupport(){}

    // Food flow
    function openFoodOptions(){ $('foodOptionsModal').classList.add('open'); }
    $('closeFoodOptions').onclick = ()=> $('foodOptionsModal').classList.remove('open');
    $('foodFastBtn').onclick = ()=>{ $('foodOptionsModal').classList.remove('open'); openFoodVendorsFiltered('fastfood'); };
    $('foodGroceryBtn').onclick = ()=>{ $('foodOptionsModal').classList.remove('open'); openFoodVendorsFiltered('grocery'); };
    $('foodSearchBtn').onclick = ()=>{
      const q = ( $('foodSearch')?.value || '' ).toLowerCase().trim();
      $('foodOptionsModal').classList.remove('open');
      openFoodVendorsSearch(q);
    };

    function wireFoodFlow(){
      $('closeFoodVendors').onclick = ()=> $('foodVendorsModal').classList.remove('open');
      $('closeFoodMenu').onclick = ()=> $('foodMenuModal').classList.remove('open');
      $('foodCheckoutBtn').onclick = ()=> openCheckout();
    }
    function openFoodVendorsFiltered(kind){
      renderVendorsList((VENDORS||[]).filter(v=>v.kind===kind));
    }
    function openFoodVendorsSearch(q){
      const inVendors = VENDORS.filter(v=>v.name.toLowerCase().includes(q));
      const inMenusVendorIds = Object.keys(MENUS).filter(vid => (MENUS[vid]||[]).some(m=>m.title.toLowerCase().includes(q)));
      const keep = new Set(inVendors.map(v=>v.id).concat(inMenusVendorIds));
      renderVendorsList(VENDORS.filter(v=>keep.has(v.id)));
    }
    function openFoodVendors(){
      renderVendorsList(VENDORS);
    }
    function renderVendorsList(list){
      const box=$('foodVendorsList'); box.innerHTML='';
      (list && list.length ? list : VENDORS).forEach(v=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>${v.name}</strong></div><div class="small muted">${v.kind==='fastfood'?'Fast food':'Grocery'} ‚Ä¢ Payments: ${v.payment.join(', ')}</div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="menu">View Menu</button><button class="btn ghost" data-k="call">üìû</button><button class="btn ghost" data-k="wa">üü¢</button></div>
        </div>`;
        el.querySelector('[data-k="menu"]').onclick = ()=> openFoodMenu(v);
        el.querySelector('[data-k="call"]').onclick = ()=> location.href=`tel:${encodeURIComponent(v.phone||'')}`;
        el.querySelector('[data-k="wa"]').onclick   = ()=> location.href=`https://wa.me/${encodeURIComponent((v.whatsapp||'').replace(/\D/g,''))}`;
        box.appendChild(el);
      });
      $('foodVendorsTitle').textContent='Food Vendors';
      $('foodVendorsModal').classList.add('open');
    }
    function openFoodMenu(vendor){
      if (cart.vendorId && cart.vendorId !== vendor.id) {
        if (!confirm(`Your cart has items from ${cart.vendorName}. Clear cart to order from ${vendor.name}?`)) return;
        resetCart();
      }
      if (!cart.vendorId){ cart.vendorId=vendor.id; cart.vendorName=vendor.name; cart.vendorPayment=vendor.payment.slice(); saveCart(); }
      $('foodVendorsModal').classList.remove('open');
      $('foodMenuTitle').textContent = `${vendor.name} ‚Äî Menu`;
      const list=$('foodMenuList'); list.innerHTML='';
      const menu = MENUS[vendor.id] || [];
      menu.forEach(m=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${m.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${m.title}</strong><div class="small muted">$${m.price.toFixed(2)}</div></div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="add">Ôºã Add</button></div>
        </div>`;
        row.querySelector('[data-k="add"]').onclick = ()=>{
          const i=cart.items.findIndex(x=>x.id===m.id);
          if (i>=0) cart.items[i].qty+=1; else cart.items.push({ id:m.id, title:m.title, price:m.price, img:m.img, qty:1 });
          saveCart(); syncFoodTotals(); window.updateBellBadge && updateBellBadge();
        };
        list.appendChild(row);
      });
      syncFoodTotals();
      $('foodMenuModal').classList.add('open');
    }
    function syncFoodTotals(){
      const total=cart.items.reduce((a,b)=>a+b.price*b.qty,0);
      $('foodCartTotal').textContent=total.toFixed(2);
    }

    // Cart modal (Food/Grocery)
    function renderCart(){
      const list=$('cartList'); const totalEl=$('cartTotal'); list.innerHTML='';
      if(!cart.items.length){ list.innerHTML='<div class="small muted">Your cart is empty.</div>'; totalEl.textContent='0.00'; return; }
      let total=0;
      cart.items.forEach(item=>{
        total+=item.price*item.qty;
        const row=document.createElement('div'); row.className='card'; row.dataset.id=item.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between; align-items:flex-start">
          <div class="row"><img src="${item.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${item.title}</strong><div class="small muted">$${item.price.toFixed(2)}</div><div class="small muted">Vendor: ${cart.vendorName||'-'}</div></div></div>
          <div class="row" style="gap:6px; align-items:center">
            <button class="btn ghost" data-k="dec" type="button">‚àí</button>
            <div>${item.qty}</div>
            <button class="btn ghost" data-k="inc" type="button">Ôºã</button>
            <button class="btn ghost" data-k="rm"  type="button">‚úñ</button>
          </div>
        </div>`;
        list.appendChild(row);
      });
      totalEl.textContent=total.toFixed(2);

      list.onclick = (e)=>{
        const btn=e.target.closest('[data-k]'); if(!btn) return;
        const id=btn.closest('.card')?.dataset?.id; const k=btn.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if (i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); } else saveCart();
        renderCart(); window.updateBellBadge && updateBellBadge();
      };
    }

    // Checkout open
    function openCheckout(){
      if (!cart.items.length) { alert('Your cart is empty.'); return; }
      const wrap=$('chkItemsList'); wrap.innerHTML='';
      cart.items.forEach(it=>{
        const row=document.createElement('div'); row.className='card'; row.dataset.id=it.id;
        row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div class="row"><img src="${it.img||''}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${it.title}</strong><div class="small muted">$${it.price.toFixed(2)}</div></div></div>
          <div class="row"><button class="btn ghost" data-k="dec">‚àí</button><div>${it.qty}</div><button class="btn ghost" data-k="inc">Ôºã</button><button class="btn ghost" data-k="rm">‚úñ</button></div>
        </div>`;
        wrap.appendChild(row);
      });
      wrap.onclick=(e)=>{
        const b=e.target.closest('[data-k]'); if(!b) return;
        const id=b.closest('.card')?.dataset?.id; const k=b.getAttribute('data-k');
        const i=cart.items.findIndex(x=>x.id===id); if(i<0) return;
        if (k==='dec') cart.items[i].qty=Math.max(1,cart.items[i].qty-1);
        if (k==='inc') cart.items[i].qty=cart.items[i].qty+1;
        if (k==='rm')  cart.items.splice(i,1);
        if (!cart.items.length) { resetCart(); $('checkoutModal').classList.remove('open'); return; }
        saveCart(); openCheckout();
      };
      $('vendorPayHint').textContent = `Vendor accepts: ${cart.vendorPayment.join(', ') || '‚Äî'}`;
      $('checkoutModal').classList.add('open');
    }

    // Place order (Food)
    $('placeOrderBtn').onclick = async ()=>{
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      const name=$('chkName').value.trim(), phone=$('chkPhone').value.trim(), address=$('chkAddress').value.trim(), unit=($('chkUnit').value||'').trim(), notes=($('chkNotes').value||'').trim();
      if (!cart.items.length) return alert('Cart is empty');
      if (!$('chkTerms').checked) return alert('Please accept the Terms');
      if (!address) return alert('Enter delivery address');
      if (!name||!phone) return alert('Enter name and phone');
      if (cart.vendorPayment.length && !cart.vendorPayment.includes(method)) {
        return alert(`This vendor does not accept ${method.toUpperCase()} payment. Allowed: ${cart.vendorPayment.join(', ')}`);
      }
      const payload = { vendorId: cart.vendorId, vendorName: cart.vendorName, items: cart.items.map(i=>({id:i.id,title:i.title,qty:i.qty,price:i.price})), name, phone, address, unit, notes, category:'food' };
      if (method==='card'){
        try{
          const r=await fetch(`${BASE_API}/api/payments/checkout-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,successUrl:location.origin+'/?checkout=success',cancelUrl:location.origin+'/?checkout=cancel'})});
          const d=await r.json().catch(()=>({}));
          if (d?.url){ saveLastOrder({ orderId: d.orderId||('ord-'+Date.now()), code: genCode(), status:'pending', vendorName: cart.vendorName }); resetCart(); window.updateBellBadge&&updateBellBadge(); return location.href=d.url; }
          if ((d?.id||d?.sessionId) && window.Stripe){ const stripe=window.Stripe(STRIPE_PK); saveLastOrder({ orderId: d.orderId||('ord-'+Date.now()), code: genCode(), status:'pending', vendorName: cart.vendorName }); resetCart(); window.updateBellBadge&&updateBellBadge(); await stripe.redirectToCheckout({sessionId: d.id||d.sessionId}); return; }
          alert('Payment session error. Try Cash.');
        }catch{ alert('Payment session error. Try Cash.'); }
      } else {
        let orderId='ord-'+Date.now(), code=genCode();
        try{
          const r2=await fetch(`${BASE_API}/api/marketplace/orders`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,paymentMethod:'cash'})});
          const d2=await r2.json().catch(()=>({})); orderId=d2.orderId||orderId; code=d2.deliveryCode||code;
        }catch{}
        $('checkoutModal').classList.remove('open');
        showOrderStatus(orderId, code, 'cash', cart.vendorName);
        saveLastOrder({ orderId, code, status:'pending', vendorName: cart.vendorName });
        resetCart(); window.updateBellBadge&&updateBellBadge();
      }
    };
    function genCode(){ return String(Math.floor(100000+Math.random()*900000)); }
    function showOrderStatus(orderId, code, method, vendorName){
      $('orderInfo').innerHTML = `<div class="card">
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div style="margin-top:6px"><strong>Status:</strong> <span id="ordStatus">pending</span></div>
        <div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div>
        <div class="small muted" style="margin-top:6px">Please don't share this code with the seller until your goods are delivered and confirmed.</div>
        <div class="small muted" style="margin-top:6px">${method==='card'?'Funds are held until code entry.':'Cash selected: code marks delivered.'}</div>
        <div class="small muted" style="margin-top:6px">Vendor: ${vendorName||'-'}</div>
      </div>`;
      $('orderModal').classList.add('open');
      const ord=$('ordStatus'); let t=0; const poll=setInterval(async()=>{ t+=3; let s; try{ const r=await fetch(`${BASE_API}/api/marketplace/orders/${encodeURIComponent(orderId)}`); const d=await r.json().catch(()=>({})); s=d.status; }catch{ if (t>=6&&t<12) s='accepted'; else if (t>=12&&t<18) s='out_for_delivery'; else if (t>=18) s='delivered'; else s='pending'; } ord.textContent=s||'pending'; if (s==='delivered'||t>=24) clearInterval(poll); },3000);
    }

    // Orders
    function saveLastOrder(o){ localStorage.setItem('zup_last_order', JSON.stringify(o||{})); addOrderRecord(o); }
    function getLastOrder(){ try{ return JSON.parse(localStorage.getItem('zup_last_order')||'{}'); }catch{return{}} }
    function addOrderRecord(o){
      try{
        const me = auth.currentUser?.email || 'me';
        const all = JSON.parse(localStorage.getItem('zup_orders')||'[]');
        all.push({ ...o, buyer: me, seller: o.vendorName||'Vendor', ts: Date.now() });
        localStorage.setItem('zup_orders', JSON.stringify(all));
      }catch{}
    }
    function loadOrders(){ try{ return JSON.parse(localStorage.getItem('zup_orders')||'[]'); }catch{return[]} }
    function renderOrders(){
      const me = auth.currentUser?.email || 'me';
      const all = loadOrders();
      const buyerList = all.filter(x=>x.buyer===me);
      const sellerList = all.filter(x=>x.seller && x.seller!==me);

      const buyerBox=$('buyerOrders'); buyerBox.innerHTML='';
      if (!buyerList.length) buyerBox.innerHTML='<div class="small muted">No orders.</div>';
      buyerList.forEach(o=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>${o.vendorName||'Vendor'}</strong> ‚Ä¢ <span class="small muted">Order: ${o.orderId||'-'}</span></div>
          <div class="small">Code: <span style="font-family:monospace">${o.code||'-'}</span></div>
          <div class="small muted">${new Date(o.ts||Date.now()).toLocaleString()}</div></div>
          <div class="row" style="gap:6px"><button class="btn ghost" data-k="view">View</button></div>
        </div>`;
        row.querySelector('[data-k="view"]').onclick = ()=>{
          const box=$('lastOrderInfo');
          box.innerHTML = `<div><strong>Order ID:</strong> ${o.orderId||'-'}</div><div><strong>Delivery code:</strong> <span style="font-family:monospace">${o.code||'-'}</span></div><div class="small muted" style="margin-top:6px">Please don't share this code with the seller until your goods are delivered and confirmed.</div>`;
          $('lastOrderModal').classList.add('open');
        };
        buyerBox.appendChild(row);
      });

      const sellerBox=$('sellerOrders'); sellerBox.innerHTML='';
      if (!sellerList.length) sellerBox.innerHTML='<div class="small muted">No orders for seller.</div>';
      sellerList.forEach(o=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`<div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><div><strong>Order:</strong> ${o.orderId||'-'}</div><div class="small muted">${new Date(o.ts||Date.now()).toLocaleString()}</div></div>
          <div class="row" style="gap:6px"><button class="btn primary" data-k="confirm">Confirm Delivery</button></div>
        </div>`;
        row.querySelector('[data-k="confirm"]').onclick = ()=> $('confirmDeliveryModal').classList.add('open');
        sellerBox.appendChild(row);
      });

      $('confirmSubmit').onclick = ()=>{
        const code=($('confirmCode').value||'').trim();
        if (!code) return alert('Enter the code');
        const last=getLastOrder();
        if (String(last.code||'') === code) {
          localStorage.setItem('zup_last_order', JSON.stringify({ ...last, status:'delivered', code:null }));
          $('confirmStatus').textContent='Delivery confirmed. Payment will be released.';
          setTimeout(()=>{ $('confirmDeliveryModal').classList.remove('open'); }, 800);
        } else {
          $('confirmStatus').textContent='Incorrect code.';
        }
      };
      $('sendCodeSMS').onclick = ()=>{
        const last=getLastOrder(); if (!last?.code) return alert('No code found.');
        const phone = prompt('Enter phone number to send the code to:'); if (!phone) return;
        const msg = `ZippUp code for Order ${last.orderId||''}: ${last.code}. Do NOT share until delivered.`;
        location.href = `sms:${encodeURIComponent(phone)}?body=${encodeURIComponent(msg)}`;
      };
    }

    // Auth gate
    function setUserUI(u){ const name=(u?.displayName || u?.email || 'Guest'); user.name=name; $('userName').textContent=name; $('profName').textContent=name; document.getElementById('authGate')?.remove(); }
    function ensureGate(){
      let gate=document.getElementById('authGate');
      if (!gate) {
        gate=document.createElement('div');
        gate.id='authGate';
        gate.style.cssText='position:fixed;inset:0;background:#fff;z-index:10000;display:flex;align-items:center;justify-content:center;padding:16px';
        gate.innerHTML=`
          <div style="width:100%;max-width:420px;border:1px solid #E5E7EB;border-radius:12px;box-shadow:0 8px 24px rgba(17,24,39,.08);padding:16px;background:#fff">
            <div class="list">
              <div style="text-align:center;margin-bottom:10px">
                <div style="font-weight:800;font-size:18px">ZippUp: Hustle faster!</div>
                <div style="font-size:13px;color:#475569;margin-top:4px">One stop to your OnDemand services.</div>
              </div>
              <div class="field"><label class="small">Email</label><input id="lgEmail" type="email"/></div>
              <div class="field"><label class="small">Password</label><input id="lgPassword" type="password"/></div>
              <div class="row" style="gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px">
                <button class="btn primary" id="lgSignIn" type="button">Sign in</button>
                <button class="btn ghost" id="lgSignUp" type="button">Sign up</button>
                <button class="btn ghost" id="lgGoogle" type="button">Google</button>
              </div>
              <div class="small" style="text-align:center;margin-top:10px">Forgot password? <a href="#" id="lgReset">Reset</a></div>
            </div>
          </div>`;
        document.body.appendChild(gate);
      }
      gate.style.display='flex';
      wireGateHandlers();
    }
    function wireGateHandlers(){
      const e=$('lgEmail'), p=$('lgPassword'), si=$('lgSignIn'), su=$('lgSignUp'), gg=$('lgGoogle'), rs=$('lgReset');
      if (si && !si.dataset.bound){ si.dataset.bound='1'; si.onclick=async()=>{ const email=e.value.trim(), pw=p.value.trim(); if(!email||!pw) return alert('Enter email and password'); try{ await auth.signInWithEmailAndPassword(email,pw); }catch(err){ alert(err.message||'Sign in failed'); } }; }
      if (su && !su.dataset.bound){ su.dataset.bound='1'; su.onclick=async()=>{ const email=e.value.trim(), pw=p.value.trim(); if(!email||!pw) return alert('Enter email and password'); try{ await auth.createUserWithEmailAndPassword(email,pw); alert('Account created. Check your email to verify.'); }catch(err){ alert(err.message||'Sign up failed'); } }; }
      if (gg && !gg.dataset.bound){ gg.dataset.bound='1'; gg.onclick=async()=>{ try{ await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }catch(err){ alert(err.message||'Google sign in failed'); } }; }
      if (rs && !rs.dataset.bound){ rs.dataset.bound='1'; rs.onclick=async(ev)=>{ ev.preventDefault(); const email=e.value.trim(); if(!email) return alert('Enter your email'); try{ await auth.sendPasswordResetEmail(email); alert('Password reset email sent'); }catch(err){ alert(err.message||'Reset failed'); } }; }
    }
    auth.onAuthStateChanged((u)=>{ if (u) setUserUI(u); else ensureGate(); });

    // Profile edit
    function updateProfileUI(){
      $('userName').textContent=(user?.name||'Guest');
      $('profName').textContent=(user?.name||'Demo User');
      const saved=localStorage.getItem('zup_profile_photo');
      if (saved) { const av=$('user-avatar'); av.style.backgroundImage=`url("${saved}")`; av.style.backgroundSize='cover'; av.style.backgroundPosition='center'; av.textContent=''; }
    }
    $('editProfileBtn').onclick = ()=>{
      let m=$('profileEditModal');
      if (!m) {
        m=document.createElement('div'); m.id='profileEditModal'; m.className='modal open';
        m.innerHTML=`
          <div class="sheet">
            <div class="head"><strong>Edit Profile</strong><button class="btn ghost" id="peClose" type="button">‚úñ</button></div>
            <div class="body">
              <div class="list">
                <div class="field"><label class="small">Public name</label><input id="peName" value="${(user?.name||'')}" /></div>
                <div class="field"><label class="small">Photo</label><input id="pePhoto" type="file" accept="image/*"/></div>
                <button class="btn primary" id="peSave" type="button">Save</button>
              </div>
            </div>
          </div>`;
        document.body.appendChild(m);
        m.addEventListener('click',(e)=>{ if(e.target===m) m.classList.remove('open'); });
        $('peClose').onclick=()=> m.classList.remove('open');
        $('peSave').onclick=()=>{
          const name=$('peName').value.trim(); if (name) user.name=name;
          const f=$('pePhoto').files?.[0];
          if (f) {
            const fr=new FileReader();
            fr.onload=()=>{ localStorage.setItem('zup_profile_photo', fr.result); updateProfileUI(); m.classList.remove('open'); };
            fr.readAsDataURL(f);
          } else { updateProfileUI(); m.classList.remove('open'); }
        };
      } else m.classList.add('open');
    };

    // Booking use current
    $('bkUseCurrent').onclick = async ()=>{
      try {
        if (!coords) await initLocation();
        if (coords) { const name = await reverseGeocode(coords.lat, coords.lng); $('bkAddress').value = name || ''; }
      } catch {}
    };

    // Wallet UI
    const wallet = {
      balance: 245.80,
      tx: [
        { id:'t1', type:'topup', amount:50,  desc:'Card top-up', ts:Date.now()-86400000 },
        { id:'t2', type:'pay',   amount:-12, desc:'Food order', ts:Date.now()-3600000 },
      ],
      cards: [{ brand:'Visa', last4:'4242' }]
    };
    function renderWallet(){
      $('walletBalance').textContent = '$' + wallet.balance.toFixed(2);
      const txBox=$('walletTx'); txBox.innerHTML='';
      wallet.tx.slice().sort((a,b)=>b.ts-a.ts).forEach(t=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`<div class="row" style="justify-content:space-between"><div>${t.desc}</div><div style="font-weight:700;${t.amount<0?'color:#DC2626':''}">${t.amount<0?'-':''}$${Math.abs(t.amount).toFixed(2)}</div></div><div class="small muted">${new Date(t.ts).toLocaleString()}</div>`;
        txBox.appendChild(row);
      });
      const cardBox=$('walletCards'); cardBox.innerHTML='';
      wallet.cards.forEach(c=>{
        const row=document.createElement('div'); row.className='card';
        row.innerHTML=`<div class="row" style="justify-content:space-between"><div>${c.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${c.last4}</div><div class="small muted">Saved</div></div>`;
        cardBox.appendChild(row);
      });
    }
    renderWallet();
    $('walletAdd').onclick = async ()=>{
      try{
        const r=await fetch(`${BASE_API}/api/payments/checkout-session`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ type:'wallet_topup', amount:20, successUrl:location.origin+'/?topup=success', cancelUrl:location.origin+'/?topup=cancel' }) });
        const d=await r.json().catch(()=>({}));
        if (d?.url) return location.href=d.url;
        if ((d?.id||d?.sessionId) && window.Stripe){ const stripe=window.Stripe(STRIPE_PK); await stripe.redirectToCheckout({sessionId: d.id||d.sessionId}); }
        else alert('Could not start top-up.');
      }catch{ alert('Network error.'); }
    };
    $('walletCashOut').onclick = ()=> alert('Cash out: coming soon');
    $('walletSend').onclick = ()=> {
      const email = prompt('Enter recipient email');
      const amt = Number(prompt('Amount'));
      if (!email || !amt) return;
      if (amt > wallet.balance) return alert('Insufficient funds');
      wallet.balance -= amt; wallet.tx.push({ id:'t'+Date.now(), type:'send', amount:-amt, desc:`Send to ${email}`, ts:Date.now() }); renderWallet();
      alert('Sent');
    };
  </script>
  <script>
(function killSplash(){
  function hide() {
    try {
      const s = document.getElementById('splash');
      if (s) { s.style.opacity = '0'; setTimeout(()=> s && s.remove(), 200); }
      const home = document.getElementById('page-home');
      if (home && !home.classList.contains('active')) home.classList.add('active');
    } catch {}
  }
  // Remove splash on DOM ready, on load, on any error, and after a short timeout
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(hide, 0);
  } else {
    document.addEventListener('DOMContentLoaded', hide, { once:true });
  }
  window.addEventListener('load', hide, { once:true });
  window.addEventListener('error', hide);
  window.addEventListener('unhandledrejection', hide);
  setTimeout(hide, 1500);
})();
</script>
</body>
</html>
