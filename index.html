<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZippUp — On‑Demand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.08) }
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }
    header { position:sticky; top:0; z-index:20; background:var(--card); border-bottom:1px solid var(--border) }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px }
    .greet { display:flex; flex-direction:column }
    .small { color:var(--muted); font-size:13px }
    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .service { cursor:pointer; transition:transform .1s ease }
    .service:hover { transform:translateY(-2px) }
    .row { display:flex; gap:10px; align-items:center }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }
    .floating-panic { position:fixed; right:16px; bottom:80px; width:60px; height:60px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:16; display:flex; align-items:center; justify-content:center }
    .nav { position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:space-around; background:#fff; border-top:1px solid var(--border); padding:8px 0; z-index:15 }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }
    /* Pages */
    .page { display:none; padding-bottom:80px }
    .page.active { display:block }
    /* Modals */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow) }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px }
    .list { display:flex; flex-direction:column; gap:12px }
    .provider { border:1px solid var(--border); border-radius:14px; padding:12px }
    .controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
    #track-map { width:100%; height:360px; border-radius:12px; border:1px solid var(--border) }
    /* Profile dropdown */
    #profileMenu { position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:180px; z-index:30 }
    #profileMenu .btn { width:100%; justify-content:flex-start }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="greet">
        <strong>Hello, <span id="userName">Guest</span></strong>
        <span class="small">📍 <span id="userLoc">Detecting location…</span></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="notifBtn">🔔</button>
        <button class="btn ghost" id="cartBtn">🛒</button>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn">👤 Account</button>
          <div id="profileMenu">
            <button class="btn ghost" id="menuProfile">👤 Profile</button>
            <button class="btn ghost" id="menuWallet">💰 Wallet</button>
            <button class="btn ghost" id="menuTopup">⚡ Top‑up</button>
            <button class="btn ghost" id="menuLogout">🚪 Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Pages -->
  <main id="page-home" class="page active">
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency…"/>
        <button class="btn ghost" id="voiceBtn">🎤</button>
        <button class="btn primary" id="searchBtn">Search</button>
      </div>
    </section>

    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>

    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>

    <section class="section">
      <div class="title">Recent</div>
      <div id="recentList"></div>
    </section>
  </main>

  <main id="page-services" class="page">
    <section class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesAllGrid"></div>
    </section>
  </main>

  <main id="page-bookings" class="page">
    <section class="section">
      <div class="title">My Bookings</div>
      <div id="bookingsList"></div>
    </section>
  </main>

  <main id="page-marketplace" class="page">
    <section class="section">
      <div class="title">Marketplace</div>
      <div class="card">Browse and manage products here (coming soon)</div>
    </section>
  </main>

  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row"><div style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">👤</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Demo User</strong></div>
              <div class="small" id="profEmail">demo@zippup.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn">Edit</button>
        </div>
      </div>
      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn">Manage Products</button>
        <button class="btn ghost" id="emergencyContactsBtn">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn">Become Verified Provider</button>
        <button class="btn ghost" id="availToggleBtn">Go Offline / Available</button>
      </div>
    </section>
  </main>

  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong>$245.80</strong></div>
    </section>
  </main>

  <main id="page-topup" class="page">
    <section class="section">
      <div class="title">Top‑up (Digital)</div>
      <div class="grid">
        <div class="card service" data-topup="airtime"><div class="row"><div style="font-size:24px">📞</div><h4>Buy Airtime</h4></div></div>
        <div class="card service" data-topup="data"><div class="row"><div style="font-size:24px">📶</div><h4>Data Bundles</h4></div></div>
        <div class="card service" data-topup="bills"><div class="row"><div style="font-size:24px">💡</div><h4>Pay Bills</h4></div></div>
      </div>
    </section>
  </main>

  <button class="floating-panic" id="panicBtn">🚨</button>

  <nav class="nav">
    <button data-page="home" class="active">🏠 Home</button>
    <button data-page="services">🔧 Services</button>
    <button data-page="bookings">📋 Bookings</button>
    <button data-page="marketplace">🛍️ Marketplace</button>
  </nav>

  <!-- Providers Modal -->
  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders">✖</button>
      </div>
      <div class="body">
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <!-- Booking Form Modal -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking">✖</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <div class="small">Date</div>
              <input id="bkDate" type="date" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Time</div>
              <input id="bkTime" type="time" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div>
            <div class="small">Address or use current</div>
            <input id="bkAddress" placeholder="Enter address (optional)" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          </div>
          <div>
            <div class="small">Details</div>
            <textarea id="bkDesc" rows="3" placeholder="Describe the job…" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          </div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Instant Request Modal (90s) -->
  <div class="modal" id="instantModal">
    <div class="sheet">
      <div class="head">
        <strong id="instantTitle">Contacting provider…</strong>
        <button class="btn ghost" id="cancelInstant">Cancel</button>
      </div>
      <div class="body">
        <div class="card">
          <div>Time left: <strong id="countdown">90</strong>s</div>
          <div class="small muted" id="instantHint">Waiting for provider to accept…</div>
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="findOthers">Find other providers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong>Live Tracking</strong>
        <button class="btn ghost" id="closeTrack">✖</button>
      </div>
      <div class="body">
        <div id="trackStatus" class="small muted">Provider accepted. En route…</div>
        <div id="trackMapWrap" style="margin-top:10px"><div id="track-map"></div></div>
      </div>
    </div>
  </div>

  <!-- Category Options Modal (Transport / Food) -->
  <div class="modal" id="categoryOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong id="categoryOptionsTitle">Options</strong>
        <button class="btn ghost" id="closeCategoryOptions">✖</button>
      </div>
      <div class="body">
        <div id="categoryOptionsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Items/Search Modal (Fastfood / Groceries / Others etc.) -->
  <div class="modal" id="itemsModal">
    <div class="sheet">
      <div class="head">
        <strong id="itemsTitle">Find Items</strong>
        <button class="btn ghost" id="closeItems">✖</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="itemSearch" placeholder="Say or type what you need (e.g., pizza, plumber, tire)…" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <button class="btn ghost" id="itemVoice">🎤</button>
          <button class="btn primary" id="itemGo">Search</button>
        </div>
        <div id="itemChips" class="controls"></div>
      </div>
    </div>
  </div>

  <script>
    const BASE_API = 'https://zippup-backend-v3.onrender.com';

    let user = { name:'Guest', email:'demo@zippup.com' };
    let coords = null;
    let selectedProvider = null;
    let requestId = null;
    let instantTimer = null;
    let instantLeft = 90;
    let map, userMarker, providerMarker, trackPoll = null;
    let currentPage = 'home';

    // Elements
    const userNameEl = document.getElementById('userName');
    const userLocEl  = document.getElementById('userLoc');
    const servicesGrid = document.getElementById('servicesGrid');
    const emergencyGrid = document.getElementById('emergencyGrid');
    const recentList = document.getElementById('recentList');

    const providersModal = document.getElementById('providersModal');
    const providersList  = document.getElementById('providersList');
    const providersTitle = document.getElementById('providersTitle');
    document.getElementById('closeProviders').onclick = () => providersModal.classList.remove('open');

    const bookingModal = document.getElementById('bookingModal');
    const bookingForm  = document.getElementById('bookingForm');
    document.getElementById('closeBooking').onclick = () => bookingModal.classList.remove('open');

    const instantModal = document.getElementById('instantModal');
    const countdownEl  = document.getElementById('countdown');
    document.getElementById('cancelInstant').onclick = cancelInstant;
    document.getElementById('findOthers').onclick = () => { instantModal.classList.remove('open'); providersModal.classList.add('open'); };

    const trackModal = document.getElementById('trackModal');
    const trackStatus= document.getElementById('trackStatus');
    document.getElementById('closeTrack').onclick = () => { stopTracking(); trackModal.classList.remove('open'); };

    // Category options
    const categoryOptionsModal = document.getElementById('categoryOptionsModal');
    const categoryOptionsTitle = document.getElementById('categoryOptionsTitle');
    const categoryOptionsList  = document.getElementById('categoryOptionsList');
    document.getElementById('closeCategoryOptions').onclick = () => categoryOptionsModal.classList.remove('open');

    // Items modal
    const itemsModal = document.getElementById('itemsModal');
    const itemsTitle = document.getElementById('itemsTitle');
    const itemSearch = document.getElementById('itemSearch');
    const itemVoice  = document.getElementById('itemVoice');
    const itemGo     = document.getElementById('itemGo');
    const itemChips  = document.getElementById('itemChips');
    document.getElementById('closeItems').onclick = () => itemsModal.classList.remove('open');

    // Header actions
    const notifBtn = document.getElementById('notifBtn');
    const cartBtn  = document.getElementById('cartBtn');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu= document.getElementById('profileMenu');
    notifBtn.onclick = () => showPage('home') || alert('Notifications (coming soon)');
    cartBtn.onclick  = () => showPage('marketplace');
    profileBtn.onclick = (e) => { e.stopPropagation(); profileMenu.style.display = profileMenu.style.display==='block' ? 'none' : 'block'; };
    document.addEventListener('click', () => profileMenu.style.display='none');
    document.getElementById('menuProfile').onclick = () => { profileMenu.style.display='none'; showPage('profile'); };
    document.getElementById('menuWallet').onclick  = () => { profileMenu.style.display='none'; showPage('wallet'); };
    document.getElementById('menuTopup').onclick   = () => { profileMenu.style.display='none'; showPage('topup'); };
    document.getElementById('menuLogout').onclick  = () => { profileMenu.style.display='none'; alert('Logged out'); };

    // Panic
    document.getElementById('panicBtn').onclick = async () => {
      const ok = confirm('Confirm PANIC alert?\n\nThis will send your live location to your 5 contacts and the national line.');
      if (!ok) return;
      await triggerPanic();
    };

    // Footer nav
    document.querySelectorAll('.nav button').forEach(b=>{
      b.onclick = () => {
        document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        showPage(b.dataset.page);
      };
    });

    // Home search
    const voiceBtn = document.getElementById('voiceBtn');
    const searchInp= document.getElementById('search');
    voiceBtn.onclick = () => voiceToInput(searchInp, () => runHomeSearch());
    document.getElementById('searchBtn').onclick = runHomeSearch;

    // Top-up page quick actions
    document.querySelectorAll('[data-topup]').forEach(el=>{
      el.onclick = () => alert('Top-up: ' + el.dataset.topup);
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      userNameEl.textContent = user.name;
      document.getElementById('profName').textContent = user.name;
      document.getElementById('profEmail').textContent = user.email;
      initLocation();
      renderServices();
      renderEmergency();
      renderRecent();
      renderServicesAll();
      renderBookings();
      [providersModal, bookingModal, instantModal, trackModal, categoryOptionsModal, itemsModal].forEach(m=>{
        m.addEventListener('click', (e)=>{ if (e.target === m) m.classList.remove('open'); });
      });
    });

    function showPage(page){
      const ids = ['home','services','bookings','marketplace','profile','wallet','topup'];
      currentPage = page;
      ids.forEach(id => {
        const el = document.getElementById('page-'+id);
        if (el) el.classList.toggle('active', id===page);
      });
      if (page==='services') renderServicesAll();
      if (page==='bookings') renderBookings();
      return true;
    }

    async function initLocation() {
      try {
        const pos = await new Promise((res, rej) =>
          navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 })
        );
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const name = await reverseGeocode(coords.lat, coords.lng);
        userLocEl.textContent = name || 'Unknown';
      } catch {
        userLocEl.textContent = 'Location unavailable';
      }
    }
    async function reverseGeocode(lat,lng){
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json();
        return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || '');
      } catch { return null; }
    }

    // Catalog
    const SERVICES = [
      { id:'transport', name:'Transport', icon:'🚗', desc:'Ride & moving', instant:true, scheduled:true },
      { id:'food', name:'Food', icon:'🍔', desc:'Restaurant & grocery', instant:true, scheduled:true },
      { id:'tech', name:'Tech Services', icon:'🔧', desc:'Phone/computer repair', instant:true, scheduled:true },
      { id:'home', name:'Home Services', icon:'🏠', desc:'Cleaning & maintenance', instant:true, scheduled:true },
      { id:'construction', name:'Construction', icon:'🏗️', desc:'Builders & electricians', instant:false, scheduled:true },
      { id:'auto', name:'Automobile Repair', icon:'🛠️', desc:'Mechanics, tires, roadside', instant:true, scheduled:true },
      { id:'others', name:'Others', icon:'🎯', desc:'Events, tutors, more', instant:false, scheduled:true },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance', icon:'🚑' },
      { id:'fire',      name:'Fire Service', icon:'🚒' },
      { id:'towing',    name:'Towing', icon:'🚛' },
      { id:'security',  name:'Security', icon:'🛡️' },
      // Roadside uses item-search flow below
      { id:'roadside',  name:'Roadside', icon:'🔧' },
    ];

    function renderServices(){
      servicesGrid.innerHTML = '';
      SERVICES.forEach(s => {
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `
          <div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div>
          <div class="small muted" style="margin-top:6px">${s.desc}</div>
          <div class="row" style="margin-top:8px">
            ${s.instant ? '<span class="pill">Instant</span>' : ''}
            ${s.scheduled ? '<span class="pill">Scheduled</span>' : ''}
          </div>
        `;
        el.onclick = () => openCategory(s.id, s.name);
        servicesGrid.appendChild(el);
      });
    }
    function renderServicesAll(){
      const wrap = document.getElementById('servicesAllGrid');
      if (!wrap) return;
      wrap.innerHTML = '';
      SERVICES.forEach(s=>{
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = () => openCategory(s.id, s.name);
        wrap.appendChild(el);
      });
    }

    function renderEmergency(){
      emergencyGrid.innerHTML = '';
      EMERGENCY.forEach(e => {
        const el = document.createElement('div');
        el.className = 'card service';
        el.innerHTML = `
          <div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div>
          <div class="small muted" style="margin-top:6px">${e.id==='roadside' ? 'Describe the issue' : 'Find nearest/available'}</div>
          <div class="row" style="margin-top:8px"><span class="pill">Instant</span></div>
        `;
        el.onclick = () => {
          if (e.id==='roadside') openItemsModal('roadside');
          else openEmergency(e.id, e.name);
        };
        emergencyGrid.appendChild(el);
      });
    }

    function renderRecent(){
      recentList.innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>🚗 Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>🔧 Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
      `;
    }

    // Category flows
    async function openCategory(catId, label){
      // Transport → choose Ride/Taxi or Truck/Backie
      if (catId === 'transport') {
        openCategoryOptions('Transport Options', [
          { id:'ride',   name:'Ride / Taxi', icon:'🚗' },
          { id:'moving', name:'Truck / Backie', icon:'🚚' },
        ], (opt) => {
          categoryOptionsModal.classList.remove('open');
          providersTitle.textContent = opt.name + ' — Providers';
          fetchProviders('transport', opt.id).then(renderProviders);
          providersModal.classList.add('open');
        });
        return;
      }
      // Food → choose Fast food or Groceries → items search
      if (catId === 'food') {
        openCategoryOptions('Food Options', [
          { id:'fastfood', name:'Fast Food', icon:'🍔' },
          { id:'grocery',  name:'Groceries', icon:'🛒' },
        ], (opt) => {
          categoryOptionsModal.classList.remove('open');
          openItemsModal(opt.id);
        });
        return;
      }
      // Other categories → items search first
      const itemsMap = {
        home:       { title:'Home Services', chips:['cleaning','gardening','painting','plumber','electrician'] },
        tech:       { title:'Tech Services', chips:['phone repair','computer','tv repair','software'] },
        auto:       { title:'Automobile', chips:['mechanic','tires','battery','car wash'] },
        construction:{ title:'Construction', chips:['builder','carpenter','electrician','plumber'] },
        others:     { title:'Other Services', chips:['events','tutor','legal','photography'] },
        roadside:   { title:'Roadside Help', chips:['flat tire','jumpstart','fuel','lockout'] },
      };
      if (itemsMap[catId]) {
        openItemsModal(catId, itemsMap[catId].title, itemsMap[catId].chips);
        return;
      }
      // Fallback: open providers
      providersTitle.textContent = label + ' — Providers';
      const list = await fetchProviders(catId);
      renderProviders(list);
      providersModal.classList.add('open');
    }

    function openCategoryOptions(title, options, onPick){
      categoryOptionsTitle.textContent = title;
      categoryOptionsList.innerHTML = '';
      options.forEach(o => {
        const el = document.createElement('div');
        el.className = 'provider';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row"><div style="font-size:24px">${o.icon||'•'}</div><div><strong>${o.name}</strong></div></div>
            <button class="btn primary">Choose</button>
          </div>
        `;
        el.querySelector('button').onclick = () => onPick(o);
        categoryOptionsList.appendChild(el);
      });
      categoryOptionsModal.classList.add('open');
    }

    // Items → providers
    function openItemsModal(kind, customTitle, customChips){
      const title = customTitle || (kind === 'fastfood' ? 'Fast Food' : kind === 'grocery' ? 'Groceries' : 'Find Service');
      const chipDefaults = {
        fastfood:['pizza','burger','fries','chicken','drinks','meat'],
        grocery: ['milk','bread','eggs','rice','fruits','vegetables','water'],
        home:    ['cleaning','gardening','painting','plumber','electrician'],
        tech:    ['phone repair','computer','tv repair','software'],
        auto:    ['mechanic','tires','battery','car wash'],
        construction:['builder','carpenter','electrician','plumber'],
        others:  ['events','tutor','legal','photography'],
        roadside:['flat tire','jumpstart','fuel','lockout'],
      };
      itemsTitle.textContent = title;
      const chips = customChips || chipDefaults[kind] || [];
      renderItemChips(chips);
      itemsModal.classList.add('open');

      itemGo.onclick = async () => {
        const q = (itemSearch.value||'').trim().toLowerCase();
        itemsModal.classList.remove('open');
        providersTitle.textContent = (q ? q : title) + ' — Providers';
        const list = await fetchProviders(kind, q || kind);
        renderProviders(list);
        providersModal.classList.add('open');
      };

      itemVoice.onclick = () => voiceToInput(itemSearch, () => itemGo.click());
    }
    function renderItemChips(chips){
      itemChips.innerHTML = '';
      chips.forEach(text => {
        const b = document.createElement('button');
        b.className = 'btn ghost';
        b.textContent = text;
        b.onclick = () => { itemSearch.value = text; itemGo.click(); };
        itemChips.appendChild(b);
      });
    }

    // Emergency
    async function openEmergency(emId, label){
      providersTitle.textContent = label + ' — Nearest';
      const list = await fetchProviders('emergency', emId);
      renderProviders(list);
      providersModal.classList.add('open');
    }

    // Providers
    async function fetchProviders(category, sub=null){
      try{
        const q = new URLSearchParams({ category, sub: sub || '', lat: coords?.lat || '', lng: coords?.lng || '' });
        const r = await fetch(`${BASE_API}/api/providers/nearby?${q.toString()}`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return d.providers || [];
      }catch{
        return [
          { id:'p1', name:'Pro One', icon:'👤', distance:'0.8km', eta:'6-9m', fee:'$8-12', available:true },
          { id:'p2', name:'Quick Help', icon:'⚡', distance:'1.2km', eta:'8-12m', fee:'$10-15', available:true },
          { id:'p3', name:'Nearby Tech', icon:'🔧', distance:'2.1km', eta:'12-18m', fee:'$12-18', available:true },
        ];
      }
    }
    function renderProviders(list){
      providersList.innerHTML = '';
      if (!list?.length){ providersList.innerHTML = '<div class="small muted">No providers found nearby.</div>'; return; }
      list.forEach(p=>{
        const el = document.createElement('div');
        el.className = 'provider';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row"><div style="font-size:24px">${p.icon || '👤'}</div><div><strong>${p.name}</strong><div class="small muted">${p.distance || '—'} • ETA ${p.eta || '—'} • Fee ${p.fee || '—'}</div></div></div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="controls">
            <button class="btn primary" data-k="instant">Instant Request</button>
            <button class="btn ghost" data-k="schedule">Schedule</button>
          </div>
        `;
        el.querySelectorAll('button[data-k]').forEach(b=>{
          b.onclick = () => (b.dataset.k === 'instant' ? startInstant(p) : openBooking(p));
        });
        providersList.appendChild(el);
      });
    }

    // Panic
    async function triggerPanic(){
      try{
        const body = { type:'panic', location: coords ? { latitude:coords.lat, longitude:coords.lng } : null, message:'User triggered PANIC alert' };
        const r = await fetch(`${BASE_API}/api/emergency/alert`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json().catch(()=>({}));
        if (r.ok){
          alert('Panic alert sent.');
          if (d.trackingUrl) location.href = d.trackingUrl;
          else if (d.alertId) location.href = `/emergency/track/${d.alertId}`;
        } else {
          alert('Alert sent (fallback).');
        }
      }catch{ alert('Alert sent (no GPS).'); }
    }

    // Instant (90s)
    async function startInstant(provider){
      selectedProvider = provider;
      providersModal.classList.remove('open');
      instantLeft = 90;
      countdownEl.textContent = String(instantLeft);
      instantModal.classList.add('open');

      try{
        const r = await fetch(`${BASE_API}/api/requests`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ type:'instant', providerId: provider.id, location: coords ? { latitude:coords.lat, longitude:coords.lng } : null })
        });
        const d = await r.json().catch(()=>({}));
        requestId = d.requestId || 'demo-'+Date.now();
      }catch{ requestId = 'demo-'+Date.now(); }

      instantTimer = setInterval(async () => {
        instantLeft -= 1;
        countdownEl.textContent = String(instantLeft);

        if (instantLeft % 3 === 0) {
          const status = await getRequestStatus(requestId);
          if (status === 'accepted'){ stopInstant(); openTracking(); return; }
          if (status === 'rejected'){ stopInstant(); alert('Provider rejected.'); instantModal.classList.remove('open'); return; }
        }
        if (instantLeft <= 0) {
          stopInstant(); alert('No response. Try others.');
          instantModal.classList.remove('open');
        }
      }, 1000);
    }
    function stopInstant(){ if (instantTimer) clearInterval(instantTimer); instantTimer = null; }
    async function cancelInstant(){
      stopInstant();
      if (requestId){ try{ await fetch(`${BASE_API}/api/requests/${encodeURIComponent(requestId)}`, { method:'DELETE' }); }catch{} }
      instantModal.classList.remove('open');
    }
    async function getRequestStatus(id){
      try{
        const r = await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return d.status || 'pending';
      }catch{
        if (instantLeft < 78) return 'accepted'; // demo
        return 'pending';
      }
    }

    // Tracking
    function openTracking(){
      instantModal.classList.remove('open');
      trackModal.classList.add('open');
      setTimeout(initMap, 50);
      startTracking();
    }
    function initMap(){
      if (!map){
        map = L.map('track-map', { zoomControl:true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OSM' }).addTo(map);
      }
      const userLatLng = coords ? [coords.lat, coords.lng] : [0,0];
      map.setView(userLatLng, 14);
      if (userMarker) userMarker.remove();
      userMarker = L.marker(userLatLng, { title:'You' }).addTo(map);
      if (providerMarker) providerMarker.remove();
    }
    function startTracking(){
      if (trackPoll) clearInterval(trackPoll);
      trackPoll = setInterval(async () => {
        const pos = await getProviderPosition(requestId);
        if (!pos) return;
        const latlng = [pos.lat, pos.lng];
        if (!providerMarker) providerMarker = L.marker(latlng, { title:'Provider', icon: defaultIcon() }).addTo(map);
        else providerMarker.setLatLng(latlng);
        trackStatus.textContent = `Provider en route • ${pos.eta || 'ETA —'}`;
      }, 3000);
    }
    function stopTracking(){ if (trackPoll) clearInterval(trackPoll); trackPoll = null; }
    function defaultIcon(){
      return L.icon({
        iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
        shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize:[25,41], iconAnchor:[12,41]
      });
    }
    async function getProviderPosition(id){
      try{
        const r = await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}/position`);
        if (!r.ok) throw new Error();
        const d = await r.json();
        return { lat:d.provider?.lat, lng:d.provider?.lng, eta: d.eta };
      }catch{
        const base = coords ? { lat: coords.lat + (Math.random()-0.5)/100, lng: coords.lng + (Math.random()-0.5)/100 } : { lat:0, lng:0 };
        return { lat: base.lat, lng: base.lng, eta: '8 min' };
      }
    }

    // Scheduled
    function openBooking(provider){ selectedProvider = provider; bookingModal.classList.add('open'); }
    bookingForm.onsubmit = async (e) => {
      e.preventDefault();
      const date = document.getElementById('bkDate').value;
      const time = document.getElementById('bkTime').value;
      const address = document.getElementById('bkAddress').value;
      const desc = document.getElementById('bkDesc').value;
      if (!date || !time){ alert('Pick date and time'); return; }
      try{
        const r = await fetch(`${BASE_API}/api/bookings`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            providerId: selectedProvider.id,
            bookingType:'scheduled', date, time, address, description:desc,
            location: coords ? { latitude:coords.lat, longitude:coords.lng } : null
          })
        });
        if (!r.ok) throw new Error();
        alert('Booking request sent. Check My Bookings for status.');
      }catch{
        alert('Booking sent (demo). Provider will confirm soon.');
      } finally { bookingModal.classList.remove('open'); }
    };

    // Voice helper
    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR();
      rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = (e) => {
        const text = e.results[0][0].transcript || '';
        inputEl.value = text;
        if (onResult) onResult(text);
      };
      rec.onerror = () => {};
      rec.start();
    }

    // Home search router
    function runHomeSearch(){
      const q = (searchInp.value||'').trim().toLowerCase();
      if (!q) return;
      if (/(ride|taxi|cab|uber|bolt)/.test(q)) { openCategory('transport','Transport'); return; }
      if (/(truck|backie|moving|load)/.test(q)) {
        openCategoryOptions('Transport Options',[{id:'moving',name:'Truck / Backie',icon:'🚚'}],o=>{
          categoryOptionsModal.classList.remove('open');
          providersTitle.textContent = o.name + ' — Providers';
          fetchProviders('transport','moving').then(renderProviders);
          providersModal.classList.add('open');
        });
        return;
      }
      if (/(food|pizza|burger|fries|chicken|drinks)/.test(q)) { openItemsModal('fastfood'); return; }
      if (/(grocery|milk|bread|eggs|rice|fruit|vegetable|vegetables)/.test(q)) { openItemsModal('grocery'); return; }
      if (/(ambulance|medical)/.test(q)) { openEmergency('ambulance','Ambulance'); return; }
      if (/(fire)/.test(q)) { openEmergency('fire','Fire Service'); return; }
      if (/(towing|tow)/.test(q)) { openEmergency('towing','Towing'); return; }
      if (/(security|police)/.test(q)) { openEmergency('security','Security'); return; }
      // Category-intent for other services
      if (/(plumber|electrician|clean|garden|paint)/.test(q)) { openItemsModal('home'); return; }
      if (/(mechanic|tire|battery|car wash)/.test(q)) { openItemsModal('auto'); return; }
      if (/(phone|computer|laptop|tv|repair|software)/.test(q)) { openItemsModal('tech'); return; }
      if (/(builder|carpenter|construction)/.test(q)) { openItemsModal('construction'); return; }
      if (/(event|tutor|legal|photo|photography)/.test(q)) { openItemsModal('others'); return; }
      if (/(flat|jumpstart|fuel|lockout|road)/.test(q)) { openItemsModal('roadside'); return; }

      // fallback generic provider search
      providersTitle.textContent = q + ' — Providers';
      fetchProviders('search', q).then(renderProviders);
      providersModal.classList.add('open');
    }

    // Bookings (landing page)
    function renderBookings(){
      const el = document.getElementById('bookingsList');
      if (!el) return;
      el.innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>🔧 Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>🚗 Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
      `;
    }
  </script>
</body>
</html>
