<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
  <title>ZippUp â€” Onâ€‘Demand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">

  <!-- SDKs -->
  <script src="https://js.stripe.com/v3"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827;
      --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --header-h:58px; --nav-h:64px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{width:100%;height:100%;max-width:100%;overflow-x:hidden;-webkit-text-size-adjust:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;background:var(--bg);color:var(--text)}

    /* Fixed header bar with only title + right actions; greet/location goes below header */
    header{
      position:fixed;top:0;left:0;right:0;height:calc(var(--header-h) + env(safe-area-inset-top,0px));
      padding-top:env(safe-area-inset-top,0px);background:var(--card);border-bottom:1px solid var(--border);
      display:flex;align-items:flex-end;z-index:100;
    }
    header .bar{width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;gap:8px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .brand strong{font-weight:800}
    .brand small{color:var(--muted);display:block;line-height:1}
    .right-actions{display:flex;align-items:center;gap:8px}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .account-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis}

    /* Main page area below header; footer is fixed */
    .page{position:fixed;top:calc(var(--header-h) + env(safe-area-inset-top,0px));bottom:calc(var(--nav-h) + env(safe-area-inset-bottom,0px));left:0;right:0;overflow:auto}
    .section{padding:12px 16px}
    .title{font-weight:800;margin-bottom:10px}
    .small{color:var(--muted);font-size:13px}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:#F3F4F6}
    .btn.block{width:100%}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px}
    .success{background:#ECFDF5;color:#065F46}
    .danger{background:#FEE2E2;color:#991B1B}

    .search{padding:12px 16px}
    .search .box{display:flex;gap:8px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .search input{flex:1;border:0;outline:0;font-size:15px}

    /* Greeting + location below header, visible on phones */
    .greet-wrap{padding:8px 16px}
    .greet{display:flex;gap:4px}
    .loc-pin{display:inline-flex;align-items:center;gap:6px}

    /* Map preview */
    #homeMap{height:160px;border-radius:14px;border:1px solid var(--border);overflow:hidden}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
    .modal.open{display:flex}
    .sheet{width:100%;max-width:720px;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;max-height:88vh;overflow:hidden;border:1px solid var(--border)}
    .sheet .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .sheet .body{padding:14px;overflow:auto;max-height:calc(88vh - 54px)}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field input,.field textarea,.field select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px}

    /* Bottom nav */
    .nav{position:fixed;left:0;right:0;bottom:0;height:calc(var(--nav-h) + env(safe-area-inset-bottom,0px));padding-bottom:env(safe-area-inset-bottom,0px);background:#fff;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;z-index:100}
    .nav .item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 6px;min-width:64px}
    .nav .item.active strong{color:var(--primary)}

    /* Product cards and vendor lists */
    .product{display:flex;gap:12px}
    .product img{width:92px;height:92px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .product .meta{flex:1;min-width:0}
    .vendor{display:flex;gap:10px;align-items:center;justify-content:space-between}

    /* Back bar inside pages/modals */
    .backbar{display:flex;align-items:center;gap:8px;padding:8px 0;margin-bottom:8px;border-bottom:1px solid var(--border)}
    .backbar .back{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}

    /* Hide header cart permanently and keep Account/Bell visible in header bar */
    #cartBtn,#headerCartBadge{display:none !important}
    .right-actions .icon-btn{margin-right:2px}

    /* Terms modal readability */
    #termsModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
    #termsModal .modal-content{width:100%;max-width:720px;background:#fff;border:1px solid var(--border);border-radius:14px;max-height:80vh;overflow:hidden}
    #termsModal .modal-body{padding:14px;overflow:auto;max-height:calc(80vh - 54px)}
  </style>
</head>
<body>

  <!-- Header bar: title + bell + account (aligned to the bar) -->
  <header>
    <div class="bar">
      <div class="brand">
        <div>
          <strong>ZippUp</strong>
          <small class="muted">Onâ€‘Demand Services</small>
        </div>
      </div>
      <div class="right-actions">
        <button id="notifBtn" class="icon-btn" title="Notifications">ğŸ””</button>
        <button id="accountBtn" class="account-btn" title="Account">ğŸ‘¤ <span id="accountName">Account</span></button>
      </div>
    </div>
  </header>

  <!-- Main page -->
  <main id="page-home" class="page">
    <!-- Greeting + geo location under header -->
    <div class="greet-wrap">
      <div class="greet">
        <strong id="greetLine">Hello ğŸ‘‹</strong>
        <span class="small muted">ZippUp: Hustle faster!</span>
        <div class="loc-pin small"><span>ğŸ“</span><span id="locText">Locating youâ€¦</span></div>
      </div>
    </div>

    <!-- Small map preview -->
    <div class="section">
      <div id="homeMap"></div>
    </div>

    <!-- Search -->
    <div class="search">
      <div class="box">
        <span>ğŸ”</span>
        <input id="globalSearch" placeholder="Search services, vendors, itemsâ€¦"/>
      </div>
    </div>

    <!-- Services grid (moved up) -->
    <div class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesGrid">
        <div class="card service" data-service="transport">ğŸš— Transport</div>
        <div class="card service" data-service="home">ğŸ  Home Services</div>
        <div class="card service" data-service="construction">ğŸ—ï¸ Construction</div>
        <div class="card service" data-service="cleaning">ğŸ§¹ Cleaning</div>
        <div class="card service" data-service="tech">ğŸ’» Tech Help</div>
        <div class="card service" data-service="food">ğŸ” Food</div>
        <div class="card service" data-service="grocery">ğŸ›’ Grocery</div>
        <div class="card service" data-service="marketplace">ğŸ›ï¸ Marketplace</div>
        <div class="card service" data-service="emergencyRoot">ğŸš¨ Emergency Services</div>
        <div class="card service" data-service="digitalRoot">ğŸ’³ Digital Services</div>
      </div>
    </div>

    <!-- Marketplace header with Sell button -->
    <div class="section" id="marketplaceHeader" style="display:none">
      <div class="row" style="justify-content:space-between">
        <div class="title">Marketplace</div>
        <button id="sellBtn" class="btn ghost">Sell products</button>
      </div>
    </div>
    <div class="section" id="marketplaceList" style="display:none">
      <div class="search">
        <div class="box">
          <span>ğŸ”</span>
          <input id="marketSearch" placeholder="Search marketplaceâ€¦"/>
        </div>
      </div>
      <div id="marketItems" class="grid"></div>
    </div>

    <!-- Vendors list for Food/Grocery -->
    <div class="section" id="vendorsSection" style="display:none">
      <div class="backbar">
        <button class="back" data-back="home">â†</button>
        <strong id="vendorsTitle">Vendors</strong>
      </div>
      <div class="search">
        <div class="box">
          <span>ğŸ”</span>
          <input id="vendorSearch" placeholder="Search vendors or itemsâ€¦"/>
        </div>
      </div>
      <div id="vendorsList" class="grid"></div>
    </div>

    <!-- Vendor menu -->
    <div class="section" id="menuSection" style="display:none">
      <div class="backbar">
        <button class="back" data-back="vendors">â†</button>
        <strong id="menuVendorName">Menu</strong>
      </div>
      <div id="menuItems" class="grid"></div>
      <div class="section">
        <button id="openCartBtn" class="btn primary block">View Cart</button>
      </div>
    </div>

    <!-- Wallet -->
    <div class="section" id="walletSection" style="display:none">
      <div class="backbar">
        <button class="back" data-back="home">â†</button>
        <strong>Wallet</strong>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="small muted">Balance</div>
            <div style="font-size:22px;font-weight:800" id="walletBalance">$0.00</div>
          </div>
          <div class="row">
            <button class="btn ghost" id="walletAdd">Add Funds (Coming soon)</button>
            <button class="btn ghost" id="walletCashOut">Cash Out (Coming soon)</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button class="btn ghost" id="walletSend">Send to user</button>
          <button class="btn ghost" id="walletCards">Saved cards</button>
        </div>
      </div>
      <div class="section" style="padding:12px 0">
        <div class="title">Transactions</div>
        <div id="walletTx" class="grid"></div>
      </div>
    </div>

  </main>

  <!-- Bottom navigation -->
  <nav class="nav">
    <div class="item active" data-nav="home">ğŸ <strong>Home</strong></div>
    <div class="item" data-nav="wallet">ğŸ‘›<strong>Wallet</strong></div>
    <div class="item" data-nav="orders">ğŸ“¦<strong>Orders</strong></div>
    <div class="item" data-nav="chat">ğŸ’¬<strong>Chat</strong></div>
    <div class="item" data-nav="profile">ğŸ‘¤<strong>Profile</strong></div>
  </nav>

  <!-- Emergency and Digital category pickers -->
  <div class="modal" id="emergencyPicker">
    <div class="sheet">
      <div class="head"><strong>Emergency Services</strong><button class="btn ghost" data-close="emergencyPicker">âœ–</button></div>
      <div class="body">
        <div class="grid">
          <button class="card" data-emer="ambulance">ğŸš‘ Ambulance</button>
          <button class="card" data-emer="fire">ğŸ”¥ Fire Service</button>
          <button class="card" data-emer="roadside" id="btnRoadside">ğŸ› ï¸ Roadside Assist</button>
          <button class="card" data-emer="security">ğŸ›¡ï¸ Security</button>
          <button class="card" data-emer="towing">ğŸš› Towing</button>
        </div>
        <div class="section">
          <div class="search">
            <div class="box">
              <span>ğŸ”</span>
              <input id="emergencySearch" placeholder="Search providersâ€¦"/>
            </div>
          </div>
          <div id="emergencyProviders" class="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="digitalPicker">
    <div class="sheet">
      <div class="head"><strong>Digital Services</strong><button class="btn ghost" data-close="digitalPicker">âœ–</button></div>
      <div class="body">
        <div class="grid">
          <button class="card" data-digital="airtime">ğŸ“± Buy Airtime</button>
          <button class="card" data-digital="data">ğŸ“¶ Buy Data</button>
          <button class="card" data-digital="bills">ğŸ§¾ Pay Bills</button>
          <button class="card" data-digital="digital-products">ğŸ›’ Digital Products</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Food/Grocery entry modal -->
  <div class="modal" id="foodEntry">
    <div class="sheet">
      <div class="head"><strong>Select type</strong><button class="btn ghost" data-close="foodEntry">âœ–</button></div>
      <div class="body">
        <div class="grid">
          <button class="card" data-food="fast">ğŸ” Fast food</button>
          <button class="card" data-food="grocery">ğŸ›’ Groceries</button>
        </div>
        <div class="section">
          <div class="search">
            <div class="box">
              <span>ğŸ”</span>
              <input id="foodSearch" placeholder="Search vendors or foodsâ€¦"/>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart / Checkout -->
  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head"><strong>Cart</strong><button class="btn ghost" data-close="cartModal">âœ–</button></div>
      <div class="body" style="display:flex;flex-direction:column;gap:12px">
        <div id="cartItems"></div>
        <div class="card">
          <div class="field">
            <label class="small">Payment method</label>
            <select id="payMethod">
              <option value="card">Card</option>
              <option value="cash">Cash</option>
              <option value="wallet">Wallet</option>
            </select>
          </div>
          <div class="row" style="justify-content:space-between">
            <div class="small muted">Subtotal</div><div id="cartSubtotal"><strong>$0.00</strong></div>
          </div>
          <div class="row" style="justify-content:space-between">
            <div class="small muted">Delivery</div><div id="cartDelivery"><strong>$0.00</strong></div>
          </div>
          <div class="row" style="justify-content:space-between">
            <div>Total</div><div id="cartTotal" style="font-weight:800">$0.00</div>
          </div>
          <div class="field" style="margin-top:8px">
            <label class="small"><input type="checkbox" id="termsChk"> I accept the terms</label>
            <button id="openTerms" class="btn ghost" type="button">Read Terms</button>
          </div>
          <button id="placeOrderBtn" class="btn primary block">Place order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Terms modal -->
  <div id="termsModal">
    <div class="modal-content">
      <div class="head" style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)">
        <strong>Terms and Conditions</strong>
        <button id="termsClose" class="btn ghost">âœ–</button>
      </div>
      <div class="modal-body">
        <p><strong>Food/Grocery:</strong> Your payment may be held in escrow until the seller confirms delivery using your oneâ€‘time code.</p>
        <p><strong>Delivery Code:</strong> Please do not share your confirm delivery code with the seller until you receive and confirm the product in their presence. If you lose the code, open Account â†’ Manage Orders, pick the order to view it again.</p>
        <p><strong>Transport:</strong> Charges are calculated and deducted when the trip ends based on distance/time like Bolt.</p>
        <p><strong>Other Services:</strong> Billing starts when provider marks Arrived; after 7 minutes, timeâ€‘based charges accrue by the providerâ€™s hourly rate until they end the job.</p>
        <p><strong>Wallet:</strong> Card topâ€‘up coming soon. Wallet can be used to pay cardâ€‘required services when balance is sufficient.</p>
      </div>
    </div>
  </div>

  <!-- Orders page -->
  <div class="modal" id="ordersPage">
    <div class="sheet">
      <div class="head"><strong>Manage Orders</strong><button class="btn ghost" data-close="ordersPage">âœ–</button></div>
      <div class="body">
        <div class="small muted" style="margin-bottom:8px">Buyers can view their oneâ€‘time delivery codes here. Sellers can open an order and confirm delivery by entering buyerâ€™s code.</div>
        <div id="ordersList" class="grid"></div>
      </div>
    </div>
  </div>

  <!-- Marketplace sell form -->
  <div class="modal" id="sellForm">
    <div class="sheet">
      <div class="head"><strong>Sell a product</strong><button class="btn ghost" data-close="sellForm">âœ–</button></div>
      <div class="body">
        <div class="field">
          <label class="small">Category</label>
          <select id="mkCat">
            <option value="electronics">Electronics</option>
            <option value="fashion">Fashion</option>
            <option value="home">Home & Kitchen</option>
            <option value="auto">Auto</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field"><label class="small">Type</label><input id="mkType" placeholder="e.g., Phone"/></div>
        <div class="field"><label class="small">Title</label><input id="mkTitle" placeholder="Product title"/></div>
        <div class="field"><label class="small">Price</label><input id="mkPrice" type="number" min="0" step="0.01"/></div>
        <div class="field"><label class="small">Stock</label><input id="mkStock" type="number" min="0"/></div>
        <div class="field">
          <label class="small">Images (up to 10)</label>
          <input id="mkImages" type="file" accept="image/*" multiple>
        </div>
        <button id="mkSubmit" class="btn primary block">Submit</button>
      </div>
    </div>
  </div>

  <!-- Food vendor manage products (profile) -->
  <div class="modal" id="manageFood">
    <div class="sheet">
      <div class="head"><strong>Manage Product (Food Vendors Only)</strong><button class="btn ghost" data-close="manageFood">âœ–</button></div>
      <div class="body">
        <div class="small muted" style="margin-bottom:8px">Upload multiple items per batch; up to 5 images per item; set payment acceptance.</div>
        <div id="foodItemsForm"></div>
        <button id="addFoodRow" class="btn ghost" type="button">+ Add another item</button>
        <button id="saveFoodItems" class="btn primary block" style="margin-top:10px">Save items</button>
      </div>
    </div>
  </div>

  <!-- Panic modal -->
  <div class="modal" id="panicModal">
    <div class="sheet">
      <div class="head"><strong>Emergency Alert</strong><button class="btn ghost" data-close="panicModal">âœ–</button></div>
      <div class="body">
        <div class="small muted" style="margin-bottom:8px">We'll notify your contacts and nearby security with your location.</div>
        <div class="field"><label class="small">Message (optional)</label><textarea id="panicMsg" rows="3" placeholder="Describe emergencyâ€¦"></textarea></div>
        <div class="row" style="justify-content:flex-end"><button id="panicSend" class="btn primary">Send Alert</button></div>
      </div>
    </div>
  </div>

  <script>
    // Firebase init (Auth only)
    const firebaseConfig = {
      apiKey: "AIzaSyApgmcfu5qGFn9tw872dQ2KkdDz_GPmL70",
      authDomain: "zippup-535ca.firebaseapp.com",
      projectId: "zippup-535ca",
      appId: "1:382212325227:web:c04d91386817c7cff7d62e",
      messagingSenderId: "382212325227",
      measurementId: "G-YKJEVL8M6V"
    };
    if (window.firebase) {
      try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    }

    // Globals
    const stripe = window.Stripe ? Stripe('pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd') : null;
    const API_BASE = window.NEXT_PUBLIC_API_URL || '';
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // State
    let user = { id:'demo-user', name:'Guest', role:'buyer', wallet: 120.50 };
    let vendors = {
      fast: [
        { id:'v1', name:'Burger Hub', rating:4.6, distance:'1.2km', items:[
          { id:'m1', title:'Cheese Burger', price:5.99, img:'' },
          { id:'m2', title:'Fries', price:2.49, img:'' },
        ], pay:{cash:true,card:true} },
        { id:'v2', name:'Pizza Place', rating:4.4, distance:'2.0km', items:[
          { id:'m3', title:'Pepperoni Slice', price:3.50, img:'' },
        ], pay:{cash:false,card:true} },
      ],
      grocery: [
        { id:'g1', name:'Fresh Mart', rating:4.7, distance:'0.9km', items:[
          { id:'g11', title:'Apples (1kg)', price:2.99, img:'' },
          { id:'g12', title:'Milk (1L)', price:1.49, img:'' },
        ], pay:{cash:true,card:true} },
      ]
    };
    let marketplace = [
      { id:'p1', title:'iPhone 12', price:350, img:'', seller:'John', cat:'electronics' },
      { id:'p2', title:'Sofa', price:120, img:'', seller:'Ava', cat:'home' },
    ];
    let cart = { vendorId:null, vendorName:'', type:'fast', items:[] }; // food/grocery only
    let orders = JSON.parse(localStorage.getItem('zup_orders') || '[]');
    let wallet = { balance: user.wallet, tx: JSON.parse(localStorage.getItem('zup_wallet_tx')||'[]'), cards:[{brand:'visa', last4:'4242'}] };

    // Booking/live tracking state for instant services
    let live = { active:false, watchId:null, timer:null, startedAt:null, arrivedAt:null, serviceType:null, hourlyRate:20 };

    // UI helpers
    function money(n){ return `$${(n||0).toFixed(2)}`; }
    function toast(msg){ alert(msg); }

    // Header/account
    function renderHeader() {
      $('#accountName').textContent = user.name || 'Account';
      $('#greetLine').textContent = `Hello ${user.name || 'there'} ğŸ‘‹`;
    }

    // Geolocation + map
    function initMap() {
      const map = L.map('homeMap',{ zoomControl:false }).setView([0,0], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos=>{
          const { latitude, longitude } = pos.coords;
          $('#locText').textContent = `Lat ${latitude.toFixed(4)}, Lng ${longitude.toFixed(4)}`;
          map.setView([latitude, longitude], 15);
          L.marker([latitude, longitude]).addTo(map);
        }, _=> $('#locText').textContent='Location unavailable');
      } else {
        $('#locText').textContent = 'Location unavailable';
      }
    }

    // Services routing
    function show(sectionId) {
      // hide all major sections
      ['vendorsSection','menuSection','marketplaceHeader','marketplaceList','walletSection'].forEach(id=>{
        const el = $('#'+id); if (el) el.style.display = 'none';
      });
      if (sectionId) $('#'+sectionId).style.display = '';
      // nav active
      $$('.nav .item').forEach(i=>i.classList.remove('active'));
      if (sectionId==='walletSection') $(`.nav .item[data-nav="wallet"]`)?.classList.add('active');
      else $(`.nav .item[data-nav="home"]`)?.classList.add('active');
    }

    // Food/Grocery entry
    function openFoodEntry() { openModal('foodEntry'); }
    function listVendors(kind) {
      closeModal('foodEntry');
      const list = vendors[kind] || [];
      $('#vendorsTitle').textContent = kind==='fast' ? 'Fast food vendors' : 'Grocery vendors';
      const q = ($('#foodSearch').value||'').toLowerCase();
      const filtered = list.filter(v => v.name.toLowerCase().includes(q) || v.items.some(it=>it.title.toLowerCase().includes(q)));
      const html = filtered.map(v=>`
        <div class="card vendor">
          <div>
            <div style="font-weight:700">${v.name}</div>
            <div class="small muted">â­ ${v.rating} â€¢ ${v.distance}</div>
            <div class="small">${v.pay.card ? 'Card' : ''} ${v.pay.cash ? 'Cash' : ''}</div>
          </div>
          <button class="btn primary" data-open-menu="${v.id}" data-kind="${kind}">Open</button>
        </div>
      `).join('');
      $('#vendorsList').innerHTML = html || '<div class="small muted">No vendors found</div>';
      show('vendorsSection');
    }
    function openMenu(kind, vendorId) {
      const v = (vendors[kind]||[]).find(x=>x.id===vendorId);
      if (!v) return;
      $('#menuVendorName').textContent = v.name;
      const items = v.items.map(it=>`
        <div class="card product">
          <img src="${it.img||'https://via.placeholder.com/160'}" alt="">
          <div class="meta">
            <div style="font-weight:700">${it.title}</div>
            <div class="small muted">${money(it.price)}</div>
            <div class="row" style="margin-top:6px">
              <button class="btn ghost" data-add="${v.id}" data-kind="${kind}" data-id="${it.id}">Add</button>
            </div>
          </div>
        </div>
      `).join('');
      $('#menuItems').innerHTML = items || '<div class="small muted">No items</div>';
      show('menuSection');
    }

    // Cart (single vendor only)
    function addToCart(kind, vendorId, itemId) {
      const v = (vendors[kind]||[]).find(x=>x.id===vendorId);
      if (!v) return;
      const item = v.items.find(i=>i.id===itemId);
      if (!item) return;
      if (cart.vendorId && cart.vendorId !== v.id) {
        if (!confirm(`Cart contains items from ${cart.vendorName}. Clear cart to add from ${v.name}?`)) return;
        cart = { vendorId:null, vendorName:'', type:kind, items:[] };
      }
      cart.vendorId = v.id; cart.vendorName = v.name; cart.type = kind;
      const found = cart.items.find(ci=>ci.id===item.id);
      if (found) found.qty += 1;
      else cart.items.push({ id:item.id, title:item.title, price:item.price, qty:1 });
      persistCart();
      toast('Added to cart');
    }
    function persistCart(){ localStorage.setItem('zup_cart', JSON.stringify(cart)); }
    function restoreCart(){
      try{
        const c = JSON.parse(localStorage.getItem('zup_cart')||'{}');
        if (c && c.items) cart = c;
      }catch{}
    }
    function renderCart() {
      let subtotal = 0;
      const rows = (cart.items||[]).map(ci=>{
        const line = ci.price * ci.qty; subtotal += line;
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div><strong>${ci.title}</strong><div class="small muted">${money(ci.price)}</div></div>
              <div class="row">
                <button class="btn ghost" data-dec="${ci.id}">âˆ’</button>
                <div style="min-width:24px;text-align:center">${ci.qty}</div>
                <button class="btn ghost" data-inc="${ci.id}">+</button>
                <button class="btn ghost" data-del="${ci.id}">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      $('#cartItems').innerHTML = rows || '<div class="small muted">Your cart is empty</div>';
      const delivery = subtotal>0 ? 2.50 : 0;
      $('#cartSubtotal').innerHTML = `<strong>${money(subtotal)}</strong>`;
      $('#cartDelivery').innerHTML = `<strong>${money(delivery)}</strong>`;
      $('#cartTotal').textContent = money(subtotal + delivery);
    }
    function changeQty(id, delta){
      const it = cart.items.find(i=>i.id===id);
      if (!it) return;
      it.qty += delta;
      if (it.qty<=0) cart.items = cart.items.filter(i=>i.id!==id);
      persistCart(); renderCart();
    }
    function removeItem(id){
      cart.items = cart.items.filter(i=>i.id!==id);
      persistCart(); renderCart();
    }

    // Checkout
    function placeOrder(){
      if (!cart.items || cart.items.length===0) { toast('Your cart is empty'); return; }
      const accept = $('#termsChk').checked;
      if (!accept) { toast('Please accept the terms'); return; }
      const method = $('#payMethod').value;
      const total = Number($('#cartTotal').textContent.replace(/[^0-9.]/g,''))||0;
      // Vendor payment rules
      const v = Object.values(vendors).flat().find(x=>x.id===cart.vendorId);
      if (v) {
        if (method==='cash' && !v.pay.cash) { toast('This vendor does not accept Cash'); return; }
        if (method==='card' && !v.pay.card) { toast('This vendor does not accept Card'); return; }
      }
      if (method==='wallet') {
        if (wallet.balance < total) { toast('Insufficient wallet balance'); return; }
        wallet.balance -= total;
        wallet.tx.unshift({ id:'tx'+Date.now(), type:'debit', amount:total, note:`Order at ${cart.vendorName}` });
        localStorage.setItem('zup_wallet_tx', JSON.stringify(wallet.tx));
        $('#walletBalance').textContent = money(wallet.balance);
        confirmOrder('wallet');
      } else if (method==='card') {
        // Simulate Stripe redirect success
        setTimeout(()=>confirmOrder('card'), 600);
      } else if (method==='cash') {
        confirmOrder('cash');
      }
    }
    function confirmOrder(paidBy){
      // Generate delivery code for food/grocery only
      const needsCode = ['fast','grocery'].includes(cart.type);
      const code = needsCode ? (''+Math.floor(100000 + Math.random()*900000)) : '';
      const order = {
        id:'ord'+Date.now(), vendorId:cart.vendorId, vendorName:cart.vendorName, items:cart.items,
        total: $('#cartTotal').textContent, method: $('#payMethod').value, code,
        role:user.role, status:'active', createdAt: new Date().toISOString()
      };
      orders.unshift(order);
      localStorage.setItem('zup_orders', JSON.stringify(orders));
      if (needsCode) {
        alert(`Order placed.\nYour delivery code: ${code}\n\nPlease do not share your confirm delivery code with the seller until you receive and confirm the product in their presence.\nIf you lose the code, open Account â†’ Manage Orders and view the order.`);
      } else {
        alert('Order placed.');
      }
      cart = { vendorId:null, vendorName:'', type:'fast', items:[] };
      persistCart(); renderCart();
      closeModal('cartModal');
      openOrders();
    }

    // Orders (buyer/seller)
    function openOrders(){
      const html = orders.map(o=>{
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div>
                <div><strong>${o.vendorName||'Marketplace'}</strong></div>
                <div class="small muted">${o.items.length} item(s) â€¢ ${o.total}</div>
                <div class="small">Status: ${o.status}</div>
                ${o.code ? `<div class="badge success">Buyer Code: ${o.code}</div>` : ``}
              </div>
              <div class="row">
                <button class="btn ghost" data-view-order="${o.id}">View</button>
                ${user.role==='seller' && o.code ? `<button class="btn primary" data-confirm-order="${o.id}">Confirm delivery</button>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join('');
      $('#ordersList').innerHTML = html || '<div class="small muted">No orders yet</div>';
      openModal('ordersPage');
    }
    function viewOrder(id){
      const o = orders.find(x=>x.id===id); if(!o) return;
      const items = o.items.map(i=>`${i.title} Ã—${i.qty}`).join(', ');
      alert(`Order ${id}\nVendor: ${o.vendorName}\nItems: ${items}\nTotal: ${o.total}\nMethod: ${o.method}\n${o.code?('Your code: '+o.code):''}`);
    }
    function confirmDelivery(id){
      const o = orders.find(x=>x.id===id); if(!o) return;
      const code = prompt('Enter buyer code to confirm delivery:');
      if (!code) return;
      if (code === o.code) {
        o.status = 'completed';
        o.code = ''; // expire code
        localStorage.setItem('zup_orders', JSON.stringify(orders));
        toast('Delivery confirmed. Payout will be processed for card orders.');
        openOrders();
      } else {
        toast('Invalid code');
      }
    }

    // Wallet
    function openWallet(){
      $('#walletBalance').textContent = money(wallet.balance);
      const tx = wallet.tx.map(t=>`
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>${t.note||t.type}</div>
            <div style="font-weight:700">${t.type==='debit'?'-':''}${money(t.amount)}</div>
          </div>
        </div>
      `).join('');
      $('#walletTx').innerHTML = tx || '<div class="small muted">No transactions</div>';
      show('walletSection');
    }

    // Marketplace
    function renderMarketplace(){
      $('#marketplaceHeader').style.display = '';
      $('#marketplaceList').style.display = '';
      const q = ($('#marketSearch').value||'').toLowerCase();
      const list = marketplace.filter(m => m.title.toLowerCase().includes(q));
      $('#marketItems').innerHTML = list.map(m=>`
        <div class="card product">
          <img src="${m.img||'https://via.placeholder.com/160'}" alt="">
          <div class="meta">
            <div style="font-weight:700">${m.title}</div>
            <div class="small muted">${money(m.price)} â€¢ ${m.seller}</div>
            <div class="row" style="margin-top:6px">
              <a class="btn ghost" href="tel:">Call</a>
              <a class="btn ghost" href="https://wa.me/" target="_blank">WhatsApp</a>
              <button class="btn primary" onclick="alert('Open inâ€‘app chat')">Chat</button>
            </div>
          </div>
        </div>
      `).join('') || '<div class="small muted">No listings</div>';
    }

    // Sell form
    function submitMarketplace(){
      const item = {
        id:'p'+Date.now(),
        title: $('#mkTitle').value.trim(),
        price: parseFloat($('#mkPrice').value||'0'),
        img: '', seller: user.name||'You', cat: $('#mkCat').value
      };
      if (!item.title || !item.price) { toast('Enter title and price'); return; }
      marketplace.unshift(item);
      closeModal('sellForm');
      renderMarketplace();
      toast('Listing submitted');
    }

    // Manage food menu (vendors)
    function ensureFoodRow(container){
      const row = document.createElement('div');
      row.className = 'card';
      row.style.marginBottom = '10px';
      row.innerHTML = `
        <div class="field">
          <label class="small">Category</label>
          <select class="f-cat">
            <option value="fast">Fast food</option>
            <option value="grocery">Groceries</option>
          </select>
        </div>
        <div class="field"><label class="small">Title</label><input class="f-title" placeholder="Item title"></div>
        <div class="field"><label class="small">Price</label><input class="f-price" type="number" min="0" step="0.01"></div>
        <div class="field"><label class="small">Description</label><textarea class="f-desc" rows="2"></textarea></div>
        <div class="field">
          <label class="small">Images (up to 5)</label>
          <input class="f-imgs" type="file" accept="image/*" multiple>
        </div>
        <div class="row">
          <label class="small"><input type="checkbox" class="f-cash" checked> Cash</label>
          <label class="small"><input type="checkbox" class="f-card" checked> Card</label>
        </div>
      `;
      container.appendChild(row);
    }
    function openManageFood(){
      const wrap = $('#foodItemsForm'); wrap.innerHTML = '';
      ensureFoodRow(wrap);
      openModal('manageFood');
    }
    function saveFoodItems(){
      const wrap = $('#foodItemsForm');
      const cards = Array.from(wrap.querySelectorAll('.card'));
      const items = cards.map(c=>{
        return {
          cat: c.querySelector('.f-cat').value,
          title: c.querySelector('.f-title').value.trim(),
          price: parseFloat(c.querySelector('.f-price').value||'0'),
          desc: c.querySelector('.f-desc').value.trim(),
          pay: { cash: c.querySelector('.f-cash').checked, card: c.querySelector('.f-card').checked },
        };
      }).filter(x=>x.title && x.price>0);
      // Save into vendor dataset under current user as vendor
      items.forEach(it=>{
        const pool = vendors[it.cat];
        let me = pool.find(v=>v.id==='me');
        if (!me) { me = { id:'me', name:(user.name||'You'), rating:5.0, distance:'0.0km', items:[], pay:{cash:true,card:true} }; pool.unshift(me); }
        me.pay = it.pay;
        me.items.unshift({ id:'m'+Date.now()+Math.random(), title:it.title, price:it.price, img:'' });
      });
      closeModal('manageFood');
      toast('Menu updated');
    }

    // Emergency
    function openEmergency(){ openModal('emergencyPicker'); }
    function openDigital(){ openModal('digitalPicker'); }
    function handleEmergency(kind){
      // All emergency categories share same search area with simple list
      const providers = [
        { id:'e1', name:`${kind} Team A`, eta:'5 min' },
        { id:'e2', name:`${kind} Team B`, eta:'8 min' },
      ];
      const html = providers.map(p=>`
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div><strong>${p.name}</strong><div class="small muted">ETA ${p.eta}</div></div>
            <button class="btn primary" onclick="alert('Request sent')">Request</button>
          </div>
        </div>
      `).join('');
      $('#emergencyProviders').innerHTML = html;
    }

    // Instant booking cancel (reliable)
    function startLive(serviceType, hourlyRate){
      live.active = true; live.serviceType = serviceType; live.hourlyRate = hourlyRate || 20; live.startedAt = Date.now(); live.arrivedAt = null;
      if (navigator.geolocation) {
        live.watchId = navigator.geolocation.watchPosition(()=>{},()=>{});
      }
      live.timer = setInterval(()=>{}, 10000);
    }
    function markArrived(){
      if (!live.active) return;
      live.arrivedAt = Date.now();
      // charges start after 7 minutes
    }
    function endJob(){
      if (!live.active) return;
      const cost = calcServiceCost();
      stopLive();
      alert(`Service ended. Cost: ${money(cost)}`);
    }
    function calcServiceCost(){
      if (live.serviceType==='transport') {
        // Simulate fixed at end
        return 7.50 + Math.random()*5;
      }
      // Hourly rate after 7 minutes grace from arrival
      if (!live.arrivedAt) return 0;
      const ms = Math.max(0, Date.now() - (live.arrivedAt + 7*60*1000));
      const hours = ms/3600000;
      return hours * (live.hourlyRate||20);
    }
    function cancelLive(){
      if (!live.active) { toast('No active booking'); return; }
      if (!confirm('Cancel current request?')) return;
      stopLive();
      alert('Request cancelled');
      // return to related service page
      show(null); // back to home default
    }
    function stopLive(){
      live.active=false;
      if (live.watchId!=null) { try{navigator.geolocation.clearWatch(live.watchId);}catch{} live.watchId=null; }
      if (live.timer){ clearInterval(live.timer); live.timer=null; }
      live.startedAt=null; live.arrivedAt=null; live.serviceType=null;
    }

    // Panic
    function sendPanic(){
      alert('Emergency alert sent with your location.');
      closeModal('panicModal');
    }

    // Modals
    function openModal(id){ $('#'+id).classList.add('open'); }
    function closeModal(id){ $('#'+id).classList.remove('open'); }

    // Back buttons
    function hookBacks(){
      $$('.back').forEach(b=>{
        b.addEventListener('click', ()=>{
          const t = b.getAttribute('data-back');
          if (t==='home') { show(null); }
          if (t==='vendors') { show('vendorsSection'); }
        });
      });
    }

    // Bindings
    function bind() {
      // Header buttons
      $('#notifBtn').addEventListener('click', ()=> alert('Notifications will show here. Cart alerts are included.'));
      $('#accountBtn').addEventListener('click', ()=> openOrders());

      // Services
      $$('#servicesGrid .service').forEach(s=>{
        s.addEventListener('click', ()=>{
          const type = s.getAttribute('data-service');
          if (type==='food') return openFoodEntry();
          if (type==='grocery') return openFoodEntry();
          if (type==='marketplace') { renderMarketplace(); return; }
          if (type==='emergencyRoot') return openEmergency();
          if (type==='digitalRoot') return openDigital();
          if (type==='transport') { startLive('transport'); alert('Transport request created. It will be charged when trip ends. Use Cancel to stop.'); return; }
          // Other service: show search and allow instant request
          alert('Open providers list (with search). Billing starts 7 minutes after Arrived.');
          startLive('service', 25);
        });
      });

      // Emergency
      $('#btnRoadside').addEventListener('click', ()=> handleEmergency('Roadside'));
      $('#emergencySearch').addEventListener('input', ()=> {/* filtering placeholder */});
      $$('#emergencyPicker [data-emer]').forEach(b=> b.addEventListener('click', ()=> handleEmergency(b.getAttribute('data-emer'))));
      $$('#emergencyPicker [data-close="emergencyPicker"]').forEach(b=> b.addEventListener('click', ()=> closeModal('emergencyPicker')));

      // Digital
      $$('#digitalPicker [data-close="digitalPicker"]').forEach(b=> b.addEventListener('click', ()=> closeModal('digitalPicker')));

      // Food entry
      $$('#foodEntry [data-close="foodEntry"]').forEach(b=> b.addEventListener('click', ()=> closeModal('foodEntry')));
      $$('#foodEntry [data-food]').forEach(b=> b.addEventListener('click', ()=> listVendors(b.getAttribute('data-food'))));
      $('#foodSearch').addEventListener('input', ()=>{
        // re-filter based on current pick; default fast
        // no-op until vendor type chosen
      });

      // Vendor list open
      $('#vendorsList').addEventListener('click', e=>{
        const btn = e.target.closest('[data-open-menu]'); if (!btn) return;
        openMenu(btn.getAttribute('data-kind'), btn.getAttribute('data-open-menu'));
      });
      // Add to cart
      $('#menuItems').addEventListener('click', e=>{
        const btn = e.target.closest('[data-add]'); if (!btn) return;
        addToCart(btn.getAttribute('data-kind'), btn.getAttribute('data-add'), btn.getAttribute('data-id'));
      });
      // Open cart
      $('#openCartBtn').addEventListener('click', ()=>{ renderCart(); openModal('cartModal'); });

      // Cart change
      $('#cartItems').addEventListener('click', e=>{
        const t = e.target;
        const inc = t.closest('[data-inc]'); if (inc) { changeQty(inc.getAttribute('data-inc'), +1); return; }
        const dec = t.closest('[data-dec]'); if (dec) { changeQty(dec.getAttribute('data-dec'), -1); return; }
        const del = t.closest('[data-del]'); if (del) { removeItem(del.getAttribute('data-del')); return; }
      });
      $('#placeOrderBtn').addEventListener('click', placeOrder);
      $('#openTerms').addEventListener('click', ()=> { $('#termsModal').style.display='flex'; });
      $('#termsClose').addEventListener('click', ()=> { $('#termsModal').style.display='none'; });

      // Marketplace
      $('#sellBtn').addEventListener('click', ()=> openModal('sellForm'));
      $('#mkSubmit').addEventListener('click', submitMarketplace);
      $('#marketSearch').addEventListener('input', renderMarketplace);

      // Orders
      $('#ordersList').addEventListener('click', e=>{
        const v = e.target.closest('[data-view-order]'); if (v) return viewOrder(v.getAttribute('data-view-order'));
        const c = e.target.closest('[data-confirm-order]'); if (c) return confirmDelivery(c.getAttribute('data-confirm-order'));
      });

      // Wallet
      $('#walletAdd').addEventListener('click', ()=> toast('Topâ€‘up coming soon'));
      $('#walletCashOut').addEventListener('click', ()=> toast('Cash out coming soon'));
      $('#walletSend').addEventListener('click', ()=>{
        const to = prompt('Enter recipient username or email:'); if (!to) return;
        const amt = parseFloat(prompt('Amount')||'0'); if (!amt || amt<=0) return;
        if (amt > wallet.balance) return toast('Insufficient balance');
        wallet.balance -= amt; wallet.tx.unshift({ id:'tx'+Date.now(), type:'debit', amount:amt, note:`Send to ${to}` });
        localStorage.setItem('zup_wallet_tx', JSON.stringify(wallet.tx));
        $('#walletBalance').textContent = money(wallet.balance); openWallet();
      });
      $('#walletCards').addEventListener('click', ()=> {
        const line = wallet.cards.map(c=>`${c.brand.toUpperCase()} â€¢â€¢â€¢â€¢ ${c.last4}`).join('\n') || 'No saved cards';
        alert(line);
      });

      // Manage Food menu
      $('#addFoodRow').addEventListener('click', ()=> ensureFoodRow($('#foodItemsForm')));
      $('#saveFoodItems').addEventListener('click', saveFoodItems);

      // Panic
      $('#panicSend').addEventListener('click', sendPanic);

      // Bottom nav
      $$('.nav .item').forEach(i=> i.addEventListener('click', ()=>{
        const tab = i.getAttribute('data-nav');
        $$('.nav .item').forEach(n=>n.classList.remove('active')); i.classList.add('active');
        if (tab==='home') { show(null); }
        if (tab==='wallet') { openWallet(); }
        if (tab==='orders') { openOrders(); }
        if (tab==='profile') { openManageFood(); } // open food manage as main actionable in profile
      }));

      // Back arrows
      hookBacks();

      // Close buttons for modals
      $$('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeModal(b.getAttribute('data-close'))));

      // Marketplace default hidden until user taps Marketplace
      renderHeader();
    }

    // Init
    function init() {
      renderHeader();
      initMap();
      restoreCart();
      bind();
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
