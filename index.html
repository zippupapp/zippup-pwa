<!DOCTYPE html>
<html lang="en">
<head>
  <style>
  /* Make the Checkout row in the cart modal always visible */
  #cartModal .sheet .body { max-height: 70vh; overflow: auto; }
  #cartModal .sheet .body .row:last-child { position: sticky; bottom: 0; background:#fff; padding-top:10px; border-top:1px solid var(--border); }
  /* Small ‚Äúactive request‚Äù bar */
  .active-request-bar { position: fixed; left:16px; right:16px; bottom:120px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 8px 24px rgba(17,24,39,.08); z-index:1000; padding:10px; display:none }
  .active-request-bar .btn { padding:8px 12px; border-radius:10px; border:0; font-weight:600; cursor:pointer }
  .active-request-bar .primary { background:#2563EB; color:#fff }
  .active-request-bar .ghost { background:#F3F4F6 }
</style
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ZippUp ‚Äî On‚ÄëDemand Services</title>
  <meta name="theme-color" content="#2563EB"/>
  <link rel="manifest" href="manifest.json"/>

  <!-- Leaflet (tracking map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Stripe -->
  <script defer src="https://js.stripe.com/v3"></script>

  <!-- Google Places (autocomplete for transport addresses) -->
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6IF-c6Ce0iSpEDITpaUGJ20y7_ZZxHl0&libraries=places"></script>

  <style>
    :root { --primary:#2563EB; --primary-600:#1D4ED8; --bg:#F9FAFB; --card:#FFFFFF; --text:#111827; --muted:#6B7280; --danger:#DC2626; --success:#10B981; --border:#E5E7EB; --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.08) }
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; background:var(--bg); color:var(--text) }
    header { position:sticky; top:0; z-index:20; background:var(--card); border-bottom:1px solid var(--border) }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px }
    .greet { display:flex; flex-direction:column }
    .small { color:var(--muted); font-size:13px }
    .search { padding:16px }
    .search .box { display:flex; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px }
    .search input { flex:1; border:0; outline:0; font-size:15px }
    .section { padding:12px 16px }
    .title { font-weight:700; margin-bottom:10px }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px }
    @media(min-width:720px){ .grid{ grid-template-columns:repeat(3,minmax(0,1fr)) } }
    .card { background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow) }
    .service { cursor:pointer; transition:transform .1s ease }
    .service:hover { transform:translateY(-2px) }
    .row { display:flex; gap:10px; align-items:center }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; font-size:12px; border-radius:999px; background:#EEF2FF; color:#3730A3 }
    .badge { padding:4px 8px; font-size:12px; border-radius:999px }
    .success{ background:#ECFDF5; color:#065F46 }
    .muted { color:var(--muted) }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600 }
    .btn.primary { background:var(--primary); color:#fff }
    .btn.primary:hover { background:var(--primary-600) }
    .btn.ghost { background:#F3F4F6 }
    .btn.block { width:100% }
    .floating-panic { position:fixed; right:16px; bottom:80px; width:60px; height:60px; border-radius:50%; background:var(--danger); color:#fff; border:0; font-size:20px; box-shadow:var(--shadow); z-index:16; display:flex; align-items:center; justify-content:center }
    .nav { position:fixed; left:0; right:0; bottom:0; display:flex; justify-content:space-around; background:#fff; border-top:1px solid var(--border); padding:8px 0; z-index:15 }
    .nav button { background:none; border:0; padding:8px 10px; border-radius:10px; color:var(--muted) }
    .nav button.active { color:var(--primary); background:#EFF6FF }
    .page { display:none; padding-bottom:80px }
    .page.active { display:block }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding:16px }
    .modal.open { display:flex }
    .sheet { width:100%; max-width:720px; background:#fff; border-radius:16px; border:1px solid var(--border); box-shadow:var(--shadow) }
    .sheet .head { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between }
    .sheet .body { padding:16px }
    .list { display:flex; flex-direction:column; gap:12px }
    .provider { border:1px solid var(--border); border-radius:14px; padding:12px }
    .controls { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
    #track-map { width:100%; height:360px; border-radius:12px; border:1px solid var(--border) }
    #profileMenu { position:absolute; right:0; top:110%; display:none; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:180px; z-index:30 }
    #profileMenu .btn { width:100%; justify-content:flex-start }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid var(--border); background:#eef2ff; display:flex; align-items:center; justify-content:center; font-size:18px }
    .rating { color:#F59E0B; font-size:12px }
    .verify { color:#2563EB; font-size:14px }
    .stop-row { display:flex; gap:8px; align-items:center }
    /* Toggle switch */
    .switch { position:relative; display:inline-block; width:48px; height:28px }
    .switch input { display:none }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#d1d5db; transition:.2s; border-radius:999px }
    .slider:before { position:absolute; content:""; height:22px; width:22px; left:3px; top:3px; background:#fff; transition:.2s; border-radius:999px }
    .switch input:checked + .slider { background:#10B981 }
    .switch input:checked + .slider:before { transform:translateX(20px) }
  </style>
</head>
<body>
  <!-- One-time SW off to prevent stale cache on phone -->
  <script>
    (function(){
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
      }
    })();
  </script>

  <header>
    <div class="row">
      <div class="greet">
        <strong>Hello, <span id="userName">Guest</span></strong>
        <span class="small">üìç <span id="userLoc">Detecting location‚Ä¶</span></span>
      </div>
      <div class="row">
        <button class="btn ghost" id="notifBtn" type="button">üîî</button>
        <div style="position:relative">
          <button class="btn ghost" id="cartBtn" type="button">üõí</button>
          <span id="headerCartBadge" style="position:absolute; top:-6px; right:-6px; background:#DC2626; color:#fff; border-radius:999px; font-size:12px; padding:0 6px; line-height:18px; min-width:18px; text-align:center;">0</span>
        </div>
        <div style="position:relative">
          <button class="btn ghost" id="profileBtn" type="button">üë§ Account</button>
          <div id="profileMenu">
            <button class="btn ghost" id="menuProfile" type="button">üë§ Profile</button>
            <button class="btn ghost" id="menuWallet" type="button">üí∞ Wallet</button>
            <button class="btn ghost" id="menuTopup" type="button">‚ö° Top‚Äëup</button>
            <button class="btn ghost" id="menuSupport" type="button">üÜò Contact Support</button>
            <button class="btn ghost" id="menuLogout" type="button">üö™ Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Home -->
  <main id="page-home" class="page active">
    <section class="search">
      <div class="box">
        <input id="search" placeholder="Search transport, food, services, emergency‚Ä¶"/>
        <button class="btn ghost" id="voiceBtn" type="button">üé§</button>
        <button class="btn primary" id="searchBtn" type="button">Search</button>
      </div>
    </section>

    <section class="section">
      <div class="title">Emergency</div>
      <div class="grid" id="emergencyGrid"></div>
    </section>

    <section class="section">
      <div class="title">All Services</div>
      <div class="grid" id="servicesGrid"></div>
    </section>

    <section class="section">
      <div class="title">Recent</div>
      <div id="recentList"></div>
    </section>
  </main>

  <!-- Services landing -->
  <main id="page-services" class="page">
    <section class="section">
      <div class="title">Services</div>
      <div class="grid" id="servicesAllGrid"></div>
    </section>
  </main>

  <!-- Bookings landing -->
  <main id="page-bookings" class="page">
    <section class="section">
      <div class="title">My Bookings</div>
      <div id="bookingsList"></div>
    </section>
  </main>

  <!-- Marketplace landing -->
  <main id="page-marketplace" class="page">
    <section class="search">
      <div class="box">
        <input id="mpSearch" placeholder="Search products (e.g., phone, shoes, blender)‚Ä¶"/>
        <button class="btn ghost" id="mpVoice" type="button">üé§</button>
        <button class="btn primary" id="mpSearchBtn" type="button">Search</button>
      </div>
    </section>
    <section class="section">
      <div class="controls" id="mpChips"></div>
    </section>
    <section class="section">
      <div class="title">Products</div>
      <div class="grid" id="mpGrid"></div>
    </section>
    <div class="cart-fab">
      <button class="btn primary" id="openCartBtn" type="button">üõí Cart (<span id="cartCount">0</span>)</button>
    </div>
  </main>

  <!-- Profile -->
  <main id="page-profile" class="page">
    <section class="section">
      <div class="title">Profile</div>
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row">
            <div style="width:48px;height:48px;border-radius:50%;background:#E5EDFF;display:flex;align-items:center;justify-content:center">üë§</div>
            <div style="margin-left:8px">
              <div><strong id="profName">Demo User</strong> <span class="small muted">(Public name used in bookings)</span></div>
              <div class="small" id="profEmail">demo@zippup.com</div>
            </div>
          </div>
          <button class="btn primary" id="editProfileBtn" type="button">Edit</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div><strong>Availability</strong><div class="small muted">Go Offline / Available</div></div>
          <label class="switch">
            <input type="checkbox" id="availToggle" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="list" style="margin-top:12px">
        <button class="btn ghost" id="manageServicesBtn" type="button">Manage Services</button>
        <button class="btn ghost" id="manageProductsBtn" type="button">Manage Products</button>
        <button class="btn ghost" id="emergencyContactsBtn" type="button">Emergency Contacts</button>
        <button class="btn ghost" id="providerVerifyBtn" type="button">Become Verified Provider</button>
        <button class="btn ghost" id="supportBtn" type="button">Contact Support</button>
      </div>
    </section>
  </main>

  <!-- Wallet -->
  <main id="page-wallet" class="page">
    <section class="section">
      <div class="title">Wallet</div>
      <div class="card">Balance: <strong>$245.80</strong></div>
    </section>
  </main>

  <!-- Top-up -->
  <main id="page-topup" class="page">
    <section class="section">
      <div class="title">Top‚Äëup (Digital)</div>
      <div class="grid">
        <div class="card service" data-topup="airtime"><div class="row"><div style="font-size:24px">üìû</div><h4>Buy Airtime</h4></div></div>
        <div class="card service" data-topup="data"><div class="row"><div style="font-size:24px">üì∂</div><h4>Data Bundles</h4></div></div>
        <div class="card service" data-topup="bills"><div class="row"><div style="font-size:24px">üí°</div><h4>Pay Bills</h4></div></div>
      </div>
    </section>
  </main>

  <!-- Manage Services -->
  <main id="page-manage-services" class="page">
    <section class="section">
      <div class="title">Manage Services</div>
      <div class="list">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div><strong>Your Services</strong></div>
              <div class="small muted">Add, edit or remove services you offer</div>
            </div>
            <button class="btn primary" id="addServiceBtn" type="button">+ Add Service</button>
          </div>
        </div>
        <div id="servicesManageList" class="list"></div>
      </div>
    </section>
  </main>

  <!-- Manage Products -->
  <main id="page-manage-products" class="page">
    <section class="section">
      <div class="title">Manage Products</div>
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div><strong>Your Products</strong></div>
            <div class="small muted">Add, edit or remove marketplace products (up to 10 images)</div>
          </div>
          <button class="btn primary" id="addProductBtn" type="button">+ Add Product</button>
        </div>
      </div>
      <div id="productsManageList" class="list" style="margin-top:12px"></div>
    </section>
  </main>

  <!-- Emergency Contacts -->
  <main id="page-emergency-contacts" class="page">
    <section class="section">
      <div class="title">Emergency Contacts</div>
      <div class="card">
        <div class="small muted">Add up to 5 contacts who receive panic alerts.</div>
        <div id="contactsList" class="list" style="margin-top:10px"></div>
        <button class="btn primary" id="addContactBtn" type="button">+ Add Contact</button>
      </div>
    </section>
  </main>

  <!-- Verify Provider -->
  <main id="page-verify-provider" class="page">
    <section class="section">
      <div class="title">Become Verified Provider</div>
      <div class="card">
        <div class="small muted">Upload ID and documents. Admin will review and approve or decline.</div>
        <div class="list" style="margin-top:10px">
          <input placeholder="Full name" id="vpName" style="padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <input placeholder="Service category (e.g., Driver, Plumber)" id="vpCategory" style="padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <input placeholder="ID number" id="vpId" style="padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <button class="btn primary" id="vpSubmit" type="button">Submit for Verification</button>
        </div>
      </div>
      <div id="vpStatus" class="small" style="margin-top:10px;color:#2563EB"></div>
    </section>
  </main>

  <!-- Contact Support -->
  <main id="page-support" class="page">
    <section class="section">
      <div class="title">Contact Support</div>
      <div class="card">
        <div class="list">
          <input id="supSubject" placeholder="Subject" style="padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <textarea id="supMessage" rows="5" placeholder="Describe your issue or question‚Ä¶" style="padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          <button class="btn primary" id="supSend" type="button">Send Message</button>
        </div>
      </div>
    </section>
  </main>

  <button class="floating-panic" id="panicBtn" type="button">üö®</button>

  <nav class="nav">
    <button data-page="home" class="active" type="button">üè† Home</button>
    <button data-page="services" type="button">üîß Services</button>
    <button data-page="bookings" type="button">üìã Bookings</button>
    <button data-page="marketplace" type="button">üõçÔ∏è Marketplace</button>
  </nav>

  <!-- Providers Modal -->
  <div class="modal" id="providersModal">
    <div class="sheet">
      <div class="head">
        <strong id="providersTitle">Providers</strong>
        <button class="btn ghost" id="closeProviders" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list" id="providersList"></div>
      </div>
    </div>
  </div>

  <!-- Booking Form Modal (Scheduled) -->
  <div class="modal" id="bookingModal">
    <div class="sheet">
      <div class="head">
        <strong>Book Service</strong>
        <button class="btn ghost" id="closeBooking" type="button">‚úñ</button>
      </div>
      <div class="body">
        <form id="bookingForm" class="list">
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <div class="small">Date</div>
              <input id="bkDate" type="date" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Time</div>
              <input id="bkTime" type="time" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div>
            <div class="small">Address</div>
            <input id="bkAddress" required placeholder="Enter address" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          </div>
          <div>
            <div class="small">Details</div>
            <textarea id="bkDesc" rows="3" placeholder="Describe the job‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          </div>
          <button class="btn primary block" type="submit">Send Booking Request</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Transport Instant Booking Modal -->
  <div class="modal" id="tiModal">
    <div class="sheet">
      <div class="head">
        <strong>Ride Details</strong>
        <button class="btn ghost" id="tiClose" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div>
            <div class="small">Pickup address</div>
            <div class="row" style="gap:8px">
              <input id="tiPickup" placeholder="Detecting current location‚Ä¶" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px"/>
              <button class="btn ghost" id="tiUseCurrent" type="button">üìç Use current</button>
            </div>
          </div>
          <div>
            <div class="small">Destination address</div>
            <input id="tiDestination" placeholder="Where are you going?" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          </div>
          <div>
            <div class="small">Stops (optional)</div>
            <div id="tiStops" class="list"></div>
            <div class="row" style="gap:8px;margin-top:6px">
              <button class="btn ghost" id="tiAddStop" type="button">Ôºã Add stop</button>
              <button class="btn ghost" id="tiRemoveStop" type="button">‚àí Remove stop</button>
            </div>
            <div class="small muted">Up to 5 stops, each with suggestions.</div>
          </div>
          <button class="btn primary" id="tiStart" type="button">Start Instant Request</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Instant Request Modal (90s) -->
  <div class="modal" id="instantModal">
    <div class="sheet">
      <div class="head">
        <strong id="instantTitle">Contacting provider‚Ä¶</strong>
        <button class="btn ghost" id="cancelInstant" type="button">Cancel</button>
      </div>
      <div class="body">
        <div class="card">
          <div>Time left: <strong id="countdown">90</strong>s</div>
          <div class="small muted" id="instantHint">Waiting for provider to accept‚Ä¶</div>
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn ghost" id="findOthers" type="button">Find other providers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking Modal -->
  <div class="modal" id="trackModal">
    <div class="sheet">
      <div class="head">
        <strong>Live Tracking</strong>
        <button class="btn ghost" id="closeTrack" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="trackStatus" class="small muted">Provider accepted. En route‚Ä¶</div>
        <div class="row" style="gap:8px;margin:8px 0">
          <button class="btn ghost" id="trackChatBtn" type="button">üí¨ Chat</button>
          <a class="btn ghost" id="trackCallBtn" href="#" type="button">üìû Call</a>
        </div>
        <div id="trackMapWrap" style="margin-top:10px"><div id="track-map"></div></div>
      </div>
    </div>
  </div>

  <!-- Category Options Modal (Transport / Food) -->
  <div class="modal" id="categoryOptionsModal">
    <div class="sheet">
      <div class="head">
        <strong id="categoryOptionsTitle">Options</strong>
        <button class="btn ghost" id="closeCategoryOptions" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="categoryOptionsList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Items/Search Modal -->
  <div class="modal" id="itemsModal">
    <div class="sheet">
      <div class="head">
        <strong id="itemsTitle">Find Items</strong>
        <button class="btn ghost" id="closeItems" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="row" style="gap:8px;margin-bottom:10px">
          <input id="itemSearch" placeholder="Say or type what you need (e.g., pizza, plumber, tire)‚Ä¶" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px"/>
          <button class="btn ghost" id="itemVoice" type="button">üé§</button>
          <button class="btn primary" id="itemGo" type="button">Search</button>
        </div>
        <div id="itemChips" class="controls"></div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal" id="cartModal">
    <div class="sheet">
      <div class="head">
        <strong>My Cart</strong>
        <button class="btn ghost" id="closeCart" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="cartList" class="list"></div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="price">Total: $<span id="cartTotal">0.00</span></div>
          <button class="btn primary" id="checkoutBtn" type="button">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" id="checkoutModal">
    <div class="sheet">
      <div class="head">
        <strong>Checkout</strong>
        <button class="btn ghost" id="closeCheckout" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div class="list">
          <div class="row" style="gap:12px">
            <div style="flex:1">
              <div class="small">Full Name</div>
              <input id="chkName" placeholder="Your full name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Phone</div>
              <input id="chkPhone" placeholder="e.g. +1234567890" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div class="row" style="gap:12px">
            <div style="flex:2">
              <div class="small">Street / Address</div>
              <input id="chkAddress" placeholder="e.g. 12 Main St" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
            <div style="flex:1">
              <div class="small">Flat / House No.</div>
              <input id="chkUnit" placeholder="e.g. Apt 2B" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"/>
            </div>
          </div>
          <div>
            <div class="small">Delivery Notes</div>
            <textarea id="chkNotes" rows="3" placeholder="Any special instructions‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></textarea>
          </div>
          <div>
            <div class="small">Payment Method</div>
            <div class="controls">
              <label><input type="radio" name="payMethod" value="card" checked/> Card (funds held until delivery)</label>
              <label><input type="radio" name="payMethod" value="cash"/> Cash (you accept the risk)</label>
            </div>
          </div>
          <label class="terms">
            <input type="checkbox" id="chkTerms"/>
            <span>I accept the Terms.</span>
          </label>
          <button class="btn primary" id="placeOrderBtn" type="button">Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Status Modal -->
  <div class="modal" id="orderModal">
    <div class="sheet">
      <div class="head">
        <strong>Order Status</strong>
        <button class="btn ghost" id="closeOrder" type="button">‚úñ</button>
      </div>
      <div class="body">
        <div id="orderInfo" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // Config
    const BASE_API = 'https://zippup-backend-v3.onrender.com';
    const STRIPE_PK = 'pk_test_51RsMiZGMO6NwkYaMOEK0rl7KZXpKnYGJYTvXl2iycbSWj0biC7zD51ODQvlfAM1yWCKICPWUhNSs8dunOWxPdhuA00VyFwvHjd';
    const FALLBACK_PAYMENT_LINK = '';

    let user = { name:'Guest', email:'demo@zippup.com' };
    let coords = null;
    let selectedProvider = null;
    let requestId = null;
    let instantTimer = null;
    let instantLeft = 90;
    let map, userMarker, providerMarker, trackPoll = null;
    let lastCategory = null;
    const activeRequests = {};

    // Elements / helpers
    const $ = (id)=>document.getElementById(id);
    function showPage(page){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      (document.getElementById('page-'+page) || document.getElementById('page-home')).classList.add('active');
    }

    // Header/menu buttons
    $('notifBtn').onclick = ()=>alert('Notifications (coming soon)');
    $('profileBtn').onclick = (e)=>{ e.stopPropagation(); const m=$('profileMenu'); m.style.display = (m.style.display==='block'?'none':'block'); };
    document.addEventListener('click', ()=>{ const m=$('profileMenu'); if (m) m.style.display='none'; });
    $('menuProfile').onclick = ()=>{ $('profileMenu').style.display='none'; showPage('profile'); };
    $('menuWallet').onclick  = ()=>{ $('profileMenu').style.display='none'; showPage('wallet'); };
    $('menuTopup').onclick   = ()=>{ $('profileMenu').style.display='none'; showPage('topup'); };
    $('menuSupport').onclick = ()=>{ $('profileMenu').style.display='none'; showPage('support'); };
    $('menuLogout').onclick  = ()=>{ $('profileMenu').style.display='none'; alert('Logged out'); };

    // Footer nav
    document.querySelectorAll('.nav button').forEach(b=>{
      b.onclick = ()=>{ document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); showPage(b.dataset.page); };
    });

    // Profile page buttons
    $('manageServicesBtn').onclick   = ()=>showPage('manage-services');
    $('manageProductsBtn').onclick   = ()=>showPage('manage-products');
    $('emergencyContactsBtn').onclick= ()=>showPage('emergency-contacts');
    $('providerVerifyBtn').onclick   = ()=>showPage('verify-provider');
    $('supportBtn').onclick          = ()=>showPage('support');

    // Availability switch
    const availKey = 'zippup_availability';
    $('availToggle').checked = localStorage.getItem(availKey) === 'on';
    $('availToggle').onchange = (e)=>{ localStorage.setItem(availKey, e.target.checked ? 'on' : 'off'); alert('Availability: ' + (e.target.checked ? 'Available' : 'Offline')); };

    // Panic button
    $('panicBtn').onclick = async () => {
      if (!confirm('Confirm PANIC alert?')) return;
      try{
        const body = { type:'panic', userPublicName: user.name, location: coords ? { latitude:coords.lat, longitude:coords.lng } : null };
        const r = await fetch(`${BASE_API}/api/emergency/alert`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const d = await r.json().catch(()=>({}));
        if (r.ok){ alert('Panic alert sent'); if (d.trackingUrl) location.href=d.trackingUrl; }
        else alert('Alert sent (fallback).');
      }catch{ alert('Alert sent (no GPS).'); }
    };

    // Init user/location
    document.addEventListener('DOMContentLoaded', () => {
      $('userName').textContent = user.name;
      initLocation();
      renderServices(); renderEmergency(); renderRecent(); renderServicesAll(); renderBookings();
      initMarketplace();

      // Cart/Checkout bindings
      $('cartBtn').onclick = (e)=>{ e.preventDefault(); showPage('marketplace'); renderCart(); $('cartModal').classList.add('open'); };
      $('openCartBtn').onclick = ()=>{ renderCart(); $('cartModal').classList.add('open'); };
      $('closeCart').onclick = ()=> $('cartModal').classList.remove('open');
      $('checkoutBtn').onclick = ()=>{ $('cartModal').classList.remove('open'); $('checkoutModal').classList.add('open'); };
      $('closeCheckout').onclick = ()=> $('checkoutModal').classList.remove('open');
      $('closeOrder').onclick = ()=> $('orderModal').classList.remove('open');
    });

    async function initLocation() {
      try {
        const pos = await new Promise((res, rej)=>navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:10000 }));
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const name = await reverseGeocode(coords.lat, coords.lng);
        $('userLoc').textContent = name || 'Unknown';
      } catch { $('userLoc').textContent = 'Location unavailable'; }
    }
    async function reverseGeocode(lat,lng){
      try {
        const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
        const d = await r.json(); return (d.locality || d.city || 'Unknown') + ', ' + (d.countryName || '');
      } catch { return null; }
    }

    // Services / Emergency
    const SERVICES = [
      { id:'transport',    name:'Transport',         icon:'üöó', desc:'Ride & moving',               instant:true,  scheduled:true },
      { id:'food',         name:'Food',              icon:'üçî', desc:'Restaurant & grocery',       instant:true,  scheduled:true },
      { id:'tech',         name:'Tech Services',     icon:'üîß', desc:'Phone/computer repair',      instant:true,  scheduled:true },
      { id:'home',         name:'Home Services',     icon:'üè†', desc:'Cleaning & maintenance',     instant:true,  scheduled:true },
      { id:'construction', name:'Construction',      icon:'üèóÔ∏è', desc:'Builders & electricians',   instant:false, scheduled:true },
      { id:'auto',         name:'Automobile Repair', icon:'üõ†Ô∏è', desc:'Mechanics, tires, roadside', instant:true,  scheduled:true },
      { id:'others',       name:'Others',            icon:'üéØ', desc:'Events, tutors, more',       instant:false, scheduled:true },
    ];
    const EMERGENCY = [
      { id:'ambulance', name:'Ambulance',     icon:'üöë' },
      { id:'fire',      name:'Fire Service',  icon:'üöí' },
      { id:'towing',    name:'Towing',        icon:'üöõ' },
      { id:'security',  name:'Security',      icon:'üõ°Ô∏è' },
      { id:'roadside',  name:'Roadside',      icon:'üîß' },
    ];

    function renderServices(){
      const grid = $('servicesGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div><div class="row" style="margin-top:8px">${s.instant?'<span class="pill">Instant</span>':''}${s.scheduled?'<span class="pill">Scheduled</span>':''}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderServicesAll(){
      const grid = $('servicesAllGrid'); grid.innerHTML='';
      SERVICES.forEach(s=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${s.icon}</div><h4>${s.name}</h4></div><div class="small muted" style="margin-top:6px">${s.desc}</div>`;
        el.onclick = ()=> openCategory(s.id, s.name);
        grid.appendChild(el);
      });
    }
    function renderEmergency(){
      const grid = $('emergencyGrid'); grid.innerHTML='';
      EMERGENCY.forEach(e=>{
        const el=document.createElement('div'); el.className='card service';
        el.innerHTML = `<div class="row"><div style="font-size:28px">${e.icon}</div><h4>${e.name}</h4></div><div class="small muted" style="margin-top:6px">${e.id==='roadside'?'Describe the issue':'Find nearest/available'}</div><div class="row" style="margin-top:8px"><span class="pill">Instant</span></div>`;
        el.onclick = ()=>{ if (e.id==='roadside') openItemsModal('roadside'); else openEmergency(e.id, e.name); };
        grid.appendChild(el);
      });
    }
    function renderRecent(){
      $('recentList').innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>`;
    }
    function renderBookings(){
      $('bookingsList').innerHTML = `
        <div class="card"><div class="row" style="justify-content:space-between"><div>üîß Phone Repair</div><span class="badge" style="background:#FFF7ED;color:#9A3412">scheduled</span></div><div class="small muted" style="margin-top:6px">Tomorrow 11:00</div></div>
        <div class="card" style="margin-top:8px"><div class="row" style="justify-content:space-between"><div>üöó Ride to Airport</div><span class="badge success">completed</span></div><div class="small muted" style="margin-top:6px">2h ago</div></div>`;
    }

    // Category flow
    function openCategory(catId, label){
      lastCategory = catId;
      if (activeRequests[catId]) { alert(`You already have a pending ${label} request.`); return; }
      if (catId==='transport') {
        openCategoryOptions('Transport Options', [
          { id:'ride',   name:'Ride / Taxi', icon:'üöó' },
          { id:'moving', name:'Truck / Backie', icon:'üöö' },
        ], opt=>{
          $('categoryOptionsModal').classList.remove('open');
          $('providersTitle').textContent = opt.name + ' ‚Äî Providers';
          fetchProviders('transport', opt.id).then(renderProviders);
          $('providersModal').classList.add('open');
        });
        return;
      }
      if (catId==='food') {
        openCategoryOptions('Food Options', [
          { id:'fastfood', name:'Fast Food', icon:'üçî' },
          { id:'grocery',  name:'Groceries', icon:'üõí' },
        ], opt=>{
          $('categoryOptionsModal').classList.remove('open');
          openItemsModal(opt.id);
        });
        return;
      }
      $('providersTitle').textContent = label + ' ‚Äî Providers';
      fetchProviders(catId).then(renderProviders);
      $('providersModal').classList.add('open');
    }
    function openCategoryOptions(title, options, onPick){
      $('categoryOptionsTitle').textContent = title;
      $('categoryOptionsList').innerHTML='';
      options.forEach(o=>{
        const el=document.createElement('div'); el.className='provider';
        el.innerHTML = `<div class="row" style="justify-content:space-between"><div class="row"><div style="font-size:24px">${o.icon||'‚Ä¢'}</div><div><strong>${o.name}</strong></div></div><button class="btn primary" type="button">Choose</button></div>`;
        el.querySelector('button').onclick=()=>onPick(o);
        $('categoryOptionsList').appendChild(el);
      });
      $('categoryOptionsModal').classList.add('open');
      $('closeCategoryOptions').onclick=()=>$('categoryOptionsModal').classList.remove('open');
    }

    // Items modal (search chips)
    function openItemsModal(kind){
      $('itemsTitle').textContent = (kind==='fastfood'?'Fast Food':kind==='grocery'?'Groceries':'Find Service');
      const chipsMap = {
        fastfood:['pizza','burger','fries','chicken','drinks','meat'],
        grocery: ['milk','bread','eggs','rice','fruits','vegetables','water'],
        home:    ['cleaning','gardening','painting','plumber','electrician'],
        tech:    ['phone repair','computer','tv repair','software'],
        auto:    ['mechanic','tires','battery','car wash'],
        construction:['builder','carpenter','electrician','plumber'],
        others:  ['events','tutor','legal','photography'],
        roadside:['flat tire','jumpstart','fuel','lockout'],
      };
      $('itemChips').innerHTML='';
      (chipsMap[kind]||[]).forEach(text=>{
        const b=document.createElement('button'); b.className='btn ghost'; b.type='button'; b.textContent=text;
        b.onclick=()=>{ $('itemSearch').value=text; $('itemGo').click(); };
        $('itemChips').appendChild(b);
      });
      $('itemsModal').classList.add('open');
      $('closeItems').onclick=()=>$('itemsModal').classList.remove('open');
      $('itemVoice').onclick = ()=> voiceToInput($('itemSearch'), ()=>$('itemGo').click());
      $('itemGo').onclick = async ()=>{
        const q = ($('itemSearch').value||'').trim().toLowerCase();
        $('itemsModal').classList.remove('open');
        $('providersTitle').textContent = (q||'Results') + ' ‚Äî Providers';
        const list = await fetchProviders(kind, q||kind);
        renderProviders(list);
        $('providersModal').classList.add('open');
      };
    }

    // Providers
    $('closeProviders').onclick = ()=>$('providersModal').classList.remove('open');
    async function fetchProviders(category, sub=null){
      try{
        const q = new URLSearchParams({ category, sub: sub||'', lat: coords?.lat||'', lng: coords?.lng||'' });
        const r = await fetch(`${BASE_API}/api/providers/nearby?${q.toString()}`);
        if (!r.ok) throw 0; const d = await r.json(); return d.providers||[];
      }catch{
        return [
          { id:'p1', publicName:'Alex M.', jobTitle:'Driver', verified:true, rating:4.8, rides:120, phone:'+123456789', photoUrl:'', icon:'üë§', distance:'0.8km', eta:'6-9m', fareMin:120, fareMax:130, currency:'$', available:true },
          { id:'p2', publicName:'Quick Help', jobTitle:'Mechanic', verified:false, rating:4.5, rides:74, phone:null, photoUrl:'', icon:'‚ö°', distance:'1.2km', eta:'8-12m', fareMin:10, fareMax:15, currency:'$', available:true },
          { id:'p3', publicName:'Nearby Tech', jobTitle:'Plumber', verified:true, rating:4.2, rides:55, phone:null, photoUrl:'', icon:'üîß', distance:'2.1km', eta:'12-18m', fareMin:12, fareMax:18, currency:'$', available:true },
        ];
      }
    }
    function renderProviders(list){
      const box=$('providersList'); box.innerHTML='';
      if (!list?.length){ box.innerHTML='<div class="small muted">No providers found nearby.</div>'; return; }
      list.forEach(p=>{
        const name = p.publicName || p.name || 'Provider';
        const title= p.jobTitle ? ` ‚Ä¢ ${p.jobTitle}` : '';
        const verified = p.verified ? `<span class="verify">‚úîÔ∏è</span>` : `<span class="small muted">unverified</span>`;
        const rating = p.rating ? ` <span class="rating">‚òÖ ${(+p.rating).toFixed ? (+p.rating).toFixed(1) : p.rating}</span>` : '';
        const avatar = p.photoUrl ? `<img src="${p.photoUrl}" class="avatar" alt="${name}"/>` : `<div class="avatar">${(p.icon||'üë§')}</div>`;
        const fare = (p.fareMin && p.fareMax) ? `${p.currency||'$'}${p.fareMin}‚Äë${p.fareMax}` : (p.fee||'‚Äî');

        const el=document.createElement('div'); el.className='provider';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="row" style="align-items:center">
              ${avatar}
              <div>
                <div><strong>${name}</strong> ${verified} ${rating}</div>
                <div class="small muted">${p.distance || '‚Äî'} ‚Ä¢ ETA ${p.eta || '‚Äî'}${title}</div>
                <div class="small"><strong>Est. fare:</strong> ${fare}</div>
              </div>
            </div>
            <span class="badge ${p.available ? 'success':''}">${p.available ? 'available':'unavailable'}</span>
          </div>
          <div class="controls">
            <button class="btn primary" data-k="instant" type="button">Instant Request</button>
            <button class="btn ghost" data-k="schedule" type="button">Schedule</button>
          </div>`;
        el.querySelectorAll('button[data-k]').forEach(b=>{
          b.onclick = ()=> (b.dataset.k==='instant' ? startInstantEntry(p) : openBooking(p));
        });
        box.appendChild(el);
      });
    }

    // Speech-to-text
    $('voiceBtn').onclick = ()=> voiceToInput($('search'), ()=>runHomeSearch());
    function voiceToInput(inputEl, onResult){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert('Voice not supported'); return; }
      const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{ const text=e.results[0][0].transcript||''; inputEl.value=text; onResult&&onResult(text); };
      rec.start();
    }
    $('searchBtn').onclick = runHomeSearch;
    function runHomeSearch(){
      const q = ($('search').value||'').trim().toLowerCase(); if (!q) return;
      if (/(ride|taxi|cab|uber|bolt)/.test(q)) return openCategory('transport','Transport');
      if (/(truck|backie|moving|load)/.test(q)) {
        openCategoryOptions('Transport Options',[{id:'moving',name:'Truck / Backie',icon:'üöö'}],o=>{
          $('categoryOptionsModal').classList.remove('open');
          $('providersTitle').textContent = o.name + ' ‚Äî Providers';
          fetchProviders('transport','moving').then(renderProviders);
          $('providersModal').classList.add('open');
        });
        return;
      }
      if (/(food|pizza|burger|fries|chicken|drinks)/.test(q)) return openItemsModal('fastfood');
      if (/(grocery|milk|bread|eggs|rice|fruit|vegetable|vegetables)/.test(q)) return openItemsModal('grocery');
      if (/(ambulance|medical)/.test(q)) return openEmergency('ambulance','Ambulance');
      if (/(fire)/.test(q)) return openEmergency('fire','Fire Service');
      if (/(towing|tow)/.test(q)) return openEmergency('towing','Towing');
      if (/(security|police)/.test(q)) return openEmergency('security','Security');
      if (/(plumber|electrician|clean|garden|paint)/.test(q)) return openItemsModal('home');
      if (/(mechanic|tire|battery|car wash)/.test(q)) return openItemsModal('auto');
      if (/(phone|computer|laptop|tv|repair|software)/.test(q)) return openItemsModal('tech');
      if (/(builder|carpenter|construction)/.test(q)) return openItemsModal('construction');
      if (/(event|tutor|legal|photo|photography)/.test(q)) return openItemsModal('others');
      if (/(flat|jumpstart|fuel|lockout|road)/.test(q)) return openItemsModal('roadside');
      $('providersTitle').textContent = q + ' ‚Äî Providers';
      fetchProviders('search', q).then(renderProviders);
      $('providersModal').classList.add('open');
    }

    // Emergency open
    async function openEmergency(emId, label){
      $('providersTitle').textContent = label + ' ‚Äî Nearest';
      const list = await fetchProviders('emergency', emId);
      renderProviders(list);
      $('providersModal').classList.add('open');
    }

    // Transport instant entry
    const tiModal = $('tiModal'), tiPickup=$('tiPickup'), tiDestination=$('tiDestination'), tiStops=$('tiStops');
    let tiStopCount=0;
    $('tiClose').onclick = ()=> tiModal.classList.remove('open');
    $('tiUseCurrent').onclick = async ()=>{
      if (coords) { tiPickup.value = await reverseGeocode(coords.lat, coords.lng) || ''; }
      else { await initLocation(); if (coords) tiPickup.value = await reverseGeocode(coords.lat, coords.lng) || ''; }
    };
    $('tiAddStop').onclick = ()=>{
      if (tiStopCount>=5) return alert('Maximum of 5 stops');
      tiStopCount++;
      const wrap=document.createElement('div'); wrap.className='stop-row';
      wrap.innerHTML=`<label class="small" style="min-width:56px">Stop ${tiStopCount}</label><input class="tiStopInput" placeholder="Enter stop ${tiStopCount} address" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px"/>`;
      tiStops.appendChild(wrap); attachAutocomplete(wrap.querySelector('.tiStopInput'));
    };
    $('tiRemoveStop').onclick = ()=>{ if (tiStopCount<=0) return; tiStops.removeChild(tiStops.lastElementChild); tiStopCount--; };

    function attachAutocomplete(inputEl){
      if (!inputEl) return;
      function init(){ if (!window.google?.maps?.places) return setTimeout(init,300); new google.maps.places.Autocomplete(inputEl,{fields:['formatted_address','geometry','name'],types:['geocode']}); }
      init();
    }
    function startInstantEntry(provider){
      selectedProvider = provider;
      if (lastCategory==='transport'){
        tiModal.classList.add('open');
        attachAutocomplete(tiPickup); attachAutocomplete(tiDestination);
        if (coords && !tiPickup.value) reverseGeocode(coords.lat, coords.lng).then(n=>tiPickup.value=n||'');
        $('tiStart').onclick = ()=> startInstantTransport(provider);
      } else startInstant(provider);
    }
    async function startInstantTransport(provider){
      const pickup=(tiPickup.value||'').trim(), destination=(tiDestination.value||'').trim();
      if (!pickup||!destination){ alert('Pickup and Destination are required'); return; }
      const stops = Array.from(document.querySelectorAll('.tiStopInput')).map(i=>i.value.trim()).filter(Boolean).slice(0,5);
      activeRequests['transport']=true; tiModal.classList.remove('open');
      startInstantCountdownInit();
      try{
        const r = await fetch(`${BASE_API}/api/requests`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({type:'instant',category:'transport',providerId:provider.id,userPublicName:user.name,pickup,destination,stops,location:coords?{latitude:coords.lat,longitude:coords.lng}:null})
        });
        const d=await r.json().catch(()=>({})); requestId=d.requestId||('demo-'+Date.now());
      }catch{ requestId='demo-'+Date.now(); }
      startInstantCountdown('transport', provider.phone);
    }
    async function startInstant(provider){
      activeRequests[lastCategory||'general']=true;
      startInstantCountdownInit();
      try{
        const r=await fetch(`${BASE_API}/api/requests`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({type:'instant',category:lastCategory||'general',providerId:provider.id,userPublicName:user.name,location:coords?{latitude:coords.lat,longitude:coords.lng}:null})
        });
        const d=await r.json().catch(()=>({})); requestId=d.requestId||('demo-'+Date.now());
      }catch{ requestId='demo-'+Date.now(); }
      startInstantCountdown(lastCategory||'general', provider.phone);
    }
    function startInstantCountdownInit(){
      $('providersModal').classList.remove('open');
      instantLeft=90; $('countdown').textContent=String(instantLeft); $('instantHint').textContent='Waiting for provider to accept‚Ä¶'; $('instantModal').classList.add('open');
    }
    function startInstantCountdown(key, phone){
      $('cancelInstant').onclick = ()=>{ $('instantModal').classList.remove('open'); activeRequests[key]=false; };
      instantTimer=setInterval(async ()=>{
        instantLeft-=1; $('countdown').textContent=String(instantLeft);
        if (instantLeft%3===0){
          const status=await getRequestStatus(requestId);
          if (status==='accepted'){ stopInstant(); openTracking(phone); return; }
          if (status==='rejected'){ stopInstant(); alert('Provider rejected.'); $('instantModal').classList.remove('open'); activeRequests[key]=false; return; }
        }
        if (instantLeft<=0){ stopInstant(); alert('No response. Try others.'); $('instantModal').classList.remove('open'); activeRequests[key]=false; }
      },1000);
      $('findOthers').onclick = ()=>{ $('instantModal').classList.remove('open'); $('providersModal').classList.add('open'); };
    }
    function stopInstant(){ if (instantTimer) clearInterval(instantTimer); instantTimer=null; }
    async function getRequestStatus(id){
      try{ const r=await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}`); if(!r.ok) throw 0; const d=await r.json(); return d.status||'pending'; }
      catch{ return (instantLeft<78)?'accepted':'pending'; }
    }

    // Tracking
    function openTracking(phone){
      $('instantModal').classList.remove('open'); $('trackModal').classList.add('open'); setTimeout(initMap,50); startTracking();
      if (phone){ $('trackCallBtn').href=`tel:${phone}`; } else { $('trackCallBtn').href='#'; }
      $('trackChatBtn').onclick = ()=>alert('In‚Äëapp chat coming soon');
    }
    function initMap(){
      if (!map){ map=L.map('track-map',{zoomControl:true}); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM' }).addTo(map); }
      const userLatLng = coords ? [coords.lat, coords.lng] : [0,0];
      map.setView(userLatLng, 14); if (userMarker) userMarker.remove(); userMarker=L.marker(userLatLng,{title:'You'}).addTo(map); if (providerMarker) providerMarker.remove();
    }
    function startTracking(){
      if (trackPoll) clearInterval(trackPoll);
      trackPoll=setInterval(async ()=>{
        const pos=await getProviderPosition(requestId); if (!pos) return;
        const latlng=[pos.lat,pos.lng]; if (!providerMarker) providerMarker=L.marker(latlng,{title:'Provider',icon: L.icon({iconUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',iconRetinaUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',shadowUrl:'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map);
        else providerMarker.setLatLng(latlng);
        $('trackStatus').textContent = `Provider en route ‚Ä¢ ${pos.eta || 'ETA ‚Äî'}`;
      },3000);
    }
    async function getProviderPosition(id){
      try{ const r=await fetch(`${BASE_API}/api/requests/${encodeURIComponent(id)}/position`); if(!r.ok) throw 0; const d=await r.json(); return {lat:d.provider?.lat,lng:d.provider?.lng,eta:d.eta}; }
      catch{ const base=coords?{lat:coords.lat+(Math.random()-0.5)/100,lng:coords.lng+(Math.random()-0.5)/100}:{lat:0,lng:0}; return {lat:base.lat,lng:base.lng,eta:'8 min'}; }
    }
    $('closeTrack').onclick = ()=>{ if (trackPoll) clearInterval(trackPoll); $('trackModal').classList.remove('open'); };

    // Scheduled booking
    function openBooking(provider){ selectedProvider=provider; $('bookingModal').classList.add('open'); }
    $('closeBooking').onclick = ()=> $('bookingModal').classList.remove('open');
    $('bookingForm').onsubmit = async (e)=>{
      e.preventDefault();
      const date=$('bkDate').value, time=$('bkTime').value, address=$('bkAddress').value.trim(), desc=$('bkDesc').value.trim();
      if(!date||!time||!address) return alert('Date, time and address are required');
      try{
        const r=await fetch(`${BASE_API}/api/bookings`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({providerId:selectedProvider.id,bookingType:'scheduled',date,time,address,description:desc,userPublicName:user.name,location:coords?{latitude:coords.lat,longitude:coords.lng}:null})});
        if(!r.ok) throw 0; alert('Booking request sent.');
      }catch{ alert('Booking sent (demo).'); }
      $('bookingModal').classList.remove('open');
    };

    // Marketplace
    const MP_CATEGORIES = [
      { id:'electronics', name:'Electronics' },
      { id:'fashion',     name:'Fashion' },
      { id:'home',        name:'Home & Garden' },
      { id:'sports',      name:'Sports' },
      { id:'automobile',  name:'Automobile' },
      { id:'spares',      name:'Spare Parts' },
      { id:'others',      name:'Others' },
    ];
    const MP_PRODUCTS = [
      { id:'p100', title:'Smartphone X',     cat:'electronics', price:499, stock:12, img:'https://images.unsplash.com/photo-1510552776732-01acc9a4c14f?q=80&w=800&auto=format&fit=crop' },
      { id:'p101', title:'Wireless Earbuds', cat:'electronics', price:59,  stock:34, img:'https://images.unsplash.com/photo-1585386959984-a41552231658?q=80&w=800&auto=format&fit=crop' },
      { id:'p200', title:'Running Shoes',    cat:'fashion',     price:79,  stock:18, img:'https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=800&auto=format&fit=crop' },
      { id:'p201', title:'Denim Jacket',     cat:'fashion',     price:69,  stock:9,  img:'https://images.unsplash.com/photo-1542060748-10c28b62716b?q=80&w=800&auto=format&fit=crop' },
      { id:'p300', title:'Blender Pro',      cat:'home',        price:49,  stock:22, img:'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?q=80&w=800&auto=format&fit=crop' },
      { id:'p301', title:'Desk Lamp',        cat:'home',        price:25,  stock:41, img:'https://images.unsplash.com/photo-1505685296765-3a2736de412f?q=80&w=800&auto=format&fit=crop' },
      { id:'p400', title:'Football',         cat:'sports',      price:19,  stock:27, img:'https://images.unsplash.com/photo-1521417530178-1f1f06f9a70b?q=80&w=800&auto=format&fit=crop' },
      { id:'p401', title:'Yoga Mat',         cat:'sports',      price:29,  stock:15, img:'https://images.unsplash.com/photo-1599050751795-5a9e3d0f5f7b?q=80&w=800&auto=format&fit=crop' },
      { id:'p500', title:'Engine Oil 5W-30', cat:'automobile',  price:35,  stock:20, img:'https://images.unsplash.com/photo-1584448099095-530a1a9b55d8?q=80&w=800&auto=format&fit=crop' },
      { id:'p501', title:'Car Tyre 17\"',    cat:'automobile',  price:89,  stock:16, img:'https://images.unsplash.com/photo-1580674285055-c64b4d5d6a2f?q=80&w=800&auto=format&fit=crop' },
      { id:'p600', title:'Brake Pads',       cat:'spares',      price:24,  stock:28, img:'https://images.unsplash.com/photo-1607863680058-5b5b7762dd44?q=80&w=800&auto=format&fit=crop' },
      { id:'p601', title:'Spark Plugs (4)',  cat:'spares',      price:19,  stock:35, img:'https://images.unsplash.com/photo-1610465299997-91a2b74a53b0?q=80&w=800&auto=format&fit=crop' },
      { id:'p700', title:'Gift Box',         cat:'others',      price:12,  stock:50, img:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=800&auto=format&fit=crop' },
      { id:'p701', title:'Photo Frame',      cat:'others',      price:15,  stock:33, img:'https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?q=80&w=800&auto=format&fit=crop' },
    ];
    let cart = loadCart();

    $('mpVoice').onclick = ()=> voiceToInput($('mpSearch'), ()=> runMarketplaceSearch());
    $('mpSearchBtn').onclick = runMarketplaceSearch;

    function initMarketplace(){
      $('mpChips').innerHTML='';
      MP_CATEGORIES.forEach(c=>{
        const b=document.createElement('button'); b.className='btn ghost'; b.type='button'; b.textContent=c.name;
        b.onclick=()=> renderMarketplace(c.id, $('mpSearch').value.trim().toLowerCase());
        $('mpChips').appendChild(b);
      });
      renderMarketplace(); updateCartCount();
    }
    function runMarketplaceSearch(){ renderMarketplace(null, $('mpSearch').value.trim().toLowerCase()); }
    function renderMarketplace(category=null, query=''){
      $('mpGrid').innerHTML='';
      let list = MP_PRODUCTS.slice();
      if (category) list = list.filter(p=>p.cat===category);
      if (query) list = list.filter(p=>p.title.toLowerCase().includes(query)||p.cat.includes(query));
      if (!list.length){ $('mpGrid').innerHTML='<div class="small muted">No products found.</div>'; return; }
      list.forEach(p=>{
        const el=document.createElement('div'); el.className='card product'; el.dataset.id=p.id;
        el.innerHTML=`<img src="${p.img}" alt="${p.title}"/><div><strong>${p.title}</strong></div>
          <div class="row" style="justify-content:space-between"><div class="price">$${p.price.toFixed(2)}</div><div class="small muted">Stock: ${p.stock}</div></div>
          <button class="btn primary" type="button">${p.stock>0?'Add to Cart':'Out of Stock'}</button>`;
        const btn=el.querySelector('button'); btn.disabled=p.stock<=0; btn.onclick=()=>addToCart(p.id);
        $('mpGrid').appendChild(el);
      });
    }
    function addToCart(productId){
      const prod=MP_PRODUCTS.find(p=>p.id===productId); if(!prod||prod.stock<=0) return;
      const i=cart.items.findIndex(x=>x.id===productId);
      if (i>=0) cart.items[i].qty+=1; else cart.items.push({id:prod.id,title:prod.title,price:prod.price,img:prod.img,qty:1});
      saveCart(); updateCartCount();
    }
    function updateCartCount(){ const n=cart.items.reduce((a,b)=>a+b.qty,0); const badge=$('headerCartBadge'); if ($('cartCount')) $('cartCount').textContent=String(n); if (badge) badge.textContent=String(n); }
    function loadCart(){ try{ return JSON.parse(localStorage.getItem('mp_cart')||'{"items":[]}'); }catch{ return { items:[] }; } }
    function saveCart(){ localStorage.setItem('mp_cart', JSON.stringify(cart)); }
    function renderCart(){
      const list=$('cartList'); const totalEl=$('cartTotal'); list.innerHTML='';
      if(!cart.items.length){ list.innerHTML='<div class="small muted">Your cart is empty.</div>'; totalEl.textContent='0.00'; return; }
      let total=0;
      cart.items.forEach(item=>{
        total+=item.price*item.qty;
        const row=document.createElement('div'); row.className='card'; row.dataset.id=item.id;
        row.innerHTML = `<div class="row" style="justify-content:space-between; align-items:flex-start">
          <div class="row"><img src="${item.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"/><div style="margin-left:8px"><strong>${item.title}</strong><div class="small muted">$${item.price.toFixed(2)}</div></div></div>
          <div class="qty"><button class="btn ghost" data-k="dec" type="button">‚àí</button><div>${item.qty}</div><button class="btn ghost" data-k="inc" type="button">Ôºã</button><button class="btn ghost" data-k="rm" type="button">‚úñ</button></div></div>`;
        const [dec, , inc, rm] = row.querySelectorAll('button');
        dec.onclick=()=>{ item.qty=Math.max(1,item.qty-1); saveCart(); renderCart(); updateCartCount(); };
        inc.onclick=()=>{ item.qty+=1; saveCart(); renderCart(); updateCartCount(); };
        rm.onclick =()=>{ cart.items=cart.items.filter(x=>x.id!==item.id); saveCart(); renderCart(); updateCartCount(); };
        list.appendChild(row);
      });
      totalEl.textContent=total.toFixed(2);
    }

    // Checkout
    $('placeOrderBtn').onclick = async ()=>{
      const method = [...document.querySelectorAll('input[name="payMethod"]')].find(r=>r.checked)?.value || 'card';
      const name=$('chkName').value.trim(), phone=$('chkPhone').value.trim(), address=$('chkAddress').value.trim(), unit=($('chkUnit').value||'').trim(), notes=($('chkNotes').value||'').trim();
      if (!$('chkTerms').checked) return alert('Please accept the Terms');
      if (!address) return alert('Enter delivery address');
      if (!name||!phone) return alert('Enter name and phone');
      if (!cart.items.length) return alert('Cart is empty');

      const payload = { items: cart.items.map(i=>({id:i.id,title:i.title,qty:i.qty,price:i.price})), name, phone, address, unit, notes };

      if (method==='card'){
        try{
          const r=await fetch(`${BASE_API}/api/payments/checkout-session`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,successUrl:location.origin+'/?checkout=success',cancelUrl:location.origin+'/?checkout=cancel'})});
          const d=await r.json().catch(()=>({}));
          if (d?.url){ cart.items=[]; saveCart(); updateCartCount(); location.href=d.url; return; }
          if ((d?.id||d?.sessionId) && window.Stripe){ const stripe=window.Stripe(STRIPE_PK); cart.items=[]; saveCart(); updateCartCount(); await stripe.redirectToCheckout({sessionId: d.id||d.sessionId}); return; }
          if (FALLBACK_PAYMENT_LINK){ cart.items=[]; saveCart(); updateCartCount(); location.href=FALLBACK_PAYMENT_LINK; return; }
          alert('Payment session error. Try Cash.');
        }catch{
          if (FALLBACK_PAYMENT_LINK){ cart.items=[]; saveCart(); updateCartCount(); location.href=FALLBACK_PAYMENT_LINK; return; }
          alert('Payment session error. Try Cash.');
        }
      } else {
        let orderId='demo-'+Date.now(), code=String(Math.floor(100000+Math.random()*900000));
        try{ const r2=await fetch(`${BASE_API}/api/marketplace/orders`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,paymentMethod:'cash'})}); const d2=await r2.json().catch(()=>({})); orderId=d2.orderId||orderId; code=d2.deliveryCode||code; }catch{}
        $('checkoutModal').classList.remove('open'); showOrderStatus(orderId, code, 'cash'); cart.items=[]; saveCart(); updateCartCount();
      }
    };
    function showOrderStatus(orderId, code, method){
      $('orderInfo').innerHTML = `<div class="card"><div><strong>Order ID:</strong> ${orderId}</div><div style="margin-top:6px"><strong>Status:</strong> <span id="ordStatus">pending</span></div><div style="margin-top:6px"><strong>Delivery code:</strong> <span style="font-family:monospace">${code}</span></div><div class="small muted" style="margin-top:6px">${method==='card'?'Funds are held until code entry.':'Cash selected: code marks delivered.'}</div></div>`;
      $('orderModal').classList.add('open');
      const ord=$('ordStatus'); let t=0; const poll=setInterval(async()=>{ t+=3; let s; try{ const r=await fetch(`${BASE_API}/api/marketplace/orders/${encodeURIComponent(orderId)}`); const d=await r.json().catch(()=>({})); s=d.status; }catch{ if (t>=6&&t<12) s='accepted'; else if (t>=12&&t<18) s='out_for_delivery'; else if (t>=18) s='delivered'; else s='pending'; } ord.textContent=s||'pending'; if (s==='delivered'||t>=24) clearInterval(poll); },3000);
    }

    // Profile sub-pages (dummy interactions)
    $('addServiceBtn').onclick = ()=> alert('Add Service form (to implement)');
    $('addProductBtn').onclick = ()=> alert('Add Product form (to implement)');
    $('vpSubmit').onclick = ()=>{ $('vpStatus').textContent='Submitted. Awaiting admin review.'; };
    $('supSend').onclick = ()=>{ if(!$('supSubject').value.trim()||!$('supMessage').value.trim()) return alert('Enter subject and message'); alert('Support message sent'); $('supSubject').value=''; $('supMessage').value=''; };

    // Transport helpers: Google Places attach on demand
  </script>
  <script>
// ZippUp mobile hotfix: sticky checkout, fast Transport/Food, active booking bar
(function () {
  // 0) Inject minimal CSS so we don't touch your existing styles
  const css = `
    /* Cart modal: scroll body, keep checkout visible */
    #cartModal .sheet .body { max-height: 70vh; overflow: auto; }
    #cartModal .sheet .body .checkout-sticky { position: sticky; bottom: 0; background:#fff; padding-top:10px; border-top:1px solid var(--border); }

    /* Active request bar */
    .active-request-bar { position: fixed; left:16px; right:16px; bottom:120px; background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:0 8px 24px rgba(17,24,39,.08); z-index: 1000; padding:10px; display:none }
    .active-request-bar .row { display:flex; align-items:center; justify-content:space-between; gap:8px }
    .active-request-bar .btn { padding:8px 12px; border-radius:10px; border:0; font-weight:600; cursor:pointer }
    .active-request-bar .primary { background:#2563EB; color:#fff }
    .active-request-bar .ghost { background:#F3F4F6 }
  `;
  const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);

  // 1) Make Transport/Food cards open on first tap (mobile safe)
  function openByLabel(text) {
    const t = (text||'').toLowerCase();
    if (t.includes('transport')) { try { openCategory('transport','Transport'); } catch {} return true; }
    if (t.includes('food'))      { try { openCategory('food','Food'); }         catch {} return true; }
    return false;
  }
  function svcTap(e){
    const card = e.target.closest('.card.service'); if (!card) return;
    const h4 = card.querySelector('h4'); if (!h4) return;
    if (openByLabel(h4.textContent)) { e.preventDefault(); e.stopPropagation(); }
  }
  ['pointerup','click','touchend'].forEach(ev => document.addEventListener(ev, svcTap, { capture:true, passive:false }));

  // 2) Cart modal: make Checkout row sticky automatically
  function stickCheckoutRow() {
    const row = document.querySelector('#cartModal .body #checkoutBtn')?.closest('.row');
    if (row && !row.classList.contains('checkout-sticky')) row.classList.add('checkout-sticky');
  }
  const cartBody = document.querySelector('#cartModal .body');
  if (cartBody) new MutationObserver(stickCheckoutRow).observe(cartBody, { childList:true, subtree:true });
  stickCheckoutRow();

  // 3) Active booking bar (persists when user leaves page)
  const BAR_ID = 'zupActiveBar';
  function ensureBar() {
    if (document.getElementById(BAR_ID)) return document.getElementById(BAR_ID);
    const bar = document.createElement('div');
    bar.id = BAR_ID;
    bar.className = 'active-request-bar';
    bar.innerHTML = `
      <div class="row">
        <div id="zupActiveText" class="small">You have an active request</div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="zupActiveCancel" type="button">Cancel</button>
          <button class="btn primary" id="zupActiveTrack" type="button">Resume tracking</button>
        </div>
      </div>
    `;
    document.body.appendChild(bar);
    document.getElementById('zupActiveTrack').onclick = () => {
      try { openTracking(_activeCache?.phone || null); } catch {}
      bar.style.display = 'none';
    };
    document.getElementById('zupActiveCancel').onclick = async () => {
      // Try to cancel via existing code, else just clear
      try { typeof cancelInstant === 'function' ? await cancelInstant('User cancelled', _activeCache?.category || 'general') : null; } catch {}
      clearActive();
    };
    return bar;
  }
  function saveActive(obj) {
    localStorage.setItem('zup_active_req', JSON.stringify(obj||{}));
  }
  function loadActive() {
    try { return JSON.parse(localStorage.getItem('zup_active_req')||'{}'); } catch { return {}; }
  }
  function showActive(obj) {
    const bar = ensureBar();
    const txt = document.getElementById('zupActiveText');
    if (txt) txt.textContent = `Active ${obj?.category || 'service'} request ‚Ä¢ tap to resume or cancel`;
    bar.style.display = 'block';
  }
  function clearActive() {
    localStorage.removeItem('zup_active_req');
    const bar = document.getElementById(BAR_ID);
    if (bar) bar.style.display = 'none';
  }

  // 3a) Monkey‚Äëpatch your startInstant/startInstantTransport to persist the active request
  let _activeCache = loadActive();
  ['startInstantTransport','startInstant'].forEach(fnName => {
    const orig = window[fnName];
    if (typeof orig === 'function') {
      window[fnName] = function patched(provider) {
        try {
          // Call original
          const ret = orig.apply(this, arguments);
          // Save active after a tick (requestId gets set shortly after)
          setTimeout(() => {
            const obj = {
              id: (window.requestId || _activeCache?.id || ('demo-'+Date.now())),
              category: (window.lastCategory || _activeCache?.category || 'general'),
              phone: provider?.phone || null,
            };
            _activeCache = obj; saveActive(obj); showActive(obj);
          }, 300);
          return ret;
        } catch (e) { return orig.apply(this, arguments); }
      }
    }
  });
  // When tracking closes, clear active (optional: keep until completed)
  if (typeof window.closeTrack === 'function') {
    const origClose = window.closeTrack;
    window.closeTrack = function patchedClose() {
      try { origClose.apply(this, arguments); } catch {}
      // keep active so user can resume ‚Äî comment next line to keep persistent
      // clearActive();
    }
  }

  // 3b) Restore bar on load if there is an active request
  if (_activeCache && _activeCache.id) { showActive(_activeCache); }

  // 4) Helpful note for Google Maps "Do you own this website?" overlay
  // That message comes from Google Maps/Places when the key isn't allowed for your domain
  // or billing isn't enabled. To stop it:
  // - In Google Cloud Console: enable billing for the project of this key
  // - Enable APIs: Maps JavaScript API + Places API
  // - Credentials -> your key -> add your site domain to "Website restrictions" (e.g. https://your-site.com/*)
  // Until then, address suggestions still work where possible; the overlay is from Google, not from this code.
})();
</script>
  <script>
(function () {
  // 1) Fast‚Äëtap for Transport/Food (one tap on phone)
  function openByLabel(txt){txt=(txt||'').toLowerCase(); if(txt.includes('transport')){try{openCategory('transport','Transport')}catch{}} else if(txt.includes('food')){try{openCategory('food','Food')}catch{}}}
  function svcTap(e){var card=e.target.closest('.card.service'); if(!card) return; var h4=card.querySelector('h4'); if(!h4) return; openByLabel(h4.textContent); }
  document.addEventListener('click', svcTap, true);
  document.addEventListener('touchend', svcTap, {capture:true, passive:false});

  // 2) Active request bar (resume/cancel if user navigates away)
  var bar=document.createElement('div');
  bar.className='active-request-bar';
  bar.innerHTML='<div class="row" style="display:flex;align-items:center;justify-content:space-between;gap:8px"><div class="small">You have an active request</div><div style="display:flex;gap:6px"><button class="btn ghost" id="arCancel" type="button">Cancel</button><button class="btn primary" id="arResume" type="button">Resume tracking</button></div></div>';
  document.body.appendChild(bar);
  function saveActive(id,cat,phone){try{localStorage.setItem('zup_active_req',JSON.stringify({id:id,cat:cat,phone:phone||null}))}catch{}}
  function loadActive(){try{return JSON.parse(localStorage.getItem('zup_active_req')||'{}')}catch{return{}}}
  function clearActive(){try{localStorage.removeItem('zup_active_req')}catch{}}
  function showBar(){bar.style.display='block'}
  function hideBar(){bar.style.display='none'}

  // Patch instant starters to remember the active request
  ['startInstantTransport','startInstant'].forEach(function(n){
    var orig=window[n];
    if(typeof orig==='function'){
      window[n]=function(p){
        var ret=orig.apply(this,arguments);
        setTimeout(function(){
          var a=loadActive();
          var id=window.requestId||a.id||('demo-'+Date.now());
          var cat=window.lastCategory||a.cat||'general';
          var phone=p&&p.phone||a.phone||null;
          saveActive(id,cat,phone); showBar();
        },300);
        return ret;
      }
    }
  });

  // Resume/cancel handlers
  document.getElementById('arResume').onclick=function(){
    var a=loadActive();
    try{ openTracking(a.phone||null); }catch{}
    hideBar();
  };
  document.getElementById('arCancel').onclick=async function(){
    var a=loadActive();
    try{ typeof cancelInstant==='function' && await cancelInstant('User cancelled', a.cat||'general'); }catch{}
    clearActive(); hideBar();
  };

  // Restore bar on load if needed
  var a0=loadActive(); if(a0&&a0.id) showBar();

  // 3) Note for Google ‚ÄúDo you own this website?‚Äù overlay (info only):
  // Enable billing + Maps JavaScript API + Places API; add your site domain as an allowed referrer on the key.
})();
</script>
  <script>
// ZippUp combined hotfix: checkout sticky + cart edit + fast Transport/Food + search suggestions + fallback address suggestions
(function () {
  const $ = (id) => document.getElementById(id);

  // 0) Sticky checkout row (cart modal) + scroll body
  (function makeCheckoutSticky() {
    const body = document.querySelector('#cartModal .sheet .body');
    if (!body) return;
    body.style.maxHeight = '70vh';
    body.style.overflow = 'auto';
    const row = document.querySelector('#cartModal .sheet .body #checkoutBtn')?.closest('.row');
    if (row) {
      row.style.position = 'sticky';
      row.style.bottom = '0';
      row.style.background = '#fff';
      row.style.paddingTop = '10px';
      row.style.borderTop = '1px solid var(--border)';
    }
  })();

  // 1) Cart edit (+/‚àí/‚úñ) via delegation, non-destructive
  function readCart() {
    try { return (window.cart && Array.isArray(window.cart.items)) ? window.cart : JSON.parse(localStorage.getItem('mp_cart') || '{"items":[]}'); }
    catch { return { items: [] }; }
  }
  function writeCart(c) {
    if (window.cart) window.cart.items = c.items;
    localStorage.setItem('mp_cart', JSON.stringify(c));
  }
  function updateCounts(c) {
    const n = c.items.reduce((a,b)=>a+b.qty,0);
    const hb = $('headerCartBadge'), cc = $('cartCount');
    if (hb) hb.textContent = String(n);
    if (cc) cc.textContent = String(n);
  }
  function renderCartSafe() {
    try { window.renderCart && window.renderCart(); } catch {}
    updateCounts(readCart());
  }
  function editCartHandler(e) {
    const btn = e.target.closest('#cartList [data-k]');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();

    const row = btn.closest('.card');
    const id  = row?.dataset?.id;
    if (!id) return;

    const c = readCart();
    const i = c.items.findIndex(x => x.id === id);
    if (i < 0) return;

    const k = btn.getAttribute('data-k');
    if (k === 'dec') c.items[i].qty = Math.max(1, c.items[i].qty - 1);
    if (k === 'inc') c.items[i].qty = c.items[i].qty + 1;
    if (k === 'rm')  c.items.splice(i, 1);

    writeCart(c);
    renderCartSafe();
  }
  document.addEventListener('click', editCartHandler, { passive:false });
  document.addEventListener('touchend', editCartHandler, { passive:false });

  // 2) Ensure both cart buttons open the same modal, checkout opens reliably
  function openCartModal() {
    try { showPage('marketplace'); } catch {}
    renderCartSafe();
    const m = $('cartModal'); if (m) m.classList.add('open');
  }
  function bindTap(el, fn){
    if (!el) return;
    const h=(e)=>{ e.preventDefault(); e.stopPropagation(); fn(e); };
    el.addEventListener('click', h, { passive:false });
    el.addEventListener('touchend', h, { passive:false });
  }
  bindTap($('cartBtn'), openCartModal);
  bindTap($('openCartBtn'), openCartModal);
  bindTap($('closeCart'), ()=> $('cartModal')?.classList.remove('open'));
  bindTap($('checkoutBtn'), ()=> { $('cartModal')?.classList.remove('open'); $('checkoutModal')?.classList.add('open'); });

  // 3) Fast-activate Transport/Food on first tap (does not change your handlers)
  function openByLabel(text) {
    const t = (text||'').toLowerCase();
    if (t.includes('transport')) { try { openCategory('transport','Transport'); } catch {} return true; }
    if (t.includes('food'))      { try { openCategory('food','Food'); }         catch {} return true; }
    return false;
  }
  function svcTap(e){
    const card = e.target.closest('.card.service'); if (!card) return;
    const h4 = card.querySelector('h4'); if (!h4) return;
    if (openByLabel(h4.textContent)) { e.preventDefault(); e.stopPropagation(); }
  }
  document.addEventListener('click', svcTap, { capture:true, passive:false });
  document.addEventListener('touchend', svcTap, { capture:true, passive:false });

  // 4) Search suggestions + redirect (AI-like)
  (function wireSearch() {
    const input = $('search');
    const btn   = $('searchBtn');
    if (!input || !btn) return;

    let panel = document.getElementById('zupSuggest');
    if (!panel) {
      panel = document.createElement('div');
      panel.id = 'zupSuggest';
      panel.style.cssText = 'position:fixed;left:16px;right:16px;top:86px;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);z-index:60;display:none;max-height:260px;overflow:auto';
      document.body.appendChild(panel);
    }
    const MAP = {
      transport: /(transport|ride|taxi|cab|uber|bolt|truck|backie|moving|load)/i,
      fastfood:  /(food|pizza|burger|fries|chicken|kfc|shawarma|drinks|meal)/i,
      grocery:   /(grocery|market|milk|bread|eggs|rice|fruit|vegetable|veggies|water)/i,
      emergency: /(ambulance|medical|fire|towing|tow|security|police|roadside|flat|jumpstart|fuel|lockout)/i,
      home:      /(clean|garden|painting|plumber|electrician|home service)/i,
      tech:      /(phone|computer|laptop|tv|repair|software|tech)/i,
      auto:      /(mechanic|tire|tyre|battery|car wash|auto)/i,
      construct: /(builder|carpenter|construction)/i,
      others:    /(event|tutor|legal|photo|photography|other)/i
    };
    function hide(){ panel.style.display='none'; panel.innerHTML=''; }
    function navigate(term) {
      const q = (term || input.value || '').trim().toLowerCase();
      if (!q) return;
      if (MAP.transport.test(q)) { try { openCategory('transport','Transport'); } catch {} return hide(); }
      if (MAP.fastfood.test(q))  { try { openItemsModal('fastfood'); }           catch {} return hide(); }
      if (MAP.grocery.test(q))   { try { openItemsModal('grocery'); }            catch {} return hide(); }
      if (MAP.emergency.test(q)) {
        if (/ambulance|medical/.test(q)) { try { openEmergency('ambulance','Ambulance'); } catch {} }
        else if (/fire/.test(q))         { try { openEmergency('fire','Fire Service'); }   catch {} }
        else if (/towing|tow/.test(q))   { try { openEmergency('towing','Towing'); }       catch {} }
        else                             { try { openEmergency('security','Security'); }   catch {} }
        return hide();
      }
      if (MAP.home.test(q))      { try { openItemsModal('home'); }        catch {} return hide(); }
      if (MAP.tech.test(q))      { try { openItemsModal('tech'); }        catch {} return hide(); }
      if (MAP.auto.test(q))      { try { openItemsModal('auto'); }        catch {} return hide(); }
      if (MAP.construct.test(q)) { try { openItemsModal('construction'); }catch {} return hide(); }
      if (MAP.others.test(q))    { try { openItemsModal('others'); }      catch {} return hide(); }
      try {
        document.getElementById('providersTitle').textContent = q + ' ‚Äî Providers';
        fetchProviders('search', q).then(renderProviders);
        document.getElementById('providersModal').classList.add('open');
      } catch {}
      hide();
    }
    let t = 0;
    function suggest() {
      clearTimeout(t);
      const q = input.value.trim();
      if (!q) return hide();
      t = setTimeout(async () => {
        panel.innerHTML=''; panel.style.display='block';
        let items = [];
        try {
          const r = await fetch(`${(window.BASE_API||'')}/api/search/suggestions?q=${encodeURIComponent(q)}`);
          const d = await r.json().catch(()=>({}));
          items = Array.isArray(d?.suggestions) ? d.suggestions.slice(0,8) : [];
        } catch {}
        if (!items.length) {
          const seed = ['Transport','Ride','Truck / Backie','Fast Food','Groceries','Plumber','Electrician','Mechanic','Security','Towing'];
          items = seed.filter(s=>s.toLowerCase().includes(q.toLowerCase())).slice(0,8);
          if (!items.length) items = seed.slice(0,6);
        }
        items.forEach(text=>{
          const row=document.createElement('button');
          row.type='button';
          row.style.cssText='display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:#fff;border-bottom:1px solid var(--border);cursor:pointer';
          row.textContent=text;
          row.onclick=()=>{ input.value=text; navigate(text); };
          panel.appendChild(row);
        });
        const more=document.createElement('button');
        more.type='button';
        more.style.cssText='display:block;width:100%;text-align:center;padding:10px 12px;border:0;background:#F3F4F6;cursor:pointer;font-weight:600';
        more.textContent='Search';
        more.onclick=()=>navigate(q);
        panel.appendChild(more);
      }, 180);
    }
    input.addEventListener('input', suggest, { passive:true });
    input.addEventListener('focus', suggest, { passive:true });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); navigate(); }});
    document.addEventListener('click',(e)=>{ if(!panel.contains(e.target) && e.target!==input) hide(); },{passive:true});
    btn.onclick = ()=>navigate();
  })();

  // 5) Fallback address suggestions (Pickup/Destination/Stops) without Google Maps
  (function wireAddressFallback() {
    // Create one floating suggestion panel
    const panel = document.createElement('div');
    panel.id = 'addrSuggest';
    panel.style.cssText = 'position:fixed;max-height:240px;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);z-index:70;display:none';
    document.body.appendChild(panel);

    let activeInput = null, debounce = 0;

    function positionPanel(input) {
      const r = input.getBoundingClientRect();
      panel.style.left   = Math.round(r.left) + 'px';
      panel.style.top    = Math.round(r.bottom + 6) + 'px';
      panel.style.width  = Math.round(r.width) + 'px';
    }
    function hidePanel(){ panel.style.display='none'; panel.innerHTML=''; activeInput=null; }

    async function queryAddresses(q) {
      // Nominatim fallback (no key). Respect rate-limits, keep it short.
      const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=5&addressdetails=1&q=' + encodeURIComponent(q);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      return await res.json().catch(()=>[]);
    }
    function bindInput(input) {
      if (!input || input.dataset.addrBound === '1') return;
      input.dataset.addrBound = '1';
      input.setAttribute('autocomplete','off');
      input.addEventListener('input', () => {
        clearTimeout(debounce);
        const q = input.value.trim();
        if (q.length < 3) { hidePanel(); return; }
        debounce = setTimeout(async () => {
          try {
            const items = await queryAddresses(q);
            if (!items || !items.length) { hidePanel(); return; }
            activeInput = input;
            panel.innerHTML=''; positionPanel(input);
            items.forEach(it=>{
              const line = it.display_name || [it.name, it.address && (it.address.city || it.address.town || it.address.village), it.address && it.address.country].filter(Boolean).join(', ');
              const btn  = document.createElement('button');
              btn.type='button';
              btn.style.cssText='display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:#fff;border-bottom:1px solid var(--border);cursor:pointer';
              btn.textContent = line;
              btn.onclick = ()=>{ input.value = line; hidePanel(); };
              panel.appendChild(btn);
            });
            panel.style.display='block';
          } catch { hidePanel(); }
        }, 220);
      }, { passive:true });
      input.addEventListener('focus', () => { if (input.value.trim().length >= 3) positionPanel(input); }, { passive:true });
      input.addEventListener('blur', () => setTimeout(hidePanel, 150));
    }

    function bindAll() {
      const pickup = document.getElementById('tiPickup');
      const dest   = document.getElementById('tiDestination');
      bindInput(pickup); bindInput(dest);
      document.querySelectorAll('.tiStopInput').forEach(bindInput);
    }
    // Initial bind, plus observe dynamically added stop fields
    bindAll();
    const observer = new MutationObserver(() => bindAll());
    observer.observe(document.body, { childList:true, subtree:true });
    // Close on outside click
    document.addEventListener('click', (e)=>{ if (!panel.contains(e.target) && e.target !== activeInput) hidePanel(); }, { passive:true });
  })();

  // 6) Final safety: make critical buttons type=button
  window.addEventListener('DOMContentLoaded', ()=>{
    ['cartBtn','openCartBtn','checkoutBtn','closeCart','placeOrderBtn'].forEach(id => { const b=$(id); if (b) b.setAttribute('type','button'); });
    renderCartSafe();
  });
})();
</script>
  <script>
// ZippUp targeted hotfix: cart edit + sticky checkout + fast Transport/Food + transport-only address suggestions (country-limited) + Google overlay fallback
(function () {
  const $ = (id) => document.getElementById(id);

  // 0) Sticky checkout row + scrollable cart items
  (function makeCheckoutSticky() {
    const body = document.querySelector('#cartModal .sheet .body');
    if (!body) return;
    body.style.maxHeight = '70vh';
    body.style.overflow = 'auto';
    const row = document.querySelector('#cartModal .sheet .body #checkoutBtn')?.closest('.row');
    if (row) {
      row.style.position = 'sticky';
      row.style.bottom = '0';
      row.style.background = '#fff';
      row.style.paddingTop = '10px';
      row.style.borderTop = '1px solid var(--border)';
    }
  })();

  // 1) Cart editing (+ / ‚àí / ‚úñ) with totals/badge updates (non-destructive)
  function readCart() {
    try { return (window.cart && Array.isArray(window.cart.items)) ? window.cart : JSON.parse(localStorage.getItem('mp_cart') || '{"items":[]}'); }
    catch { return { items: [] }; }
  }
  function writeCart(c) {
    if (window.cart) window.cart.items = c.items;
    localStorage.setItem('mp_cart', JSON.stringify(c));
  }
  function updateCounts(c) {
    const n = c.items.reduce((a,b)=>a+b.qty,0);
    const hb = $('headerCartBadge'), cc = $('cartCount');
    if (hb) hb.textContent = String(n);
    if (cc) cc.textContent = String(n);
  }
  function rerenderCartUI() {
    try { window.renderCart && window.renderCart(); } catch {}
    updateCounts(readCart());
  }
  function editCartHandler(e) {
    const btn = e.target.closest('#cartList [data-k]');
    if (!btn) return;
    e.preventDefault(); e.stopPropagation();

    const row = btn.closest('.card');
    let id  = row?.dataset?.id || '';
    const c = readCart();

    if (!id) {
      // Fallback match by title text if dataset is missing
      const title = (row.querySelector('strong')?.textContent || '').trim();
      const found = c.items.find(i => i.title === title);
      if (found) id = found.id;
    }
    if (!id) return;

    const i = c.items.findIndex(x => x.id === id);
    if (i < 0) return;

    const k = btn.getAttribute('data-k');
    if (k === 'dec') c.items[i].qty = Math.max(1, c.items[i].qty - 1);
    if (k === 'inc') c.items[i].qty = c.items[i].qty + 1;
    if (k === 'rm')  c.items.splice(i, 1);

    writeCart(c);
    rerenderCartUI();
  }
  document.addEventListener('click', editCartHandler, { passive:false });
  document.addEventListener('touchend', editCartHandler, { passive:false });

  // 2) Make BOTH cart buttons open modal; checkout opens reliably
  function openCartModal() {
    try { showPage('marketplace'); } catch {}
    rerenderCartUI();
    $('cartModal')?.classList.add('open');
  }
  function bindTap(el, fn){
    if (!el) return;
    const h=(e)=>{ e.preventDefault(); e.stopPropagation(); fn(e); };
    el.addEventListener('click', h, { passive:false });
    el.addEventListener('touchend', h, { passive:false });
  }
  bindTap($('cartBtn'), openCartModal);
  bindTap($('openCartBtn'), openCartModal);
  bindTap($('closeCart'), ()=> $('cartModal')?.classList.remove('open'));
  bindTap($('checkoutBtn'), ()=> { $('cartModal')?.classList.remove('open'); $('checkoutModal')?.classList.add('open'); });

  // 3) Fast-activate Transport/Food on one tap (does not change your handlers)
  function openByLabel(text) {
    const t = (text||'').toLowerCase();
    if (t.includes('transport')) { try { openCategory('transport','Transport'); } catch {} return true; }
    if (t.includes('food'))      { try { openCategory('food','Food'); }         catch {} return true; }
    return false;
  }
  function svcTap(e){
    const card = e.target.closest('.card.service'); if (!card) return;
    const h4 = card.querySelector('h4'); if (!h4) return;
    if (openByLabel(h4.textContent)) { e.preventDefault(); e.stopPropagation(); }
  }
  document.addEventListener('click', svcTap, { capture:true, passive:false });
  document.addEventListener('touchend', svcTap, { capture:true, passive:false });

  // 4) Transport-only fallback address suggestions (no Google overlay; country-limited)
  // If Google key is blocked, this takes over. Only binds inside the transport modal (#tiModal).
  window.gm_authFailure = function() { window.__zupGoogleBlocked = true; };
  (function transportAddressFallback() {
    const tiModal = document.getElementById('tiModal');
    if (!tiModal) return;

    // Country/area bias: prefer coords if available; otherwise try IP country
    let countryCode = null;
    let bounds = null; // { minLon, minLat, maxLon, maxLat } around current coords
    function initGeoBias() {
      try {
        if (window.coords && typeof window.coords.lat === 'number' && typeof window.coords.lng === 'number') {
          const lat = window.coords.lat, lng = window.coords.lng;
          const d = 0.6; // ~60-70km bbox
          bounds = { minLon: lng - d, minLat: lat - d, maxLon: lng + d, maxLat: lat + d };
        } else {
          // Light IP lookup to get country code (used by Nominatim)
          fetch('https://ipapi.co/json/')
            .then(r=>r.json()).then(d=>{ if (d && d.country_code) countryCode = String(d.country_code).toLowerCase(); })
            .catch(()=>{});
        }
      } catch {}
    }
    initGeoBias();

    const panel = document.createElement('div');
    panel.id = 'addrSuggest';
    panel.style.cssText = 'position:fixed;max-height:240px;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);z-index:70;display:none';
    document.body.appendChild(panel);

    let activeInput = null, debounce = 0;
    function positionPanel(input) {
      const r = input.getBoundingClientRect();
      panel.style.left   = Math.round(r.left) + 'px';
      panel.style.top    = Math.round(r.bottom + 6) + 'px';
      panel.style.width  = Math.round(r.width) + 'px';
    }
    function hidePanel(){ panel.style.display='none'; panel.innerHTML=''; activeInput=null; }

    async function queryAddresses(q) {
      // Nominatim with bias
      const params = new URLSearchParams({ format:'json', limit:'5', addressdetails:'1', q });
      if (bounds) {
        params.set('viewbox', `${bounds.minLon},${bounds.maxLat},${bounds.maxLon},${bounds.minLat}`);
        params.set('bounded', '1');
      } else if (countryCode) {
        params.set('countrycodes', countryCode);
      }
      const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      return await res.json().catch(()=>[]);
    }

    function bindInput(input) {
      if (!input || input.dataset.addrBound === '1') return;
      input.dataset.addrBound = '1';
      input.setAttribute('autocomplete','off');
      input.addEventListener('input', () => {
        clearTimeout(debounce);
        const q = input.value.trim();
        if (q.length < 3) { hidePanel(); return; }
        debounce = setTimeout(async () => {
          try {
            const items = await queryAddresses(q);
            if (!items || !items.length) { hidePanel(); return; }
            activeInput = input;
            panel.innerHTML=''; positionPanel(input);
            items.forEach(it=>{
              const line = it.display_name || [it.name, it.address && (it.address.city || it.address.town || it.address.village), it.address && it.address.country].filter(Boolean).join(', ');
              const btn  = document.createElement('button');
              btn.type='button';
              btn.style.cssText='display:block;width:100%;text-align:left;padding:10px 12px;border:0;background:#fff;border-bottom:1px solid var(--border);cursor:pointer';
              btn.textContent = line;
              btn.onclick = ()=>{ input.value = line; hidePanel(); };
              panel.appendChild(btn);
            });
            panel.style.display='block';
          } catch { hidePanel(); }
        }, 220);
      }, { passive:true });
      input.addEventListener('focus', () => { if (input.value.trim().length >= 3) positionPanel(input); }, { passive:true });
      input.addEventListener('blur', () => setTimeout(hidePanel, 150));
    }

    function bindTransportInputs() {
      // Bind ONLY inside Transport modal
      const pickup = document.getElementById('tiPickup');
      const dest   = document.getElementById('tiDestination');
      if (pickup) bindInput(pickup);
      if (dest)   bindInput(dest);
      document.querySelectorAll('#tiModal .tiStopInput').forEach(bindInput);
    }

    // Observe the transport modal only (stops remain transport-only)
    const mo = new MutationObserver(() => bindTransportInputs());
    mo.observe(tiModal, { childList:true, subtree:true });
    bindTransportInputs();

    // If Google key is blocked, prevent your attachAutocomplete from trying to use it
    const origAttach = window.attachAutocomplete;
    window.attachAutocomplete = function(inputEl){
      if (window.__zupGoogleBlocked) return; // no-op; fallback takes over
      try { if (typeof origAttach === 'function') origAttach(inputEl); } catch {}
    };
  })();

  // 5) Safety: ensure key buttons are not treated as form submit on mobile
  window.addEventListener('DOMContentLoaded', ()=>{
    ['cartBtn','openCartBtn','checkoutBtn','closeCart','placeOrderBtn'].forEach(id => { const b=$(id); if (b) b.setAttribute('type','button'); });
    // Initial badge sync
    updateCounts(readCart());
  });
})();
</script>
</body>
</html>
